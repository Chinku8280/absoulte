<?php

/**
 * NOTICE OF LICENSE
 *
 * This source file is subject to the HRSALE License
 * that is bundled with this package in the file license.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.hrsale.com/license.txt
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to hrsalesoft@gmail.com so we can send you a copy immediately.
 *
 * @author   HRSALE
 * @author-email  hrsalesoft@gmail.com
 * @copyright  Copyright Â© hrsale.com. All Rights Reserved
 */


require_once(APPPATH . 'third_party/dompdf/autoload.inc.php');

use Dompdf\Dompdf;
use Dompdf\Options; //


defined('BASEPATH') or exit('No direct script access allowed');

class Payroll extends MY_Controller
{

	public function __construct()
	{
		parent::__construct();
		$this->load->library('Pdf');
		//load the model
		$this->load->model("Payroll_model");
		$this->load->model("Xin_model");
		$this->load->model("Employees_model");
		$this->load->model("Designation_model");
		$this->load->model("Department_model");
		$this->load->model("Location_model");
		$this->load->model("Timesheet_model");

		$this->load->model("Overtime_request_model");
		$this->load->model("Company_model");
		$this->load->model("Finance_model");
		$this->load->model("Cpf_options_model");
		$this->load->model("Cpf_percentage_model");
		$this->load->model("Cpf_payslip_model");
		$this->load->model("Contribution_fund_model");
		$this->load->model("PaymentDeduction_Model");

		$this->load->helper('string');
	}

	/*Function to set JSON output*/
	public function output($Return = array())
	{
		/*Set response header*/
		header("Access-Control-Allow-Origin: *");
		header("Content-Type: application/json; charset=UTF-8");
		/*Final JSON response*/
		exit(json_encode($Return));
	}

	// payroll templates
	public function templates()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] 			= 	$this->lang->line('left_payroll_templates') . ' | ' . $this->Xin_model->site_title();
		$data['all_companies'] 	= 	$this->Xin_model->get_companies();
		$data['breadcrumbs'] 	= 	$this->lang->line('left_payroll_templates');
		$data['path_url'] 		= 	'payroll_templates';
		$role_resources_ids 	= 	$this->Xin_model->user_role_resource();
		if (in_array('34', $role_resources_ids)) {
			if (!empty($session)) {
				$data['subview'] = $this->load->view("admin/payroll/templates", $data, TRUE);
				$this->load->view('admin/layout/layout_main', $data); //page load
			} else {
				redirect('admin/');
			}
		} else {
			redirect('admin/dashboard');
		}
	}

	// generate payslips
	public function generate_payslip()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}

		$data['title'] 			= 	$this->lang->line('left_generate_payslip') . ' | ' . $this->Xin_model->site_title();
		$data['all_employees'] 	= 	$this->Xin_model->all_employees();
		$data['all_companies'] 	= 	$this->Xin_model->get_companies();
		$data['breadcrumbs'] 	= 	$this->lang->line('left_generate_payslip');
		$data['path_url'] 		= 	'generate_payslip';
		$role_resources_ids 	= 	$this->Xin_model->user_role_resource();
		if (in_array('36', $role_resources_ids)) {
			if (!empty($session)) {
				$data['subview'] = $this->load->view("admin/payroll/generate_payslip", $data, TRUE);
				$this->load->view('admin/layout/layout_main', $data); //page load
			} else {
				redirect('admin/');
			}
		} else {
			redirect('admin/dashboard');
		}
	}

	// payment history
	public function payment_history()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] 			= 	$this->lang->line('xin_payslip_history');
		$data['all_employees'] 	= 	$this->Xin_model->all_employees();
		$data['breadcrumbs'] 	= 	$this->lang->line('xin_payslip_history');
		$data['path_url'] 		= 	'payment_history';
		$data['get_all_companies'] 	= 	$this->Xin_model->get_companies();
		$role_resources_ids 		= 	$this->Xin_model->user_role_resource();
		if (in_array('37', $role_resources_ids)) {
			if (!empty($session)) {
				$data['subview'] = $this->load->view("admin/payroll/payment_history", $data, TRUE);
				$this->load->view('admin/layout/layout_main', $data); //page load
			} else {
				redirect('admin/');
			}
		} else {
			redirect('admin/dashboard');
		}
	}

	// payslip > employees
	public function payslip_list()
	{
		$data['title'] = $this->Xin_model->site_title();
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			$this->load->view("admin/payroll/generate_payslip", $data);
		} else {
			redirect('admin/');
		}

		// Datatables Variables
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));

		// payment month
		$pay_date = $this->input->get("month_year");

		$role_resources_ids = $this->Xin_model->user_role_resource();
		$user_info = $this->Xin_model->read_user_info($session['user_id']);
		if ($user_info[0]->user_role_id == 1 || in_array('314', $role_resources_ids)) {
			if ($this->input->get("employee_id") == 0 && $this->input->get("company_id") == 0) {
				$payslip = $this->Employees_model->get_employees_payslip($pay_date);
			} else if ($this->input->get("employee_id") == 0 && $this->input->get("company_id") != 0) {
				$payslip = $this->Payroll_model->get_comp_template($this->input->get("company_id"), 0, $pay_date);
			} else if ($this->input->get("employee_id") != 0 && $this->input->get("company_id") != 0) {
				$payslip = $this->Payroll_model->get_employee_comp_template($this->input->get("company_id"), $this->input->get("employee_id"), $pay_date);
			} else {
				$payslip = $this->Employees_model->get_employees_payslip($pay_date);
			}
		} else {
			$payslip = $this->Payroll_model->get_employee_comp_template($user_info[0]->company_id, $session['user_id']);
		}

		$system = $this->Xin_model->read_setting_info(1);
		$data = array();
		foreach ($payslip->result() as $r) {
			$exit_employee = $this->Employees_model->get_employee_exit($r->user_id);

			if (count($exit_employee) > 0) {
				$e_date = date('Y-m-d', strtotime($exit_employee[0]->exit_date));
				$exit_date = date('m-Y', strtotime($e_date));
				if ($exit_date >= $pay_date)  {
					$emp_name = $r->first_name . ' ' . $r->last_name;
					// office shift
					$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);
	
					//overtime request
					$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
					$re_hrs_old_int1 = 0;
					$re_hrs_old_seconds = 0;
					$re_pcount = 0;
					foreach ($overtime_count as $overtime_hr) {
						$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
						$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
						$re_interval_late = $request_clock_in->diff($request_clock_out);
						$re_hours_r  = $re_interval_late->format('%h');
						$re_minutes_r = $re_interval_late->format('%i');
						$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';
	
						$re_str_time = $re_total_time;
	
						$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);
	
						sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$re_hrs_old_int1 += $re_hrs_old_seconds;
	
						$re_pcount = gmdate("H", $re_hrs_old_int1);
					}
	
					$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
					$hrs_old_int1 = 0;
					$pcount = 0;
					foreach ($result->result() as $hour_work) {
						$clock_in =  new DateTime($hour_work->clock_in);
						$clock_out =  new DateTime($hour_work->clock_out);
						$interval_late = $clock_in->diff($clock_out);
						$hours_r  = $interval_late->format('%h');
						$minutes_r = $interval_late->format('%i');
						$total_time = $hours_r . ":" . $minutes_r . ":" . '00';
	
						$str_time = $total_time;
	
						$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);
	
						sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$hrs_old_int1 += $hrs_old_seconds;
	
						$pcount = gmdate("H", $hrs_old_int1);
					}
					$pcount = $pcount + $re_pcount;
	
					// get company
					$company = $this->Xin_model->read_company_info($r->company_id);
					if (!is_null($company)) {
						$comp_name = $company[0]->name;
					} else {
						$comp_name = '--';
					}
	
					/**
					 * Local Variable
					 */
					$g_ordinary_wage = 0;
					$g_additional_wage = 0;
					$g_shg = 0;
					$g_sdl = 0;
	
					// 1: salary type
					if ($r->wages_type == 1) {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					} else if ($r->wages_type == 2) {
						$wages_type = $this->lang->line('xin_employee_daily_wages');
						if ($pcount > 0) {
							$basic_salary = $pcount * $r->basic_salary;
						} else {
							$basic_salary = $pcount;
						}
						$p_class = 'emo_hourly_pay';
						$view_p_class = 'hourlywages_template_modal';
					} else {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					}
	
	
					// employee deduction
					$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
					$pa_month = date('m-Y', strtotime('01-' . $pay_date));
					$deduction_amount = 0;
					if ($employee_deduction) {
						foreach ($employee_deduction as $deduction) {
							if ($deduction->type_id == 1) {
								$deduction_amount +=  $deduction->amount;
							}
							if ($deduction->type_id == 2) {
								$from_month_year = date('m-Y', strtotime($deduction->from_date));
								$to_month_year = date('d-m-Y', strtotime($deduction->to_date));
	
	
								if ($from_month_year != "" && $to_month_year != "") {
									if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
										$deduction_amount +=  $deduction->amount;
									}
								}
							}
						}
					}
	
	
	
					//3: Gross rate of pay (unpaid leave deduction)
					$holidays_count = 0;
					$no_of_working_days = 0;
					$month_start_date = new DateTime('01-' . $pay_date);
					$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
					$month_end_date->modify('+1 day');
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($month_start_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$period_day = $p->format('l');
						$period_date = $p->format('Y-m-d');
	
						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
						if ($is_holiday) {
							$holidays_count += 1;
						}
	
						//working days excluding holidays based on office shift
						if ($period_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_working_days += 1;
							}
						}
					}
	
					//unpaid leave
					$unpaid_leave_amount = 0;
					$leaves_taken_count = 0;
					$leave_period = array();
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							$pay_date_month = new DateTime('01-' . $pay_date);
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);
	
							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {
									if ($office_shift[0]->monday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
						}
					}
	
					// if joining date and pay date same then this logic work
					$month_date_join = date('m-Y', strtotime($r->date_of_joining));
					$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
					$month_last_date = date('m-Y', strtotime($lastday));
	
					$first_date =  new DateTime($r->date_of_joining);
					$no_of_days_worked = 0;
					$same_month_holidays_count = 0;
					if ($month_date_join == $pay_date) {
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($first_date, $interval, $month_end_date);
						foreach ($period as $p) {
							$p_day = $p->format('l');
							$m_p_date = $p->format('Y-m-d');
	
							//holidays in a month
							$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
							if ($is_holiday) {
								$same_month_holidays_count += 1;
							}
	
							//working days excluding holidays based on office shift
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$no_of_days_worked += 1;
								}
							}
						}
					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
					} else {
						// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
						$no_of_days_worked = $no_of_working_days -  $holidays_count;
					}
	
	
					if ($month_date_join == $pay_date){
						$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
					}else{
						$show_main_salary = $basic_salary;
					}
				
					$g_ordinary_wage += $show_main_salary;
					$g_shg += $show_main_salary;
					$g_sdl += $show_main_salary;
				
					$g_ordinary_wage -= $deduction_amount;
					$g_shg -= $deduction_amount;
					$g_sdl -= $deduction_amount;
	
	
					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
							$loan_de_amount += $er_loan;
						}
					} else {
						$loan_de_amount = 0;
					}
					$loan_de_amount = number_format(floatval($loan_de_amount), 2);
	
					
					// 2: all allowances
					$allowance_amount = 0;
					$gross_allowance_amount = 0;
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
	
	
							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								if ($month_date_join == $pay_date){
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}
	
							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}
	
							$allowance_amount += $eallowance_amount;
						}
					}
					$gross_allowance_amount = $allowance_amount;
	
	
	
					// commissions
					$commissions_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $c->commission_amount / 2;
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
	
							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommissions_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommissions_amount;
							}
	
							if ($c->sdl == 1) {
								$g_sdl += $ecommissions_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommissions_amount;
							}
	
							$commissions_amount += $ecommissions_amount;
						}
					}
	
					//share options
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
	
								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;
					}
	
					
					// otherpayments
					$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
					$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
					$other_payments_amount = 0;
					if ($count_other_payments > 0) {
						foreach ($other_payments->result() as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}
	
									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
	
									$other_payments_amount += $epayments_amount;
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $pay_date) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $pay_date);
								}
	
								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
	
								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $pay_date) {
										$last_date = new DateTime($sl_other_payments->end_date);
									} else if($last_date->format('m-Y') >= $pay_date){
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
								if(!empty($last_date)){
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $pay_date) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
	
	
										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');
	
											//holidays in a month
	
											$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}
	
											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}
	
										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
	
	
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
									}
								}
							}
						}
					} else {
						$other_payments_amount = 0;
					}
	
					$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
		
					if ($unpaid_leaves) {
						$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
					}
					
					// $g_ordinary_wage = $gross_pay;
					$g_shg = $gross_pay;
					$g_sdl = $gross_pay;
	
					$g_ordinary_wage -= $unpaid_leave_amount;
	
					
	
					// other benefit
					$other_benefit_mount = 0;
					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
					foreach ($other_benefit_list->result() as $benefit_list) {
						$other_benefit_mount += $benefit_list->other_benefit_cost;
					}
	
	
					// statutory_deductions
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') {
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							} else {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							}
						}
					} else {
						$statutory_deductions_amount = 0;
					}
	
					// overtime
					$overtime_amount = 0;
					$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
					if ($overtime) {
						$ot_hrs = 0;
						$ot_mins = 0;
						foreach ($overtime as $ot) {
							$total_hours = explode(':', $ot->total_hours);
							$ot_hrs += $total_hours[0];
							$ot_mins += $total_hours[1];
						}
						if ($ot_mins > 0) {
							$ot_hrs += round($ot_mins / 60, 2);
						}
	
						//overtime rate
						$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
						if ($overtime_rate) {
							$rate = $overtime_rate->overtime_pay_rate;
						} else {
							$week_hours = 44;
							$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
							$rate = $rate * 1.5;
						}
	
						if ($ot_hrs > 0) {
							$overtime_amount = round($ot_hrs * $rate, 2);
						}
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$overtime_amount = $overtime_amount / 2;
							}
						}
						$g_ordinary_wage += $overtime_amount;
						$g_sdl += $overtime_amount;
					}
	
					// make payment
					// if (true || $system[0]->is_half_monthly == 1) {
						
					// 	$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
					// 	$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
					// 	if ($payment_check->num_rows() > 1) {
	
					// 		//foreach($payment_last as $payment_half_last){
					// 		$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					// 		$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
					// 		$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
					// 		//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';
	
					// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
					// 		if (in_array('313', $role_resources_ids)) {
					// 			$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					// 		} else {
					// 			$delete = '';
					// 		}
	
					// 		$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
					// 		//}
					// 		//detail link
					// 		$detail = '';
					// 	} else if ($payment_check->num_rows() > 0) {
	
					// 		$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					// 		$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
					// 		$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
	
					// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
	
					// 		$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
					// 		if (in_array('313', $role_resources_ids)) {
					// 			$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					// 		} else {
					// 			$delete = '';
					// 		}
					// 		$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
					// 		$detail = '';
					// 	} else {
	
					// 		$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
					// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
					// 		$delete = '';
					// 		//detail link
					// 		$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					// 	}
					// 	//detail link
					// 	//$detail = '';
					// } else {
					// 	$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					// 	if ($payment_check->num_rows() > 0) {
					// 		$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					// 		$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
					// 		if ($make_payment[0]->status == 1) {
					// 			$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
					// 		} else if ($make_payment[0]->status == 2) {
					// 			$status = '<span class="label label-warning">' . "Partially" . '</span>';
					// 		}
					// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
					// 		if (in_array('313', $role_resources_ids)) {
					// 			$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					// 		} else {
					// 			$delete = '';
					// 		}
					// 	} else {
	
					// 		$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
					// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
					// 			<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
					// 				<span class="fa fas fa-money"></span>
					// 			</button>
					// 		</span>';
					// 		$delete = '';
					// 	}
					// 	//detail link
					// 	$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					// }
	
					$payment_check = $this->Payroll_model->check_make_payment_payslip_for_first_payment($r->user_id, $pay_date);
					$payment_check_final = $this->Payroll_model->check_make_payment_payslip_for_final_payment($r->user_id, $pay_date);
					$balance = 0;
					$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
					if($check && $check[0]->balance_amount > 0){
						$balance = $check[0]->balance_amount;
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
						$status = '<span class="label label-warning">' . "Partially Paid" . '</span>';
	
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
						
						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$delete  = $delete;
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						
					}else if($check && $check[0]->is_advance != 1  && $check[0]->balance_amount == 0){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
						$status = '<span class="label label-success">Paid</span>';
	
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
						
						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$delete  = $delete;
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						
					}else {
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
							$delete = '';
							$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
							$balance = $this->Xin_model->currency_sign(0, $r->user_id);
						}
	
					
					// employee accommodations
					$employee_accommodations = 0;
					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $pay_date || $period_to == $pay_date) {
							if (!empty($get_employee_accommodation->rent_paid)) {
								$employee_accommodations += $get_employee_accommodation->rent_paid;
							}
						}
					}
	
					// employee claims
					$claim_amount = 0;
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $pay_date) {
							$claim_amount += $claims->amount;
						}
					}
	
	
	
					$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
					$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
					$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;
	
	
					// cpf calculation
					$emp_dob = $r->date_of_birth;
					$dob = new DateTime($emp_dob);
	
					$today = new DateTime('01-' . $pay_date);
					$age = $dob->diff($today);
					$age_year = $age->y;
					$age_month = $age->m;
	
					$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
					$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
					$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;
	
					if ($age_month > 0) {
						$age_year = $age_year + 1;
					}
	
					$cpf_employee 	= 	0;
					$cpf_employer	=	0;
	
					$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
					if ($im_status) {
						$immigration_id = $im_status->immigration_id;
						if ($immigration_id == 2) {
							$issue_date = $im_status->issue_date;
							$i_date = new DateTime($issue_date);
							$today = new DateTime();
							$pr_age = $i_date->diff($today);
							$pr_age_year = $pr_age->y;
							$pr_age_month = $pr_age->m;
						}
	
						if ($immigration_id == 1 || $immigration_id == 2) {
	
							$ordinary_wage = $g_ordinary_wage;
							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}
	
							//additional wage
							$additional_wage = $g_additional_wage;
							$aw = $g_additional_wage;
							$tw = $ow + $additional_wage;
							if ($im_status->issue_date != "") {
								if ($pr_age_year == 1) {
	
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 2) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.45 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
											$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
											if ($count_total_cpf > 1776) {
												$total_cpf = 1776;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1110) {
												$cpf_employee = 1110;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(6 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.375 * ($tw - 500));
											$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
											$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
											if ($count_total_cpf > 1369) {
												$total_cpf = 1369;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 925) {
												$cpf_employee = 925;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
											if ($count_total_cpf > 814) {
												$total_cpf = 814;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 3 || $pr_age_year > 3) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(17 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.6 * ($tw - 500));
											$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
											$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
											if ($count_total_cpf > 2738) {
												$total_cpf = 2738;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1480) {
												$cpf_employee = 1480;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = $total_cpf - $cpf_employee;
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(15.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.51 * ($tw - 500));
											$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
											$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
											if ($count_total_cpf > 2405) {
												$total_cpf = 2405;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1258) {
												$cpf_employee = 1258;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(12 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.345 * ($tw - 500));
											$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
											$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
											if ($count_total_cpf > 1739) {
												$total_cpf = 1739;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 851) {
												$cpf_employee = 851;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65 && $age_year <= 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
											if ($count_total_cpf > 1221) {
												$total_cpf = 1221;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(7.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
											if ($count_total_cpf > 925) {
												$total_cpf = 925;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
							}
	
	
	
							if ($immigration_id == 1) {
	
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$count_total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
	
	
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
	
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$count_total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
	
							$total_net_salary = $total_net_salary - $cpf_employee;
							$cpf_total = $cpf_employee + $cpf_employer;
	
							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
						}
					}
	
	
					$shg_fund_deduction_amount = 0;
					//Other Fund Contributions
					$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
	
					if ($employee_contributions && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$shg_fund_name = $contribution_type[0]->contribution;
						$shg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
					}
					$ashg_fund_deduction_amount = 0;
	
					$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
					if ($employee_ashg_contributions  && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_ashg_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$ashg_fund_name = $contribution_type[0]->contribution;
	
						$ashg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
					}
	
					// echo $total_net_salary;
	
					// $sdl_total_amount = 0;
					// if ($g_sdl > 1 && $g_sdl <= 800) {
					// 	$sdl_total_amount = 2;
					// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					// 	$sdl_amount = (0.25 * $g_sdl) / 100;
					// 	$sdl_total_amount = $sdl_amount;
					// } elseif ($g_sdl > 4500) {
					// 	$sdl_total_amount = 11.25;
					// }
	
	
					$net_salary = number_format((float)$total_net_salary, 2, '.', '');
					$basic_salary = number_format((float)$basic_salary, 2, '.', '');
					// if ($basic_salary == 0 || $basic_salary == '') {
					// 	$fmpay = '';
					// } else {
						$fmpay = $mpay;
					// }
	
	
					$company_info = $this->Company_model->read_company_information($r->company_id);
					if (!is_null($company_info)) {
						$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
						$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
						//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
					} else {
						//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
						$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);
	
						$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);
	
						//$net_salary = $this->Xin_model->currency_sign($net_salary);	
						//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
						$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
					}
	
					$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';
	
					//action link
					$act = $detail . $fmpay . $delete;
					// $act = $fmpay . $delete;
	
					if ($r->wages_type == 1) {
						if ($system[0]->is_half_monthly == 1) {
							$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
						} else {
							$emp_payroll_wage = $wages_type;
						}
					} else {
						$emp_payroll_wage = $wages_type;
					}
	
					$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					$p = $payslips->result();
					
					$mode_of_payment = $r->payment_mode ?? '';
	
	
					$data[] = array(
						$act,
						$iemp_name,
						$emp_payroll_wage,
						// $basic_salary,
						$this->Xin_model->currency_sign($show_main_salary, $r->user_id),
						$this->Xin_model->currency_sign($cpf_employee, $r->user_id),
						$net_salary,
						$balance,
						$mode_of_payment,
						$status
					);
				}
			} else {
				$emp_name = $r->first_name . ' ' . $r->last_name;
				// office shift
				$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}

				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
				$hrs_old_int1 = 0;
				$pcount = 0;
				foreach ($result->result() as $hour_work) {
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}
				$pcount = $pcount + $re_pcount;

				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}


				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
				$pa_month = date('m-Y', strtotime('01-' . $pay_date));
				$deduction_amount = 0;
				if ($employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						if ($deduction->type_id == 1) {
							$deduction_amount +=  $deduction->amount;
						}
						if ($deduction->type_id == 2) {
							$from_month_year = date('m-Y', strtotime($deduction->from_date));
							$to_month_year = date('d-m-Y', strtotime($deduction->to_date));


							if ($from_month_year != "" && $to_month_year != "") {
								if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
									$deduction_amount +=  $deduction->amount;
								}
							}
						}
					}
				}



				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $pay_date);
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						$pay_date_month = new DateTime('01-' . $pay_date);
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
					}
				}

				// if joining date and pay date same then this logic work
				$month_date_join = date('m-Y', strtotime($r->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($r->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $pay_date) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$m_p_date = $p->format('Y-m-d');

						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}
				// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
				$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}


				if ($month_date_join == $pay_date){
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				}else{
					$show_main_salary = $basic_salary;
				}
			
				$g_ordinary_wage += $show_main_salary;
				$g_shg += $show_main_salary;
				$g_sdl += $show_main_salary;
			
				$g_ordinary_wage -= $deduction_amount;
				$g_shg -= $deduction_amount;
				$g_sdl -= $deduction_amount;


				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				if ($count_loan_deduction > 0) {
					foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
						} else {
							$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
						}
						$loan_de_amount += $er_loan;
					}
				} else {
					$loan_de_amount = 0;
				}
				$loan_de_amount = number_format(floatval($loan_de_amount), 2);

				
				// 2: all allowances
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
				if ($salary_allowances) {
					foreach ($salary_allowances as $sa) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$eallowance_amount = $sa->allowance_amount / 2;
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
						} else {
							$eallowance_amount = $sa->allowance_amount;
						}


						if (!empty($sa->salary_month)) {
							$g_additional_wage += $eallowance_amount;
						} else {
							if ($month_date_join == $pay_date){
								$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
							}
							$g_ordinary_wage += $eallowance_amount;
							if ($sa->id == 2) {
								$gross_allowance_amount = $eallowance_amount;
							}
						}

						if ($sa->sdl == 1) {
							$g_sdl += $eallowance_amount;
						}
						if ($sa->shg == 1) {
							$g_shg += $eallowance_amount;
						}

						$allowance_amount += $eallowance_amount;
					}
				}
				$gross_allowance_amount = $allowance_amount;



				// commissions
				$commissions_amount = 0;
				$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
				if ($commissions) {
					foreach ($commissions as $c) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$ecommissions_amount = $c->commission_amount / 2;
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
						} else {
							$ecommissions_amount = $c->commission_amount;
						}

						if ($c->commission_type == 9) {
							$g_ordinary_wage += $ecommissions_amount;
						} elseif ($c->commission_type == 10) {
							$g_additional_wage += $ecommissions_amount;
						}

						if ($c->sdl == 1) {
							$g_sdl += $ecommissions_amount;
						}
						if ($c->shg == 1) {
							$g_shg += $ecommissions_amount;
						}

						$commissions_amount += $ecommissions_amount;
					}
				}

				//share options
				$share_options_amount = 0;
				$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
				if ($share_options) {
					$eebr_amount = 0;
					$eris_amount = 0;
					foreach ($share_options as $s) {
						$scheme = $s->so_scheme;
						if ($scheme == 1) {
							$price_doe = $s->price_date_of_excercise;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;
							$amount = ($price_doe - $price_ex) * $no_shares;
							$eebr_amount += $amount;
						} else {
							$price_doe = $s->price_date_of_excercise;
							$price_dog = $s->price_date_of_grant;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;

							$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
							$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
							$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
						}
					}
					$share_options_amount = round($eebr_amount + $eris_amount, 2);
					$g_additional_wage += $share_options_amount;
					$g_sdl += $share_options_amount;
					$g_shg += $share_options_amount;
				}

				
				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				if ($count_other_payments > 0) {
					foreach ($other_payments->result() as $sl_other_payments) {
						if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
							if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$epayments_amount = $sl_other_payments->payments_amount / 2;
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}
								} else {
									$epayments_amount = $sl_other_payments->payments_amount;
								}

								if ($sl_other_payments->cpf_applicable == 1) {
									$g_additional_wage += $epayments_amount;
									$g_shg += $epayments_amount;
									$g_sdl += $epayments_amount;
								}

								$other_payments_amount += $epayments_amount;
							}
						} else {
							$first_date = new DateTime($sl_other_payments->date);
							if ($first_date->format('m-Y') == $pay_date) {
								$first_date =  new DateTime($sl_other_payments->date);
							} else {
								$first_date = new DateTime('01-' . $pay_date);
							}

							$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));

							if (!empty($sl_other_payments->end_date)) {
								$last_date = new DateTime($sl_other_payments->end_date);
								if ($last_date->format('m-Y') == $pay_date) {
									$last_date = new DateTime($sl_other_payments->end_date);
								} else if($last_date->format('m-Y') >= $pay_date){
									$last_date = $month_end_date_for_other;
								} else {
									$last_date = '';
								}
							} else {
								$last_date = $month_end_date_for_other;
							}
							if(!empty($last_date)){
								$last_date->modify('+1 day');
								$final_last_day = new DateTime($last_date->format('d-m-Y'));
								if ($final_last_day->format('m-Y') >= $pay_date) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}


									// it for no of working day
									$no_of_days_worked_for_other_payment = 0;
									$same_month_holidays_count_for_other_payment = 0;
									$interval = new DateInterval('P1D');
									$period = new DatePeriod($first_date, $interval, $last_date);
									foreach ($period as $p) {
										$p_day = $p->format('l');
										$p_date = $p->format('Y-m-d');

										//holidays in a month

										$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
										if ($is_holiday) {
											$same_month_holidays_count_for_other_payment += 1;
										}

										//working days excluding holidays based on office shift
										if ($p_day == 'Monday') {
											if ($office_shift[0]->monday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Tuesday') {
											if ($office_shift[0]->tuesday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Wednesday') {
											if ($office_shift[0]->wednesday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Thursday') {
											if ($office_shift[0]->thursday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Friday') {
											if ($office_shift[0]->friday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Saturday') {
											if ($office_shift[0]->saturday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Sunday') {
											if ($office_shift[0]->sunday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										}
									}

									$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
									$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);


									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
									$other_payments_amount += $epayments_amount;
								}
							}
						}
					}
				} else {
					$other_payments_amount = 0;
				}

				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
	
				if ($unpaid_leaves) {
					$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				}
				
				// $g_ordinary_wage = $gross_pay;
				$g_shg = $gross_pay;
				$g_sdl = $gross_pay;

				$g_ordinary_wage -= $unpaid_leave_amount;

				

				// other benefit
				$other_benefit_mount = 0;
				$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
				foreach ($other_benefit_list->result() as $benefit_list) {
					$other_benefit_mount += $benefit_list->other_benefit_cost;
				}


				// statutory_deductions
				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if ($count_statutory_deductions > 0) {
					foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
						if ($system[0]->statutory_fixed != 'yes') {
							$sta_salary = $gross_pay;
							$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $st_amount / 2;
								} else {
									$single_sd = $st_amount;
								}
							} else {
								$single_sd = $st_amount;
							}
							$statutory_deductions_amount += $single_sd;
						} else {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
							} else {
								$single_sd = $sl_salary_statutory_deductions->deduction_amount;
							}
							$statutory_deductions_amount += $single_sd;
						}
					}
				} else {
					$statutory_deductions_amount = 0;
				}

				// overtime
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
				if ($overtime) {
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;
				}

				// make payment
				// if (true || $system[0]->is_half_monthly == 1) {
					
				// 	$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
				// 	$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
				// 	if ($payment_check->num_rows() > 1) {

				// 		//foreach($payment_last as $payment_half_last){
				// 		$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				// 		$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

				// 		$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
				// 		//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';

				// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

				// 		if (in_array('313', $role_resources_ids)) {
				// 			$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
				// 		} else {
				// 			$delete = '';
				// 		}

				// 		$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
				// 		//}
				// 		//detail link
				// 		$detail = '';
				// 	} else if ($payment_check->num_rows() > 0) {

				// 		$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				// 		$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

				// 		$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

				// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';

				// 		$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

				// 		if (in_array('313', $role_resources_ids)) {
				// 			$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
				// 		} else {
				// 			$delete = '';
				// 		}
				// 		$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
				// 		$detail = '';
				// 	} else {

				// 		$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
				// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
				// 		$delete = '';
				// 		//detail link
				// 		$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
				// 	}
				// 	//detail link
				// 	//$detail = '';
				// } else {
				// 	$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
				// 	if ($payment_check->num_rows() > 0) {
				// 		$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				// 		$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

				// 		if ($make_payment[0]->status == 1) {
				// 			$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
				// 		} else if ($make_payment[0]->status == 2) {
				// 			$status = '<span class="label label-warning">' . "Partially" . '</span>';
				// 		}
				// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

				// 		if (in_array('313', $role_resources_ids)) {
				// 			$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
				// 		} else {
				// 			$delete = '';
				// 		}
				// 	} else {

				// 		$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
				// 		$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
				// 			<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
				// 				<span class="fa fas fa-money"></span>
				// 			</button>
				// 		</span>';
				// 		$delete = '';
				// 	}
				// 	//detail link
				// 	$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
				// }

				$payment_check = $this->Payroll_model->check_make_payment_payslip_for_first_payment($r->user_id, $pay_date);
				$payment_check_final = $this->Payroll_model->check_make_payment_payslip_for_final_payment($r->user_id, $pay_date);
				$balance = 0;
				$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
				if($check && $check[0]->balance_amount > 0){
					$balance = $check[0]->balance_amount;
					$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				
					$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

					$status = '<span class="label label-warning">' . "Partially Paid" . '</span>';

					$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
					$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
					
					if (in_array('313', $role_resources_ids)) {
						$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					} else {
						$delete = '';
					}
					// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
					$delete  = $delete;
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					
				}else if($check && $check[0]->is_advance != 1  && $check[0]->balance_amount == 0){
					$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				
					$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

					$status = '<span class="label label-success">Paid</span>';

					$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
					
					if (in_array('313', $role_resources_ids)) {
						$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					} else {
						$delete = '';
					}
					// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
					$delete  = $delete;
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					
				}else {
						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						$balance = $this->Xin_model->currency_sign(0, $r->user_id);
					}

				
				// employee accommodations
				$employee_accommodations = 0;
				$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
				foreach ($get_employee_accommodations as $get_employee_accommodation) {
					$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
					$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
					if ($period_from == $pay_date || $period_to == $pay_date) {
						if (!empty($get_employee_accommodation->rent_paid)) {
							$employee_accommodations += $get_employee_accommodation->rent_paid;
						}
					}
				}

				// employee claims
				$claim_amount = 0;
				$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
				foreach ($get_employee_claims->result() as $claims) {
					$date 	= 	date('m-Y', strtotime($claims->date));
					if ($date == $pay_date) {
						$claim_amount += $claims->amount;
					}
				}



				$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
				$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;


				// cpf calculation
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);

				$today = new DateTime('01-' . $pay_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}

				$cpf_employee 	= 	0;
				$cpf_employer	=	0;

				$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
				if ($im_status) {
					$immigration_id = $im_status->immigration_id;
					if ($immigration_id == 2) {
						$issue_date = $im_status->issue_date;
						$i_date = new DateTime($issue_date);
						$today = new DateTime();
						$pr_age = $i_date->diff($today);
						$pr_age_year = $pr_age->y;
						$pr_age_month = $pr_age->m;
					}

					if ($immigration_id == 1 || $immigration_id == 2) {

						$ordinary_wage = $g_ordinary_wage;
						if ($ordinary_wage > $ordinary_wage_cap) {
							$ow = $ordinary_wage_cap;
						} else {
							$ow = $ordinary_wage;
						}

						//additional wage
						$additional_wage = $g_additional_wage;
						$aw = $g_additional_wage;
						$tw = $ow + $additional_wage;
						if ($im_status->issue_date != "") {
							if ($pr_age_year == 1) {

								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 2) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.45 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
										$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
										if ($count_total_cpf > 1776) {
											$total_cpf = 1776;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1110) {
											$cpf_employee = 1110;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(6 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.375 * ($tw - 500));
										$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
										$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
										if ($count_total_cpf > 1369) {
											$total_cpf = 1369;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 925) {
											$cpf_employee = 925;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
										if ($count_total_cpf > 814) {
											$total_cpf = 814;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 3 || $pr_age_year > 3) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = $total_cpf - $cpf_employee;
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
						}



						if ($immigration_id == 1) {

							if ($age_year <= 55) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(17 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.6 * ($tw - 500));
									$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
									$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
									if ($count_total_cpf > 2738) {
										$count_total_cpf = 2738;
									} else {
										$total_cpf = $count_total_cpf;
									}


									if ($count_cpf_employee > 1480) {
										$cpf_employee = 1480;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 55 && $age_year <= 60) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(15.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.51 * ($tw - 500));
									$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;

									$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
									if ($count_total_cpf > 2405) {
										$count_total_cpf = 2405;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 1258) {
										$cpf_employee = 1258;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 60 && $age_year <= 65) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(12 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.345 * ($tw - 500));
									$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
									$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

									if ($count_total_cpf > 1739) {
										$total_cpf = 1739;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 851) {
										$cpf_employee = 851;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 65 && $age_year <= 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(9 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.225 * ($tw - 500));
									$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
									$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

									if ($count_total_cpf > 1221) {
										$total_cpf = 1221;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 555) {
										$cpf_employee = 555;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(7.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.15 * ($tw - 500));
									$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
									$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

									if ($count_total_cpf > 925) {
										$total_cpf = 925;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 370) {
										$cpf_employee = 370;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							}
						}

						$total_net_salary = $total_net_salary - $cpf_employee;
						$cpf_total = $cpf_employee + $cpf_employer;

						$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
						$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
						$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
					}
				}


				$shg_fund_deduction_amount = 0;
				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);

				if ($employee_contributions && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$shg_fund_name = $contribution_type[0]->contribution;
					$shg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
				}
				$ashg_fund_deduction_amount = 0;

				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				if ($employee_ashg_contributions  && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$ashg_fund_name = $contribution_type[0]->contribution;

					$ashg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
				}

				// echo $total_net_salary;

				// $sdl_total_amount = 0;
				// if ($g_sdl > 1 && $g_sdl <= 800) {
				// 	$sdl_total_amount = 2;
				// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
				// 	$sdl_amount = (0.25 * $g_sdl) / 100;
				// 	$sdl_total_amount = $sdl_amount;
				// } elseif ($g_sdl > 4500) {
				// 	$sdl_total_amount = 11.25;
				// }


				$net_salary = number_format((float)$total_net_salary, 2, '.', '');
				$basic_salary = number_format((float)$basic_salary, 2, '.', '');
				// if ($basic_salary == 0 || $basic_salary == '') {
				// 	$fmpay = '';
				// } else {
					$fmpay = $mpay;
				// }


				$company_info = $this->Company_model->read_company_information($r->company_id);
				if (!is_null($company_info)) {
					$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
					$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
					//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
				} else {
					//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
					$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);

					$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);

					//$net_salary = $this->Xin_model->currency_sign($net_salary);	
					//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
					$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
				}

				$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';

				//action link
				$act = $detail . $fmpay . $delete;
				// $act = $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}

				$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
				$p = $payslips->result();
				
				$mode_of_payment = $r->payment_mode ?? '';


				$data[] = array(
					$act,
					$iemp_name,
					$emp_payroll_wage,
					// $basic_salary,
					$this->Xin_model->currency_sign($show_main_salary, $r->user_id),
					$this->Xin_model->currency_sign($cpf_employee, $r->user_id),
					$net_salary,
					$balance,
					$mode_of_payment,
					$status
				);
			}
		}
		$output = array(
			"draw" 				=> 	$draw,
			"recordsTotal" 		=> 	$payslip->num_rows(),
			"recordsFiltered" 	=> 	$payslip->num_rows(),
			"data" 				=> 	$data
		);
		echo json_encode($output);
		exit();
	}


	// get payroll template info by id
	public function payroll_template_read()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] = $this->Xin_model->site_title();
		$id = $this->input->get('employee_id');

		$user = $this->Xin_model->read_user_info($id);

		$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($designation)) {
			$designation_name = $designation[0]->designation_name;
		} else {
			$designation_name = '--';
		}
		// department
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$department_name = $department[0]->department_name;
		} else {
			$department_name = '--';
		}
		$data = array(
			'first_name' 		=> 	$user[0]->first_name,
			'last_name' 		=> 	$user[0]->last_name,
			'employee_id' 		=> 	$user[0]->employee_id,
			'user_id' 			=> 	$user[0]->user_id,
			'department_name' 	=> 	$department_name,
			'designation_name' 	=> 	$designation_name,
			'date_of_joining' 	=> 	$user[0]->date_of_joining,
			'profile_picture' 	=> 	$user[0]->profile_picture,
			'gender' 			=> 	$user[0]->gender,
			'wages_type' 		=> 	$user[0]->wages_type,
			'basic_salary' 		=> 	$user[0]->basic_salary,
			'daily_wages' 		=> 	$user[0]->daily_wages,
		);
		if (!empty($session)) {
			$this->load->view('admin/payroll/dialog_templates', $data);
		} else {
			redirect('admin/');
		}
	}


	// pay monthly > create payslip
	public function pay_salary()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] = $this->Xin_model->site_title();
		$id = $this->input->get('employee_id');

		$user = $this->Xin_model->read_user_info($id);
		// get designation
		$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($designation)) {
			$designation_id = $designation[0]->designation_id;
		} else {
			$designation_id = 1;
		}
		// department
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$department_id = $department[0]->department_id;
		} else {
			$department_id = 1;
		}
		$claim_info = $this->Employees_model->read_employee_claim_information($user[0]->user_id);

		$claim_amount = 0;
		if ($claim_info) {
			foreach ($claim_info as $claim) {
				$claim_amount += $claim->amount;
			}
		}

		$final_data = 	$data = array(
			'user_id' 	=> 	$user[0]->user_id,
			'pay_date' 	=> 	$this->input->get('pay_date')
		);

		$data = array(
			'department_id' 	=> 	$department_id,
			'designation_id' 	=> 	$designation_id,
			'company_id' 		=> 	$user[0]->company_id,
			'location_id' 		=> 	$user[0]->location_id,
			'user_id' 			=> 	$user[0]->user_id,
			'dob' 				=> 	$user[0]->date_of_birth,
			'wages_type' 		=> 	$user[0]->wages_type,
			'basic_salary' 		=> 	$user[0]->basic_salary,
			'daily_wages' 		=> 	$user[0]->daily_wages,
			'office_shift_id' 	=> 	$user[0]->office_shift_id,
			'final_calculation' =>	$this->contribution_calculation($final_data),
		);
		if (!empty($session)) {
			$this->load->view('admin/payroll/dialog_make_payment', $data);
		} else {
			redirect('admin/');
		}
	}

	// check other payment
	public function check_payment()
	{
		$pay_date 	= 	$this->input->get('pay_date');
		$user_id	=	$this->input->get('user_id');
		$payslip 	= 	$this->Employees_model->get_single_employees_payslip($pay_date, $user_id);
		$system 	= 	$this->Xin_model->read_setting_info(1);
		$check		=	$this->input->get('check');

		$role_resources_ids = $this->Xin_model->user_role_resource();
		$balance_amount = $this->uncheck_payment($this->input->get());
		$final_contribution_amount = $this->contribution_calculation($this->input->get());
		
		foreach ($payslip->result() as $r) {
			$exit_employee = $this->Employees_model->get_employee_exit($r->user_id);

			if (count($exit_employee) > 0) {
				$e_date = date('Y-m-d', strtotime($exit_employee[0]->exit_date));
				$exit_date = date('m-Y', strtotime($e_date));
				if ($exit_date >= $pay_date) {
					$emp_name = $r->first_name . ' ' . $r->last_name;
					// office shift
					$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);
	
					//overtime request
					$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $pay_date);
					$re_hrs_old_int1 = 0;
					$re_hrs_old_seconds = 0;
					$re_pcount = 0;
					foreach ($overtime_count as $overtime_hr) {
						$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
						$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
						$re_interval_late = $request_clock_in->diff($request_clock_out);
						$re_hours_r  = $re_interval_late->format('%h');
						$re_minutes_r = $re_interval_late->format('%i');
						$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';
	
						$re_str_time = $re_total_time;
	
						$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);
	
						sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$re_hrs_old_int1 += $re_hrs_old_seconds;
	
						$re_pcount = gmdate("H", $re_hrs_old_int1);
					}
	
					$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
					$hrs_old_int1 = 0;
					$pcount = 0;
					foreach ($result->result() as $hour_work) {
						$clock_in =  new DateTime($hour_work->clock_in);
						$clock_out =  new DateTime($hour_work->clock_out);
						$interval_late = $clock_in->diff($clock_out);
						$hours_r  = $interval_late->format('%h');
						$minutes_r = $interval_late->format('%i');
						$total_time = $hours_r . ":" . $minutes_r . ":" . '00';
	
						$str_time = $total_time;
	
						$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);
	
						sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$hrs_old_int1 += $hrs_old_seconds;
	
						$pcount = gmdate("H", $hrs_old_int1);
					}
					$pcount = $pcount + $re_pcount;
	
					// get company
					$company = $this->Xin_model->read_company_info($r->company_id);
					if (!is_null($company)) {
						$comp_name = $company[0]->name;
					} else {
						$comp_name = '--';
					}
	
					/**
					 * Local Variable
					 */
					$g_ordinary_wage = 0;
					$g_additional_wage = 0;
					$g_shg = 0;
					$g_sdl = 0;
	
					// 1: salary type
					if ($r->wages_type == 1) {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					} else if ($r->wages_type == 2) {
						$wages_type = $this->lang->line('xin_employee_daily_wages');
						if ($pcount > 0) {
							$basic_salary = $pcount * $r->basic_salary;
						} else {
							$basic_salary = $pcount;
						}
						$p_class = 'emo_hourly_pay';
						$view_p_class = 'hourlywages_template_modal';
					} else {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					}
	
	
					// check if any payment one 
					$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
					$check_payment = $check && !empty($check[0]->check_id) ? explode(',', $check[0]->check_id) : [];
					
					if (in_array('chk_gross_salary', $check_payment) || !in_array('chk_gross_salary', $this->input->get('check_id'))) {
						$basic_salary = 0;
					}else if($check && $check[0]->is_advance == 1){
						$basic_salary = $basic_salary - $check[0]->advance_amount; 
					}
					
					// employee deduction
					$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
					$pa_month = date('m-Y', strtotime('01-' . $pay_date));
					$deduction_amount = 0;
					if (!in_array('chk_total_employee_deduction', $check_payment) && in_array('chk_total_employee_deduction', $this->input->get('check_id'))) {
						if ($employee_deduction) {
							foreach ($employee_deduction as $deduction) {
								if ($deduction->type_id == 1) {
									$deduction_amount +=  $deduction->amount;
								}
								if ($deduction->type_id == 2) {
									$from_month_year = date('m-Y', strtotime($deduction->from_date));
									$to_month_year = date('d-m-Y', strtotime($deduction->to_date));
	
	
									if ($from_month_year != "" && $to_month_year != "") {
										if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
											$deduction_amount +=  $deduction->amount;
										}
									}
								}
							}
						}
					}
	
	
					//3: Gross rate of pay (unpaid leave deduction)
					$holidays_count = 0;
					$no_of_working_days = 0;
					$month_start_date = new DateTime('01-' . $pay_date);
					$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
					$month_end_date->modify('+1 day');
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($month_start_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$period_day = $p->format('l');
						$period_date = $p->format('Y-m-d');
	
						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
						if ($is_holiday) {
							$holidays_count += 1;
						}
	
						//working days excluding holidays based on office shift
						if ($period_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_working_days += 1;
							}
						}
					}
	
					//unpaid leave
					$unpaid_leave_amount = 0;
					$leaves_taken_count = 0;
					$leave_period = array();
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
						
					// if (!in_array('chk_leave_deductions', $check_payment) && in_array('chk_leave_deductions', $this->input->get('check_id'))) {
						if ($unpaid_leaves) {
							foreach ($unpaid_leaves as $k => $l) {
								$pay_date_month = new DateTime('01-' . $pay_date);
								$l_from_date = new DateTime($l->from_date);
								$l_to_date = new DateTime($l->to_date);
	
								if ($l_from_date->format('m') == $l_to_date->format('m')) {
									$start_date = $l_from_date;
									$end_date = $l_to_date;
								} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
									$start_date = $l_from_date;
									$end_date = new DateTime($start_date->format('Y-m-t'));
								} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
									$start_date = $pay_date_month;
									$end_date = $l_to_date;
								}
								$end_date->modify('+1 day');
								$interval = new DateInterval('P1D');
								$period = new DatePeriod($start_date, $interval, $end_date);
								foreach ($period as $d) {
									$p_day = $d->format('l');
									if ($p_day == 'Monday') {
										if ($office_shift[0]->monday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Tuesday') {
										if ($office_shift[0]->tuesday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Wednesday') {
										if ($office_shift[0]->wednesday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Thursday') {
										if ($office_shift[0]->thursday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Friday') {
										if ($office_shift[0]->friday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Saturday') {
										if ($office_shift[0]->saturday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Sunday') {
										if ($office_shift[0]->sunday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									}
								}
								$leave_period[$k]['is_half'] = $l->is_half_day;
							}
						}
					// }
					
					// if joining date and pay date same then this logic work
					$month_date_join = date('m-Y', strtotime($r->date_of_joining));
					$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
					$month_last_date = date('m-Y', strtotime($lastday));
	
					$first_date =  new DateTime($r->date_of_joining);
					$no_of_days_worked = 0;
					$same_month_holidays_count = 0;
					if ($month_date_join == $pay_date) {
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($first_date, $interval, $month_end_date);
						foreach ($period as $p) {
							$p_day = $p->format('l');
							$m_p_date = $p->format('Y-m-d');
	
							//holidays in a month
							$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
							if ($is_holiday) {
								$same_month_holidays_count += 1;
							}
	
							//working days excluding holidays based on office shift
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$no_of_days_worked += 1;
								}
							}
						}
						// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
						$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
					} else {
						// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
						$no_of_days_worked = $no_of_working_days -  $holidays_count;
					}
	
	
					if ($month_date_join == $pay_date){
						$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
					}else{
						$show_main_salary = $basic_salary;
					}
				
					$g_ordinary_wage += $show_main_salary;
					$g_shg += $show_main_salary;
					$g_sdl += $show_main_salary;
				
					$g_ordinary_wage -= $deduction_amount;
					$g_shg -= $deduction_amount;
					$g_sdl -= $deduction_amount;
	
					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
					$loan_de_amount = 0;
					if (!in_array('chk_loan_de_amount', $check_payment) && in_array('chk_loan_de_amount', $this->input->get('check_id'))) {
						if ($count_loan_deduction > 0) {
							foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
									} else {
										$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
									}
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
								$loan_de_amount += $er_loan;
							}
						} else {
							$loan_de_amount = 0;
						}
						$loan_de_amount = number_format(floatval($loan_de_amount), 2);
					}
	
					// 2: all allowances
					$allowance_amount = 0;
					$gross_allowance_amount = 0;
					if (!in_array('chk_total_allowances', $check_payment) && in_array('chk_total_allowances', $this->input->get('check_id'))) {
						$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
						if ($salary_allowances) {
							foreach ($salary_allowances as $sa) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$eallowance_amount = $sa->allowance_amount / 2;
									} else {
										$eallowance_amount = $sa->allowance_amount;
									}
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
	
	
								if (!empty($sa->salary_month)) {
									$g_additional_wage += $eallowance_amount;
								} else {
									if ($month_date_join == $pay_date){
										$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
									}
									$g_ordinary_wage += $eallowance_amount;
									if ($sa->id == 2) {
										$gross_allowance_amount = $eallowance_amount;
									}
								}
	
								if ($sa->sdl == 1) {
									$g_sdl += $eallowance_amount;
								}
								if ($sa->shg == 1) {
									$g_shg += $eallowance_amount;
								}
	
								$allowance_amount += $eallowance_amount;
							}
						}
						$gross_allowance_amount = $allowance_amount;
					}
					
	
	
	
					// commissions
					$commissions_amount = 0;
					if ( !in_array('chk_total_commissions', $check_payment) && in_array('chk_total_commissions', $this->input->get('check_id'))) {
						$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
						if ($commissions) {
							foreach ($commissions as $c) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$ecommissions_amount = $c->commission_amount / 2;
									} else {
										$ecommissions_amount = $c->commission_amount;
									}
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
	
								if ($c->commission_type == 9) {
									$g_ordinary_wage += $ecommissions_amount;
								} elseif ($c->commission_type == 10) {
									$g_additional_wage += $ecommissions_amount;
								}
	
								if ($c->sdl == 1) {
									$g_sdl += $ecommissions_amount;
								}
								if ($c->shg == 1) {
									$g_shg += $ecommissions_amount;
								}
	
								$commissions_amount += $ecommissions_amount;
							}
						}
					}
	
					//share options
					$share_options_amount = 0;
					if (!in_array('chk_total_share', $check_payment) && in_array('chk_total_share', $this->input->get('check_id'))) {
						$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
						if ($share_options) {
							$eebr_amount = 0;
							$eris_amount = 0;
							foreach ($share_options as $s) {
								$scheme = $s->so_scheme;
								if ($scheme == 1) {
									$price_doe = $s->price_date_of_excercise;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;
									$amount = ($price_doe - $price_ex) * $no_shares;
									$eebr_amount += $amount;
								} else {
									$price_doe = $s->price_date_of_excercise;
									$price_dog = $s->price_date_of_grant;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;
	
									$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
									$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
									$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
								}
							}
							$share_options_amount = round($eebr_amount + $eris_amount, 2);
							$g_additional_wage += $share_options_amount;
							$g_sdl += $share_options_amount;
							$g_shg += $share_options_amount;
						}
					}
	
					// otherpayments
					$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
					$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
					$other_payments_amount = 0;
					if (!in_array('chk_total_other_payments', $check_payment) && in_array('chk_total_other_payments', $this->input->get('check_id'))) {
						if ($count_other_payments > 0) {
							foreach ($other_payments->result() as $sl_other_payments) {
								if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
									if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
	
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
	
										$other_payments_amount += $epayments_amount;
									}
								} else {
									$first_date = new DateTime($sl_other_payments->date);
									if ($first_date->format('m-Y') == $pay_date) {
										$first_date =  new DateTime($sl_other_payments->date);
									} else {
										$first_date = new DateTime('01-' . $pay_date);
									}
	
									$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
	
									if (!empty($sl_other_payments->end_date)) {
										$last_date = new DateTime($sl_other_payments->end_date);
										if ($last_date->format('m-Y') == $pay_date) {
											$last_date = new DateTime($sl_other_payments->end_date);
										}else if($last_date->format('m-Y') >= $pay_date){
											$last_date = $month_end_date_for_other;
										} else {
											$last_date = '';
										}
									} else {
										$last_date = $month_end_date_for_other;
									}
									if(!empty($last_date)){
										$last_date->modify('+1 day');
										$final_last_day = new DateTime($last_date->format('d-m-Y'));
										if ($final_last_day->format('m-Y') >= $pay_date) {
											if ($system[0]->is_half_monthly == 1) {
												if ($system[0]->half_deduct_month == 2) {
													$epayments_amount = $sl_other_payments->payments_amount / 2;
												} else {
													$epayments_amount = $sl_other_payments->payments_amount;
												}
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
	
	
											// it for no of working day
											$no_of_days_worked_for_other_payment = 0;
											$same_month_holidays_count_for_other_payment = 0;
											$interval = new DateInterval('P1D');
											$period = new DatePeriod($first_date, $interval, $last_date);
											foreach ($period as $p) {
												$p_day = $p->format('l');
												$p_date = $p->format('Y-m-d');
	
												//holidays in a month
	
												$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
												if ($is_holiday) {
													$same_month_holidays_count_for_other_payment += 1;
												}
	
												//working days excluding holidays based on office shift
												if ($p_day == 'Monday') {
													if ($office_shift[0]->monday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Tuesday') {
													if ($office_shift[0]->tuesday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Wednesday') {
													if ($office_shift[0]->wednesday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Thursday') {
													if ($office_shift[0]->thursday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Friday') {
													if ($office_shift[0]->friday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Saturday') {
													if ($office_shift[0]->saturday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Sunday') {
													if ($office_shift[0]->sunday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												}
											}
	
											$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
											$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
											
	
	
											if ($sl_other_payments->cpf_applicable == 1) {
												$g_additional_wage += $epayments_amount;
												$g_shg += $epayments_amount;
												$g_sdl += $epayments_amount;
											}
											$other_payments_amount += $epayments_amount;
										}
									}
								}
							}
						} else {
							$other_payments_amount = 0;
						}
					}
					
	
					$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
					// if (!in_array('chk_leave_deductions', $check_payment) && in_array('chk_leave_deductions', $this->input->get('check_id'))) {
						if ($unpaid_leaves) {
							$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
						}
					// }
	
					// $g_ordinary_wage = $gross_pay;
					$g_shg = $gross_pay;
					$g_sdl = $gross_pay;
	
					$g_ordinary_wage -= $unpaid_leave_amount;
	
	
					// other benefit
					$other_benefit_mount = 0;
					if (!in_array('chk_total_employee_deduction', $check_payment) && in_array('chk_total_employee_deduction', $this->input->get('check_id'))) {
						$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
						foreach ($other_benefit_list->result() as $benefit_list) {
							$other_benefit_mount += $benefit_list->other_benefit_cost;
						}
					}
	
	
					// statutory_deductions
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
					$statutory_deductions_amount = 0;
					if ( !in_array('chk_total_statutory_deductions', $check_payment) && in_array('chk_total_statutory_deductions', $this->input->get('check_id'))) {
						if ($count_statutory_deductions > 0) {
							foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
								if ($system[0]->statutory_fixed != 'yes') {
									$sta_salary = $gross_pay;
									$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$single_sd = $st_amount / 2;
										} else {
											$single_sd = $st_amount;
										}
									} else {
										$single_sd = $st_amount;
									}
									$statutory_deductions_amount += $single_sd;
								} else {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
										} else {
											$single_sd = $sl_salary_statutory_deductions->deduction_amount;
										}
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
									$statutory_deductions_amount += $single_sd;
								}
							}
						} else {
							$statutory_deductions_amount = 0;
						}
					}
	
					// overtime
					$overtime_amount = 0;
					if (!in_array('chk_total_overtime', $check_payment) && in_array('chk_total_overtime', $this->input->get('check_id'))) {
						$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
						if ($overtime) {
							$ot_hrs = 0;
							$ot_mins = 0;
							foreach ($overtime as $ot) {
								$total_hours = explode(':', $ot->total_hours);
								$ot_hrs += $total_hours[0];
								$ot_mins += $total_hours[1];
							}
							if ($ot_mins > 0) {
								$ot_hrs += round($ot_mins / 60, 2);
							}
	
							//overtime rate
							$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
							if ($overtime_rate) {
								$rate = $overtime_rate->overtime_pay_rate;
							} else {
								$week_hours = 44;
								$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
								$rate = $rate * 1.5;
							}
	
							if ($ot_hrs > 0) {
								$overtime_amount = round($ot_hrs * $rate, 2);
							}
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$overtime_amount = $overtime_amount / 2;
								}
							}
							$g_ordinary_wage += $overtime_amount;
							$g_sdl += $overtime_amount;
						}
					}
	
					// make payment
					if ($system[0]->is_half_monthly == 1) {
						$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
						$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
						if ($payment_check->num_rows() > 1) {
	
							//foreach($payment_last as $payment_half_last){
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
							//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';
	
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
	
							$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
							//}
							//detail link
							$detail = '';
						} else if ($payment_check->num_rows() > 0) {
	
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
	
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
	
							$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
							$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
							$detail = '';
						} else {
	
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
							$delete = '';
							//detail link
							$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						}
						//detail link
						//$detail = '';
					} else {
						$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
						if ($payment_check->num_rows() > 0) {
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							if ($make_payment[0]->status == 0) {
								$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
							} else if ($make_payment[0]->status == 3) {
								$status = '<span class="label label-warning">' . "Partially" . '</span>';
							}
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
						} else {
	
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
								<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
									<span class="fa fas fa-money"></span>
								</button>
							</span>';
							$delete = '';
						}
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
	
	
					// employee accommodations
					$employee_accommodations = 0;
					if (!in_array('chk_total_employee_deduction', $check_payment) && in_array('chk_total_employee_deduction', $this->input->get('check_id'))){
						$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
						foreach ($get_employee_accommodations as $get_employee_accommodation) {
							$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
							$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
							if ($period_from == $pay_date || $period_to == $pay_date) {
								if (!empty($get_employee_accommodation->rent_paid)) {
									$employee_accommodations += $get_employee_accommodation->rent_paid;
								}
							}
						}
					}
	
					// employee claims
					$claim_amount = 0;
					if (!in_array('chk_employee_claim', $check_payment) && in_array('chk_employee_claim', $this->input->get('check_id'))){
						$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
						foreach ($get_employee_claims->result() as $claims) {
							$date 	= 	date('m-Y', strtotime($claims->date));
							if ($date == $pay_date) {
								$claim_amount += $claims->amount;
							}
						}
					}
	
					$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
					$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
					$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;
	
	
					$database_cpf_employee = 0;
					if($check){
						foreach($check as $c){
							$database_cpf_employee += $c->cpf_employee_amount;
						}
					}
	
	
	
					// cpf calculation
					$emp_dob = $r->date_of_birth;
					$dob = new DateTime($emp_dob);
	
					$today = new DateTime('01-' . $pay_date);
					$age = $dob->diff($today);
					$age_year = $age->y;
					$age_month = $age->m;
	
					$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
					$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
					$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;
	
					if ($age_month > 0) {
						$age_year = $age_year + 1;
					}
	
					$cpf_employee 	= 	0;
					$cpf_employer	=	0;
					$cpf_total		= 	0;
					$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
					if ($im_status) {
						$immigration_id = $im_status->immigration_id;
						if ($immigration_id == 2) {
							$issue_date = $im_status->issue_date;
							$i_date = new DateTime($issue_date);
							$today = new DateTime();
							$pr_age = $i_date->diff($today);
							$pr_age_year = $pr_age->y;
							$pr_age_month = $pr_age->m;
						}
	
						if ($immigration_id == 1 || $immigration_id == 2) {
	
							$ordinary_wage = $g_ordinary_wage;
							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}
	
							//additional wage
							$additional_wage = $g_additional_wage;
							$aw = $g_additional_wage;
							$tw = $ow + $additional_wage;
							if ($im_status->issue_date != "") {
								if ($pr_age_year == 1) {
	
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 2) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.45 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
											$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
											if ($count_total_cpf > 1776) {
												$total_cpf = 1776;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1110) {
												$cpf_employee = 1110;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(6 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.375 * ($tw - 500));
											$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
											$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
											if ($count_total_cpf > 1369) {
												$total_cpf = 1369;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 925) {
												$cpf_employee = 925;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
											if ($count_total_cpf > 814) {
												$total_cpf = 814;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 3 || $pr_age_year > 3) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(17 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.6 * ($tw - 500));
											$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
											$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
											if ($count_total_cpf > 2738) {
												$total_cpf = 2738;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1480) {
												$cpf_employee = 1480;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = $total_cpf - $cpf_employee;
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(15.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.51 * ($tw - 500));
											$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
											$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
											if ($count_total_cpf > 2405) {
												$total_cpf = 2405;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1258) {
												$cpf_employee = 1258;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(12 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.345 * ($tw - 500));
											$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
											$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
											if ($count_total_cpf > 1739) {
												$total_cpf = 1739;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 851) {
												$cpf_employee = 851;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65 && $age_year <= 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
											if ($count_total_cpf > 1221) {
												$total_cpf = 1221;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(7.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
											if ($count_total_cpf > 925) {
												$total_cpf = 925;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
							}
	
	
	
							if ($immigration_id == 1) {
	
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$count_total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
	
	
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
	
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$count_total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
	
							
	
							$total_net_salary = $total_net_salary - $cpf_employee;
							$cpf_total = $cpf_employee + $cpf_employer;
	
							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
						}
					}
	
	
					// $shg_fund_deduction_amount = 0;
					// //Other Fund Contributions
					// $employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
					// if ($employee_contributions && $g_shg > 0) {
					// 	$gross_s = $g_shg;
					// 	$contribution_id = $employee_contributions->contribution_id;
					// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					// 	$shg_fund_name = $contribution_type[0]->contribution;
					// 	$shg_fund_deduction_amount += $contribution_amount;
					// 	$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
					// }
					// $ashg_fund_deduction_amount = 0;
	
					// $employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
					// if ($employee_ashg_contributions  && $g_shg > 0) {
					// 	$gross_s = $g_shg;
					// 	$contribution_id = $employee_ashg_contributions->contribution_id;
					// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					// 	$ashg_fund_name = $contribution_type[0]->contribution;
	
					// 	$ashg_fund_deduction_amount += $contribution_amount;
					// 	$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
					// }
	
					// echo $total_net_salary;
	
					// $sdl_total_amount = 0;
					// if ($g_sdl > 1 && $g_sdl <= 800) {
					// 	$sdl_total_amount = 2;
					// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					// 	$sdl_amount = (0.25 * $g_sdl) / 100;
					// 	$sdl_total_amount = $sdl_amount;
					// } elseif ($g_sdl > 4500) {
					// 	$sdl_total_amount = 11.25;
					// }
	
	
					$net_salary = number_format((float)$total_net_salary, 2, '.', '');
					$basic_salary = number_format((float)$basic_salary, 2, '.', '');
					if ($basic_salary == 0 || $basic_salary == '') {
						$fmpay = '';
					} else {
						$fmpay = $mpay;
					}
	
	
					$company_info = $this->Company_model->read_company_information($r->company_id);
					if (!is_null($company_info)) {
						$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
						$net_salary = $net_salary;
						//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
					} else {
						//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
						$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);
	
						$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);
	
						//$net_salary = $this->Xin_model->currency_sign($net_salary);	
						//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
						$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
					}
	
					$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';
	
					//action link
					$act = $detail . $fmpay . $delete;
					// $act = $fmpay . $delete;
	
					if ($r->wages_type == 1) {
						if ($system[0]->is_half_monthly == 1) {
							$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
						} else {
							$emp_payroll_wage = $wages_type;
						}
					} else {
						$emp_payroll_wage = $wages_type;
					}
	
					$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					$p = $payslips->result();
					$balance = $this->Xin_model->currency_sign($p[0]->balance_amount ?? 0, $r->user_id);
					$mode_of_payment = $r->payment_mode ?? '';
	
	
					 
					if($balance_amount > 0)
						 $calculate_balance_amount = $balance_amount - ($final_contribution_amount['cpf_employee'] - ($cpf_employee + $database_cpf_employee));
					else
						$calculate_balance_amount = 0;
	
					// $cpf =  $final_contribution_amount['cpf_employee'] - ($final_contribution_amount['cpf_employee'] - $cpf_employee);
	
					if($check && $check[0]->is_advance != 1){
						$net_salary = round($net_salary,2);
					}else{
						$net_salary = round($net_salary - $final_contribution_amount['contribution'],2);
					}
	
					$data = array(
						'total_cpf_employee'	=> 	$cpf_employee,
						// 'total_cpf_employee'	=> 	$cpf,
						'total_cpf_employer'	=>	$cpf_employer,
						'cpf_total'				=> 	$cpf_total,
						'net_salary'			=>	$net_salary,
						'contribution'			=>	$final_contribution_amount['contribution'],
						'total_deduction'		=>	$total_deduction,
						'balance'				=>	round($calculate_balance_amount,2),
						'unpaid_leave_amount'	=>	$unpaid_leave_amount,
						$final_contribution_amount['cpf_employee']
					);
				}
			} else {
				$emp_name = $r->first_name . ' ' . $r->last_name;
				// office shift
				$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $pay_date);
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}

				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
				$hrs_old_int1 = 0;
				$pcount = 0;
				foreach ($result->result() as $hour_work) {
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}
				$pcount = $pcount + $re_pcount;

				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}


				// check if any payment one 
				$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
				$check_payment = $check && !empty($check[0]->check_id) ? explode(',', $check[0]->check_id) : [];
				
				if (in_array('chk_gross_salary', $check_payment) || !in_array('chk_gross_salary', $this->input->get('check_id'))) {
					$basic_salary = 0;
				}else if($check && $check[0]->is_advance == 1){
					$basic_salary = $basic_salary - $check[0]->advance_amount; 
				}
				
				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
				$pa_month = date('m-Y', strtotime('01-' . $pay_date));
				$deduction_amount = 0;
				if (!in_array('chk_total_employee_deduction', $check_payment) && in_array('chk_total_employee_deduction', $this->input->get('check_id'))) {
					if ($employee_deduction) {
						foreach ($employee_deduction as $deduction) {
							if ($deduction->type_id == 1) {
								$deduction_amount +=  $deduction->amount;
							}
							if ($deduction->type_id == 2) {
								$from_month_year = date('m-Y', strtotime($deduction->from_date));
								$to_month_year = date('d-m-Y', strtotime($deduction->to_date));


								if ($from_month_year != "" && $to_month_year != "") {
									if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
										$deduction_amount +=  $deduction->amount;
									}
								}
							}
						}
					}
				}


				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $pay_date);
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
					
				// if (!in_array('chk_leave_deductions', $check_payment) && in_array('chk_leave_deductions', $this->input->get('check_id'))) {
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							$pay_date_month = new DateTime('01-' . $pay_date);
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);

							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {
									if ($office_shift[0]->monday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
						}
					}
				// }
				
				// if joining date and pay date same then this logic work
				$month_date_join = date('m-Y', strtotime($r->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($r->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $pay_date) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$m_p_date = $p->format('Y-m-d');

						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}
					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}


				if ($month_date_join == $pay_date){
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				}else{
					$show_main_salary = $basic_salary;
				}
			
				$g_ordinary_wage += $show_main_salary;
				$g_shg += $show_main_salary;
				$g_sdl += $show_main_salary;
			
				$g_ordinary_wage -= $deduction_amount;
				$g_shg -= $deduction_amount;
				$g_sdl -= $deduction_amount;

				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				if (!in_array('chk_loan_de_amount', $check_payment) && in_array('chk_loan_de_amount', $this->input->get('check_id'))) {
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
							$loan_de_amount += $er_loan;
						}
					} else {
						$loan_de_amount = 0;
					}
					$loan_de_amount = number_format(floatval($loan_de_amount), 2);
				}

				// 2: all allowances
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if (!in_array('chk_total_allowances', $check_payment) && in_array('chk_total_allowances', $this->input->get('check_id'))) {
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}


							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								if ($month_date_join == $pay_date){
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}

							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}

							$allowance_amount += $eallowance_amount;
						}
					}
					$gross_allowance_amount = $allowance_amount;
				}
				



				// commissions
				$commissions_amount = 0;
				if ( !in_array('chk_total_commissions', $check_payment) && in_array('chk_total_commissions', $this->input->get('check_id'))) {
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $c->commission_amount / 2;
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
							} else {
								$ecommissions_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommissions_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommissions_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommissions_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommissions_amount;
							}

							$commissions_amount += $ecommissions_amount;
						}
					}
				}

				//share options
				$share_options_amount = 0;
				if (!in_array('chk_total_share', $check_payment) && in_array('chk_total_share', $this->input->get('check_id'))) {
					$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;
					}
				}

				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				if (!in_array('chk_total_other_payments', $check_payment) && in_array('chk_total_other_payments', $this->input->get('check_id'))) {
					if ($count_other_payments > 0) {
						foreach ($other_payments->result() as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}

									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}

									$other_payments_amount += $epayments_amount;
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $pay_date) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $pay_date);
								}

								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));

								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $pay_date) {
										$last_date = new DateTime($sl_other_payments->end_date);
									}else if($last_date->format('m-Y') >= $pay_date){
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
								if(!empty($last_date)){
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $pay_date) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}


										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');

											//holidays in a month

											$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}

											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}

										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
										


										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
									}
								}
							}
						}
					} else {
						$other_payments_amount = 0;
					}
				}
				

				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
				// if (!in_array('chk_leave_deductions', $check_payment) && in_array('chk_leave_deductions', $this->input->get('check_id'))) {
					if ($unpaid_leaves) {
						$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
					}
				// }

				// $g_ordinary_wage = $gross_pay;
				$g_shg = $gross_pay;
				$g_sdl = $gross_pay;

				$g_ordinary_wage -= $unpaid_leave_amount;


				// other benefit
				$other_benefit_mount = 0;
				if (!in_array('chk_total_employee_deduction', $check_payment) && in_array('chk_total_employee_deduction', $this->input->get('check_id'))) {
					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
					foreach ($other_benefit_list->result() as $benefit_list) {
						$other_benefit_mount += $benefit_list->other_benefit_cost;
					}
				}


				// statutory_deductions
				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if ( !in_array('chk_total_statutory_deductions', $check_payment) && in_array('chk_total_statutory_deductions', $this->input->get('check_id'))) {
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') {
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							} else {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							}
						}
					} else {
						$statutory_deductions_amount = 0;
					}
				}

				// overtime
				$overtime_amount = 0;
				if (!in_array('chk_total_overtime', $check_payment) && in_array('chk_total_overtime', $this->input->get('check_id'))) {
					$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
					if ($overtime) {
						$ot_hrs = 0;
						$ot_mins = 0;
						foreach ($overtime as $ot) {
							$total_hours = explode(':', $ot->total_hours);
							$ot_hrs += $total_hours[0];
							$ot_mins += $total_hours[1];
						}
						if ($ot_mins > 0) {
							$ot_hrs += round($ot_mins / 60, 2);
						}

						//overtime rate
						$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
						if ($overtime_rate) {
							$rate = $overtime_rate->overtime_pay_rate;
						} else {
							$week_hours = 44;
							$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
							$rate = $rate * 1.5;
						}

						if ($ot_hrs > 0) {
							$overtime_amount = round($ot_hrs * $rate, 2);
						}
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$overtime_amount = $overtime_amount / 2;
							}
						}
						$g_ordinary_wage += $overtime_amount;
						$g_sdl += $overtime_amount;
					}
				}

				// make payment
				if ($system[0]->is_half_monthly == 1) {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
					$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
					if ($payment_check->num_rows() > 1) {

						//foreach($payment_last as $payment_half_last){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}

						$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
						//}
						//detail link
						$detail = '';
					} else if ($payment_check->num_rows() > 0) {

						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';

						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$detail = '';
					} else {

						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
					//detail link
					//$detail = '';
				} else {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					if ($payment_check->num_rows() > 0) {
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						if ($make_payment[0]->status == 0) {
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						} else if ($make_payment[0]->status == 3) {
							$status = '<span class="label label-warning">' . "Partially" . '</span>';
						}
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
					} else {

						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
							<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
								<span class="fa fas fa-money"></span>
							</button>
						</span>';
						$delete = '';
					}
					//detail link
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
				}


				// employee accommodations
				$employee_accommodations = 0;
				if (!in_array('chk_total_employee_deduction', $check_payment) && in_array('chk_total_employee_deduction', $this->input->get('check_id'))){
					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $pay_date || $period_to == $pay_date) {
							if (!empty($get_employee_accommodation->rent_paid)) {
								$employee_accommodations += $get_employee_accommodation->rent_paid;
							}
						}
					}
				}

				// employee claims
				$claim_amount = 0;
				if (!in_array('chk_employee_claim', $check_payment) && in_array('chk_employee_claim', $this->input->get('check_id'))){
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $pay_date) {
							$claim_amount += $claims->amount;
						}
					}
				}

				$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
				$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;


				$database_cpf_employee = 0;
				if($check){
					foreach($check as $c){
						$database_cpf_employee += $c->cpf_employee_amount;
					}
				}



				// cpf calculation
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);

				$today = new DateTime('01-' . $pay_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}

				$cpf_employee 	= 	0;
				$cpf_employer	=	0;
				$cpf_total		= 	0;
				$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
				if ($im_status) {
					$immigration_id = $im_status->immigration_id;
					if ($immigration_id == 2) {
						$issue_date = $im_status->issue_date;
						$i_date = new DateTime($issue_date);
						$today = new DateTime();
						$pr_age = $i_date->diff($today);
						$pr_age_year = $pr_age->y;
						$pr_age_month = $pr_age->m;
					}

					if ($immigration_id == 1 || $immigration_id == 2) {

						$ordinary_wage = $g_ordinary_wage;
						if ($ordinary_wage > $ordinary_wage_cap) {
							$ow = $ordinary_wage_cap;
						} else {
							$ow = $ordinary_wage;
						}

						//additional wage
						$additional_wage = $g_additional_wage;
						$aw = $g_additional_wage;
						$tw = $ow + $additional_wage;
						if ($im_status->issue_date != "") {
							if ($pr_age_year == 1) {

								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 2) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.45 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
										$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
										if ($count_total_cpf > 1776) {
											$total_cpf = 1776;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1110) {
											$cpf_employee = 1110;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(6 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.375 * ($tw - 500));
										$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
										$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
										if ($count_total_cpf > 1369) {
											$total_cpf = 1369;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 925) {
											$cpf_employee = 925;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
										if ($count_total_cpf > 814) {
											$total_cpf = 814;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 3 || $pr_age_year > 3) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = $total_cpf - $cpf_employee;
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
						}



						if ($immigration_id == 1) {

							if ($age_year <= 55) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(17 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.6 * ($tw - 500));
									$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
									$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
									if ($count_total_cpf > 2738) {
										$count_total_cpf = 2738;
									} else {
										$total_cpf = $count_total_cpf;
									}


									if ($count_cpf_employee > 1480) {
										$cpf_employee = 1480;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 55 && $age_year <= 60) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(15.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.51 * ($tw - 500));
									$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;

									$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
									if ($count_total_cpf > 2405) {
										$count_total_cpf = 2405;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 1258) {
										$cpf_employee = 1258;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 60 && $age_year <= 65) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(12 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.345 * ($tw - 500));
									$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
									$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

									if ($count_total_cpf > 1739) {
										$total_cpf = 1739;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 851) {
										$cpf_employee = 851;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 65 && $age_year <= 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(9 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.225 * ($tw - 500));
									$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
									$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

									if ($count_total_cpf > 1221) {
										$total_cpf = 1221;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 555) {
										$cpf_employee = 555;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(7.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.15 * ($tw - 500));
									$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
									$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

									if ($count_total_cpf > 925) {
										$total_cpf = 925;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 370) {
										$cpf_employee = 370;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							}
						}

						

						$total_net_salary = $total_net_salary - $cpf_employee;
						$cpf_total = $cpf_employee + $cpf_employer;

						$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
						$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
						$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
					}
				}


				// $shg_fund_deduction_amount = 0;
				// //Other Fund Contributions
				// $employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
				// if ($employee_contributions && $g_shg > 0) {
				// 	$gross_s = $g_shg;
				// 	$contribution_id = $employee_contributions->contribution_id;
				// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
				// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
				// 	$shg_fund_name = $contribution_type[0]->contribution;
				// 	$shg_fund_deduction_amount += $contribution_amount;
				// 	$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
				// }
				// $ashg_fund_deduction_amount = 0;

				// $employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				// if ($employee_ashg_contributions  && $g_shg > 0) {
				// 	$gross_s = $g_shg;
				// 	$contribution_id = $employee_ashg_contributions->contribution_id;
				// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
				// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
				// 	$ashg_fund_name = $contribution_type[0]->contribution;

				// 	$ashg_fund_deduction_amount += $contribution_amount;
				// 	$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
				// }

				// echo $total_net_salary;

				// $sdl_total_amount = 0;
				// if ($g_sdl > 1 && $g_sdl <= 800) {
				// 	$sdl_total_amount = 2;
				// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
				// 	$sdl_amount = (0.25 * $g_sdl) / 100;
				// 	$sdl_total_amount = $sdl_amount;
				// } elseif ($g_sdl > 4500) {
				// 	$sdl_total_amount = 11.25;
				// }


				$net_salary = number_format((float)$total_net_salary, 2, '.', '');
				$basic_salary = number_format((float)$basic_salary, 2, '.', '');
				if ($basic_salary == 0 || $basic_salary == '') {
					$fmpay = '';
				} else {
					$fmpay = $mpay;
				}


				$company_info = $this->Company_model->read_company_information($r->company_id);
				if (!is_null($company_info)) {
					$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
					$net_salary = $net_salary;
					//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
				} else {
					//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
					$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);

					$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);

					//$net_salary = $this->Xin_model->currency_sign($net_salary);	
					//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
					$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
				}

				$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';

				//action link
				$act = $detail . $fmpay . $delete;
				// $act = $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}

				$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
				$p = $payslips->result();
				$balance = $this->Xin_model->currency_sign($p[0]->balance_amount ?? 0, $r->user_id);
				$mode_of_payment = $r->payment_mode ?? '';


				 
				if($balance_amount > 0)
				 	$calculate_balance_amount = $balance_amount - ($final_contribution_amount['cpf_employee'] - ($cpf_employee + $database_cpf_employee));
				else
					$calculate_balance_amount = 0;

				// $cpf =  $final_contribution_amount['cpf_employee'] - ($final_contribution_amount['cpf_employee'] - $cpf_employee);

				if($check && $check[0]->is_advance != 1){
					$net_salary = round($net_salary,2);
				}else{
					$net_salary = round($net_salary - $final_contribution_amount['contribution'],2);
				}

				$data = array(
					'total_cpf_employee'	=> 	$cpf_employee,
					// 'total_cpf_employee'	=> 	$cpf,
					'total_cpf_employer'	=>	$cpf_employer,
					'cpf_total'				=> 	$cpf_total,
					'net_salary'			=>	$net_salary,
					'contribution'			=>	$final_contribution_amount['contribution'],
					'total_deduction'		=>	$total_deduction,
					'balance'				=>	round($calculate_balance_amount,2),
					'unpaid_leave_amount'	=>	$unpaid_leave_amount,
					$final_contribution_amount['cpf_employee']
				);
			}
		}

		echo json_encode($data);
		exit;
	}

	// for uncheck
	public function uncheck_payment($data)
	{
		$pay_date 	= 	$data['pay_date'];
		$user_id	=	$data['user_id'];
		$payslip 	= 	$this->Employees_model->get_single_employees_payslip($pay_date, $user_id);
		$system 	= 	$this->Xin_model->read_setting_info(1);
		$uncheck_id		=	$data['uncheck_id'] ?? [];

		$role_resources_ids = $this->Xin_model->user_role_resource();
		foreach ($payslip->result() as $r) {
			$exit_employee = $this->Employees_model->get_employee_exit($r->user_id);

			if (count($exit_employee) > 0) {
				$e_date = date('Y-m-d', strtotime($exit_employee[0]->exit_date));
				$exit_date = date('m-Y', strtotime($e_date));
				if ($exit_date >= $pay_date) {
					$emp_name = $r->first_name . ' ' . $r->last_name;
					// office shift
					$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);
	
					//overtime request
					$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $pay_date);
					$re_hrs_old_int1 = 0;
					$re_hrs_old_seconds = 0;
					$re_pcount = 0;
					foreach ($overtime_count as $overtime_hr) {
						$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
						$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
						$re_interval_late = $request_clock_in->diff($request_clock_out);
						$re_hours_r  = $re_interval_late->format('%h');
						$re_minutes_r = $re_interval_late->format('%i');
						$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';
	
						$re_str_time = $re_total_time;
	
						$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);
	
						sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$re_hrs_old_int1 += $re_hrs_old_seconds;
	
						$re_pcount = gmdate("H", $re_hrs_old_int1);
					}
	
					$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
					$hrs_old_int1 = 0;
					$pcount = 0;
					foreach ($result->result() as $hour_work) {
						$clock_in =  new DateTime($hour_work->clock_in);
						$clock_out =  new DateTime($hour_work->clock_out);
						$interval_late = $clock_in->diff($clock_out);
						$hours_r  = $interval_late->format('%h');
						$minutes_r = $interval_late->format('%i');
						$total_time = $hours_r . ":" . $minutes_r . ":" . '00';
	
						$str_time = $total_time;
	
						$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);
	
						sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$hrs_old_int1 += $hrs_old_seconds;
	
						$pcount = gmdate("H", $hrs_old_int1);
					}
					$pcount = $pcount + $re_pcount;
	
					// get company
					$company = $this->Xin_model->read_company_info($r->company_id);
					if (!is_null($company)) {
						$comp_name = $company[0]->name;
					} else {
						$comp_name = '--';
					}
	
					/**
					 * Local Variable
					 */
					$g_ordinary_wage = 0;
					$g_additional_wage = 0;
					$g_shg = 0;
					$g_sdl = 0;
	
					// 1: salary type
					if ($r->wages_type == 1) {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					} else if ($r->wages_type == 2) {
						$wages_type = $this->lang->line('xin_employee_daily_wages');
						if ($pcount > 0) {
							$basic_salary = $pcount * $r->basic_salary;
						} else {
							$basic_salary = $pcount;
						}
						$p_class = 'emo_hourly_pay';
						$view_p_class = 'hourlywages_template_modal';
					} else {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					}
	
					if (!in_array('chk_gross_salary', $uncheck_id)) {
						$basic_salary = 0;
					}
					
					// employee deduction
					$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
					$pa_month = date('m-Y', strtotime('01-' . $pay_date));
					$deduction_amount = 0;
					if (in_array('chk_total_employee_deduction', $uncheck_id)) {
						if ($employee_deduction) {
							foreach ($employee_deduction as $deduction) {
								if ($deduction->type_id == 1) {
									$deduction_amount +=  $deduction->amount;
								}
								if ($deduction->type_id == 2) {
									$from_month_year = date('m-Y', strtotime($deduction->from_date));
									$to_month_year = date('d-m-Y', strtotime($deduction->to_date));
	
	
									if ($from_month_year != "" && $to_month_year != "") {
										if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
											$deduction_amount +=  $deduction->amount;
										}
									}
								}
							}
						}
					}
	
	
	
	
					//3: Gross rate of pay (unpaid leave deduction)
					$holidays_count = 0;
					$no_of_working_days = 0;
					$month_start_date = new DateTime('01-' . $pay_date);
					$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
					$month_end_date->modify('+1 day');
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($month_start_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$period_day = $p->format('l');
						$period_date = $p->format('Y-m-d');
	
						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
						if ($is_holiday) {
							$holidays_count += 1;
						}
	
						//working days excluding holidays based on office shift
						if ($period_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_working_days += 1;
							}
						}
					}
	
					//unpaid leave
					$unpaid_leave_amount = 0;
					$leaves_taken_count = 0;
					$leave_period = array();
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
					// if (in_array('chk_leave_deductions', $uncheck_id)) {
						if ($unpaid_leaves) {
							foreach ($unpaid_leaves as $k => $l) {
								$pay_date_month = new DateTime('01-' . $pay_date);
								$l_from_date = new DateTime($l->from_date);
								$l_to_date = new DateTime($l->to_date);
	
								if ($l_from_date->format('m') == $l_to_date->format('m')) {
									$start_date = $l_from_date;
									$end_date = $l_to_date;
								} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
									$start_date = $l_from_date;
									$end_date = new DateTime($start_date->format('Y-m-t'));
								} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
									$start_date = $pay_date_month;
									$end_date = $l_to_date;
								}
								$end_date->modify('+1 day');
								$interval = new DateInterval('P1D');
								$period = new DatePeriod($start_date, $interval, $end_date);
								foreach ($period as $d) {
									$p_day = $d->format('l');
									if ($p_day == 'Monday') {
										if ($office_shift[0]->monday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Tuesday') {
										if ($office_shift[0]->tuesday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Wednesday') {
										if ($office_shift[0]->wednesday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Thursday') {
										if ($office_shift[0]->thursday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Friday') {
										if ($office_shift[0]->friday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Saturday') {
										if ($office_shift[0]->saturday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Sunday') {
										if ($office_shift[0]->sunday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									}
								}
								$leave_period[$k]['is_half'] = $l->is_half_day;
							}
						}
					// }
						
	
					// if joining date and pay date same then this logic work
					$month_date_join = date('m-Y', strtotime($r->date_of_joining));
					$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
					$month_last_date = date('m-Y', strtotime($lastday));
	
					$first_date =  new DateTime($r->date_of_joining);
					$no_of_days_worked = 0;
					$same_month_holidays_count = 0;
					if ($month_date_join == $pay_date) {
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($first_date, $interval, $month_end_date);
						foreach ($period as $p) {
							$p_day = $p->format('l');
							$m_p_date = $p->format('Y-m-d');
	
							//holidays in a month
							$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
							if ($is_holiday) {
								$same_month_holidays_count += 1;
							}
	
							//working days excluding holidays based on office shift
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$no_of_days_worked += 1;
								}
							}
						}
	
						// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
						$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
					} else {
						// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
						$no_of_days_worked = $no_of_working_days -  $holidays_count;
					}
					// echo $holidays_count;
	
					if ($month_date_join == $pay_date){
						$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
					}else{
						$show_main_salary = $basic_salary;
					}
				
					$g_ordinary_wage += $show_main_salary;
					$g_shg += $show_main_salary;
					$g_sdl += $show_main_salary;
				
					$g_ordinary_wage -= $deduction_amount;
					$g_shg -= $deduction_amount;
					$g_sdl -= $deduction_amount;
	
	
					
					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
					$loan_de_amount = 0;
					if (in_array('chk_loan_de_amount', $uncheck_id)) {
						if ($count_loan_deduction > 0) {
							foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
									} else {
										$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
									}
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
								$loan_de_amount += $er_loan;
							}
						} else {
							$loan_de_amount = 0;
						}
						$loan_de_amount = number_format(floatval($loan_de_amount), 2);
					}
	
					// 2: all allowances
					$allowance_amount = 0;
					$gross_allowance_amount = 0;
					if (in_array('chk_total_allowances', $uncheck_id)) {
						$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
						if ($salary_allowances) {
							foreach ($salary_allowances as $sa) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$eallowance_amount = $sa->allowance_amount / 2;
									} else {
										$eallowance_amount = $sa->allowance_amount;
									}
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
	
	
								if (!empty($sa->salary_month)) {
									$g_additional_wage += $eallowance_amount;
								} else {
									if ($month_date_join == $pay_date){
										$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
									}
									$g_ordinary_wage += $eallowance_amount;
									if ($sa->id == 2) {
										$gross_allowance_amount = $eallowance_amount;
									}
								}
	
								if ($sa->sdl == 1) {
									$g_sdl += $eallowance_amount;
								}
								if ($sa->shg == 1) {
									$g_shg += $eallowance_amount;
								}
	
								$allowance_amount += $eallowance_amount;
							}
						}
						$gross_allowance_amount = $allowance_amount;
					}
	
	
					// commissions
					$commissions_amount = 0;
					if (in_array('chk_total_commissions', $uncheck_id)) {
						$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
						if ($commissions) {
							foreach ($commissions as $c) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$ecommissions_amount = $c->commission_amount / 2;
									} else {
										$ecommissions_amount = $c->commission_amount;
									}
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
	
								if ($c->commission_type == 9) {
									$g_ordinary_wage += $ecommissions_amount;
								} elseif ($c->commission_type == 10) {
									$g_additional_wage += $ecommissions_amount;
								}
	
								if ($c->sdl == 1) {
									$g_sdl += $ecommissions_amount;
								}
								if ($c->shg == 1) {
									$g_shg += $ecommissions_amount;
								}
	
								$commissions_amount += $ecommissions_amount;
							}
						}
					}
	
					//share options
					$share_options_amount = 0;
					if (in_array('chk_total_share', $uncheck_id)) {
						$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
						if ($share_options) {
							$eebr_amount = 0;
							$eris_amount = 0;
							foreach ($share_options as $s) {
								$scheme = $s->so_scheme;
								if ($scheme == 1) {
									$price_doe = $s->price_date_of_excercise;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;
									$amount = ($price_doe - $price_ex) * $no_shares;
									$eebr_amount += $amount;
								} else {
									$price_doe = $s->price_date_of_excercise;
									$price_dog = $s->price_date_of_grant;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;
	
									$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
									$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
									$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
								}
							}
							$share_options_amount = round($eebr_amount + $eris_amount, 2);
							$g_additional_wage += $share_options_amount;
							$g_sdl += $share_options_amount;
							$g_shg += $share_options_amount;
						}
					}
	
	
					// otherpayments
					$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
					$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
					$other_payments_amount = 0;
					if (in_array('chk_total_other_payments', $uncheck_id)) {
						if ($count_other_payments > 0) {
							foreach ($other_payments->result() as $sl_other_payments) {
								if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
									if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
	
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
	
										$other_payments_amount += $epayments_amount;
									}
								} else {
									$first_date = new DateTime($sl_other_payments->date);
									if ($first_date->format('m-Y') == $pay_date) {
										$first_date =  new DateTime($sl_other_payments->date);
									} else {
										$first_date = new DateTime('01-' . $pay_date);
									}
	
									$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
	
									if (!empty($sl_other_payments->end_date)) {
										$last_date = new DateTime($sl_other_payments->end_date);
										if ($last_date->format('m-Y') == $pay_date) {
											$last_date = new DateTime($sl_other_payments->end_date);
										}else if($last_date->format('m-Y') >= $pay_date){
												$last_date = $month_end_date_for_other;
										} else {
											$last_date = '';
										}
									} else {
										$last_date = $month_end_date_for_other;
									}
									if(!empty($last_date)){
										$last_date->modify('+1 day');
										$final_last_day = new DateTime($last_date->format('d-m-Y'));
										if ($final_last_day->format('m-Y') >= $pay_date) {
											if ($system[0]->is_half_monthly == 1) {
												if ($system[0]->half_deduct_month == 2) {
													$epayments_amount = $sl_other_payments->payments_amount / 2;
												} else {
													$epayments_amount = $sl_other_payments->payments_amount;
												}
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
	
	
											// it for no of working day
											$no_of_days_worked_for_other_payment = 0;
											$same_month_holidays_count_for_other_payment = 0;
											$interval = new DateInterval('P1D');
											$period = new DatePeriod($first_date, $interval, $last_date);
											foreach ($period as $p) {
												$p_day = $p->format('l');
												$p_date = $p->format('Y-m-d');
	
												//holidays in a month
	
												$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
												if ($is_holiday) {
													$same_month_holidays_count_for_other_payment += 1;
												}
	
												//working days excluding holidays based on office shift
												if ($p_day == 'Monday') {
													if ($office_shift[0]->monday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Tuesday') {
													if ($office_shift[0]->tuesday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Wednesday') {
													if ($office_shift[0]->wednesday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Thursday') {
													if ($office_shift[0]->thursday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Friday') {
													if ($office_shift[0]->friday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Saturday') {
													if ($office_shift[0]->saturday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Sunday') {
													if ($office_shift[0]->sunday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												}
											}
	
											$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
											$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
											
	
	
											if ($sl_other_payments->cpf_applicable == 1) {
												$g_additional_wage += $epayments_amount;
												$g_shg += $epayments_amount;
												$g_sdl += $epayments_amount;
											}
											$other_payments_amount += $epayments_amount;
										}
									}
								}
							}
						} else {
							$other_payments_amount = 0;
						}
					}
	
					
					$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
					// if (in_array('chk_leave_deductions', $uncheck_id)) {
						if ($unpaid_leaves) {
							$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
					   }
					// }
	
					
				
					// $g_ordinary_wage = $gross_pay;
					$g_shg = $gross_pay;
					$g_sdl = $gross_pay;
	
					$g_ordinary_wage -= $unpaid_leave_amount;
	
					
				
					
					// other benefit
					$other_benefit_mount = 0;
					if (in_array('chk_total_employee_deduction', $uncheck_id)) {
						$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
						foreach ($other_benefit_list->result() as $benefit_list) {
							$other_benefit_mount += $benefit_list->other_benefit_cost;
						}
					}
	
	
					// statutory_deductions
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
					$statutory_deductions_amount = 0;
					if (in_array('chk_total_statutory_deductions', $uncheck_id)) {
						if ($count_statutory_deductions > 0) {
							foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
								if ($system[0]->statutory_fixed != 'yes') {
									$sta_salary = $gross_pay;
									$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$single_sd = $st_amount / 2;
										} else {
											$single_sd = $st_amount;
										}
									} else {
										$single_sd = $st_amount;
									}
									$statutory_deductions_amount += $single_sd;
								} else {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
										} else {
											$single_sd = $sl_salary_statutory_deductions->deduction_amount;
										}
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
									$statutory_deductions_amount += $single_sd;
								}
							}
						} else {
							$statutory_deductions_amount = 0;
						}
					}
	
					// overtime
					$overtime_amount = 0;
					if (in_array('chk_total_overtime', $uncheck_id)) {
						$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
						if ($overtime) {
							$ot_hrs = 0;
							$ot_mins = 0;
							foreach ($overtime as $ot) {
								$total_hours = explode(':', $ot->total_hours);
								$ot_hrs += $total_hours[0];
								$ot_mins += $total_hours[1];
							}
							if ($ot_mins > 0) {
								$ot_hrs += round($ot_mins / 60, 2);
							}
	
							//overtime rate
							$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
							if ($overtime_rate) {
								$rate = $overtime_rate->overtime_pay_rate;
							} else {
								$week_hours = 44;
								$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
								$rate = $rate * 1.5;
							}
	
							if ($ot_hrs > 0) {
								$overtime_amount = round($ot_hrs * $rate, 2);
							}
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$overtime_amount = $overtime_amount / 2;
								}
							}
							$g_ordinary_wage += $overtime_amount;
							$g_sdl += $overtime_amount;
						}
					}
	
					// make payment
					if ($system[0]->is_half_monthly == 1) {
						$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
						$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
						if ($payment_check->num_rows() > 1) {
	
							//foreach($payment_last as $payment_half_last){
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
							//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';
	
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
	
							$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
							//}
							//detail link
							$detail = '';
						} else if ($payment_check->num_rows() > 0) {
	
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
	
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
	
							$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
							$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
							$detail = '';
						} else {
	
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
							$delete = '';
							//detail link
							$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						}
						//detail link
						//$detail = '';
					} else {
						$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
						if ($payment_check->num_rows() > 0) {
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							if ($make_payment[0]->status == 0) {
								$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
							} else if ($make_payment[0]->status == 3) {
								$status = '<span class="label label-warning">' . "Partially" . '</span>';
							}
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
						} else {
	
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
								<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
									<span class="fa fas fa-money"></span>
								</button>
							</span>';
							$delete = '';
						}
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
	
	
					// employee accommodations
					$employee_accommodations = 0;
					if (in_array('chk_total_employee_deduction', $uncheck_id)){
						$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
						foreach ($get_employee_accommodations as $get_employee_accommodation) {
							$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
							$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
							if ($period_from == $pay_date || $period_to == $pay_date) {
								if (!empty($get_employee_accommodation->rent_paid)) {
									$employee_accommodations += $get_employee_accommodation->rent_paid;
								}
							}
						}
					}
	
	
					// employee claims
					$claim_amount = 0;
					if (in_array('chk_employee_claim', $uncheck_id)){
						$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
						foreach ($get_employee_claims->result() as $claims) {
							$date 	= 	date('m-Y', strtotime($claims->date));
							if ($date == $pay_date) {
								$claim_amount += $claims->amount;
							}
						}
					}
					
	
					$total_earning 		= 	$show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
					$total_deduction 	= 	floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
					$total_net_salary 	= 	($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;
	
					
					// cpf calculation
					$emp_dob = $r->date_of_birth;
					$dob = new DateTime($emp_dob);
	
					$today = new DateTime('01-' . $pay_date);
					$age = $dob->diff($today);
					$age_year = $age->y;
					$age_month = $age->m;
	
					$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
					$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
					$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;
	
					if ($age_month > 0) {
						$age_year = $age_year + 1;
					}
	
					// $cpf_employee 	= 	0;
					// $cpf_employer	=	0;
	
					// $im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
					// if ($im_status) {
					// 	$immigration_id = $im_status->immigration_id;
					// 	if ($immigration_id == 2) {
					// 		$issue_date = $im_status->issue_date;
					// 		$i_date = new DateTime($issue_date);
					// 		$today = new DateTime();
					// 		$pr_age = $i_date->diff($today);
					// 		$pr_age_year = $pr_age->y;
					// 		$pr_age_month = $pr_age->m;
					// 	}
	
					// 	if ($immigration_id == 1 || $immigration_id == 2) {
	
					// 		$ordinary_wage = $g_ordinary_wage;
					// 		if ($ordinary_wage > $ordinary_wage_cap) {
					// 			$ow = $ordinary_wage_cap;
					// 		} else {
					// 			$ow = $ordinary_wage;
					// 		}
	
					// 		//additional wage
					// 		$additional_wage = $g_additional_wage;
					// 		$aw = $g_additional_wage;
					// 		$tw = $ow + $additional_wage;
					// 		if ($im_status->issue_date != "") {
					// 			if ($pr_age_year == 1) {
	
					// 				if ($age_year <= 55) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw < 500) {
					// 						$cpf_employer = round(4 / 100 * $tw);
					// 						$cpf_employee = 0;
					// 					} else if ($tw > 500 && $tw < 750) {
					// 						$cpf_employee = floor(0.15 * ($tw - 500));
					// 						$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
					// 						$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
					// 						if ($count_cpf_employee > 370) {
					// 							$cpf_employee = 370;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						if ($count_total_cpf > 666) {
					// 							$total_cpf = 666;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 55 && $age_year <= 60) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw < 500) {
					// 						$cpf_employer = round(4 / 100 * $tw);
					// 						$cpf_employee = 0;
					// 					} else if ($tw > 500 && $tw < 750) {
					// 						$cpf_employee = floor(0.15 * ($tw - 500));
					// 						$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
					// 						$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
					// 						if ($count_cpf_employee > 370) {
					// 							$cpf_employee = 370;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						if ($count_total_cpf > 666) {
					// 							$total_cpf = 666;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 60 && $age_year <= 65) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw < 500) {
					// 						$cpf_employer = round(3.5 / 100 * $tw);
					// 						$cpf_employee = 0;
					// 					} else if ($tw > 500 && $tw < 750) {
					// 						$cpf_employee = floor(0.15 * ($tw - 500));
					// 						$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
					// 						$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
					// 						if ($count_cpf_employee > 370) {
					// 							$cpf_employee = 370;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						if ($count_total_cpf > 629) {
					// 							$total_cpf = 629;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 65) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw < 500) {
					// 						$cpf_employer = round(3.5 / 100 * $tw);
					// 						$cpf_employee = 0;
					// 					} else if ($tw > 500 && $tw < 750) {
					// 						$cpf_employee = floor(0.15 * ($tw - 500));
					// 						$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
					// 						$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
					// 						if ($count_cpf_employee > 370) {
					// 							$cpf_employee = 370;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						if ($count_total_cpf > 629) {
					// 							$total_cpf = 629;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				}
					// 			}
					// 			if ($pr_age_year == 2) {
					// 				if ($age_year <= 55) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(9 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.45 * ($tw - 500));
					// 						$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
					// 						$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
					// 						if ($count_total_cpf > 1776) {
					// 							$total_cpf = 1776;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 1110) {
					// 							$cpf_employee = 1110;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 55 && $age_year <= 60) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(6 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.375 * ($tw - 500));
					// 						$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
					// 						$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
					// 						if ($count_total_cpf > 1369) {
					// 							$total_cpf = 1369;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 925) {
					// 							$cpf_employee = 925;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 60 && $age_year <= 65) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(3.5 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.225 * ($tw - 500));
					// 						$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
					// 						$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
					// 						if ($count_total_cpf > 814) {
					// 							$total_cpf = 814;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 555) {
					// 							$cpf_employee = 555;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 65) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(3.5 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.15 * ($tw - 500));
					// 						$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
					// 						$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
					// 						if ($count_total_cpf > 629) {
					// 							$total_cpf = 629;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 370) {
					// 							$cpf_employee = 370;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				}
					// 			}
					// 			if ($pr_age_year == 3 || $pr_age_year > 3) {
					// 				if ($age_year <= 55) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(17 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.6 * ($tw - 500));
					// 						$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
					// 						$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
					// 						if ($count_total_cpf > 2738) {
					// 							$total_cpf = 2738;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 1480) {
					// 							$cpf_employee = 1480;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = $total_cpf - $cpf_employee;
					// 					}
					// 				} else if ($age_year > 55 && $age_year <= 60) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(15.5 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.51 * ($tw - 500));
					// 						$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
					// 						$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
					// 						if ($count_total_cpf > 2405) {
					// 							$total_cpf = 2405;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 1258) {
					// 							$cpf_employee = 1258;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 60 && $age_year <= 65) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(12 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.345 * ($tw - 500));
					// 						$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
					// 						$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
					// 						if ($count_total_cpf > 1739) {
					// 							$total_cpf = 1739;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 851) {
					// 							$cpf_employee = 851;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 65 && $age_year <= 70) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(9 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.225 * ($tw - 500));
					// 						$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
					// 						$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
					// 						if ($count_total_cpf > 1221) {
					// 							$total_cpf = 1221;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 555) {
					// 							$cpf_employee = 555;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				} else if ($age_year > 70) {
					// 					if ($tw < 50) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = 0;
					// 					} else if ($tw > 50 && $tw <= 500) {
					// 						$cpf_employee = 0;
					// 						$cpf_employer = round(7.5 / 100 * $tw);
					// 					} else if ($tw > 500 && $tw <= 750) {
					// 						$cpf_employee = floor(0.15 * ($tw - 500));
					// 						$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					} else if ($tw > 750) {
					// 						$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
					// 						$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
					// 						if ($count_total_cpf > 925) {
					// 							$total_cpf = 925;
					// 						} else {
					// 							$total_cpf = $count_total_cpf;
					// 						}
					// 						if ($count_cpf_employee > 370) {
					// 							$cpf_employee = 370;
					// 						} else {
					// 							$cpf_employee = floor($count_cpf_employee);
					// 						}
					// 						$cpf_employer = round($total_cpf - $cpf_employee);
					// 					}
					// 				}
					// 			}
					// 		}
	
	
	
					// 		if ($immigration_id == 1) {
	
					// 			if ($age_year <= 55) {
					// 				if ($tw < 50) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = 0;
					// 				} else if ($tw > 50 && $tw <= 500) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = round(17 / 100 * $tw);
					// 				} else if ($tw > 500 && $tw <= 750) {
					// 					$cpf_employee = floor(0.6 * ($tw - 500));
					// 					$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				} else if ($tw > 750) {
					// 					$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
					// 					$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
					// 					if ($count_total_cpf > 2738) {
					// 						$count_total_cpf = 2738;
					// 					} else {
					// 						$total_cpf = $count_total_cpf;
					// 					}
	
	
					// 					if ($count_cpf_employee > 1480) {
					// 						$cpf_employee = 1480;
					// 					} else {
					// 						$cpf_employee = floor($count_cpf_employee);
					// 					}
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				}
					// 			} else if ($age_year > 55 && $age_year <= 60) {
					// 				if ($tw < 50) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = 0;
					// 				} else if ($tw > 50 && $tw <= 500) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = round(15.5 / 100 * $tw);
					// 				} else if ($tw > 500 && $tw <= 750) {
					// 					$cpf_employee = floor(0.51 * ($tw - 500));
					// 					$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				} else if ($tw > 750) {
					// 					$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
	
					// 					$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
					// 					if ($count_total_cpf > 2405) {
					// 						$count_total_cpf = 2405;
					// 					} else {
					// 						$total_cpf = $count_total_cpf;
					// 					}
					// 					if ($count_cpf_employee > 1258) {
					// 						$cpf_employee = 1258;
					// 					} else {
					// 						$cpf_employee = floor($count_cpf_employee);
					// 					}
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				}
					// 			} else if ($age_year > 60 && $age_year <= 65) {
					// 				if ($tw < 50) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = 0;
					// 				} else if ($tw > 50 && $tw <= 500) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = round(12 / 100 * $tw);
					// 				} else if ($tw > 500 && $tw <= 750) {
					// 					$cpf_employee = floor(0.345 * ($tw - 500));
					// 					$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				} else if ($tw > 750) {
					// 					$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
					// 					$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
					// 					if ($count_total_cpf > 1739) {
					// 						$total_cpf = 1739;
					// 					} else {
					// 						$total_cpf = $count_total_cpf;
					// 					}
					// 					if ($count_cpf_employee > 851) {
					// 						$cpf_employee = 851;
					// 					} else {
					// 						$cpf_employee = floor($count_cpf_employee);
					// 					}
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				}
					// 			} else if ($age_year > 65 && $age_year <= 70) {
					// 				if ($tw < 50) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = 0;
					// 				} else if ($tw > 50 && $tw <= 500) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = round(9 / 100 * $tw);
					// 				} else if ($tw > 500 && $tw <= 750) {
					// 					$cpf_employee = floor(0.225 * ($tw - 500));
					// 					$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				} else if ($tw > 750) {
					// 					$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
					// 					$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
					// 					if ($count_total_cpf > 1221) {
					// 						$total_cpf = 1221;
					// 					} else {
					// 						$total_cpf = $count_total_cpf;
					// 					}
					// 					if ($count_cpf_employee > 555) {
					// 						$cpf_employee = 555;
					// 					} else {
					// 						$cpf_employee = floor($count_cpf_employee);
					// 					}
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				}
					// 			} else if ($age_year > 70) {
					// 				if ($tw < 50) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = 0;
					// 				} else if ($tw > 50 && $tw <= 500) {
					// 					$cpf_employee = 0;
					// 					$cpf_employer = round(7.5 / 100 * $tw);
					// 				} else if ($tw > 500 && $tw <= 750) {
					// 					$cpf_employee = floor(0.15 * ($tw - 500));
					// 					$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				} else if ($tw > 750) {
					// 					$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
					// 					$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
					// 					if ($count_total_cpf > 925) {
					// 						$total_cpf = 925;
					// 					} else {
					// 						$total_cpf = $count_total_cpf;
					// 					}
					// 					if ($count_cpf_employee > 370) {
					// 						$cpf_employee = 370;
					// 					} else {
					// 						$cpf_employee = floor($count_cpf_employee);
					// 					}
					// 					$cpf_employer = round($total_cpf - $cpf_employee);
					// 				}
					// 			}
					// 		}
	
					// 		$total_net_salary = $total_net_salary - $cpf_employee;
					// 		$cpf_total = $cpf_employee + $cpf_employer;
	
					// 		$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
					// 		$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
					// 		$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
					// 	}
					// }
	
	
					// $shg_fund_deduction_amount = 0;
					// //Other Fund Contributions
					// $employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
					// if ($employee_contributions && $g_shg > 0) {
					// 	$gross_s = $g_shg;
					// 	$contribution_id = $employee_contributions->contribution_id;
					// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					// 	$shg_fund_name = $contribution_type[0]->contribution;
					// 	$shg_fund_deduction_amount += $contribution_amount;
					// 	$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
					// }
					// $ashg_fund_deduction_amount = 0;
					// $employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
					// if ($employee_ashg_contributions  && $g_shg > 0) {
					// 	$gross_s = $g_shg;
					// 	$contribution_id = $employee_ashg_contributions->contribution_id;
					// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					// 	$ashg_fund_name = $contribution_type[0]->contribution;
	
					// 	$ashg_fund_deduction_amount += $contribution_amount;
					// 	$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
					// }
	
					// echo $total_net_salary;
	
					// $sdl_total_amount = 0;
					// if ($g_sdl > 1 && $g_sdl <= 800) {
					// 	$sdl_total_amount = 2;
					// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					// 	$sdl_amount = (0.25 * $g_sdl) / 100;
					// 	$sdl_total_amount = $sdl_amount;
					// } elseif ($g_sdl > 4500) {
					// 	$sdl_total_amount = 11.25;
					// }
	
	
					$net_salary = number_format((float)$total_net_salary, 2, '.', '');
					$basic_salary = number_format((float)$basic_salary, 2, '.', '');
					// if ($basic_salary == 0 || $basic_salary == '') {
					// 	$fmpay = '';
					// } else {
					// 	$fmpay = $mpay;
					// }
	
	
					// $company_info = $this->Company_model->read_company_information($r->company_id);
					// if (!is_null($company_info)) {
					// 	$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
					// 	$net_salary = $net_salary;
					// 	//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
					// } else {
					// 	//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
					// 	$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);
	
					// 	$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);
	
					// 	//$net_salary = $this->Xin_model->currency_sign($net_salary);	
					// 	//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
					// 	$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
					// }
	
					// $iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';
	
					//action link
					// $act = $detail . $fmpay . $delete;
					// $act = $fmpay . $delete;
	
					if ($r->wages_type == 1) {
						if ($system[0]->is_half_monthly == 1) {
							$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
						} else {
							$emp_payroll_wage = $wages_type;
						}
					} else {
						$emp_payroll_wage = $wages_type;
					}
	
					$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					$p = $payslips->result();
					$balance = $this->Xin_model->currency_sign($p[0]->balance_amount ?? 0, $r->user_id);
					$mode_of_payment = $r->payment_mode ?? '';
	
					
					
					return $net_salary;
					// $data = array(
					// 	$act,
					// 	$iemp_name,
					// 	$emp_payroll_wage,
					// 	$basic_salary,
					// 	'total_cpf_employee'	=> 	$cpf_employee,
					// 	'total_cpf_employer'	=>	$cpf_employer,
					// 	'cpf_total'				=> 	$cpf_total,
					// 	'net_salary'			=>	$net_salary,
					// 	'contribution'			=>	$contribution,
					// 	'total_deduction'		=>	$total_deduction,
					// 	$balance,
					// 	$mode_of_payment,
					// 	$status
					// );
				}
			} else {
				$emp_name = $r->first_name . ' ' . $r->last_name;
				// office shift
				$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $pay_date);
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}

				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
				$hrs_old_int1 = 0;
				$pcount = 0;
				foreach ($result->result() as $hour_work) {
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}
				$pcount = $pcount + $re_pcount;

				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}

				$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
				$check_payment = $check && !empty($check[0]->check_id) ? explode(',', $check[0]->check_id) : [];

				if (!in_array('chk_gross_salary', $uncheck_id)) {
					$basic_salary = 0;
				}else if($check && $check[0]->is_advance == 1){
					$basic_salary = $basic_salary - $check[0]->advance_amount; 
				}
				
				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
				$pa_month = date('m-Y', strtotime('01-' . $pay_date));
				$deduction_amount = 0;
				if (in_array('chk_total_employee_deduction', $uncheck_id)) {
					if ($employee_deduction) {
						foreach ($employee_deduction as $deduction) {
							if ($deduction->type_id == 1) {
								$deduction_amount +=  $deduction->amount;
							}
							if ($deduction->type_id == 2) {
								$from_month_year = date('m-Y', strtotime($deduction->from_date));
								$to_month_year = date('d-m-Y', strtotime($deduction->to_date));


								if ($from_month_year != "" && $to_month_year != "") {
									if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
										$deduction_amount +=  $deduction->amount;
									}
								}
							}
						}
					}
				}




				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $pay_date);
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
				// if (in_array('chk_leave_deductions', $uncheck_id)) {
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							$pay_date_month = new DateTime('01-' . $pay_date);
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);

							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {
									if ($office_shift[0]->monday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
						}
					}
				// }
					

				// if joining date and pay date same then this logic work
				$month_date_join = date('m-Y', strtotime($r->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($r->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $pay_date) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$m_p_date = $p->format('Y-m-d');

						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}

					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}
				// echo $holidays_count;

				if ($month_date_join == $pay_date){
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				}else{
					$show_main_salary = $basic_salary;
				}
			
				$g_ordinary_wage += $show_main_salary;
				$g_shg += $show_main_salary;
				$g_sdl += $show_main_salary;
			
				$g_ordinary_wage -= $deduction_amount;
				$g_shg -= $deduction_amount;
				$g_sdl -= $deduction_amount;


				
				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				if (in_array('chk_loan_de_amount', $uncheck_id)) {
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
							$loan_de_amount += $er_loan;
						}
					} else {
						$loan_de_amount = 0;
					}
					$loan_de_amount = number_format(floatval($loan_de_amount), 2);
				}

				// 2: all allowances
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if (in_array('chk_total_allowances', $uncheck_id)) {
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}


							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								if ($month_date_join == $pay_date){
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}

							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}

							$allowance_amount += $eallowance_amount;
						}
					}
					$gross_allowance_amount = $allowance_amount;
				}


				// commissions
				$commissions_amount = 0;
				if (in_array('chk_total_commissions', $uncheck_id)) {
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $c->commission_amount / 2;
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
							} else {
								$ecommissions_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommissions_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommissions_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommissions_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommissions_amount;
							}

							$commissions_amount += $ecommissions_amount;
						}
					}
				}

				//share options
				$share_options_amount = 0;
				if (in_array('chk_total_share', $uncheck_id)) {
					$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;
					}
				}


				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				if (in_array('chk_total_other_payments', $uncheck_id)) {
					if ($count_other_payments > 0) {
						foreach ($other_payments->result() as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}

									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}

									$other_payments_amount += $epayments_amount;
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $pay_date) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $pay_date);
								}

								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));

								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $pay_date) {
										$last_date = new DateTime($sl_other_payments->end_date);
									}else if($last_date->format('m-Y') >= $pay_date){
											$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
								if(!empty($last_date)){
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $pay_date) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}


										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');

											//holidays in a month

											$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}

											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}

										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
										


										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
									}
								}
							}
						}
					} else {
						$other_payments_amount = 0;
					}
				}

				
				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
				// if (in_array('chk_leave_deductions', $uncheck_id)) {
					if ($unpaid_leaves) {
						$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				   }
				// }

				
			
				// $g_ordinary_wage = $gross_pay;
				$g_shg = $gross_pay;
				$g_sdl = $gross_pay;

				$g_ordinary_wage -= $unpaid_leave_amount;

				
			
				
				// other benefit
				$other_benefit_mount = 0;
				if (in_array('chk_total_employee_deduction', $uncheck_id)) {
					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
					foreach ($other_benefit_list->result() as $benefit_list) {
						$other_benefit_mount += $benefit_list->other_benefit_cost;
					}
				}


				// statutory_deductions
				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if (in_array('chk_total_statutory_deductions', $uncheck_id)) {
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') {
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							} else {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							}
						}
					} else {
						$statutory_deductions_amount = 0;
					}
				}

				// overtime
				$overtime_amount = 0;
				if (in_array('chk_total_overtime', $uncheck_id)) {
					$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
					if ($overtime) {
						$ot_hrs = 0;
						$ot_mins = 0;
						foreach ($overtime as $ot) {
							$total_hours = explode(':', $ot->total_hours);
							$ot_hrs += $total_hours[0];
							$ot_mins += $total_hours[1];
						}
						if ($ot_mins > 0) {
							$ot_hrs += round($ot_mins / 60, 2);
						}

						//overtime rate
						$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
						if ($overtime_rate) {
							$rate = $overtime_rate->overtime_pay_rate;
						} else {
							$week_hours = 44;
							$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
							$rate = $rate * 1.5;
						}

						if ($ot_hrs > 0) {
							$overtime_amount = round($ot_hrs * $rate, 2);
						}
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$overtime_amount = $overtime_amount / 2;
							}
						}
						$g_ordinary_wage += $overtime_amount;
						$g_sdl += $overtime_amount;
					}
				}

				// make payment
				if ($system[0]->is_half_monthly == 1) {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
					$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
					if ($payment_check->num_rows() > 1) {

						//foreach($payment_last as $payment_half_last){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}

						$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
						//}
						//detail link
						$detail = '';
					} else if ($payment_check->num_rows() > 0) {

						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';

						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$detail = '';
					} else {

						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
					//detail link
					//$detail = '';
				} else {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					if ($payment_check->num_rows() > 0) {
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						if ($make_payment[0]->status == 0) {
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						} else if ($make_payment[0]->status == 3) {
							$status = '<span class="label label-warning">' . "Partially" . '</span>';
						}
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
					} else {

						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
							<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
								<span class="fa fas fa-money"></span>
							</button>
						</span>';
						$delete = '';
					}
					//detail link
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
				}


				// employee accommodations
				$employee_accommodations = 0;
				if (in_array('chk_total_employee_deduction', $uncheck_id)){
					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $pay_date || $period_to == $pay_date) {
							if (!empty($get_employee_accommodation->rent_paid)) {
								$employee_accommodations += $get_employee_accommodation->rent_paid;
							}
						}
					}
				}


				// employee claims
				$claim_amount = 0;
				if (in_array('chk_employee_claim', $uncheck_id)){
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $pay_date) {
							$claim_amount += $claims->amount;
						}
					}
				}
				

				$total_earning 		= 	$show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction 	= 	floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
				$total_net_salary 	= 	($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;

				
				// cpf calculation
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);

				$today = new DateTime('01-' . $pay_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}

				// $cpf_employee 	= 	0;
				// $cpf_employer	=	0;

				// $im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
				// if ($im_status) {
				// 	$immigration_id = $im_status->immigration_id;
				// 	if ($immigration_id == 2) {
				// 		$issue_date = $im_status->issue_date;
				// 		$i_date = new DateTime($issue_date);
				// 		$today = new DateTime();
				// 		$pr_age = $i_date->diff($today);
				// 		$pr_age_year = $pr_age->y;
				// 		$pr_age_month = $pr_age->m;
				// 	}

				// 	if ($immigration_id == 1 || $immigration_id == 2) {

				// 		$ordinary_wage = $g_ordinary_wage;
				// 		if ($ordinary_wage > $ordinary_wage_cap) {
				// 			$ow = $ordinary_wage_cap;
				// 		} else {
				// 			$ow = $ordinary_wage;
				// 		}

				// 		//additional wage
				// 		$additional_wage = $g_additional_wage;
				// 		$aw = $g_additional_wage;
				// 		$tw = $ow + $additional_wage;
				// 		if ($im_status->issue_date != "") {
				// 			if ($pr_age_year == 1) {

				// 				if ($age_year <= 55) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw < 500) {
				// 						$cpf_employer = round(4 / 100 * $tw);
				// 						$cpf_employee = 0;
				// 					} else if ($tw > 500 && $tw < 750) {
				// 						$cpf_employee = floor(0.15 * ($tw - 500));
				// 						$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
				// 						$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

				// 						if ($count_cpf_employee > 370) {
				// 							$cpf_employee = 370;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						if ($count_total_cpf > 666) {
				// 							$total_cpf = 666;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 55 && $age_year <= 60) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw < 500) {
				// 						$cpf_employer = round(4 / 100 * $tw);
				// 						$cpf_employee = 0;
				// 					} else if ($tw > 500 && $tw < 750) {
				// 						$cpf_employee = floor(0.15 * ($tw - 500));
				// 						$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
				// 						$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

				// 						if ($count_cpf_employee > 370) {
				// 							$cpf_employee = 370;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						if ($count_total_cpf > 666) {
				// 							$total_cpf = 666;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 60 && $age_year <= 65) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw < 500) {
				// 						$cpf_employer = round(3.5 / 100 * $tw);
				// 						$cpf_employee = 0;
				// 					} else if ($tw > 500 && $tw < 750) {
				// 						$cpf_employee = floor(0.15 * ($tw - 500));
				// 						$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
				// 						$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

				// 						if ($count_cpf_employee > 370) {
				// 							$cpf_employee = 370;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						if ($count_total_cpf > 629) {
				// 							$total_cpf = 629;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 65) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw < 500) {
				// 						$cpf_employer = round(3.5 / 100 * $tw);
				// 						$cpf_employee = 0;
				// 					} else if ($tw > 500 && $tw < 750) {
				// 						$cpf_employee = floor(0.15 * ($tw - 500));
				// 						$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
				// 						$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

				// 						if ($count_cpf_employee > 370) {
				// 							$cpf_employee = 370;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						if ($count_total_cpf > 629) {
				// 							$total_cpf = 629;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				}
				// 			}
				// 			if ($pr_age_year == 2) {
				// 				if ($age_year <= 55) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(9 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.45 * ($tw - 500));
				// 						$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
				// 						$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
				// 						if ($count_total_cpf > 1776) {
				// 							$total_cpf = 1776;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 1110) {
				// 							$cpf_employee = 1110;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 55 && $age_year <= 60) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(6 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.375 * ($tw - 500));
				// 						$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
				// 						$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
				// 						if ($count_total_cpf > 1369) {
				// 							$total_cpf = 1369;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 925) {
				// 							$cpf_employee = 925;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 60 && $age_year <= 65) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(3.5 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.225 * ($tw - 500));
				// 						$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
				// 						$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
				// 						if ($count_total_cpf > 814) {
				// 							$total_cpf = 814;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 555) {
				// 							$cpf_employee = 555;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 65) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(3.5 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.15 * ($tw - 500));
				// 						$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
				// 						$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
				// 						if ($count_total_cpf > 629) {
				// 							$total_cpf = 629;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 370) {
				// 							$cpf_employee = 370;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				}
				// 			}
				// 			if ($pr_age_year == 3 || $pr_age_year > 3) {
				// 				if ($age_year <= 55) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(17 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.6 * ($tw - 500));
				// 						$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
				// 						$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
				// 						if ($count_total_cpf > 2738) {
				// 							$total_cpf = 2738;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 1480) {
				// 							$cpf_employee = 1480;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = $total_cpf - $cpf_employee;
				// 					}
				// 				} else if ($age_year > 55 && $age_year <= 60) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(15.5 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.51 * ($tw - 500));
				// 						$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
				// 						$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
				// 						if ($count_total_cpf > 2405) {
				// 							$total_cpf = 2405;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 1258) {
				// 							$cpf_employee = 1258;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 60 && $age_year <= 65) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(12 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.345 * ($tw - 500));
				// 						$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
				// 						$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

				// 						if ($count_total_cpf > 1739) {
				// 							$total_cpf = 1739;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 851) {
				// 							$cpf_employee = 851;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 65 && $age_year <= 70) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(9 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.225 * ($tw - 500));
				// 						$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
				// 						$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

				// 						if ($count_total_cpf > 1221) {
				// 							$total_cpf = 1221;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 555) {
				// 							$cpf_employee = 555;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				} else if ($age_year > 70) {
				// 					if ($tw < 50) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = 0;
				// 					} else if ($tw > 50 && $tw <= 500) {
				// 						$cpf_employee = 0;
				// 						$cpf_employer = round(7.5 / 100 * $tw);
				// 					} else if ($tw > 500 && $tw <= 750) {
				// 						$cpf_employee = floor(0.15 * ($tw - 500));
				// 						$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					} else if ($tw > 750) {
				// 						$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
				// 						$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

				// 						if ($count_total_cpf > 925) {
				// 							$total_cpf = 925;
				// 						} else {
				// 							$total_cpf = $count_total_cpf;
				// 						}
				// 						if ($count_cpf_employee > 370) {
				// 							$cpf_employee = 370;
				// 						} else {
				// 							$cpf_employee = floor($count_cpf_employee);
				// 						}
				// 						$cpf_employer = round($total_cpf - $cpf_employee);
				// 					}
				// 				}
				// 			}
				// 		}



				// 		if ($immigration_id == 1) {

				// 			if ($age_year <= 55) {
				// 				if ($tw < 50) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = 0;
				// 				} else if ($tw > 50 && $tw <= 500) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = round(17 / 100 * $tw);
				// 				} else if ($tw > 500 && $tw <= 750) {
				// 					$cpf_employee = floor(0.6 * ($tw - 500));
				// 					$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				} else if ($tw > 750) {
				// 					$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
				// 					$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
				// 					if ($count_total_cpf > 2738) {
				// 						$count_total_cpf = 2738;
				// 					} else {
				// 						$total_cpf = $count_total_cpf;
				// 					}


				// 					if ($count_cpf_employee > 1480) {
				// 						$cpf_employee = 1480;
				// 					} else {
				// 						$cpf_employee = floor($count_cpf_employee);
				// 					}
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				}
				// 			} else if ($age_year > 55 && $age_year <= 60) {
				// 				if ($tw < 50) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = 0;
				// 				} else if ($tw > 50 && $tw <= 500) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = round(15.5 / 100 * $tw);
				// 				} else if ($tw > 500 && $tw <= 750) {
				// 					$cpf_employee = floor(0.51 * ($tw - 500));
				// 					$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				} else if ($tw > 750) {
				// 					$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;

				// 					$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
				// 					if ($count_total_cpf > 2405) {
				// 						$count_total_cpf = 2405;
				// 					} else {
				// 						$total_cpf = $count_total_cpf;
				// 					}
				// 					if ($count_cpf_employee > 1258) {
				// 						$cpf_employee = 1258;
				// 					} else {
				// 						$cpf_employee = floor($count_cpf_employee);
				// 					}
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				}
				// 			} else if ($age_year > 60 && $age_year <= 65) {
				// 				if ($tw < 50) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = 0;
				// 				} else if ($tw > 50 && $tw <= 500) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = round(12 / 100 * $tw);
				// 				} else if ($tw > 500 && $tw <= 750) {
				// 					$cpf_employee = floor(0.345 * ($tw - 500));
				// 					$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				} else if ($tw > 750) {
				// 					$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
				// 					$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

				// 					if ($count_total_cpf > 1739) {
				// 						$total_cpf = 1739;
				// 					} else {
				// 						$total_cpf = $count_total_cpf;
				// 					}
				// 					if ($count_cpf_employee > 851) {
				// 						$cpf_employee = 851;
				// 					} else {
				// 						$cpf_employee = floor($count_cpf_employee);
				// 					}
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				}
				// 			} else if ($age_year > 65 && $age_year <= 70) {
				// 				if ($tw < 50) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = 0;
				// 				} else if ($tw > 50 && $tw <= 500) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = round(9 / 100 * $tw);
				// 				} else if ($tw > 500 && $tw <= 750) {
				// 					$cpf_employee = floor(0.225 * ($tw - 500));
				// 					$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				} else if ($tw > 750) {
				// 					$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
				// 					$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

				// 					if ($count_total_cpf > 1221) {
				// 						$total_cpf = 1221;
				// 					} else {
				// 						$total_cpf = $count_total_cpf;
				// 					}
				// 					if ($count_cpf_employee > 555) {
				// 						$cpf_employee = 555;
				// 					} else {
				// 						$cpf_employee = floor($count_cpf_employee);
				// 					}
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				}
				// 			} else if ($age_year > 70) {
				// 				if ($tw < 50) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = 0;
				// 				} else if ($tw > 50 && $tw <= 500) {
				// 					$cpf_employee = 0;
				// 					$cpf_employer = round(7.5 / 100 * $tw);
				// 				} else if ($tw > 500 && $tw <= 750) {
				// 					$cpf_employee = floor(0.15 * ($tw - 500));
				// 					$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				} else if ($tw > 750) {
				// 					$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
				// 					$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

				// 					if ($count_total_cpf > 925) {
				// 						$total_cpf = 925;
				// 					} else {
				// 						$total_cpf = $count_total_cpf;
				// 					}
				// 					if ($count_cpf_employee > 370) {
				// 						$cpf_employee = 370;
				// 					} else {
				// 						$cpf_employee = floor($count_cpf_employee);
				// 					}
				// 					$cpf_employer = round($total_cpf - $cpf_employee);
				// 				}
				// 			}
				// 		}

				// 		$total_net_salary = $total_net_salary - $cpf_employee;
				// 		$cpf_total = $cpf_employee + $cpf_employer;

				// 		$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
				// 		$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
				// 		$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
				// 	}
				// }


				// $shg_fund_deduction_amount = 0;
				// //Other Fund Contributions
				// $employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
				// if ($employee_contributions && $g_shg > 0) {
				// 	$gross_s = $g_shg;
				// 	$contribution_id = $employee_contributions->contribution_id;
				// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
				// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
				// 	$shg_fund_name = $contribution_type[0]->contribution;
				// 	$shg_fund_deduction_amount += $contribution_amount;
				// 	$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
				// }
				// $ashg_fund_deduction_amount = 0;
				// $employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				// if ($employee_ashg_contributions  && $g_shg > 0) {
				// 	$gross_s = $g_shg;
				// 	$contribution_id = $employee_ashg_contributions->contribution_id;
				// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
				// 	$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
				// 	$ashg_fund_name = $contribution_type[0]->contribution;

				// 	$ashg_fund_deduction_amount += $contribution_amount;
				// 	$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
				// }

				// echo $total_net_salary;

				// $sdl_total_amount = 0;
				// if ($g_sdl > 1 && $g_sdl <= 800) {
				// 	$sdl_total_amount = 2;
				// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
				// 	$sdl_amount = (0.25 * $g_sdl) / 100;
				// 	$sdl_total_amount = $sdl_amount;
				// } elseif ($g_sdl > 4500) {
				// 	$sdl_total_amount = 11.25;
				// }


				$net_salary = number_format((float)$total_net_salary, 2, '.', '');
				$basic_salary = number_format((float)$basic_salary, 2, '.', '');
				// if ($basic_salary == 0 || $basic_salary == '') {
				// 	$fmpay = '';
				// } else {
				// 	$fmpay = $mpay;
				// }


				// $company_info = $this->Company_model->read_company_information($r->company_id);
				// if (!is_null($company_info)) {
				// 	$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
				// 	$net_salary = $net_salary;
				// 	//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
				// } else {
				// 	//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
				// 	$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);

				// 	$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);

				// 	//$net_salary = $this->Xin_model->currency_sign($net_salary);	
				// 	//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
				// 	$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
				// }

				// $iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';

				//action link
				// $act = $detail . $fmpay . $delete;
				// $act = $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}

				$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
				$p = $payslips->result();
				$balance = $this->Xin_model->currency_sign($p[0]->balance_amount ?? 0, $r->user_id);
				$mode_of_payment = $r->payment_mode ?? '';

				
				
				return $net_salary;
				// $data = array(
				// 	$act,
				// 	$iemp_name,
				// 	$emp_payroll_wage,
				// 	$basic_salary,
				// 	'total_cpf_employee'	=> 	$cpf_employee,
				// 	'total_cpf_employer'	=>	$cpf_employer,
				// 	'cpf_total'				=> 	$cpf_total,
				// 	'net_salary'			=>	$net_salary,
				// 	'contribution'			=>	$contribution,
				// 	'total_deduction'		=>	$total_deduction,
				// 	$balance,
				// 	$mode_of_payment,
				// 	$status
				// );
			}
		}
	}

	// for contrubution calculation
	public function contribution_calculation($data)
	{
		$pay_date 	= 	$data['pay_date'];
		$user_id	=	$data['user_id'];
		$payslip 	= 	$this->Employees_model->get_single_employees_payslip($pay_date, $user_id);
		$system 	= 	$this->Xin_model->read_setting_info(1);

		$role_resources_ids = $this->Xin_model->user_role_resource();
		$system = $this->Xin_model->read_setting_info(1);
		$data = array();
		foreach ($payslip->result() as $r) {
			$exit_employee = $this->Employees_model->get_employee_exit($r->user_id);

			if (count($exit_employee) > 0) {
				$e_date = date('Y-m-d', strtotime($exit_employee[0]->exit_date));
				$exit_date = date('m-Y', strtotime($e_date));
				if ($exit_date >= $pay_date){
					$emp_name = $r->first_name . ' ' . $r->last_name;
					// office shift
					$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);
	
					//overtime request
					$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
					$re_hrs_old_int1 = 0;
					$re_hrs_old_seconds = 0;
					$re_pcount = 0;
					foreach ($overtime_count as $overtime_hr) {
						$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
						$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
						$re_interval_late = $request_clock_in->diff($request_clock_out);
						$re_hours_r  = $re_interval_late->format('%h');
						$re_minutes_r = $re_interval_late->format('%i');
						$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';
	
						$re_str_time = $re_total_time;
	
						$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);
	
						sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$re_hrs_old_int1 += $re_hrs_old_seconds;
	
						$re_pcount = gmdate("H", $re_hrs_old_int1);
					}
	
					$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
					$hrs_old_int1 = 0;
					$pcount = 0;
					foreach ($result->result() as $hour_work) {
						$clock_in =  new DateTime($hour_work->clock_in);
						$clock_out =  new DateTime($hour_work->clock_out);
						$interval_late = $clock_in->diff($clock_out);
						$hours_r  = $interval_late->format('%h');
						$minutes_r = $interval_late->format('%i');
						$total_time = $hours_r . ":" . $minutes_r . ":" . '00';
	
						$str_time = $total_time;
	
						$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);
	
						sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$hrs_old_int1 += $hrs_old_seconds;
	
						$pcount = gmdate("H", $hrs_old_int1);
					}
					$pcount = $pcount + $re_pcount;
	
					// get company
					$company = $this->Xin_model->read_company_info($r->company_id);
					if (!is_null($company)) {
						$comp_name = $company[0]->name;
					} else {
						$comp_name = '--';
					}
	
					/**
					 * Local Variable
					 */
					$g_ordinary_wage = 0;
					$g_additional_wage = 0;
					$g_shg = 0;
					$g_sdl = 0;
	
					// 1: salary type
					if ($r->wages_type == 1) {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					} else if ($r->wages_type == 2) {
						$wages_type = $this->lang->line('xin_employee_daily_wages');
						if ($pcount > 0) {
							$basic_salary = $pcount * $r->basic_salary;
						} else {
							$basic_salary = $pcount;
						}
						$p_class = 'emo_hourly_pay';
						$view_p_class = 'hourlywages_template_modal';
					} else {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					}
	
					
					// employee deduction
					$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
					$pa_month = date('m-Y', strtotime('01-' . $pay_date));
					$deduction_amount = 0;
					if ($employee_deduction) {
						foreach ($employee_deduction as $deduction) {
							if ($deduction->type_id == 1) {
								$deduction_amount +=  $deduction->amount;
							}
							if ($deduction->type_id == 2) {
								$from_month_year = date('m-Y', strtotime($deduction->from_date));
								$to_month_year = date('d-m-Y', strtotime($deduction->to_date));
	
	
								if ($from_month_year != "" && $to_month_year != "") {
									if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
										$deduction_amount +=  $deduction->amount;
									}
								}
							}
						}
					}
	
	
	
					//3: Gross rate of pay (unpaid leave deduction)
					$holidays_count = 0;
					$no_of_working_days = 0;
					$month_start_date = new DateTime('01-' . $pay_date);
					$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
					$month_end_date->modify('+1 day');
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($month_start_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$period_day = $p->format('l');
						$period_date = $p->format('Y-m-d');
	
						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
						if ($is_holiday) {
							$holidays_count += 1;
						}
	
						//working days excluding holidays based on office shift
						if ($period_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_working_days += 1;
							}
						}
					}
	
					//unpaid leave
					$unpaid_leave_amount = 0;
					$leaves_taken_count = 0;
					$leave_period = array();
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							$pay_date_month = new DateTime('01-' . $pay_date);
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);
	
							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {
									if ($office_shift[0]->monday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
						}
					}
	
					// if joining date and pay date same then this logic work
					$month_date_join = date('m-Y', strtotime($r->date_of_joining));
					$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
					$month_last_date = date('m-Y', strtotime($lastday));
	
					$first_date =  new DateTime($r->date_of_joining);
					$no_of_days_worked = 0;
					$same_month_holidays_count = 0;
					if ($month_date_join == $pay_date) {
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($first_date, $interval, $month_end_date);
						foreach ($period as $p) {
							$p_day = $p->format('l');
							$m_p_date = $p->format('Y-m-d');
	
							//holidays in a month
							$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
							if ($is_holiday) {
								$same_month_holidays_count += 1;
							}
	
							//working days excluding holidays based on office shift
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$no_of_days_worked += 1;
								}
							}
						}
	
						// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
						$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
					} else {
						// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
						$no_of_days_worked = $no_of_working_days -  $holidays_count;
					}
	
	
					if ($month_date_join == $pay_date){
						$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
					}else{
						$show_main_salary = $basic_salary;
					}
				
					$g_ordinary_wage += $show_main_salary;
					$g_shg += $show_main_salary;
					$g_sdl += $show_main_salary;
				
					$g_ordinary_wage -= $deduction_amount;
					$g_shg -= $deduction_amount;
					$g_sdl -= $deduction_amount;
	
	
					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
							$loan_de_amount += $er_loan;
						}
					} else {
						$loan_de_amount = 0;
					}
					$loan_de_amount = number_format(floatval($loan_de_amount), 2);
	
					// 2: all allowances
					$allowance_amount = 0;
					$gross_allowance_amount = 0;
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
	
	
							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								if ($month_date_join == $pay_date){
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}
	
							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}
	
							$allowance_amount += $eallowance_amount;
						}
					}
					$gross_allowance_amount = $allowance_amount;
	
	
	
	
					// commissions
					$commissions_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $c->commission_amount / 2;
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
	
							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommissions_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommissions_amount;
							}
	
							if ($c->sdl == 1) {
								$g_sdl += $ecommissions_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommissions_amount;
							}
	
							$commissions_amount += $ecommissions_amount;
						}
					}
	
					//share options
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
	
								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;
					}
	
					// otherpayments
					$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
					$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
					$other_payments_amount = 0;
					if ($count_other_payments > 0) {
						foreach ($other_payments->result() as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}
	
									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
	
									$other_payments_amount += $epayments_amount;
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $pay_date) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $pay_date);
								}
	
								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
	
								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $pay_date) {
										$last_date = new DateTime($sl_other_payments->end_date);
									}else if($last_date->format('m-Y') >= $pay_date){
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
								if(!empty($last_date)){
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $pay_date) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
	
	
										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');
	
											//holidays in a month
	
											$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}
	
											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}
	
										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
										
	
	
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
									}
								}
							}
						}
					} else {
						$other_payments_amount = 0;
					}
	
	
					$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
		
					if ($unpaid_leaves) {
						$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
					}
	
					// $g_ordinary_wage = $gross_pay;
					$g_shg = $gross_pay;
					$g_sdl = $gross_pay;
				
	
					$g_ordinary_wage -= $unpaid_leave_amount;
	
	
					// other benefit
					$other_benefit_mount = 0;
					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
					foreach ($other_benefit_list->result() as $benefit_list) {
						$other_benefit_mount += $benefit_list->other_benefit_cost;
					}
	
	
					// statutory_deductions
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') {
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							} else {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							}
						}
					} else {
						$statutory_deductions_amount = 0;
					}
	
					// overtime
					$overtime_amount = 0;
					$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
					if ($overtime) {
						$ot_hrs = 0;
						$ot_mins = 0;
						foreach ($overtime as $ot) {
							$total_hours = explode(':', $ot->total_hours);
							$ot_hrs += $total_hours[0];
							$ot_mins += $total_hours[1];
						}
						if ($ot_mins > 0) {
							$ot_hrs += round($ot_mins / 60, 2);
						}
	
						//overtime rate
						$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
						if ($overtime_rate) {
							$rate = $overtime_rate->overtime_pay_rate;
						} else {
							$week_hours = 44;
							$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
							$rate = $rate * 1.5;
						}
	
						if ($ot_hrs > 0) {
							$overtime_amount = round($ot_hrs * $rate, 2);
						}
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$overtime_amount = $overtime_amount / 2;
							}
						}
						$g_ordinary_wage += $overtime_amount;
						$g_sdl += $overtime_amount;
					}
	
					// make payment
					if ($system[0]->is_half_monthly == 1) {
						$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
						$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
						if ($payment_check->num_rows() > 1) {
	
							//foreach($payment_last as $payment_half_last){
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
							//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';
	
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
	
							$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
							//}
							//detail link
							$detail = '';
						} else if ($payment_check->num_rows() > 0) {
	
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
	
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
	
							$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
							$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
							$detail = '';
						} else {
	
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
							$delete = '';
							//detail link
							$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						}
						//detail link
						//$detail = '';
					} else {
						$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
						if ($payment_check->num_rows() > 0) {
							$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
							$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
							if ($make_payment[0]->status == 0) {
								$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
							} else if ($make_payment[0]->status == 3) {
								$status = '<span class="label label-warning">' . "Partially" . '</span>';
							}
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
	
							if (in_array('313', $role_resources_ids)) {
								$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
							} else {
								$delete = '';
							}
						} else {
	
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
								<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
									<span class="fa fas fa-money"></span>
								</button>
							</span>';
							$delete = '';
						}
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
	
	
					// employee accommodations
					$employee_accommodations = 0;
					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $pay_date || $period_to == $pay_date) {
							if (!empty($get_employee_accommodation->rent_paid)) {
								$employee_accommodations += $get_employee_accommodation->rent_paid;
							}
						}
					}
	
					// employee claims
					$claim_amount = 0;
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $pay_date) {
							$claim_amount += $claims->amount;
						}
					}
	
	
					$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
					$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
					$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;
	
				
					// cpf calculation
					$emp_dob = $r->date_of_birth;
					$dob = new DateTime($emp_dob);
	
					$today = new DateTime('01-' . $pay_date);
					$age = $dob->diff($today);
					$age_year = $age->y;
					$age_month = $age->m;
	
					$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
					$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
					$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;
	
					if ($age_month > 0) {
						$age_year = $age_year + 1;
					}
	
					$cpf_employee 	= 	0;
					$cpf_employer	=	0;
					$cpf_total		=	0;
					$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
					if ($im_status) {
						$immigration_id = $im_status->immigration_id;
						if ($immigration_id == 2) {
							$issue_date = $im_status->issue_date;
							$i_date = new DateTime($issue_date);
							$today = new DateTime();
							$pr_age = $i_date->diff($today);
							$pr_age_year = $pr_age->y;
							$pr_age_month = $pr_age->m;
						}
	
						if ($immigration_id == 1 || $immigration_id == 2) {
	
							$ordinary_wage = $g_ordinary_wage;
							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}
	
							//additional wage
							$additional_wage = $g_additional_wage;
							$aw = $g_additional_wage;
							$tw = $ow + $additional_wage;
							if ($im_status->issue_date != "") {
								if ($pr_age_year == 1) {
	
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 2) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.45 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
											$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
											if ($count_total_cpf > 1776) {
												$total_cpf = 1776;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1110) {
												$cpf_employee = 1110;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(6 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.375 * ($tw - 500));
											$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
											$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
											if ($count_total_cpf > 1369) {
												$total_cpf = 1369;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 925) {
												$cpf_employee = 925;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
											if ($count_total_cpf > 814) {
												$total_cpf = 814;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 3 || $pr_age_year > 3) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(17 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.6 * ($tw - 500));
											$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
											$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
											if ($count_total_cpf > 2738) {
												$total_cpf = 2738;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1480) {
												$cpf_employee = 1480;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = $total_cpf - $cpf_employee;
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(15.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.51 * ($tw - 500));
											$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
											$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
											if ($count_total_cpf > 2405) {
												$total_cpf = 2405;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1258) {
												$cpf_employee = 1258;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(12 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.345 * ($tw - 500));
											$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
											$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
											if ($count_total_cpf > 1739) {
												$total_cpf = 1739;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 851) {
												$cpf_employee = 851;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65 && $age_year <= 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
											if ($count_total_cpf > 1221) {
												$total_cpf = 1221;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(7.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
											if ($count_total_cpf > 925) {
												$total_cpf = 925;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
							}
	
	
	
							if ($immigration_id == 1) {
	
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$count_total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
	
	
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
	
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$count_total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
	
							$total_net_salary = $total_net_salary - $cpf_employee;
							$cpf_total = $cpf_employee + $cpf_employer;
	
							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
						}
					}
	
	
					$shg_fund_deduction_amount = 0;
					//Other Fund Contributions
					$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
	
					if ($employee_contributions && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$shg_fund_name = $contribution_type[0]->contribution;
						$shg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
					}
					$ashg_fund_deduction_amount = 0;
	
					$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
					if ($employee_ashg_contributions  && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_ashg_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$ashg_fund_name = $contribution_type[0]->contribution;
	
						$ashg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
					}
	
					// echo $total_net_salary;
	
					// $sdl_total_amount = 0;
					// if ($g_sdl > 1 && $g_sdl <= 800) {
					// 	$sdl_total_amount = 2;
					// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					// 	$sdl_amount = (0.25 * $g_sdl) / 100;
					// 	$sdl_total_amount = $sdl_amount;
					// } elseif ($g_sdl > 4500) {
					// 	$sdl_total_amount = 11.25;
					// }
	
	
					$net_salary = number_format((float)$total_net_salary, 2, '.', '');
					$basic_salary = number_format((float)$basic_salary, 2, '.', '');
					if ($basic_salary == 0 || $basic_salary == '') {
						$fmpay = '';
					} else {
						$fmpay = $mpay;
					}
	
	
					$company_info = $this->Company_model->read_company_information($r->company_id);
					if (!is_null($company_info)) {
						$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
						$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
						//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
					} else {
						//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
						$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);
	
						$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);
	
						//$net_salary = $this->Xin_model->currency_sign($net_salary);	
						//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
						$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
					}
	
					$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';
	
					//action link
					$act = $detail . $fmpay . $delete;
					// $act = $fmpay . $delete;
	
					if ($r->wages_type == 1) {
						if ($system[0]->is_half_monthly == 1) {
							$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
						} else {
							$emp_payroll_wage = $wages_type;
						}
					} else {
						$emp_payroll_wage = $wages_type;
					}
	
					$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					$p = $payslips->result();
					$balance = $this->Xin_model->currency_sign($p[0]->balance_amount ?? 0, $r->user_id);
					$mode_of_payment = $r->payment_mode ?? '';
	
	
					return [
						'contribution' 	=>	$shg_fund_deduction_amount + $ashg_fund_deduction_amount,
						'salary'		=>	$net_salary,
						'cpf_employee'	=>	$cpf_employee,
						'unpaid_leave_amount'	=>	$unpaid_leave_amount
					];
					// $data[] = array(
					// 	$act,
					// 	$iemp_name,
					// 	$emp_payroll_wage,
					// 	// $basic_salary,
					// 	$this->Xin_model->currency_sign($gross_pay, $r->user_id),
					// 	$this->Xin_model->currency_sign($cpf_employee, $r->user_id),
					// 	$net_salary,
					// 	$balance,
					// 	$mode_of_payment,
					// 	$status
					// );
				}
			} else {
				$emp_name = $r->first_name . ' ' . $r->last_name;
				// office shift
				$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}

				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
				$hrs_old_int1 = 0;
				$pcount = 0;
				foreach ($result->result() as $hour_work) {
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}
				$pcount = $pcount + $re_pcount;

				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}

				
				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
				$pa_month = date('m-Y', strtotime('01-' . $pay_date));
				$deduction_amount = 0;
				if ($employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						if ($deduction->type_id == 1) {
							$deduction_amount +=  $deduction->amount;
						}
						if ($deduction->type_id == 2) {
							$from_month_year = date('m-Y', strtotime($deduction->from_date));
							$to_month_year = date('d-m-Y', strtotime($deduction->to_date));


							if ($from_month_year != "" && $to_month_year != "") {
								if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
									$deduction_amount +=  $deduction->amount;
								}
							}
						}
					}
				}



				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $pay_date);
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						$pay_date_month = new DateTime('01-' . $pay_date);
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
					}
				}

				// if joining date and pay date same then this logic work
				$month_date_join = date('m-Y', strtotime($r->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($r->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $pay_date) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$m_p_date = $p->format('Y-m-d');

						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}

					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}


				if ($month_date_join == $pay_date){
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				}else{
					$show_main_salary = $basic_salary;
				}
			
				$g_ordinary_wage += $show_main_salary;
				$g_shg += $show_main_salary;
				$g_sdl += $show_main_salary;
			
				$g_ordinary_wage -= $deduction_amount;
				$g_shg -= $deduction_amount;
				$g_sdl -= $deduction_amount;


				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				if ($count_loan_deduction > 0) {
					foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
						} else {
							$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
						}
						$loan_de_amount += $er_loan;
					}
				} else {
					$loan_de_amount = 0;
				}
				$loan_de_amount = number_format(floatval($loan_de_amount), 2);

				// 2: all allowances
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
				if ($salary_allowances) {
					foreach ($salary_allowances as $sa) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$eallowance_amount = $sa->allowance_amount / 2;
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
						} else {
							$eallowance_amount = $sa->allowance_amount;
						}


						if (!empty($sa->salary_month)) {
							$g_additional_wage += $eallowance_amount;
						} else {
							if ($month_date_join == $pay_date){
								$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
							}
							$g_ordinary_wage += $eallowance_amount;
							if ($sa->id == 2) {
								$gross_allowance_amount = $eallowance_amount;
							}
						}

						if ($sa->sdl == 1) {
							$g_sdl += $eallowance_amount;
						}
						if ($sa->shg == 1) {
							$g_shg += $eallowance_amount;
						}

						$allowance_amount += $eallowance_amount;
					}
				}
				$gross_allowance_amount = $allowance_amount;




				// commissions
				$commissions_amount = 0;
				$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
				if ($commissions) {
					foreach ($commissions as $c) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$ecommissions_amount = $c->commission_amount / 2;
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
						} else {
							$ecommissions_amount = $c->commission_amount;
						}

						if ($c->commission_type == 9) {
							$g_ordinary_wage += $ecommissions_amount;
						} elseif ($c->commission_type == 10) {
							$g_additional_wage += $ecommissions_amount;
						}

						if ($c->sdl == 1) {
							$g_sdl += $ecommissions_amount;
						}
						if ($c->shg == 1) {
							$g_shg += $ecommissions_amount;
						}

						$commissions_amount += $ecommissions_amount;
					}
				}

				//share options
				$share_options_amount = 0;
				$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
				if ($share_options) {
					$eebr_amount = 0;
					$eris_amount = 0;
					foreach ($share_options as $s) {
						$scheme = $s->so_scheme;
						if ($scheme == 1) {
							$price_doe = $s->price_date_of_excercise;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;
							$amount = ($price_doe - $price_ex) * $no_shares;
							$eebr_amount += $amount;
						} else {
							$price_doe = $s->price_date_of_excercise;
							$price_dog = $s->price_date_of_grant;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;

							$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
							$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
							$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
						}
					}
					$share_options_amount = round($eebr_amount + $eris_amount, 2);
					$g_additional_wage += $share_options_amount;
					$g_sdl += $share_options_amount;
					$g_shg += $share_options_amount;
				}

				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				if ($count_other_payments > 0) {
					foreach ($other_payments->result() as $sl_other_payments) {
						if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
							if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$epayments_amount = $sl_other_payments->payments_amount / 2;
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}
								} else {
									$epayments_amount = $sl_other_payments->payments_amount;
								}

								if ($sl_other_payments->cpf_applicable == 1) {
									$g_additional_wage += $epayments_amount;
									$g_shg += $epayments_amount;
									$g_sdl += $epayments_amount;
								}

								$other_payments_amount += $epayments_amount;
							}
						} else {
							$first_date = new DateTime($sl_other_payments->date);
							if ($first_date->format('m-Y') == $pay_date) {
								$first_date =  new DateTime($sl_other_payments->date);
							} else {
								$first_date = new DateTime('01-' . $pay_date);
							}

							$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));

							if (!empty($sl_other_payments->end_date)) {
								$last_date = new DateTime($sl_other_payments->end_date);
								if ($last_date->format('m-Y') == $pay_date) {
									$last_date = new DateTime($sl_other_payments->end_date);
								}else if($last_date->format('m-Y') >= $pay_date){
									$last_date = $month_end_date_for_other;
								} else {
									$last_date = '';
								}
							} else {
								$last_date = $month_end_date_for_other;
							}
							if(!empty($last_date)){
								$last_date->modify('+1 day');
								$final_last_day = new DateTime($last_date->format('d-m-Y'));
								if ($final_last_day->format('m-Y') >= $pay_date) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}


									// it for no of working day
									$no_of_days_worked_for_other_payment = 0;
									$same_month_holidays_count_for_other_payment = 0;
									$interval = new DateInterval('P1D');
									$period = new DatePeriod($first_date, $interval, $last_date);
									foreach ($period as $p) {
										$p_day = $p->format('l');
										$p_date = $p->format('Y-m-d');

										//holidays in a month

										$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
										if ($is_holiday) {
											$same_month_holidays_count_for_other_payment += 1;
										}

										//working days excluding holidays based on office shift
										if ($p_day == 'Monday') {
											if ($office_shift[0]->monday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Tuesday') {
											if ($office_shift[0]->tuesday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Wednesday') {
											if ($office_shift[0]->wednesday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Thursday') {
											if ($office_shift[0]->thursday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Friday') {
											if ($office_shift[0]->friday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Saturday') {
											if ($office_shift[0]->saturday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Sunday') {
											if ($office_shift[0]->sunday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										}
									}

									$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
									
									$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
									


									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
									$other_payments_amount += $epayments_amount;
								}
							}
						}
					}
				} else {
					$other_payments_amount = 0;
				}


				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
	
				if ($unpaid_leaves) {
					$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				}

				// $g_ordinary_wage = $gross_pay;
				$g_shg = $gross_pay;
				$g_sdl = $gross_pay;
			

				$g_ordinary_wage -= $unpaid_leave_amount;


				// other benefit
				$other_benefit_mount = 0;
				$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
				foreach ($other_benefit_list->result() as $benefit_list) {
					$other_benefit_mount += $benefit_list->other_benefit_cost;
				}


				// statutory_deductions
				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if ($count_statutory_deductions > 0) {
					foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
						if ($system[0]->statutory_fixed != 'yes') {
							$sta_salary = $gross_pay;
							$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $st_amount / 2;
								} else {
									$single_sd = $st_amount;
								}
							} else {
								$single_sd = $st_amount;
							}
							$statutory_deductions_amount += $single_sd;
						} else {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
							} else {
								$single_sd = $sl_salary_statutory_deductions->deduction_amount;
							}
							$statutory_deductions_amount += $single_sd;
						}
					}
				} else {
					$statutory_deductions_amount = 0;
				}

				// overtime
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
				if ($overtime) {
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;
				}

				// make payment
				if ($system[0]->is_half_monthly == 1) {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $pay_date);
					$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $pay_date);
					if ($payment_check->num_rows() > 1) {

						//foreach($payment_last as $payment_half_last){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}

						$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
						//}
						//detail link
						$detail = '';
					} else if ($payment_check->num_rows() > 0) {

						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';

						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$detail = '';
					} else {

						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
					//detail link
					//$detail = '';
				} else {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					if ($payment_check->num_rows() > 0) {
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						if ($make_payment[0]->status == 0) {
							$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						} else if ($make_payment[0]->status == 3) {
							$status = '<span class="label label-warning">' . "Partially" . '</span>';
						}
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
					} else {

						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '">
							<button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '">
								<span class="fa fas fa-money"></span>
							</button>
						</span>';
						$delete = '';
					}
					//detail link
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
				}


				// employee accommodations
				$employee_accommodations = 0;
				$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
				foreach ($get_employee_accommodations as $get_employee_accommodation) {
					$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
					$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
					if ($period_from == $pay_date || $period_to == $pay_date) {
						if (!empty($get_employee_accommodation->rent_paid)) {
							$employee_accommodations += $get_employee_accommodation->rent_paid;
						}
					}
				}

				// employee claims
				$claim_amount = 0;
				$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
				foreach ($get_employee_claims->result() as $claims) {
					$date 	= 	date('m-Y', strtotime($claims->date));
					if ($date == $pay_date) {
						$claim_amount += $claims->amount;
					}
				}


				$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
				$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;

			
				// cpf calculation
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);

				$today = new DateTime('01-' . $pay_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}

				$cpf_employee 	= 	0;
				$cpf_employer	=	0;
				$cpf_total		=	0;
				$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
				if ($im_status) {
					$immigration_id = $im_status->immigration_id;
					if ($immigration_id == 2) {
						$issue_date = $im_status->issue_date;
						$i_date = new DateTime($issue_date);
						$today = new DateTime();
						$pr_age = $i_date->diff($today);
						$pr_age_year = $pr_age->y;
						$pr_age_month = $pr_age->m;
					}

					if ($immigration_id == 1 || $immigration_id == 2) {

						$ordinary_wage = $g_ordinary_wage;
						if ($ordinary_wage > $ordinary_wage_cap) {
							$ow = $ordinary_wage_cap;
						} else {
							$ow = $ordinary_wage;
						}

						//additional wage
						$additional_wage = $g_additional_wage;
						$aw = $g_additional_wage;
						$tw = $ow + $additional_wage;
						if ($im_status->issue_date != "") {
							if ($pr_age_year == 1) {

								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 2) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.45 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
										$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
										if ($count_total_cpf > 1776) {
											$total_cpf = 1776;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1110) {
											$cpf_employee = 1110;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(6 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.375 * ($tw - 500));
										$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
										$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
										if ($count_total_cpf > 1369) {
											$total_cpf = 1369;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 925) {
											$cpf_employee = 925;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
										if ($count_total_cpf > 814) {
											$total_cpf = 814;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 3 || $pr_age_year > 3) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = $total_cpf - $cpf_employee;
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
						}



						if ($immigration_id == 1) {

							if ($age_year <= 55) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(17 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.6 * ($tw - 500));
									$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
									$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
									if ($count_total_cpf > 2738) {
										$count_total_cpf = 2738;
									} else {
										$total_cpf = $count_total_cpf;
									}


									if ($count_cpf_employee > 1480) {
										$cpf_employee = 1480;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 55 && $age_year <= 60) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(15.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.51 * ($tw - 500));
									$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;

									$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
									if ($count_total_cpf > 2405) {
										$count_total_cpf = 2405;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 1258) {
										$cpf_employee = 1258;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 60 && $age_year <= 65) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(12 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.345 * ($tw - 500));
									$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
									$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

									if ($count_total_cpf > 1739) {
										$total_cpf = 1739;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 851) {
										$cpf_employee = 851;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 65 && $age_year <= 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(9 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.225 * ($tw - 500));
									$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
									$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

									if ($count_total_cpf > 1221) {
										$total_cpf = 1221;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 555) {
										$cpf_employee = 555;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(7.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.15 * ($tw - 500));
									$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
									$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

									if ($count_total_cpf > 925) {
										$total_cpf = 925;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 370) {
										$cpf_employee = 370;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							}
						}

						$total_net_salary = $total_net_salary - $cpf_employee;
						$cpf_total = $cpf_employee + $cpf_employer;

						$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
						$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
						$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
					}
				}


				$shg_fund_deduction_amount = 0;
				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);

				if ($employee_contributions && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$shg_fund_name = $contribution_type[0]->contribution;
					$shg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
				}
				$ashg_fund_deduction_amount = 0;

				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				if ($employee_ashg_contributions  && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$ashg_fund_name = $contribution_type[0]->contribution;

					$ashg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
				}

				// echo $total_net_salary;

				// $sdl_total_amount = 0;
				// if ($g_sdl > 1 && $g_sdl <= 800) {
				// 	$sdl_total_amount = 2;
				// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
				// 	$sdl_amount = (0.25 * $g_sdl) / 100;
				// 	$sdl_total_amount = $sdl_amount;
				// } elseif ($g_sdl > 4500) {
				// 	$sdl_total_amount = 11.25;
				// }


				$net_salary = number_format((float)$total_net_salary, 2, '.', '');
				$basic_salary = number_format((float)$basic_salary, 2, '.', '');
				if ($basic_salary == 0 || $basic_salary == '') {
					$fmpay = '';
				} else {
					$fmpay = $mpay;
				}


				$company_info = $this->Company_model->read_company_information($r->company_id);
				if (!is_null($company_info)) {
					$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
					$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
					//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
				} else {
					//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
					$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);

					$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);

					//$net_salary = $this->Xin_model->currency_sign($net_salary);	
					//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
					$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
				}

				$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';

				//action link
				$act = $detail . $fmpay . $delete;
				// $act = $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}

				$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
				$p = $payslips->result();
				$balance = $this->Xin_model->currency_sign($p[0]->balance_amount ?? 0, $r->user_id);
				$mode_of_payment = $r->payment_mode ?? '';


				return [
					'contribution' 	=>	$shg_fund_deduction_amount + $ashg_fund_deduction_amount,
					'salary'		=>	$net_salary,
					'cpf_employee'	=>	$cpf_employee,
					'unpaid_leave_amount'	=>	$unpaid_leave_amount
				];
				// $data[] = array(
				// 	$act,
				// 	$iemp_name,
				// 	$emp_payroll_wage,
				// 	// $basic_salary,
				// 	$this->Xin_model->currency_sign($gross_pay, $r->user_id),
				// 	$this->Xin_model->currency_sign($cpf_employee, $r->user_id),
				// 	$net_salary,
				// 	$balance,
				// 	$mode_of_payment,
				// 	$status
				// );
			}
		}
	}


	// Validate and add info in database > add monthly payment
	public function add_pay_monthly()
	{
		if ($this->input->post('add_type') == 'add_monthly_payment') {
			/* Define return | here result is used to return user data and error for error message */
			$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
			$Return['csrf_hash'] = $this->security->get_csrf_hash();

			$basic_salary = $this->input->post('gross_salary');

			$system = $this->Xin_model->read_setting_info(1);
			$user = $this->Xin_model->read_user_info($this->input->post('emp_id'));
			// office shift
			$office_shift = $this->Timesheet_model->read_office_shift_information($this->input->post('office_shift_id'));

			if ($system[0]->is_half_monthly == 1) {
				$is_half_monthly_payroll = 1;
			} else {
				$is_half_monthly_payroll = 0;
			}
			if ($this->input->post('blance_amount') > 0) {
				$status = 3;
			} else {
				$status = 0;
			}

			$jurl = random_string('alnum', 40);

			$basic_salary = 0;
			$gross_salary = 0;
			$leave_deductions = 0;
			$total_allowances = 0;
			$total_loan = 0;
			$total_overtime = 0;
			$total_commissions = 0;
			$total_statutory_deductions = 0;
			$total_employee_deduction = 0;
			$employee_claim = 0;
			$total_other_payments = 0;
			$total_share = 0;
			$additional_allowances = 0;

			if ($this->input->post('chk_gross_salary')) {
				$basic_salary = $this->input->post('gross_salary');
				$gross_salary = $this->input->post('gross_salary');
			}

			// if ($this->input->post('chk_leave_deductions')) {
				$leave_deductions = $this->input->post('leave_deductions');
			// }

			if ($this->input->post('chk_total_allowances')) {
				$total_allowances = $this->input->post('total_allowances');
			}

			if ($this->input->post('chk_total_commissions')) {
				$total_commissions = $this->input->post('total_commissions');
			}

			if ($this->input->post('chk_loan_de_amount')) {
				$total_loan = $this->input->post('total_loan');
			}

			if ($this->input->post('chk_total_overtime')) {
				$total_overtime = $this->input->post('total_overtime');
			}

			if ($this->input->post('chk_total_statutory_deductions')) {
				$total_statutory_deductions = $this->input->post('total_statutory_deductions');
			}

			if ($this->input->post('chk_total_other_payments')) {
				$total_other_payments = $this->input->post('total_other_payments');
			}

			if ($this->input->post('chk_total_employee_deduction')) {
				$total_employee_deduction = $this->input->post('total_employee_deduction');
			}

			if ($this->input->post('chk_employee_claim')) {
				$employee_claim = $this->input->post('employee_claim');
			}

			if ($this->input->post('chk_total_share')) {
				$total_share = $this->input->post('total_share');
			}

			

			$data = array(
				'employee_id' 			=> 	$this->input->post('emp_id'),
				'department_id' 		=> 	$this->input->post('department_id'),
				'company_id' 			=> 	$this->input->post('company_id'),
				'location_id' 			=> 	$this->input->post('location_id'),
				'designation_id' 		=> 	$this->input->post('designation_id'),
				'salary_month' 			=> 	$this->input->post('pay_date'),
				'basic_salary' 			=> 	$basic_salary,
				'gross_salary' 			=> 	$gross_salary,
				'net_salary' 			=> 	$this->input->post('net_salary'),
				'wages_type' 			=> 	$this->input->post('wages_type'),
				'is_half_monthly_payroll' 		=> 	$is_half_monthly_payroll,
				'total_commissions' 			=> 	$total_commissions,
				'total_statutory_deductions' 	=> $total_statutory_deductions,
				'total_other_payments' 	=> 	$total_other_payments,
				'total_allowances' 		=> 	$total_allowances,
				'total_loan' 			=> 	$total_loan,
				'total_overtime' 		=> 	$this->input->post('total_overtime_time'),
				'total_overtime_amount' => 	$total_overtime,
				'claim_amount' 			=> 	$employee_claim,
				'cpf_employee_amount' 	=> 	$this->input->post('total_cpf_employee'),
				'cpf_employer_amount' 	=> 	$this->input->post('total_cpf_employer'),
				'leave_deduction' 		=> 	$leave_deductions,
				'contribution_fund' 	=> 	$this->input->post('total_fund_contribution'),
				'share_option_amount' 	=> 	$total_share,
				'additonal_allowance' 	=> 	$additional_allowances,
				'deduction_amount' 		=> 	$total_employee_deduction,
				'balance_amount' 		=> 	$this->input->post('balance_amount'),
				'is_payment' 			=> 	'1',
				'status' 				=> 	$this->input->post('balance_amount') > 0 ? 2 : 1,
				'payslip_type' 			=> 	'full_monthly',
				'payslip_key' 			=> 	$jurl,
				'year_to_date' 			=> 	date('d-m-Y'),
				'created_at' 			=> 	date('d-m-Y h:i:s'),
				'check_id'				=>	$this->input->post('check_id')
			);
			$result = $this->Payroll_model->add_salary_payslip($data);

			if ($result) {

				$user = $this->Xin_model->read_user_info($this->input->post('emp_id'));

				$basic_salary = $user[0]->basic_salary;

				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				$g_ordinary_wage += $basic_salary;
				$g_shg += $basic_salary;
				$g_sdl += $basic_salary;

				

				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $this->input->post('pay_date'));
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$p_day = $p->format('l');
					$p_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $p_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($p_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						$pay_date_month = new DateTime('01-' . $this->input->post('pay_date'));
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$holiday_array_new = array();

						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {

								if ($office_shift[0]->monday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
					}
				}
				
				
				$month_date_join = date('m-Y', strtotime($user[0]->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $p_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($user[0]->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $this->input->post('pay_date')) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$p_date = $p->format('Y-m-d');

						//holidays in a month

						$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}

					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}

				
				if ($month_date_join == $this->input->post('pay_date')) {
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				} else {
					$show_main_salary = $basic_salary;
				}

				

				// set allowance
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if ($this->input->post('chk_total_allowances')) {
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								// for no of working day
								if ($month_date_join == $this->input->post('pay_date')) {
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}
				
							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}
				
							$allowance_amount += $eallowance_amount;

							$allowance_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'allowance_title' 	=> 	$sa->allowance_title,
								'allowance_amount' 	=> 	$eallowance_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);
	
						}
					}
				}
				$gross_allowance_amount = $allowance_amount;


				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($this->input->post('chk_total_employee_deduction') || $employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						$xin_salary_deduction = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$this->input->post('emp_id'),
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'name' 				=> 	$deduction->deduction_type,
							'amount' 			=> 	$deduction->amount,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}

					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($this->input->post('emp_id'), $this->input->post('pay_date'));
					foreach ($other_benefit_list->result() as $other_benefit) {
						$xin_salary_deduction = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$this->input->post('emp_id'),
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'name' 				=> 	$other_benefit->other_benefit,
							'amount' 			=> 	$other_benefit->other_benefit_cost,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}

					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($this->input->post('emp_id'), $this->input->post('pay_date'));

					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $this->input->post('pay_date') || $period_to == $this->input->post('pay_date')) {
							$xin_salary_deduction = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'name' 				=> 	$get_employee_accommodation->title,
								'amount' 			=> 	$get_employee_accommodation->rent_paid,
	
							);
							$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
						}
					}

				}


				// commissions
				if ($this->input->post('chk_total_commissions')) {
					$commission_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommission_amount = $c->commission_amount / 2;
								} else {
									$ecommission_amount = $c->commission_amount;
								}
							} else {
								$ecommission_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommission_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommission_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommission_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommission_amount;
							}

							$commissions_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'commission_id' 	=> 	$c->commission_type,
								'commission_amount' => 	$ecommission_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_commissions($commissions_data);
							$commission_amount += $ecommission_amount;
						}
					}
				}

				//share options
				if ($this->input->post('chk_total_share')) {
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;

						$share_options_data = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$this->input->post('emp_id'),
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'amount' 			=> 	round($share_options_amount, 2)
						);
						$this->Payroll_model->add_salary_payslip_share_options($share_options_data);
					}
				}


				// set other payments
				$other_payments_amount = 0;
				if ($this->input->post('chk_total_other_payments')) {
					$salary_other_payments = $this->Employees_model->read_salary_other_payments($this->input->post('emp_id'));
					$count_other_payment = $this->Employees_model->count_employee_other_payments($this->input->post('emp_id'));
					if ($count_other_payment > 0) {
						foreach ($salary_other_payments as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($this->input->post('pay_date') == date('m-Y', strtotime($sl_other_payments->date))) {

									$esl_other_payments = $sl_other_payments->payments_amount;
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $esl_other_payments / 2;
										} else {
											$epayments_amount = $esl_other_payments;
										}
									} else {
										$epayments_amount = $esl_other_payments;
									}

									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
									$other_payments_amount += $epayments_amount;
									$other_payments_data = array(
										'payslip_id' 		=> 	$result,
										'employee_id' 		=> 	$this->input->post('emp_id'),
										'salary_month' 		=> 	$this->input->post('pay_date'),
										'payments_title' 	=> 	$sl_other_payments->payments_title,
										'payments_amount' 	=> 	$epayments_amount,
										'created_at' 		=> 	date('d-m-Y h:i:s')
									);
									$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $this->input->post('pay_date')) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $this->input->post('pay_date'));
								}
				
								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
				
								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $this->input->post('pay_date')) {
										$last_date = new DateTime($sl_other_payments->end_date);
									} else if ($last_date->format('m-Y') >= $this->input->post('pay_date')) {
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
				
								if (!empty($last_date)) {
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $this->input->post('pay_date')) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
				
				
										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');
				
											//holidays in a month
				
											$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $this->input->post('pay_date'));
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}
				
											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}
				
										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
				
				
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
										$other_payments_data = array(
											'payslip_id' 		=> 	$result,
											'employee_id' 		=> 	$this->input->post('emp_id'),
											'salary_month' 		=> 	$this->input->post('pay_date'),
											'payments_title' 	=> 	$sl_other_payments->payments_title,
											'payments_amount' 	=> 	$epayments_amount,
											'created_at' 		=> 	date('d-m-Y h:i:s')
										);
										$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
									}
								}
							}
						}
					}
				}


				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
	
				if ($unpaid_leaves) {
					$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				}
				// unpaid leave
				// if ($this->input->post('chk_leave_deductions')) {
					if ($unpaid_leaves) {
						foreach ($leave_period as $l) {
							$is_half = $l['is_half'];
							$leave_dates = $l['leave_date'];
							$leave_day_pay = round(($basic_salary + $allowance_amount + $other_payments_amount) / $no_of_working_days, 2);
							if ($is_half) {
								$leave_day_pay = $leave_day_pay / 2;
							}
							foreach ($leave_dates as $ld) {
								$unpaid_leave_data = array(
									'payslip_id' 		=> 	$result,
									'employee_id' 		=> 	$this->input->post('emp_id'),
									'salary_month' 		=> 	$this->input->post('pay_date'),
									'leave_date' 		=> 	$ld,
									'leave_amount' 		=> 	$leave_day_pay,
									'is_half' 			=> 	$is_half,
									'total_leave_amount' => $unpaid_leave_amount
								);
								$this->Payroll_model->add_salary_payslip_leave_deduction($unpaid_leave_data);
							}
						}
					}
				// }


				// employee claims
				if ($this->input->post('chk_employee_claim')){
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($this->input->post('emp_id'));
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $this->input->post('pay_date')) {
							$claim_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'claim_type' 		=> 	$claims->name,
								'amount' 			=> 	$claims->amount,
								'year'				=>	$claims->claim_year,
								'date'				=>	$claims->date,
								'employee_claim_id'	=>	$claims->claim_id
							);
							$this->Payroll_model->add_salary_payslip_claim($claim_data);
						}
					}
				}
			

				// set statutory_deductions
				if ($this->input->post('chk_total_statutory_deductions')) {
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($this->input->post('emp_id'));
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($this->input->post('emp_id'));
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') :
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							else :
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							endif;


							$statutory_deduction_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'deduction_title' 	=> 	$sl_statutory_deductions->deduction_title,
								'deduction_amount' 	=> 	$statutory_deductions_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);

						}
					}
				}

				// set loan
				if ($this->input->post('chk_loan_de_amount')) {
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($this->input->post('emp_id'));
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($this->input->post('emp_id'));
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							$esl_salary_loan_deduction = $sl_salary_loan_deduction->loan_deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eloan_deduction_amount = $esl_salary_loan_deduction / 2;
								} else {
									$eloan_deduction_amount = $esl_salary_loan_deduction;
								}
							} else {
								$eloan_deduction_amount = $esl_salary_loan_deduction;
							}
							$loan_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'loan_title' 		=> 	$sl_salary_loan_deduction->loan_deduction_title,
								'loan_amount' 		=> 	$eloan_deduction_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
						}
					}
				}


				// overtime
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($overtime) {
					$ot_days = 0;
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
						$ot_days += 1;
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($this->input->post('emp_id'));

					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;

						$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}

					$overtime_data = array(
						'payslip_id' 			=> 	$result,
						'employee_id' 			=> 	$this->input->post('emp_id'),
						'overtime_salary_month' => 	$this->input->post('pay_date'),
						'overtime_no_of_days' 	=> 	$ot_days,
						'overtime_hours' 		=> 	$ot_hrs,
						'overtime_rate' 		=> 	$rate,
						'total_overtime' 		=> 	$overtime_amount,
						'created_at' 			=> 	date('d-m-Y h:i:s')
					);
					$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				}

				//cpf
				$total_cpf =  $this->input->post('total_cpf');
				if ($total_cpf && $total_cpf > 0) {
					$ow_paid = $this->input->post('ow_paid');
					$cpf_data = [
						'payslip_id' 	=> 	$result,
						'month_year' 	=> 	'01-' . $this->input->post('pay_date'),
						'ow_paid'		=> 	$ow_paid,
						'ow_cpf'		=> 	$this->input->post('ow_cpf'),
						'ow_cpf_employer'	=> $this->input->post('ow_cpf_employer'),
						'ow_cpf_employee'	=> $this->input->post('ow_cpf_employee'),
						'aw_paid'		=> 	$this->input->post('aw_paid'),
						'aw_cpf'		=> 	$this->input->post('aw_cpf'),
						'aw_cpf_employer'	=> $this->input->post('aw_cpf_employer'),
						'aw_cpf_employee'	=> $this->input->post('aw_cpf_employee')
					];

					$cpf_payslip = $this->Cpf_payslip_model->add_cpf_payslip($cpf_data);
				}

				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' 			=> 	$result,
						'contribution_id' 		=> 	$contribution_id,
						'contribution_amount' 	=> $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}


				//ASHG Fund Contributions
				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' 			=> 	$result,
						'contribution_id' 		=> 	$contribution_id,
						'contribution_amount' 	=> 	$contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//sdl
				$sdl = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl = 11.25;
				}

				$cdata = array(
					'payslip_id'		 	=> 	$result,
					'contribution_id' 		=> 	5,
					'contribution_amount' 	=> 	$sdl
				);
				$this->Contribution_fund_model->setContributionPayslip($cdata);

				$Return['result'] = $this->lang->line('xin_success_payment_paid');
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
			$this->output($Return);
			exit;
		}
	}

	// payment history
	public function payslip()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		
		$key = $this->uri->segment(5);

		$result = $this->Payroll_model->read_salary_payslip_info_key($key);
		
		if (is_null($result)) {
			redirect('admin/payroll/generate_payslip');
		}
		$p_method = '';
		$payment_method = $this->Xin_model->read_payment_method($result[0]->payment_method);
		if(!is_null($payment_method)){
		  $p_method = $payment_method[0]->method_name;
		} else {
		  $p_method = '--';
		}
		// get addd by > template
		$user = $this->Xin_model->read_user_info($result[0]->employee_id);
		// user full name
		if (!is_null($user)) {
			$first_name = $user[0]->first_name;
			$last_name = $user[0]->last_name;
		} else {
			$first_name = '--';
			$last_name = '--';
		}
		// get designation
		$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($designation)) {
			$designation_name = $designation[0]->designation_name;
		} else {
			$designation_name = '--';
		}

		// department
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$department_name = $department[0]->department_name;
		} else {
			$department_name = '--';
		}


		$data = array(
			'title' 				=> 	$this->lang->line('xin_payroll_employee_payslip') . ' | ' . $this->Xin_model->site_title(),
			'first_name' 			=> 	$first_name,
			'last_name' 			=> 	$last_name,
			'employee_id' 			=> 	$user[0]->employee_id,
			'euser_id' 				=> 	$user[0]->user_id,
			'id_no' 				=> 	$user[0]->id_no,
			'date_of_birth' 		=> 	$user[0]->date_of_birth,
			'contact_no' 			=> 	$user[0]->contact_no,
			'date_of_joining' 		=> 	$user[0]->date_of_joining,
			'department_name' 		=> 	$department_name,
			'designation_name' 		=> 	$designation_name,
			'date_of_joining' 		=> 	$user[0]->date_of_joining,
			'profile_picture' 		=> 	$user[0]->profile_picture,
			'gender' 				=> 	$user[0]->gender,
			'make_payment_id' 		=> 	$result[0]->payslip_id,
			'wages_type' 			=> 	$result[0]->wages_type,
			'payment_status' 		=> 	($result[0]->status == 0 ? 'Pending' : 'Paid'),
			'payment_date' 			=> 	$result[0]->salary_month,
			'year_to_date' 			=> 	$result[0]->year_to_date,
			'basic_salary' 			=> 	$result[0]->basic_salary,
			'daily_wages' 			=> 	$result[0]->daily_wages,
			'payment_method' 		=> 	$p_method,
			'total_allowances' 		=> 	$result[0]->total_allowances,
			'total_loan' 			=> 	$result[0]->total_loan,
			'total_overtime' 		=> 	$result[0]->total_overtime,
			'total_commissions'	 	=> 	$result[0]->total_commissions,
			'total_statutory_deductions' 	=> 	$result[0]->total_statutory_deductions,
			'total_other_payments' 	=> 	$result[0]->total_other_payments,
			'share_option_amount' 	=> 	$result[0]->share_option_amount,
			'net_salary' 			=> 	$result[0]->net_salary,
			'claim_amount' 			=> 	$result[0]->claim_amount,
			'other_payment' 		=> 	$result[0]->other_payment ?? 0,
			'payslip_key' 			=> 	$result[0]->payslip_key,
			'payslip_type' 			=> 	$result[0]->payslip_type,
			'hours_worked' 			=> 	$result[0]->hours_worked,
			'pay_comments' 			=> 	$result[0]->pay_comments,
			'deduction_amount' 		=> 	$result[0]->deduction_amount,
			'is_payment' 			=> 	$result[0]->is_payment,
			'approval_status' 		=> 	$result[0]->status,
			'gross_salary'			=> 	$result[0]->net_salary,
			'cpf_employee' 			=> 	$result[0]->cpf_employee_amount,
			'cpf_employer' 			=> 	$result[0]->cpf_employer_amount,
			'total_overtime_amount' => 	$result[0]->total_overtime_amount,
			'additional_fund' 		=> 	$result[0]->cpf_employer_amount,
			'additonal_allowance' 	=> 	$result[0]->additonal_allowance,
			'hourly_rate' 			=> 	$result[0]->gross_salary,
			'mapping_data' 			=> 	$this->Payroll_model->get_mapping_data($result[0]->payslip_id),
			'leave_deduction'		=>	$result[0]->leave_deduction,
		);

		$data['breadcrumbs'] = $this->lang->line('xin_payroll_employee_payslip');
		$data['path_url'] = 'payslip';
		$role_resources_ids = $this->Xin_model->user_role_resource();

		//Contribution funds
		$contribution = $this->Contribution_fund_model->getContributionPayslip($result[0]->payslip_id);
		if ($contribution) {
			$contribution_fund = array();
			foreach ($contribution as $i => $c) {
				if ($c->contribution_id != 5) {
					$contribution_fund[$i]['contribution_id'] = $c->contribution_id;
					$contribution_fund[$i]['contribution'] = $c->contribution;
					$contribution_fund[$i]['contribution_amount'] = $c->contribution_amount;
				}
			}
			$data['contribution_fund'] = $contribution_fund;
		}


		if (!empty($session)) {
			if ($result[0]->payslip_type == 'hourly') {
				$pay_basic = 0;

				if ($this->input->get('ismobile') == 'true') {
					// print_r($data);exit();
					$data['subview'] = $this->load->view("admin/payroll/payslip_m", $data, TRUE);
					$this->load->view('admin/layout/pms/layout_pms', $data);
				} else {

					$data['subview'] = $this->load->view("admin/payroll/hourly_payslip", $data, TRUE);
					$this->load->view('admin/layout/layout_main', $data); //page load

				}
			} else {
				$data['subview'] = $this->load->view("admin/payroll/payslip", $data, TRUE);
				$this->load->view('admin/layout/layout_main', $data); //page load
			}
		} else {
			redirect('admin/');
		}
	}


	// for bulk payment list
	public function payslip_list_bulk()
	{

		$data['title'] = $this->Xin_model->site_title();
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			$this->load->view("admin/payroll/generate_payslip", $data);
		} else {
			redirect('admin/');
		}
		// Datatables Variables
		$draw 	= intval($this->input->get("draw"));
		$start 	= intval($this->input->get("start"));
		$length = intval($this->input->get("length"));

		// date and employee id/company id
		// payment month
		$pay_date = $this->input->get("month_year");

		$role_resources_ids = $this->Xin_model->user_role_resource();
		$user_info = $this->Xin_model->read_user_info($session['user_id']);

		if ($user_info[0]->user_role_id == 1 || in_array('314', $role_resources_ids)) {
			if ($this->input->get("employee_id") == 0 && $this->input->get("company_id") == 0) {
				$payslip = $this->Employees_model->get_employees_payslip($pay_date);
			} else if ($this->input->get("employee_id") == 0 && $this->input->get("company_id") != 0) {
				$payslip = $this->Payroll_model->get_comp_template($this->input->get("company_id"), 0, $pay_date);
			} else if ($this->input->get("employee_id") != 0 && $this->input->get("company_id") != 0) {
				$payslip = $this->Payroll_model->get_employee_comp_template($this->input->get("company_id"), $this->input->get("employee_id"), $pay_date);
			} else {
				$payslip = $this->Employees_model->get_employees_payslip($pay_date);
			}
		} else {
			$payslip = $this->Payroll_model->get_employee_comp_template($user_info[0]->company_id, $session['user_id']);
		}


		$system = $this->Xin_model->read_setting_info(1);
		$data = array();
		foreach ($payslip->result() as $r) {
			$exit_employee = $this->Employees_model->get_employee_exit($r->user_id);

			if (count($exit_employee) > 0) {
				$e_date = date('Y-m-d', strtotime($exit_employee[0]->exit_date));
				$exit_date = date('m-Y', strtotime($e_date));
				if ($exit_date >= $pay_date) {
					$emp_name = $r->first_name . ' ' . $r->last_name;
					// office shift
					$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);
	
					//overtime request
					$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
					$re_hrs_old_int1 = 0;
					$re_hrs_old_seconds = 0;
					$re_pcount = 0;
					foreach ($overtime_count as $overtime_hr) {
						$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
						$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
						$re_interval_late = $request_clock_in->diff($request_clock_out);
						$re_hours_r  = $re_interval_late->format('%h');
						$re_minutes_r = $re_interval_late->format('%i');
						$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';
	
						$re_str_time = $re_total_time;
	
						$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);
	
						sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$re_hrs_old_int1 += $re_hrs_old_seconds;
	
						$re_pcount = gmdate("H", $re_hrs_old_int1);
					}
	
					$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
					$hrs_old_int1 = 0;
					$pcount = 0;
					foreach ($result->result() as $hour_work) {
						$clock_in =  new DateTime($hour_work->clock_in);
						$clock_out =  new DateTime($hour_work->clock_out);
						$interval_late = $clock_in->diff($clock_out);
						$hours_r  = $interval_late->format('%h');
						$minutes_r = $interval_late->format('%i');
						$total_time = $hours_r . ":" . $minutes_r . ":" . '00';
	
						$str_time = $total_time;
	
						$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);
	
						sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$hrs_old_int1 += $hrs_old_seconds;
	
						$pcount = gmdate("H", $hrs_old_int1);
					}
					$pcount = $pcount + $re_pcount;
	
					// get company
					$company = $this->Xin_model->read_company_info($r->company_id);
					if (!is_null($company)) {
						$comp_name = $company[0]->name;
					} else {
						$comp_name = '--';
					}
	
					/**
					 * Local Variable
					 */
					$g_ordinary_wage = 0;
					$g_additional_wage = 0;
					$g_shg = 0;
					$g_sdl = 0;
	
					// 1: salary type
					if ($r->wages_type == 1) {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					} else if ($r->wages_type == 2) {
						$wages_type = $this->lang->line('xin_employee_daily_wages');
						if ($pcount > 0) {
							$basic_salary = $pcount * $r->basic_salary;
						} else {
							$basic_salary = $pcount;
						}
						$p_class = 'emo_hourly_pay';
						$view_p_class = 'hourlywages_template_modal';
					} else {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					}
	
					$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
					$check_payment = $check ? explode(',', $check[0]->check_id) : [];
					
					if (in_array('chk_gross_salary', $check_payment)) {
						$basic_salary = 0;
					}
	
					$database_cpf_employee = 0;
					if($check){
						foreach($check as $c){
							$database_cpf_employee += $c->cpf_employee_amount;
						}
					}
					$final_contribution_amount = $this->contribution_calculation(['user_id'=>$r->user_id,"pay_date"=>$pay_date]);
	
					$database_cpf_employee = $final_contribution_amount['cpf_employee'] - $database_cpf_employee;
	
					
	
					// employee deduction
					$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
					$pa_month = date('m-Y', strtotime('01-' . $pay_date));
					$deduction_amount = 0;
					if (!in_array('chk_total_employee_deduction', $check_payment)) {
						if ($employee_deduction) {
							foreach ($employee_deduction as $deduction) {
								if ($deduction->type_id == 1) {
									$deduction_amount +=  $deduction->amount;
								}
								if ($deduction->type_id == 2) {
									$from_month_year = date('m-Y', strtotime($deduction->from_date));
									$to_month_year = date('d-m-Y', strtotime($deduction->to_date));
	
	
									if ($from_month_year != "" && $to_month_year != "") {
										if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
											$deduction_amount +=  $deduction->amount;
										}
									}
								}
							}
						}
					}
	
	
	
					//3: Gross rate of pay (unpaid leave deduction)
					$holidays_count = 0;
					$no_of_working_days = 0;
					$month_start_date = new DateTime('01-' . $pay_date);
					$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
					$month_end_date->modify('+1 day');
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($month_start_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$period_day = $p->format('l');
						$period_date = $p->format('Y-m-d');
	
						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
						if ($is_holiday) {
							$holidays_count += 1;
						}
	
						//working days excluding holidays based on office shift
						if ($period_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_working_days += 1;
							}
						}
					}
	
					//unpaid leave
					$unpaid_leave_amount = 0;
					$leaves_taken_count = 0;
					$leave_period = array();
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							$pay_date_month = new DateTime('01-' . $pay_date);
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);
	
							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {
									if ($office_shift[0]->monday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
						}
					}
	
					// if joining date and pay date same then this logic work
					$month_date_join = date('m-Y', strtotime($r->date_of_joining));
					$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
					$month_last_date = date('m-Y', strtotime($lastday));
	
					$first_date =  new DateTime($r->date_of_joining);
					$no_of_days_worked = 0;
					$same_month_holidays_count = 0;
					if ($month_date_join == $pay_date) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$m_p_date = $p->format('Y-m-d');
	
						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}
	
						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}
					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
					} else {
						// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
						$no_of_days_worked = $no_of_working_days -  $holidays_count;
					}
	
	
					if ($month_date_join == $pay_date){
						$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
					}else{
						$show_main_salary = $basic_salary;
					}
				
					$g_ordinary_wage += $show_main_salary;
					$g_shg += $show_main_salary;
					$g_sdl += $show_main_salary;
				
					$g_ordinary_wage -= $deduction_amount;
					$g_shg -= $deduction_amount;
					$g_sdl -= $deduction_amount;
	
	
					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
					$loan_de_amount = 0;
					if (!in_array('chk_loan_de_amount', $check_payment)) {
						if ($count_loan_deduction > 0) {
							foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
									} else {
										$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
									}
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
								$loan_de_amount += $er_loan;
							}
						} else {
							$loan_de_amount = 0;
						}
						$loan_de_amount = number_format(floatval($loan_de_amount), 2);
					}
					
					// 2: all allowances
					$allowance_amount = 0;
					$gross_allowance_amount = 0;
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
					if (!in_array('chk_total_allowances', $check_payment)) {
						if ($salary_allowances) {
							foreach ($salary_allowances as $sa) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$eallowance_amount = $sa->allowance_amount / 2;
									} else {
										$eallowance_amount = $sa->allowance_amount;
									}
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
	
	
								if (!empty($sa->salary_month)) {
									$g_additional_wage += $eallowance_amount;
								} else {
									if ($month_date_join == $pay_date){
										$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
									}
									$g_ordinary_wage += $eallowance_amount;
									if ($sa->id == 2) {
										$gross_allowance_amount = $eallowance_amount;
									}
								}
	
								if ($sa->sdl == 1) {
									$g_sdl += $eallowance_amount;
								}
								if ($sa->shg == 1) {
									$g_shg += $eallowance_amount;
								}
	
								$allowance_amount += $eallowance_amount;
							}
						}
						$gross_allowance_amount = $allowance_amount;
					}
	
	
					// commissions
					$commissions_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
					if (!in_array('chk_total_commissions', $check_payment)) {
						if ($commissions) {
							foreach ($commissions as $c) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$ecommissions_amount = $c->commission_amount / 2;
									} else {
										$ecommissions_amount = $c->commission_amount;
									}
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
	
								if ($c->commission_type == 9) {
									$g_ordinary_wage += $ecommissions_amount;
								} elseif ($c->commission_type == 10) {
									$g_additional_wage += $ecommissions_amount;
								}
	
								if ($c->sdl == 1) {
									$g_sdl += $ecommissions_amount;
								}
								if ($c->shg == 1) {
									$g_shg += $ecommissions_amount;
								}
	
								$commissions_amount += $ecommissions_amount;
							}
						}
					}
	
					//share options
					$share_options_amount = 0;
					if (!in_array('chk_total_share', $check_payment)) {
						$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
						if ($share_options) {
							$eebr_amount = 0;
							$eris_amount = 0;
							foreach ($share_options as $s) {
								$scheme = $s->so_scheme;
								if ($scheme == 1) {
									$price_doe = $s->price_date_of_excercise;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;
									$amount = ($price_doe - $price_ex) * $no_shares;
									$eebr_amount += $amount;
								} else {
									$price_doe = $s->price_date_of_excercise;
									$price_dog = $s->price_date_of_grant;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;
	
									$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
									$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
									$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
								}
							}
							$share_options_amount = round($eebr_amount + $eris_amount, 2);
							$g_additional_wage += $share_options_amount;
							$g_sdl += $share_options_amount;
							$g_shg += $share_options_amount;
						}
					}
	
					
					// otherpayments
					$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
					$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
					$other_payments_amount = 0;
					if (!in_array('chk_total_other_payments', $check_payment)) {
						if ($count_other_payments > 0) {
							foreach ($other_payments->result() as $sl_other_payments) {
								if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
									if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
	
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
	
										$other_payments_amount += $epayments_amount;
									}
								} else {
									$first_date = new DateTime($sl_other_payments->date);
									if ($first_date->format('m-Y') == $pay_date) {
										$first_date =  new DateTime($sl_other_payments->date);
									} else {
										$first_date = new DateTime('01-' . $pay_date);
									}
	
									$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
	
									if (!empty($sl_other_payments->end_date)) {
										$last_date = new DateTime($sl_other_payments->end_date);
										if ($last_date->format('m-Y') == $pay_date) {
											$last_date = new DateTime($sl_other_payments->end_date);
										} else if($last_date->format('m-Y') >= $pay_date){
											$last_date = $month_end_date_for_other;
										} else {
											$last_date = '';
										}
									} else {
										$last_date = $month_end_date_for_other;
									}
									if(!empty($last_date)){
										$last_date->modify('+1 day');
										$final_last_day = new DateTime($last_date->format('d-m-Y'));
										if ($final_last_day->format('m-Y') >= $pay_date) {
											if ($system[0]->is_half_monthly == 1) {
												if ($system[0]->half_deduct_month == 2) {
													$epayments_amount = $sl_other_payments->payments_amount / 2;
												} else {
													$epayments_amount = $sl_other_payments->payments_amount;
												}
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
	
	
											// it for no of working day
											$no_of_days_worked_for_other_payment = 0;
											$same_month_holidays_count_for_other_payment = 0;
											$interval = new DateInterval('P1D');
											$period = new DatePeriod($first_date, $interval, $last_date);
											foreach ($period as $p) {
												$p_day = $p->format('l');
												$p_date = $p->format('Y-m-d');
	
												//holidays in a month
	
												$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
												if ($is_holiday) {
													$same_month_holidays_count_for_other_payment += 1;
												}
	
												//working days excluding holidays based on office shift
												if ($p_day == 'Monday') {
													if ($office_shift[0]->monday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Tuesday') {
													if ($office_shift[0]->tuesday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Wednesday') {
													if ($office_shift[0]->wednesday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Thursday') {
													if ($office_shift[0]->thursday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Friday') {
													if ($office_shift[0]->friday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Saturday') {
													if ($office_shift[0]->saturday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												} else if ($p_day == 'Sunday') {
													if ($office_shift[0]->sunday_in_time != '') {
														$no_of_days_worked_for_other_payment += 1;
													}
												}
											}
	
											$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
											$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
	
	
											if ($sl_other_payments->cpf_applicable == 1) {
												$g_additional_wage += $epayments_amount;
												$g_shg += $epayments_amount;
												$g_sdl += $epayments_amount;
											}
											$other_payments_amount += $epayments_amount;
										}
									}
								}
							}
						} else {
							$other_payments_amount = 0;
						}
					}
	
					$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
		
					if ($unpaid_leaves) {
						$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
					}
					
					// $g_ordinary_wage = $gross_pay;
					$g_shg = $gross_pay;
					$g_sdl = $gross_pay;
	
					$g_ordinary_wage -= $unpaid_leave_amount;
	
					
	
					// other benefit
					$other_benefit_mount = 0;
					if (!in_array('chk_total_other_payments', $check_payment)) {
						$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
						foreach ($other_benefit_list->result() as $benefit_list) {
							$other_benefit_mount += $benefit_list->other_benefit_cost;
						}
					}
	
	
					// statutory_deductions
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
					$statutory_deductions_amount = 0;
					if (!in_array('chk_total_statutory_deductions', $check_payment)) {
						if ($count_statutory_deductions > 0) {
							foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
								if ($system[0]->statutory_fixed != 'yes') {
									$sta_salary = $gross_pay;
									$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$single_sd = $st_amount / 2;
										} else {
											$single_sd = $st_amount;
										}
									} else {
										$single_sd = $st_amount;
									}
									$statutory_deductions_amount += $single_sd;
								} else {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
										} else {
											$single_sd = $sl_salary_statutory_deductions->deduction_amount;
										}
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
									$statutory_deductions_amount += $single_sd;
								}
							}
						} else {
							$statutory_deductions_amount = 0;
						}
					}
	
					// overtime
					$overtime_amount = 0;
					if (!in_array('chk_total_overtime', $check_payment)) {
						$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
						if ($overtime) {
							$ot_hrs = 0;
							$ot_mins = 0;
							foreach ($overtime as $ot) {
								$total_hours = explode(':', $ot->total_hours);
								$ot_hrs += $total_hours[0];
								$ot_mins += $total_hours[1];
							}
							if ($ot_mins > 0) {
								$ot_hrs += round($ot_mins / 60, 2);
							}
	
							//overtime rate
							$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
							if ($overtime_rate) {
								$rate = $overtime_rate->overtime_pay_rate;
							} else {
								$week_hours = 44;
								$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
								$rate = $rate * 1.5;
							}
	
							if ($ot_hrs > 0) {
								$overtime_amount = round($ot_hrs * $rate, 2);
							}
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$overtime_amount = $overtime_amount / 2;
								}
							}
							$g_ordinary_wage += $overtime_amount;
							$g_sdl += $overtime_amount;
						}
					}
	
					
	
					$payment_check = $this->Payroll_model->check_make_payment_payslip_for_first_payment($r->user_id, $pay_date);
					$payment_check_final = $this->Payroll_model->check_make_payment_payslip_for_final_payment($r->user_id, $pay_date);
					$balance = 0;
					$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
					if($check && $check[0]->balance_amount > 0){
						$balance = $check[0]->balance_amount;
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
						$status = '<span class="label label-warning">' . "Partially Paid" . '</span>';
	
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
						
						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$delete  = $delete;
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						
					}else if($check && $check[0]->balance_amount == 0){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
						$status = '<span class="label label-success">Paid</span>';
	
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
						
						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$delete  = $delete;
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						
					}else {
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
							$delete = '';
							$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
							$balance = $this->Xin_model->currency_sign(0, $r->user_id);
						}
	
					
					// employee accommodations
					$employee_accommodations = 0;
					if (!in_array('chk_total_employee_deduction', $check_payment)) {
						$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
						foreach ($get_employee_accommodations as $get_employee_accommodation) {
							$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
							$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
							if ($period_from == $pay_date || $period_to == $pay_date) {
								if (!empty($get_employee_accommodation->rent_paid)) {
									$employee_accommodations += $get_employee_accommodation->rent_paid;
								}
							}
						}
					}
	
					// employee claims
					$claim_amount = 0;
					if (!in_array('chk_employee_claim', $check_payment)) {
						$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
						foreach ($get_employee_claims->result() as $claims) {
							$date 	= 	date('m-Y', strtotime($claims->date));
							if ($date == $pay_date) {
								$claim_amount += $claims->amount;
							}
						}
					}
	
	
	
					$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
					$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
					$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;
	
	
					// cpf calculation
					$emp_dob = $r->date_of_birth;
					$dob = new DateTime($emp_dob);
	
					$today = new DateTime('01-' . $pay_date);
					$age = $dob->diff($today);
					$age_year = $age->y;
					$age_month = $age->m;
	
					$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
					$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
					$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;
	
					if ($age_month > 0) {
						$age_year = $age_year + 1;
					}
	
					$cpf_employee 	= 	0;
					$cpf_employer	=	0;
	
					$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
					if ($im_status) {
						$immigration_id = $im_status->immigration_id;
						if ($immigration_id == 2) {
							$issue_date = $im_status->issue_date;
							$i_date = new DateTime($issue_date);
							$today = new DateTime();
							$pr_age = $i_date->diff($today);
							$pr_age_year = $pr_age->y;
							$pr_age_month = $pr_age->m;
						}
	
						if ($immigration_id == 1 || $immigration_id == 2) {
	
							$ordinary_wage = $g_ordinary_wage;
							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}
	
							//additional wage
							$additional_wage = $g_additional_wage;
							$aw = $g_additional_wage;
							$tw = $ow + $additional_wage;
							if ($im_status->issue_date != "") {
								if ($pr_age_year == 1) {
	
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 2) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.45 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
											$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
											if ($count_total_cpf > 1776) {
												$total_cpf = 1776;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1110) {
												$cpf_employee = 1110;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(6 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.375 * ($tw - 500));
											$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
											$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
											if ($count_total_cpf > 1369) {
												$total_cpf = 1369;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 925) {
												$cpf_employee = 925;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
											if ($count_total_cpf > 814) {
												$total_cpf = 814;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 3 || $pr_age_year > 3) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(17 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.6 * ($tw - 500));
											$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
											$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
											if ($count_total_cpf > 2738) {
												$total_cpf = 2738;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1480) {
												$cpf_employee = 1480;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = $total_cpf - $cpf_employee;
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(15.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.51 * ($tw - 500));
											$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
											$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
											if ($count_total_cpf > 2405) {
												$total_cpf = 2405;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1258) {
												$cpf_employee = 1258;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(12 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.345 * ($tw - 500));
											$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
											$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
											if ($count_total_cpf > 1739) {
												$total_cpf = 1739;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 851) {
												$cpf_employee = 851;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65 && $age_year <= 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
											if ($count_total_cpf > 1221) {
												$total_cpf = 1221;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(7.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
											if ($count_total_cpf > 925) {
												$total_cpf = 925;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
							}
	
	
	
							if ($immigration_id == 1) {
	
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$count_total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
	
	
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
	
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$count_total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
	
							if($check){
								$cpf_employee = $database_cpf_employee;
							}
	
							$total_net_salary = $total_net_salary - $cpf_employee;
							$cpf_total = $cpf_employee + $cpf_employer;
	
							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
						}
					}
	
	
					$shg_fund_deduction_amount = 0;
					//Other Fund Contributions
					$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
	
					if (!$check && $employee_contributions && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$shg_fund_name = $contribution_type[0]->contribution;
						$shg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
					}
					$ashg_fund_deduction_amount = 0;
	
					$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
					if (!$check && $employee_ashg_contributions  && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_ashg_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$ashg_fund_name = $contribution_type[0]->contribution;
	
						$ashg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
					}
	
					// echo $total_net_salary;
	
					// $sdl_total_amount = 0;
					// if ($g_sdl > 1 && $g_sdl <= 800) {
					// 	$sdl_total_amount = 2;
					// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					// 	$sdl_amount = (0.25 * $g_sdl) / 100;
					// 	$sdl_total_amount = $sdl_amount;
					// } elseif ($g_sdl > 4500) {
					// 	$sdl_total_amount = 11.25;
					// }
	
	
					$net_salary = number_format((float)$total_net_salary, 2, '.', '');
					$basic_salary = number_format((float)$basic_salary, 2, '.', '');
					// if ($basic_salary == 0 || $basic_salary == '') {
					// 	$fmpay = '';
					// } else {
						$fmpay = $mpay;
					// }
	
	
					// $company_info = $this->Company_model->read_company_information($r->company_id);
					// if (!is_null($company_info)) {
					// 	$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
					// 	$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
					// 	//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
					// } else {
					// 	//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
					// 	$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);
	
					// 	$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);
	
					// 	//$net_salary = $this->Xin_model->currency_sign($net_salary);	
					// 	//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
					// 	$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
					// }
	
					$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';
	
					//action link
					$act = $detail . $fmpay . $delete;
					// $act = $fmpay . $delete;
	
					if ($r->wages_type == 1) {
						if ($system[0]->is_half_monthly == 1) {
							$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
						} else {
							$emp_payroll_wage = $wages_type;
						}
					} else {
						$emp_payroll_wage = $wages_type;
					}
	
					$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					$p = $payslips->result();
					
					$mode_of_payment = $r->payment_mode ?? '';
	
	
					$field =  '<div class="k-top"><span class="k-icon k-plus" role="presentation"></span><span class="k-checkbox" role="presentation"  style="display:inline-block;"><label><input type="checkbox" name="employee_id[]" class="role-checkbox main_check_box" value="'.$r->user_id.'"> </label></span><span class="k-in k-state-focused"></span></div>';
					
	
					$check_gross_salary = in_array('chk_gross_salary', $check_payment) ? "checked disabled" : "";
					$check_allowance_amount = in_array('chk_total_allowances', $check_payment) ? "checked disabled" : "";
					$check_unpaid_leave_amount = in_array('chk_leave_deductions', $check_payment) ? "checked disabled" : "";
					$check_commissions_amount = in_array('chk_total_commissions', $check_payment) ? "checked disabled" : "";
					$check_loan_de_amount = in_array('chk_loan_de_amount', $check_payment) ? "checked disabled" : "";
					$check_overtime_amount = in_array('chk_total_overtime', $check_payment) ? "checked disabled" : "";
					$check_statutory_deductions_amount = in_array('chk_total_statutory_deductions', $check_payment) ? "checked disabled" : "";
					$check_other_payments_amount = in_array('chk_total_other_payments', $check_payment) ? "checked disabled" : "";
					$check_total_deduction = in_array('chk_total_employee_deduction', $check_payment) ? "checked disabled" : "";
					$check_claim_amount = in_array('chk_employee_claim', $check_payment) ? "checked disabled" : "";
					$check_share_options_amount = in_array('chk_total_share', $check_payment) ? "checked disabled" : "";
					
					$data[] = array(
						$field,
						$iemp_name,
						$emp_payroll_wage,
						'<input type="text" name="gross_salary[]" value="'. $show_main_salary . '" readonly class="form-control"/> <input type="checkbox"  name="chk_gross_salary[]" id="chk_gross_salary" class="header_chk_gross_salary bc_checked_class row-item" '. $check_gross_salary  .'/>',
						'<input type="text" name="total_allowances[]" value="'.$allowance_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_allowances[]" id="chk_total_allowances" class="header_chk_total_allowances bc_checked_class row-item" '. $check_allowance_amount  .'/>',
						'<input type="text" name="leave_deductions[]" value="'.$unpaid_leave_amount . '" readonly class="form-control" id="leave_deductions"/> <input type="checkbox"  name="chk_leave_deductions[]" id="chk_leave_deductions" class="header_chk_leave_deductions bc_checked_class row-item" '. $check_unpaid_leave_amount  .'/>',
						'<input type="text" name="total_commissions[]" value="'.$commissions_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_commissions[]" id="chk_total_commissions" class="header_chk_total_commissions bc_checked_class row-item" '. $check_commissions_amount  .'/>',
						'<input type="text" name="total_loan[]" value="'.$loan_de_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_loan_de_amount[]" id="chk_loan_de_amount" class="header_chk_loan_de_amount bc_checked_class row-item" '. $check_loan_de_amount  .'/>',		
						'<input type="text" name="total_overtime[]" value="'.$overtime_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_overtime[]" id="chk_total_overtime" class="header_chk_total_overtime bc_checked_class row-item" '. $check_overtime_amount  .'/>',
						'<input type="text" name="total_statutory_deductions[]" value="'.$statutory_deductions_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_statutory_deductions[]" id="chk_total_statutory_deductions" class="header_chk_total_statutory_deductions bc_checked_class row-item" '. $check_statutory_deductions_amount  .'/>',
						'<input type="text" name="total_other_payments[]" value="'.$other_payments_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_other_payments[]" id="chk_total_other_payments" class="header_chk_total_other_payments bc_checked_class row-item" '. $check_other_payments_amount  .'/>',
						'<input type="text" name="total_cpf_employee[]" value="'.$cpf_employee.'" readonly class="form-control" id="total_cpf_employee"/>',
						'<input type="text" name="total_cpf_employer[]" value="'.$cpf_employer.'"  readonly class="form-control" id="total_cpf_employer"/>',
						'<input type="text" name="total_cpf[]" value="'.($cpf_employer + $cpf_employee).'"  readonly class="form-control" id="total_cpf"/>',
						'<input type="text" name="total_fund_contribution[]" value="'.($shg_fund_deduction_amount + $ashg_fund_deduction_amount).'"  readonly class="form-control" id="total_fund_contribution" />',
						'<input type="text" name="total_employee_deduction[]" value="'.$total_deduction . '" readonly class="form-control" id="total_employee_deduction"/> <input type="checkbox"  name="chk_total_employee_deduction[]" id="chk_total_employee_deduction" class="header_chk_total_employee_deduction bc_checked_class row-item" '. $check_total_deduction  .'/>',
						'<input type="text" name="employee_claim[]" value="'.$claim_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_employee_claim[]" id="chk_employee_claim" class="header_chk_employee_claim bc_checked_class row-item" '. $check_claim_amount  .'/>',
						'<input type="text" name="total_share[]" value="'.$share_options_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_share[]" id="chk_total_share" class="header_chk_total_share bc_checked_class row-item" '. $check_share_options_amount  .'/>',
						'<input type="text" name="balance_amount[]" class="form-control b_am" value="0" readonly style="width: 100px;" id="balance_amount">',
						'<input type="text" name="net_salary[]" value="'.$net_salary.'" class="form-control" readonly id="net_salary_s">',
						'<input type="text" name="payment_amount[]" value="'.$net_salary.'" class="form-control" readonly id="payment_amount_s">',
						
						// $net_salary,
						$status,
						"",
					);
	
				}
			} else {
				$emp_name = $r->first_name . ' ' . $r->last_name;
				// office shift
				$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}

				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
				$hrs_old_int1 = 0;
				$pcount = 0;
				foreach ($result->result() as $hour_work) {
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}
				$pcount = $pcount + $re_pcount;

				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}

				$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
				$check_payment = $check && !empty($check[0]->check_id) ? explode(',', $check[0]->check_id) : [];
				
				if (in_array('chk_gross_salary', $check_payment)) {
					$basic_salary = 0;
				}

				$database_cpf_employee = 0;
				if($check){
					foreach($check as $c){
						$database_cpf_employee += $c->cpf_employee_amount;
					}
				}
				$final_contribution_amount = $this->contribution_calculation(['user_id'=>$r->user_id,"pay_date"=>$pay_date]);

				$database_cpf_employee = $final_contribution_amount['cpf_employee'] - $database_cpf_employee;

				

				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
				$pa_month = date('m-Y', strtotime('01-' . $pay_date));
				$deduction_amount = 0;
				if (!in_array('chk_total_employee_deduction', $check_payment)) {
					if ($employee_deduction) {
						foreach ($employee_deduction as $deduction) {
							if ($deduction->type_id == 1) {
								$deduction_amount +=  $deduction->amount;
							}
							if ($deduction->type_id == 2) {
								$from_month_year = date('m-Y', strtotime($deduction->from_date));
								$to_month_year = date('d-m-Y', strtotime($deduction->to_date));


								if ($from_month_year != "" && $to_month_year != "") {
									if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
										$deduction_amount +=  $deduction->amount;
									}
								}
							}
						}
					}
				}



				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $pay_date);
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						$pay_date_month = new DateTime('01-' . $pay_date);
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
					}
				}

				// if joining date and pay date same then this logic work
				$month_date_join = date('m-Y', strtotime($r->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($r->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $pay_date) {
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($first_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$p_day = $p->format('l');
					$m_p_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
					if ($is_holiday) {
						$same_month_holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($p_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_days_worked += 1;
						}
					} else if ($p_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_days_worked += 1;
						}
					} else if ($p_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_days_worked += 1;
						}
					} else if ($p_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_days_worked += 1;
						}
					} else if ($p_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_days_worked += 1;
						}
					} else if ($p_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_days_worked += 1;
						}
					} else if ($p_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_days_worked += 1;
						}
					}
				}
				// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
				$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}


				if ($month_date_join == $pay_date){
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				}else{
					$show_main_salary = $basic_salary;
				}
			
				$g_ordinary_wage += $show_main_salary;
				$g_shg += $show_main_salary;
				$g_sdl += $show_main_salary;
			
				$g_ordinary_wage -= $deduction_amount;
				$g_shg -= $deduction_amount;
				$g_sdl -= $deduction_amount;


				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				if (!in_array('chk_loan_de_amount', $check_payment)) {
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
							$loan_de_amount += $er_loan;
						}
					} else {
						$loan_de_amount = 0;
					}
					$loan_de_amount = number_format(floatval($loan_de_amount), 2);
				}
				
				// 2: all allowances
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
				if (!in_array('chk_total_allowances', $check_payment)) {
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}


							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								if ($month_date_join == $pay_date){
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}

							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}

							$allowance_amount += $eallowance_amount;
						}
					}
					$gross_allowance_amount = $allowance_amount;
				}


				// commissions
				$commissions_amount = 0;
				$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
				if (!in_array('chk_total_commissions', $check_payment)) {
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $c->commission_amount / 2;
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
							} else {
								$ecommissions_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommissions_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommissions_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommissions_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommissions_amount;
							}

							$commissions_amount += $ecommissions_amount;
						}
					}
				}

				//share options
				$share_options_amount = 0;
				if (!in_array('chk_total_share', $check_payment)) {
					$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;
					}
				}

				
				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				if (!in_array('chk_total_other_payments', $check_payment)) {
					if ($count_other_payments > 0) {
						foreach ($other_payments->result() as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}

									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}

									$other_payments_amount += $epayments_amount;
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $pay_date) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $pay_date);
								}

								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));

								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $pay_date) {
										$last_date = new DateTime($sl_other_payments->end_date);
									} else if($last_date->format('m-Y') >= $pay_date){
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
								if(!empty($last_date)){
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $pay_date) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}


										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');

											//holidays in a month

											$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}

											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}

										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);


										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
									}
								}
							}
						}
					} else {
						$other_payments_amount = 0;
					}
				}

				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
	
				if ($unpaid_leaves) {
					$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				}
				
				// $g_ordinary_wage = $gross_pay;
				$g_shg = $gross_pay;
				$g_sdl = $gross_pay;

				$g_ordinary_wage -= $unpaid_leave_amount;

				

				// other benefit
				$other_benefit_mount = 0;
				if (!in_array('chk_total_other_payments', $check_payment)) {
					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
					foreach ($other_benefit_list->result() as $benefit_list) {
						$other_benefit_mount += $benefit_list->other_benefit_cost;
					}
				}


				// statutory_deductions
				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if (!in_array('chk_total_statutory_deductions', $check_payment)) {
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') {
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							} else {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							}
						}
					} else {
						$statutory_deductions_amount = 0;
					}
				}

				// overtime
				$overtime_amount = 0;
				if (!in_array('chk_total_overtime', $check_payment)) {
					$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
					if ($overtime) {
						$ot_hrs = 0;
						$ot_mins = 0;
						foreach ($overtime as $ot) {
							$total_hours = explode(':', $ot->total_hours);
							$ot_hrs += $total_hours[0];
							$ot_mins += $total_hours[1];
						}
						if ($ot_mins > 0) {
							$ot_hrs += round($ot_mins / 60, 2);
						}

						//overtime rate
						$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
						if ($overtime_rate) {
							$rate = $overtime_rate->overtime_pay_rate;
						} else {
							$week_hours = 44;
							$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
							$rate = $rate * 1.5;
						}

						if ($ot_hrs > 0) {
							$overtime_amount = round($ot_hrs * $rate, 2);
						}
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$overtime_amount = $overtime_amount / 2;
							}
						}
						$g_ordinary_wage += $overtime_amount;
						$g_sdl += $overtime_amount;
					}
				}

				

				$payment_check = $this->Payroll_model->check_make_payment_payslip_for_first_payment($r->user_id, $pay_date);
				$payment_check_final = $this->Payroll_model->check_make_payment_payslip_for_final_payment($r->user_id, $pay_date);
				$balance = 0;
				$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
				if($check && $check[0]->balance_amount > 0){
					$balance = $check[0]->balance_amount;
					$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				
					$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

					$status = '<span class="label label-warning">' . "Partially Paid" . '</span>';

					$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
					$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
					
					if (in_array('313', $role_resources_ids)) {
						$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					} else {
						$delete = '';
					}
					// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
					$delete  = $delete;
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					
				}else if($check && $check[0]->balance_amount == 0){
					$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				
					$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

					$status = '<span class="label label-success">Paid</span>';

					$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
					
					if (in_array('313', $role_resources_ids)) {
						$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					} else {
						$delete = '';
					}
					// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
					$delete  = $delete;
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					
				}else {
						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						$balance = $this->Xin_model->currency_sign(0, $r->user_id);
					}

				
				// employee accommodations
				$employee_accommodations = 0;
				if (!in_array('chk_total_employee_deduction', $check_payment)) {
					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $pay_date || $period_to == $pay_date) {
							if (!empty($get_employee_accommodation->rent_paid)) {
								$employee_accommodations += $get_employee_accommodation->rent_paid;
							}
						}
					}
				}

				// employee claims
				$claim_amount = 0;
				if (!in_array('chk_employee_claim', $check_payment)) {
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $pay_date) {
							$claim_amount += $claims->amount;
						}
					}
				}



				$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
				$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;


				// cpf calculation
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);

				$today = new DateTime('01-' . $pay_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}

				$cpf_employee 	= 	0;
				$cpf_employer	=	0;

				$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
				if ($im_status) {
					$immigration_id = $im_status->immigration_id;
					if ($immigration_id == 2) {
						$issue_date = $im_status->issue_date;
						$i_date = new DateTime($issue_date);
						$today = new DateTime();
						$pr_age = $i_date->diff($today);
						$pr_age_year = $pr_age->y;
						$pr_age_month = $pr_age->m;
					}

					if ($immigration_id == 1 || $immigration_id == 2) {

						$ordinary_wage = $g_ordinary_wage;
						if ($ordinary_wage > $ordinary_wage_cap) {
							$ow = $ordinary_wage_cap;
						} else {
							$ow = $ordinary_wage;
						}

						//additional wage
						$additional_wage = $g_additional_wage;
						$aw = $g_additional_wage;
						$tw = $ow + $additional_wage;
						if ($im_status->issue_date != "") {
							if ($pr_age_year == 1) {

								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 2) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.45 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
										$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
										if ($count_total_cpf > 1776) {
											$total_cpf = 1776;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1110) {
											$cpf_employee = 1110;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(6 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.375 * ($tw - 500));
										$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
										$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
										if ($count_total_cpf > 1369) {
											$total_cpf = 1369;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 925) {
											$cpf_employee = 925;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
										if ($count_total_cpf > 814) {
											$total_cpf = 814;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 3 || $pr_age_year > 3) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = $total_cpf - $cpf_employee;
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
						}



						if ($immigration_id == 1) {

							if ($age_year <= 55) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(17 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.6 * ($tw - 500));
									$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
									$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
									if ($count_total_cpf > 2738) {
										$count_total_cpf = 2738;
									} else {
										$total_cpf = $count_total_cpf;
									}


									if ($count_cpf_employee > 1480) {
										$cpf_employee = 1480;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 55 && $age_year <= 60) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(15.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.51 * ($tw - 500));
									$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;

									$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
									if ($count_total_cpf > 2405) {
										$count_total_cpf = 2405;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 1258) {
										$cpf_employee = 1258;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 60 && $age_year <= 65) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(12 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.345 * ($tw - 500));
									$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
									$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

									if ($count_total_cpf > 1739) {
										$total_cpf = 1739;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 851) {
										$cpf_employee = 851;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 65 && $age_year <= 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(9 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.225 * ($tw - 500));
									$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
									$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

									if ($count_total_cpf > 1221) {
										$total_cpf = 1221;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 555) {
										$cpf_employee = 555;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(7.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.15 * ($tw - 500));
									$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
									$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

									if ($count_total_cpf > 925) {
										$total_cpf = 925;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 370) {
										$cpf_employee = 370;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							}
						}

						if($check){
							$cpf_employee = $database_cpf_employee;
						}

						$total_net_salary = $total_net_salary - $cpf_employee;
						$cpf_total = $cpf_employee + $cpf_employer;

						$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
						$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
						$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
					}
				}


				$shg_fund_deduction_amount = 0;
				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);

				if (!$check && $employee_contributions && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$shg_fund_name = $contribution_type[0]->contribution;
					$shg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
				}
				$ashg_fund_deduction_amount = 0;

				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				if (!$check && $employee_ashg_contributions  && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$ashg_fund_name = $contribution_type[0]->contribution;

					$ashg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
				}

				// echo $total_net_salary;

				// $sdl_total_amount = 0;
				// if ($g_sdl > 1 && $g_sdl <= 800) {
				// 	$sdl_total_amount = 2;
				// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
				// 	$sdl_amount = (0.25 * $g_sdl) / 100;
				// 	$sdl_total_amount = $sdl_amount;
				// } elseif ($g_sdl > 4500) {
				// 	$sdl_total_amount = 11.25;
				// }


				$net_salary = number_format((float)$total_net_salary, 2, '.', '');
				$basic_salary = number_format((float)$basic_salary, 2, '.', '');
				// if ($basic_salary == 0 || $basic_salary == '') {
				// 	$fmpay = '';
				// } else {
					$fmpay = $mpay;
				// }


				// $company_info = $this->Company_model->read_company_information($r->company_id);
				// if (!is_null($company_info)) {
				// 	$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
				// 	$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
				// 	//	$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee,$r->company_id);	
				// } else {
				// 	//$basic_salary = $this->Xin_model->currency_sign($basic_salary);
				// 	$basic_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->basic_salary, $r->user_id);

				// 	$net_salary = $this->Xin_model->currency_sign($payment_check->result()[0]->net_salary, $r->user_id);

				// 	//$net_salary = $this->Xin_model->currency_sign($net_salary);	
				// 	//$cpf_employee = $this->Xin_model->currency_sign($cpf_employee);	
				// 	$cpf_employee = $this->Xin_model->currency_sign($payment_check->result()[0]->cpf_employee_amount, $r->user_id);
				// }

				$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';

				//action link
				$act = $detail . $fmpay . $delete;
				// $act = $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}

				$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
				$p = $payslips->result();
				
				$mode_of_payment = $r->payment_mode ?? '';

				$main_check = $check && $check[0]->is_advance !=1 && $check[0]->balance_amount == 0 ? 'checked disabled' : ''; 

				$field =  '<div class="k-top"><span class="k-icon k-plus" role="presentation"></span><span class="k-checkbox" role="presentation"  style="display:inline-block;"><label><input type="checkbox" name="employee_id[]" class="role-checkbox main_check_box" value="'.$r->user_id.'" '.$main_check.'> </label></span><span class="k-in k-state-focused"></span></div>';
				

				$check_gross_salary = in_array('chk_gross_salary', $check_payment) ? "checked disabled" : "";
				$check_allowance_amount = in_array('chk_total_allowances', $check_payment) ? "checked disabled" : "";
				$check_unpaid_leave_amount = in_array('chk_leave_deductions', $check_payment) ? "checked disabled" : "";
				$check_commissions_amount = in_array('chk_total_commissions', $check_payment) ? "checked disabled" : "";
				$check_loan_de_amount = in_array('chk_loan_de_amount', $check_payment) ? "checked disabled" : "";
				$check_overtime_amount = in_array('chk_total_overtime', $check_payment) ? "checked disabled" : "";
				$check_statutory_deductions_amount = in_array('chk_total_statutory_deductions', $check_payment) ? "checked disabled" : "";
				$check_other_payments_amount = in_array('chk_total_other_payments', $check_payment) ? "checked disabled" : "";
				$check_total_deduction = in_array('chk_total_employee_deduction', $check_payment) ? "checked disabled" : "";
				$check_claim_amount = in_array('chk_employee_claim', $check_payment) ? "checked disabled" : "";
				$check_share_options_amount = in_array('chk_total_share', $check_payment) ? "checked disabled" : "";
				
				$data[] = array(
					$field,
					$iemp_name,
					$emp_payroll_wage,
					'<input type="text" name="gross_salary[]" value="'. $show_main_salary . '" readonly class="form-control"/> <input type="checkbox"  name="chk_gross_salary[]" id="chk_gross_salary" class="header_chk_gross_salary bc_checked_class row-item" '. $check_gross_salary  .'/>',
					'<input type="text" name="total_allowances[]" value="'.$allowance_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_allowances[]" id="chk_total_allowances" class="header_chk_total_allowances bc_checked_class row-item" '. $check_allowance_amount  .'/>',
					'<input type="text" name="leave_deductions[]" value="'.$unpaid_leave_amount . '" readonly class="form-control leave_deductions"/> <input type="checkbox"  name="chk_leave_deductions[]" id="chk_leave_deductions" class="header_chk_leave_deductions bc_checked_class row-item" '. $check_unpaid_leave_amount  .'/>',
					'<input type="text" name="total_commissions[]" value="'.$commissions_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_commissions[]" id="chk_total_commissions" class="header_chk_total_commissions bc_checked_class row-item" '. $check_commissions_amount  .'/>',
					'<input type="text" name="total_loan[]" value="'.$loan_de_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_loan_de_amount[]" id="chk_loan_de_amount" class="header_chk_loan_de_amount bc_checked_class row-item" '. $check_loan_de_amount  .'/>',		
					'<input type="text" name="total_overtime[]" value="'.$overtime_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_overtime[]" id="chk_total_overtime" class="header_chk_total_overtime bc_checked_class row-item" '. $check_overtime_amount  .'/>',
					'<input type="text" name="total_statutory_deductions[]" value="'.$statutory_deductions_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_statutory_deductions[]" id="chk_total_statutory_deductions" class="header_chk_total_statutory_deductions bc_checked_class row-item" '. $check_statutory_deductions_amount  .'/>',
					'<input type="text" name="total_other_payments[]" value="'.$other_payments_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_other_payments[]" id="chk_total_other_payments" class="header_chk_total_other_payments bc_checked_class row-item" '. $check_other_payments_amount  .'/>',
					'<input type="text" name="total_cpf_employee[]" value="'.$cpf_employee.'" readonly class="form-control total_cpf_employee" />',
					'<input type="text" name="total_cpf_employer[]" value="'.$cpf_employer.'"  readonly class="form-control total_cpf_employer"/>',
					'<input type="text" name="total_cpf[]" value="'.($cpf_employer + $cpf_employee).'"  readonly class="form-control total_cpf"/>',
					'<input type="text" name="total_fund_contribution[]" value="'.($shg_fund_deduction_amount + $ashg_fund_deduction_amount).'"  readonly class="form-control total_fund_contribution"  />',
					'<input type="text" name="total_employee_deduction[]" value="'.$total_deduction . '" readonly class="form-control total_employee_deduction"/> <input type="checkbox"  name="chk_total_employee_deduction[]" id="chk_total_employee_deduction" class="header_chk_total_employee_deduction bc_checked_class row-item" '. $check_total_deduction  .'/>',
					'<input type="text" name="employee_claim[]" value="'.$claim_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_employee_claim[]" id="chk_employee_claim" class="header_chk_employee_claim bc_checked_class row-item" '. $check_claim_amount  .'/>',
					'<input type="text" name="total_share[]" value="'.$share_options_amount . '" readonly class="form-control"/> <input type="checkbox"  name="chk_total_share[]" id="chk_total_share" class="header_chk_total_share bc_checked_class row-item" '. $check_share_options_amount  .'/>',
					'<input type="text" name="balance_amount[]" class="form-control balance_amount" value="0" readonly style="width: 100px;" >',
					'<input type="text" name="net_salary[]" value="'.$net_salary.'" class="form-control net_salary_s" readonly>',
					'<input type="text" name="payment_amount[]" value="'.$net_salary.'" class="form-control payment_amount_s" readonly>',
					
					// $net_salary,
					$status,
					"",
				);

			}
		}
		$output = array(
			"draw" 				=> 	$draw,
			"recordsTotal" 		=> 	$payslip->num_rows(),
			"recordsFiltered" 	=> 	$payslip->num_rows(),
			"data" 				=> 	$data
		);
		echo json_encode($output);
		exit();
	}


	// bulk payment
	public function add_pay_bulk(){	
		if(!empty($this->input->post('employee_id'))){
			foreach($this->input->post('employee_id') as $key => $employee_id){
				$user = $this->Xin_model->read_user_info($employee_id);
				$jurl = random_string('alnum', 40);

				$basic_salary = 0;
				$gross_salary = 0;
				$leave_deductions = 0;
				$total_allowances = 0;
				$total_loan = 0;
				$total_overtime = 0;
				$total_commissions = 0;
				$total_statutory_deductions = 0;
				$total_employee_deduction = 0;
				$employee_claim = 0;
				$total_other_payments = 0;
				$total_share = 0;
				$additional_allowances = 0;
				$total_amount = 0;

				$basic_salary = $user[0]->basic_salary;
				if ($this->input->post('chk_gross_salary')[$key]) {	
					$gross_salary = $this->input->post('gross_salary')[$key];
				}

				// if ($this->input->post('chk_leave_deductions')) {
					$leave_deductions = $this->input->post('leave_deductions')[$key];
				// }

				if (!empty($this->input->post('chk_total_allowances')[$key])) {
					$total_allowances = $this->input->post('total_allowances')[$key];
				}

				if ($this->input->post('chk_total_commissions')[$key]) {
					$total_commissions = $this->input->post('total_commissions')[$key];
				}

				if ($this->input->post('chk_loan_de_amount')[$key]) {
					$total_loan = $this->input->post('total_loan')[$key];
				}

				if ($this->input->post('chk_total_overtime')[$key]) {
					$total_overtime = $this->input->post('total_overtime')[$key];
				}

				if ($this->input->post('chk_total_statutory_deductions')[$key]) {
					$total_statutory_deductions = $this->input->post('total_statutory_deductions')[$key];
				}

				if ($this->input->post('chk_total_other_payments')[$key]) {
					$total_other_payments = $this->input->post('total_other_payments')[$key];
				}

				if ($this->input->post('chk_total_employee_deduction')[$key]) {
					$total_employee_deduction = $this->input->post('total_employee_deduction')[$key];
				}

				if ($this->input->post('chk_employee_claim')[$key]) {
					$employee_claim = $this->input->post('employee_claim')[$key];
				}

				if ($this->input->post('chk_total_share')[$key]) {
					$total_share = $this->input->post('total_share')[$key];
				}

				

				$data = array(
					'employee_id' 			=> 	$employee_id,
					'department_id' 		=> 	$user[0]->department_id,
					'company_id' 			=> 	$user[0]->company_id,
					'location_id' 			=> 	$user[0]->location_id,
					'designation_id' 		=> 	$user[0]->designation_id,
					'salary_month' 			=> 	$this->input->post('pay_date'),
					'basic_salary' 			=> 	$basic_salary,
					'gross_salary' 			=> 	$gross_salary,
					'net_salary' 			=> 	$this->input->post('net_salary')[$key],
					'wages_type' 			=> 	$user[0]->wages_type,
					'is_half_monthly_payroll' 		=> 	0,
					'total_commissions' 			=> 	$total_commissions,
					'total_statutory_deductions' 	=> $total_statutory_deductions,
					'total_other_payments' 	=> 	$total_other_payments,
					'total_allowances' 		=> 	$total_allowances,
					'total_loan' 			=> 	$total_loan,
					'total_overtime' 		=> 	$this->input->post('total_overtime_time') ?? 0,
					'total_overtime_amount' => 	$total_overtime,
					'claim_amount' 			=> 	$employee_claim,
					'cpf_employee_amount' 	=> 	$this->input->post('total_cpf_employee')[$key],
					'cpf_employer_amount' 	=> 	$this->input->post('total_cpf_employer')[$key],
					'leave_deduction' 		=> 	$leave_deductions,
					'contribution_fund' 	=> 	$this->input->post('total_fund_contribution')[$key],
					'share_option_amount' 	=> 	$total_share,
					'additonal_allowance' 	=> 	$additional_allowances,
					'deduction_amount' 		=> 	$total_employee_deduction,
					'balance_amount' 		=> 	$this->input->post('balance_amount')[$key],
					'is_payment' 			=> 	'1',
					'status' 				=> 	$this->input->post('balance_amount')[$key] > 0 ? 2 : 1,
					'payslip_type' 			=> 	'full_monthly',
					'payslip_key' 			=> 	$jurl,
					'year_to_date' 			=> 	date('d-m-Y'),
					'created_at' 			=> 	date('d-m-Y h:i:s'),
					'check_id'				=>	$this->input->post('check_id')
				);
				// print_r($data);exit;
				$result = $this->Payroll_model->add_salary_payslip($data);

			if ($result) {

				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				$g_ordinary_wage += $basic_salary;
				$g_shg += $basic_salary;
				$g_sdl += $basic_salary;

				$office_shift = $this->Timesheet_model->read_office_shift_information($user[0]->office_shift_id);
				$system = $this->Xin_model->read_setting_info(1);

				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $this->input->post('pay_date'));
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$p_day = $p->format('l');
					$p_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($user[0]->company_id, $p_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($p_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($employee_id, $this->input->post('pay_date'));
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						$pay_date_month = new DateTime('01-' . $this->input->post('pay_date'));
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$holiday_array_new = array();

						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {

								if ($office_shift[0]->monday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
					}
				}
				
				
				$month_date_join = date('m-Y', strtotime($user[0]->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $p_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($user[0]->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $this->input->post('pay_date')) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$p_date = $p->format('Y-m-d');

						//holidays in a month

						$is_holiday = $this->Timesheet_model->is_holiday_on_date($user[0]->company_id, $p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}

					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}

				
				if ($month_date_join == $this->input->post('pay_date')) {
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				} else {
					$show_main_salary = $basic_salary;
				}

				

				// set allowance
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if ($this->input->post('chk_total_allowances')) {
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($employee_id, $this->input->post('pay_date'));
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								// for no of working day
								if ($month_date_join == $this->input->post('pay_date')) {
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}
				
							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}
				
							$allowance_amount += $eallowance_amount;

							$allowance_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$employee_id,
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'allowance_title' 	=> 	$sa->allowance_title,
								'allowance_amount' 	=> 	$eallowance_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);
	
						}
					}
				}
				$gross_allowance_amount = $allowance_amount;


				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($employee_id, $this->input->post('pay_date'));
				if ($this->input->post('chk_total_employee_deduction') || $employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						$xin_salary_deduction = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$employee_id,
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'name' 				=> 	$deduction->deduction_type,
							'amount' 			=> 	$deduction->amount,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}

					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($employee_id, $this->input->post('pay_date'));
					foreach ($other_benefit_list->result() as $other_benefit) {
						$xin_salary_deduction = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$employee_id,
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'name' 				=> 	$other_benefit->other_benefit,
							'amount' 			=> 	$other_benefit->other_benefit_cost,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}

					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($employee_id, $this->input->post('pay_date'));

					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $this->input->post('pay_date') || $period_to == $this->input->post('pay_date')) {
							$xin_salary_deduction = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$employee_id,
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'name' 				=> 	$get_employee_accommodation->title,
								'amount' 			=> 	$get_employee_accommodation->rent_paid,
	
							);
							$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
						}
					}

				}


				// commissions
				if ($this->input->post('chk_total_commissions')) {
					$commission_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($employee_id, $this->input->post('pay_date'));
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommission_amount = $c->commission_amount / 2;
								} else {
									$ecommission_amount = $c->commission_amount;
								}
							} else {
								$ecommission_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommission_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommission_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommission_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommission_amount;
							}

							$commissions_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$employee_id,
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'commission_id' 	=> 	$c->commission_type,
								'commission_amount' => 	$ecommission_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_commissions($commissions_data);
							$commission_amount += $ecommission_amount;
						}
					}
				}

				//share options
				if ($this->input->post('chk_total_share')) {
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($employee_id, $this->input->post('pay_date'));
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;

						$share_options_data = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$employee_id,
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'amount' 			=> 	round($share_options_amount, 2)
						);
						$this->Payroll_model->add_salary_payslip_share_options($share_options_data);
					}
				}


				// set other payments
				$other_payments_amount = 0;
				if ($this->input->post('chk_total_other_payments')) {
					$salary_other_payments = $this->Employees_model->read_salary_other_payments($employee_id);
					$count_other_payment = $this->Employees_model->count_employee_other_payments($employee_id);
					if ($count_other_payment > 0) {
						foreach ($salary_other_payments as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($this->input->post('pay_date') == date('m-Y', strtotime($sl_other_payments->date))) {

									$esl_other_payments = $sl_other_payments->payments_amount;
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $esl_other_payments / 2;
										} else {
											$epayments_amount = $esl_other_payments;
										}
									} else {
										$epayments_amount = $esl_other_payments;
									}

									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
									$other_payments_amount += $epayments_amount;
									$other_payments_data = array(
										'payslip_id' 		=> 	$result,
										'employee_id' 		=> 	$employee_id,
										'salary_month' 		=> 	$this->input->post('pay_date'),
										'payments_title' 	=> 	$sl_other_payments->payments_title,
										'payments_amount' 	=> 	$epayments_amount,
										'created_at' 		=> 	date('d-m-Y h:i:s')
									);
									$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $this->input->post('pay_date')) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $this->input->post('pay_date'));
								}
				
								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
				
								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $this->input->post('pay_date')) {
										$last_date = new DateTime($sl_other_payments->end_date);
									} else if ($last_date->format('m-Y') >= $this->input->post('pay_date')) {
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
				
								if (!empty($last_date)) {
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $this->input->post('pay_date')) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
				
				
										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');
				
											//holidays in a month
				
											$is_holiday = $this->Timesheet_model->is_holiday_on_date($user[0]->company_id, $this->input->post('pay_date'));
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}
				
											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}
				
										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
				
				
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
										$other_payments_data = array(
											'payslip_id' 		=> 	$result,
											'employee_id' 		=> 	$employee_id,
											'salary_month' 		=> 	$this->input->post('pay_date'),
											'payments_title' 	=> 	$sl_other_payments->payments_title,
											'payments_amount' 	=> 	$epayments_amount,
											'created_at' 		=> 	date('d-m-Y h:i:s')
										);
										$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
									}
								}
							}
						}
					}
				}


				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
	
				if ($unpaid_leaves) {
					$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				}
				// unpaid leave
				// if ($this->input->post('chk_leave_deductions')) {
					if ($unpaid_leaves) {
						foreach ($leave_period as $l) {
							$is_half = $l['is_half'];
							$leave_dates = $l['leave_date'];
							$leave_day_pay = round(($basic_salary + $allowance_amount + $other_payments_amount) / $no_of_working_days, 2);
							if ($is_half) {
								$leave_day_pay = $leave_day_pay / 2;
							}
							foreach ($leave_dates as $ld) {
								$unpaid_leave_data = array(
									'payslip_id' 		=> 	$result,
									'employee_id' 		=> 	$this->input->post('emp_id'),
									'salary_month' 		=> 	$this->input->post('pay_date'),
									'leave_date' 		=> 	$ld,
									'leave_amount' 		=> 	$leave_day_pay,
									'is_half' 			=> 	$is_half,
									'total_leave_amount' => $unpaid_leave_amount
								);
								$this->Payroll_model->add_salary_payslip_leave_deduction($unpaid_leave_data);
							}
						}
					}
				// }


				// employee claims
				if ($this->input->post('chk_employee_claim')){
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($employee_id);
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $this->input->post('pay_date')) {
							$claim_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$employee_id,
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'claim_type' 		=> 	$claims->name,
								'amount' 			=> 	$claims->amount,
								'year'				=>	$claims->claim_year,
								'date'				=>	$claims->date,
								'employee_claim_id'	=>	$claims->claim_id
							);
							$this->Payroll_model->add_salary_payslip_claim($claim_data);
						}
					}
				}
			

				// set statutory_deductions
				if ($this->input->post('chk_total_statutory_deductions')) {
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($employee_id);
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($employee_id);
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') :
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							else :
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							endif;


							$statutory_deduction_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$employee_id,
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'deduction_title' 	=> 	$sl_statutory_deductions->deduction_title,
								'deduction_amount' 	=> 	$statutory_deductions_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);

						}
					}
				}

				// set loan
				if ($this->input->post('chk_loan_de_amount')) {
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($employee_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($employee_id);
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							$esl_salary_loan_deduction = $sl_salary_loan_deduction->loan_deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eloan_deduction_amount = $esl_salary_loan_deduction / 2;
								} else {
									$eloan_deduction_amount = $esl_salary_loan_deduction;
								}
							} else {
								$eloan_deduction_amount = $esl_salary_loan_deduction;
							}
							$loan_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$employee_id,
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'loan_title' 		=> 	$sl_salary_loan_deduction->loan_deduction_title,
								'loan_amount' 		=> 	$eloan_deduction_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
						}
					}
				}


				// overtime
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($employee_id, $this->input->post('pay_date'));
				if ($overtime) {
					$ot_days = 0;
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
						$ot_days += 1;
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($employee_id);

					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;

						$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}

					$overtime_data = array(
						'payslip_id' 			=> 	$result,
						'employee_id' 			=> 	$employee_id,
						'overtime_salary_month' => 	$this->input->post('pay_date'),
						'overtime_no_of_days' 	=> 	$ot_days,
						'overtime_hours' 		=> 	$ot_hrs,
						'overtime_rate' 		=> 	$rate,
						'total_overtime' 		=> 	$overtime_amount,
						'created_at' 			=> 	date('d-m-Y h:i:s')
					);
					$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				}

				//cpf
				$total_cpf =  $this->input->post('total_cpf');
				// if ($total_cpf && $total_cpf > 0) {
				// 	$ow_paid = $this->input->post('ow_paid');
				// 	$cpf_data = [
				// 		'payslip_id' 	=> 	$result,
				// 		'month_year' 	=> 	'01-' . $this->input->post('pay_date'),
				// 		'ow_paid'		=> 	$ow_paid,
				// 		'ow_cpf'		=> 	$this->input->post('ow_cpf'),
				// 		'ow_cpf_employer'	=> $this->input->post('ow_cpf_employer'),
				// 		'ow_cpf_employee'	=> $this->input->post('ow_cpf_employee'),
				// 		'aw_paid'		=> 	$this->input->post('aw_paid'),
				// 		'aw_cpf'		=> 	$this->input->post('aw_cpf'),
				// 		'aw_cpf_employer'	=> $this->input->post('aw_cpf_employer'),
				// 		'aw_cpf_employee'	=> $this->input->post('aw_cpf_employee')
				// 	];

				// 	$cpf_payslip = $this->Cpf_payslip_model->add_cpf_payslip($cpf_data);
				// }

				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($employee_id);
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' 			=> 	$result,
						'contribution_id' 		=> 	$contribution_id,
						'contribution_amount' 	=> $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}


				//ASHG Fund Contributions
				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($employee_id);
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' 			=> 	$result,
						'contribution_id' 		=> 	$contribution_id,
						'contribution_amount' 	=> 	$contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//sdl
				$sdl = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl = 11.25;
				}

				$cdata = array(
					'payslip_id'		 	=> 	$result,
					'contribution_id' 		=> 	5,
					'contribution_amount' 	=> 	$sdl
				);
				$this->Contribution_fund_model->setContributionPayslip($cdata);

				$Return['result'] = $this->lang->line('xin_success_payment_paid');
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
			$man_arr = [];
			$bank = '';
			if($this->input->post('payment_mode') == 'DBS'){
				$company_info = $this->Company_model->read_company_information($user[0]->company_id);
				$account_number = '';
				if(!empty($company_info[0]->bank_details)){
					foreach(json_decode($company_info[0]->bank_details) as $info){
						if($info->bank_name == 'DBS'){
							$account_number = $info->bank_account_number;
						}
					}
				}
				$currencyCode = explode(' - ', $company_info[0]->default_currency);
				$payment_date = date('d-m-Y',strtotime($this->input->post('pay_date')));
				$bank_ac = $this->Employees_model->get_bank_account_info_add($employee_id);
				$total_amount += $this->input->post('net_salary')[$key];
				$file_data[] = array(
					PHP_EOL . 'PAYMENT',
					'SAL',
					$account_number,
					$currencyCode[0],
					'',
					'SGD',
					'',
					$payment_date,
					'',
					'',
					$user[0]->first_name.' '.$user[0]->last_name,
					'',
					'',
					'',
					'',
					$bank_ac->account_number ?? '',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					$this->input->post('net_salary')[$key],
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'A0',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
				);
				$c_name = $company_info[0]->name;
				$formattedDate = str_replace('-', '', $this->input->post('pay_date'));
				$man_arr[] = ['HEADER', $formattedDate, $Organization_Assigned_Id ?? ',', $c_name];
				$man_arr[] = $file_data;
				$man_arr[] = [PHP_EOL . 'TRAILER', count($file_data), $total_amount];
				$bank = "DBS";

			}
			// echo json_encode($man_arr);
			// $this->output($Return);
			echo json_encode([
				'status'	=> 'success',
				'data'		=>	$man_arr,
				'date'		=>	date('d-m-Y'),
				'bank'		=>	$bank
			]);
			exit;
			}
		}else{
			$Return['error'] = 'Please Select Employee';
			$this->output($Return);
		}

		exit;
		if ($this->input->post('add_type') == 'add_monthly_payment') {
			/* Define return | here result is used to return user data and error for error message */
			$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
			$Return['csrf_hash'] = $this->security->get_csrf_hash();

			$basic_salary = $this->input->post('gross_salary');

			$system = $this->Xin_model->read_setting_info(1);
			$user = $this->Xin_model->read_user_info($this->input->post('emp_id'));
			// office shift
			$office_shift = $this->Timesheet_model->read_office_shift_information($this->input->post('office_shift_id'));

			if ($system[0]->is_half_monthly == 1) {
				$is_half_monthly_payroll = 1;
			} else {
				$is_half_monthly_payroll = 0;
			}
			if ($this->input->post('blance_amount') > 0) {
				$status = 3;
			} else {
				$status = 0;
			}

			$jurl = random_string('alnum', 40);

			$basic_salary = 0;
			$gross_salary = 0;
			$leave_deductions = 0;
			$total_allowances = 0;
			$total_loan = 0;
			$total_overtime = 0;
			$total_commissions = 0;
			$total_statutory_deductions = 0;
			$total_employee_deduction = 0;
			$employee_claim = 0;
			$total_other_payments = 0;
			$total_share = 0;
			$additional_allowances = 0;

			if ($this->input->post('chk_gross_salary')) {
				$basic_salary = $this->input->post('gross_salary');
				$gross_salary = $this->input->post('gross_salary');
			}

			// if ($this->input->post('chk_leave_deductions')) {
				$leave_deductions = $this->input->post('leave_deductions');
			// }

			if ($this->input->post('chk_total_allowances')) {
				$total_allowances = $this->input->post('total_allowances');
			}

			if ($this->input->post('chk_total_commissions')) {
				$total_commissions = $this->input->post('total_commissions');
			}

			if ($this->input->post('chk_loan_de_amount')) {
				$total_loan = $this->input->post('total_loan');
			}

			if ($this->input->post('chk_total_overtime')) {
				$total_overtime = $this->input->post('total_overtime');
			}

			if ($this->input->post('chk_total_statutory_deductions')) {
				$total_statutory_deductions = $this->input->post('total_statutory_deductions');
			}

			if ($this->input->post('chk_total_other_payments')) {
				$total_other_payments = $this->input->post('total_other_payments');
			}

			if ($this->input->post('chk_total_employee_deduction')) {
				$total_employee_deduction = $this->input->post('total_employee_deduction');
			}

			if ($this->input->post('chk_employee_claim')) {
				$employee_claim = $this->input->post('employee_claim');
			}

			if ($this->input->post('chk_total_share')) {
				$total_share = $this->input->post('total_share');
			}

			

			$data = array(
				'employee_id' 			=> 	$this->input->post('emp_id'),
				'department_id' 		=> 	$this->input->post('department_id'),
				'company_id' 			=> 	$this->input->post('company_id'),
				'location_id' 			=> 	$this->input->post('location_id'),
				'designation_id' 		=> 	$this->input->post('designation_id'),
				'salary_month' 			=> 	$this->input->post('pay_date'),
				'basic_salary' 			=> 	$basic_salary,
				'gross_salary' 			=> 	$gross_salary,
				'net_salary' 			=> 	$this->input->post('net_salary'),
				'wages_type' 			=> 	$this->input->post('wages_type'),
				'is_half_monthly_payroll' 		=> 	$is_half_monthly_payroll,
				'total_commissions' 			=> 	$total_commissions,
				'total_statutory_deductions' 	=> $total_statutory_deductions,
				'total_other_payments' 	=> 	$total_other_payments,
				'total_allowances' 		=> 	$total_allowances,
				'total_loan' 			=> 	$total_loan,
				'total_overtime' 		=> 	$this->input->post('total_overtime_time'),
				'total_overtime_amount' => 	$total_overtime,
				'claim_amount' 			=> 	$employee_claim,
				'cpf_employee_amount' 	=> 	$this->input->post('total_cpf_employee'),
				'cpf_employer_amount' 	=> 	$this->input->post('total_cpf_employer'),
				'leave_deduction' 		=> 	$leave_deductions,
				'contribution_fund' 	=> 	$this->input->post('total_fund_contribution'),
				'share_option_amount' 	=> 	$total_share,
				'additonal_allowance' 	=> 	$additional_allowances,
				'deduction_amount' 		=> 	$total_employee_deduction,
				'balance_amount' 		=> 	$this->input->post('balance_amount'),
				'is_payment' 			=> 	'1',
				'status' 				=> 	$this->input->post('balance_amount') > 0 ? 2 : 1,
				'payslip_type' 			=> 	'full_monthly',
				'payslip_key' 			=> 	$jurl,
				'year_to_date' 			=> 	date('d-m-Y'),
				'created_at' 			=> 	date('d-m-Y h:i:s'),
				'check_id'				=>	$this->input->post('check_id')
			);
			$result = $this->Payroll_model->add_salary_payslip($data);

			if ($result) {

				$user = $this->Xin_model->read_user_info($this->input->post('emp_id'));

				$basic_salary = $user[0]->basic_salary;

				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				$g_ordinary_wage += $basic_salary;
				$g_shg += $basic_salary;
				$g_sdl += $basic_salary;

				

				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $this->input->post('pay_date'));
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$p_day = $p->format('l');
					$p_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $p_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($p_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						$pay_date_month = new DateTime('01-' . $this->input->post('pay_date'));
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$holiday_array_new = array();

						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {

								if ($office_shift[0]->monday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
					}
				}
				
				
				$month_date_join = date('m-Y', strtotime($user[0]->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $p_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($user[0]->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $this->input->post('pay_date')) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$p_date = $p->format('Y-m-d');

						//holidays in a month

						$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}

					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}

				
				if ($month_date_join == $this->input->post('pay_date')) {
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				} else {
					$show_main_salary = $basic_salary;
				}

				

				// set allowance
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if ($this->input->post('chk_total_allowances')) {
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								// for no of working day
								if ($month_date_join == $this->input->post('pay_date')) {
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}
				
							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}
				
							$allowance_amount += $eallowance_amount;

							$allowance_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'allowance_title' 	=> 	$sa->allowance_title,
								'allowance_amount' 	=> 	$eallowance_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);
	
						}
					}
				}
				$gross_allowance_amount = $allowance_amount;


				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($this->input->post('chk_total_employee_deduction') || $employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						$xin_salary_deduction = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$this->input->post('emp_id'),
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'name' 				=> 	$deduction->deduction_type,
							'amount' 			=> 	$deduction->amount,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}

					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($this->input->post('emp_id'), $this->input->post('pay_date'));
					foreach ($other_benefit_list->result() as $other_benefit) {
						$xin_salary_deduction = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$this->input->post('emp_id'),
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'name' 				=> 	$other_benefit->other_benefit,
							'amount' 			=> 	$other_benefit->other_benefit_cost,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}

					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($this->input->post('emp_id'), $this->input->post('pay_date'));

					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $this->input->post('pay_date') || $period_to == $this->input->post('pay_date')) {
							$xin_salary_deduction = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'name' 				=> 	$get_employee_accommodation->title,
								'amount' 			=> 	$get_employee_accommodation->rent_paid,
	
							);
							$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
						}
					}

				}


				// commissions
				if ($this->input->post('chk_total_commissions')) {
					$commission_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommission_amount = $c->commission_amount / 2;
								} else {
									$ecommission_amount = $c->commission_amount;
								}
							} else {
								$ecommission_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommission_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommission_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommission_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommission_amount;
							}

							$commissions_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'commission_id' 	=> 	$c->commission_type,
								'commission_amount' => 	$ecommission_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_commissions($commissions_data);
							$commission_amount += $ecommission_amount;
						}
					}
				}

				//share options
				if ($this->input->post('chk_total_share')) {
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;

						$share_options_data = array(
							'payslip_id' 		=> 	$result,
							'employee_id' 		=> 	$this->input->post('emp_id'),
							'salary_month' 		=> 	$this->input->post('pay_date'),
							'amount' 			=> 	round($share_options_amount, 2)
						);
						$this->Payroll_model->add_salary_payslip_share_options($share_options_data);
					}
				}


				// set other payments
				$other_payments_amount = 0;
				if ($this->input->post('chk_total_other_payments')) {
					$salary_other_payments = $this->Employees_model->read_salary_other_payments($this->input->post('emp_id'));
					$count_other_payment = $this->Employees_model->count_employee_other_payments($this->input->post('emp_id'));
					if ($count_other_payment > 0) {
						foreach ($salary_other_payments as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($this->input->post('pay_date') == date('m-Y', strtotime($sl_other_payments->date))) {

									$esl_other_payments = $sl_other_payments->payments_amount;
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $esl_other_payments / 2;
										} else {
											$epayments_amount = $esl_other_payments;
										}
									} else {
										$epayments_amount = $esl_other_payments;
									}

									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
									$other_payments_amount += $epayments_amount;
									$other_payments_data = array(
										'payslip_id' 		=> 	$result,
										'employee_id' 		=> 	$this->input->post('emp_id'),
										'salary_month' 		=> 	$this->input->post('pay_date'),
										'payments_title' 	=> 	$sl_other_payments->payments_title,
										'payments_amount' 	=> 	$epayments_amount,
										'created_at' 		=> 	date('d-m-Y h:i:s')
									);
									$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $this->input->post('pay_date')) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $this->input->post('pay_date'));
								}
				
								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
				
								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $this->input->post('pay_date')) {
										$last_date = new DateTime($sl_other_payments->end_date);
									} else if ($last_date->format('m-Y') >= $this->input->post('pay_date')) {
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
				
								if (!empty($last_date)) {
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $this->input->post('pay_date')) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
				
				
										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');
				
											//holidays in a month
				
											$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $this->input->post('pay_date'));
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}
				
											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}
				
										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
				
				
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
										$other_payments_data = array(
											'payslip_id' 		=> 	$result,
											'employee_id' 		=> 	$this->input->post('emp_id'),
											'salary_month' 		=> 	$this->input->post('pay_date'),
											'payments_title' 	=> 	$sl_other_payments->payments_title,
											'payments_amount' 	=> 	$epayments_amount,
											'created_at' 		=> 	date('d-m-Y h:i:s')
										);
										$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
									}
								}
							}
						}
					}
				}


				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
	
				if ($unpaid_leaves) {
					$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				}
				// unpaid leave
				// if ($this->input->post('chk_leave_deductions')) {
					if ($unpaid_leaves) {
						foreach ($leave_period as $l) {
							$is_half = $l['is_half'];
							$leave_dates = $l['leave_date'];
							$leave_day_pay = round(($basic_salary + $allowance_amount + $other_payments_amount) / $no_of_working_days, 2);
							if ($is_half) {
								$leave_day_pay = $leave_day_pay / 2;
							}
							foreach ($leave_dates as $ld) {
								$unpaid_leave_data = array(
									'payslip_id' 		=> 	$result,
									'employee_id' 		=> 	$this->input->post('emp_id'),
									'salary_month' 		=> 	$this->input->post('pay_date'),
									'leave_date' 		=> 	$ld,
									'leave_amount' 		=> 	$leave_day_pay,
									'is_half' 			=> 	$is_half,
									'total_leave_amount' => $unpaid_leave_amount
								);
								$this->Payroll_model->add_salary_payslip_leave_deduction($unpaid_leave_data);
							}
						}
					}
				// }


				// employee claims
				if ($this->input->post('chk_employee_claim')){
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($this->input->post('emp_id'));
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $this->input->post('pay_date')) {
							$claim_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'claim_type' 		=> 	$claims->name,
								'amount' 			=> 	$claims->amount,
								'year'				=>	$claims->claim_year,
								'date'				=>	$claims->date,
								'employee_claim_id'	=>	$claims->claim_id
							);
							$this->Payroll_model->add_salary_payslip_claim($claim_data);
						}
					}
				}
			

				// set statutory_deductions
				if ($this->input->post('chk_total_statutory_deductions')) {
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($this->input->post('emp_id'));
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($this->input->post('emp_id'));
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') :
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							else :
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							endif;


							$statutory_deduction_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'deduction_title' 	=> 	$sl_statutory_deductions->deduction_title,
								'deduction_amount' 	=> 	$statutory_deductions_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);

						}
					}
				}

				// set loan
				if ($this->input->post('chk_loan_de_amount')) {
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($this->input->post('emp_id'));
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($this->input->post('emp_id'));
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							$esl_salary_loan_deduction = $sl_salary_loan_deduction->loan_deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eloan_deduction_amount = $esl_salary_loan_deduction / 2;
								} else {
									$eloan_deduction_amount = $esl_salary_loan_deduction;
								}
							} else {
								$eloan_deduction_amount = $esl_salary_loan_deduction;
							}
							$loan_data = array(
								'payslip_id' 		=> 	$result,
								'employee_id' 		=> 	$this->input->post('emp_id'),
								'salary_month' 		=> 	$this->input->post('pay_date'),
								'loan_title' 		=> 	$sl_salary_loan_deduction->loan_deduction_title,
								'loan_amount' 		=> 	$eloan_deduction_amount,
								'created_at' 		=> 	date('d-m-Y h:i:s')
							);
							$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
						}
					}
				}


				// overtime
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($overtime) {
					$ot_days = 0;
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
						$ot_days += 1;
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($this->input->post('emp_id'));

					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;

						$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}

					$overtime_data = array(
						'payslip_id' 			=> 	$result,
						'employee_id' 			=> 	$this->input->post('emp_id'),
						'overtime_salary_month' => 	$this->input->post('pay_date'),
						'overtime_no_of_days' 	=> 	$ot_days,
						'overtime_hours' 		=> 	$ot_hrs,
						'overtime_rate' 		=> 	$rate,
						'total_overtime' 		=> 	$overtime_amount,
						'created_at' 			=> 	date('d-m-Y h:i:s')
					);
					$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				}

				//cpf
				$total_cpf =  $this->input->post('total_cpf');
				if ($total_cpf && $total_cpf > 0) {
					$ow_paid = $this->input->post('ow_paid');
					$cpf_data = [
						'payslip_id' 	=> 	$result,
						'month_year' 	=> 	'01-' . $this->input->post('pay_date'),
						'ow_paid'		=> 	$ow_paid,
						'ow_cpf'		=> 	$this->input->post('ow_cpf'),
						'ow_cpf_employer'	=> $this->input->post('ow_cpf_employer'),
						'ow_cpf_employee'	=> $this->input->post('ow_cpf_employee'),
						'aw_paid'		=> 	$this->input->post('aw_paid'),
						'aw_cpf'		=> 	$this->input->post('aw_cpf'),
						'aw_cpf_employer'	=> $this->input->post('aw_cpf_employer'),
						'aw_cpf_employee'	=> $this->input->post('aw_cpf_employee')
					];

					$cpf_payslip = $this->Cpf_payslip_model->add_cpf_payslip($cpf_data);
				}

				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' 			=> 	$result,
						'contribution_id' 		=> 	$contribution_id,
						'contribution_amount' 	=> $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}


				//ASHG Fund Contributions
				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' 			=> 	$result,
						'contribution_id' 		=> 	$contribution_id,
						'contribution_amount' 	=> 	$contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//sdl
				$sdl = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl = 11.25;
				}

				$cdata = array(
					'payslip_id'		 	=> 	$result,
					'contribution_id' 		=> 	5,
					'contribution_amount' 	=> 	$sdl
				);
				$this->Contribution_fund_model->setContributionPayslip($cdata);

				$Return['result'] = $this->lang->line('xin_success_payment_paid');
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
			$this->output($Return);
			exit;
		}
	}


	// for advance payment list
	public function payslip_list_bulk_advance()
	{


		$data['title'] = $this->Xin_model->site_title();
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			$this->load->view("admin/payroll/generate_payslip", $data);
		} else {
			redirect('admin/');
		}

		// Datatables Variables
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));

		// payment month
		$pay_date = $this->input->get("month_year");

		$role_resources_ids = $this->Xin_model->user_role_resource();
		$user_info = $this->Xin_model->read_user_info($session['user_id']);
		if ($user_info[0]->user_role_id == 1 || in_array('314', $role_resources_ids)) {
			if ($this->input->get("employee_id") == 0 && $this->input->get("company_id") == 0) {
				$payslip = $this->Employees_model->get_employees_payslip($pay_date);
			} else if ($this->input->get("employee_id") == 0 && $this->input->get("company_id") != 0) {
				$payslip = $this->Payroll_model->get_comp_template($this->input->get("company_id"), 0, $pay_date);
			} else if ($this->input->get("employee_id") != 0 && $this->input->get("company_id") != 0) {
				$payslip = $this->Payroll_model->get_employee_comp_template($this->input->get("company_id"), $this->input->get("employee_id"), $pay_date);
			} else {
				$payslip = $this->Employees_model->get_employees_payslip($pay_date);
			}
		} else {
			$payslip = $this->Payroll_model->get_employee_comp_template($user_info[0]->company_id, $session['user_id']);
		}

		$system = $this->Xin_model->read_setting_info(1);
		$data = array();
		foreach ($payslip->result() as $r) {
			$exit_employee = $this->Employees_model->get_employee_exit($r->user_id);

			if (count($exit_employee) > 0) {
				$e_date = date('Y-m-d', strtotime($exit_employee[0]->exit_date));
				$exit_date = date('m-Y', strtotime($e_date));
				if ($exit_date >= $pay_date) {
					$emp_name = $r->first_name . ' ' . $r->last_name;
					// office shift
					$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);
	
					//overtime request
					$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
					$re_hrs_old_int1 = 0;
					$re_hrs_old_seconds = 0;
					$re_pcount = 0;
					foreach ($overtime_count as $overtime_hr) {
						$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
						$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
						$re_interval_late = $request_clock_in->diff($request_clock_out);
						$re_hours_r  = $re_interval_late->format('%h');
						$re_minutes_r = $re_interval_late->format('%i');
						$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';
	
						$re_str_time = $re_total_time;
	
						$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);
	
						sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$re_hrs_old_int1 += $re_hrs_old_seconds;
	
						$re_pcount = gmdate("H", $re_hrs_old_int1);
					}
	
					$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
					$hrs_old_int1 = 0;
					$pcount = 0;
					foreach ($result->result() as $hour_work) {
						$clock_in =  new DateTime($hour_work->clock_in);
						$clock_out =  new DateTime($hour_work->clock_out);
						$interval_late = $clock_in->diff($clock_out);
						$hours_r  = $interval_late->format('%h');
						$minutes_r = $interval_late->format('%i');
						$total_time = $hours_r . ":" . $minutes_r . ":" . '00';
	
						$str_time = $total_time;
	
						$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);
	
						sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);
	
						$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;
	
						$hrs_old_int1 += $hrs_old_seconds;
	
						$pcount = gmdate("H", $hrs_old_int1);
					}
					$pcount = $pcount + $re_pcount;
	
					// get company
					$company = $this->Xin_model->read_company_info($r->company_id);
					if (!is_null($company)) {
						$comp_name = $company[0]->name;
					} else {
						$comp_name = '--';
					}
	
					/**
					 * Local Variable
					 */
					$g_ordinary_wage = 0;
					$g_additional_wage = 0;
					$g_shg = 0;
					$g_sdl = 0;
	
					// 1: salary type
					if ($r->wages_type == 1) {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					} else if ($r->wages_type == 2) {
						$wages_type = $this->lang->line('xin_employee_daily_wages');
						if ($pcount > 0) {
							$basic_salary = $pcount * $r->basic_salary;
						} else {
							$basic_salary = $pcount;
						}
						$p_class = 'emo_hourly_pay';
						$view_p_class = 'hourlywages_template_modal';
					} else {
						$wages_type = $this->lang->line('xin_payroll_basic_salary');
						if ($system[0]->is_half_monthly == 1) {
							$basic_salary = $r->basic_salary / 2;
						} else {
							$basic_salary = $r->basic_salary;
						}
						$p_class = 'emo_monthly_pay';
						$view_p_class = 'payroll_template_modal';
					}
	
					
	
					// employee deduction
					$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
					$pa_month = date('m-Y', strtotime('01-' . $pay_date));
					$deduction_amount = 0;
					if ($employee_deduction) {
						foreach ($employee_deduction as $deduction) {
							if ($deduction->type_id == 1) {
								$deduction_amount +=  $deduction->amount;
							}
							if ($deduction->type_id == 2) {
								$from_month_year = date('m-Y', strtotime($deduction->from_date));
								$to_month_year = date('d-m-Y', strtotime($deduction->to_date));
	
	
								if ($from_month_year != "" && $to_month_year != "") {
									if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
										$deduction_amount +=  $deduction->amount;
									}
								}
							}
						}
					}
	
	
	
					//3: Gross rate of pay (unpaid leave deduction)
					$holidays_count = 0;
					$no_of_working_days = 0;
					$month_start_date = new DateTime('01-' . $pay_date);
					$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
					$month_end_date->modify('+1 day');
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($month_start_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$period_day = $p->format('l');
						$period_date = $p->format('Y-m-d');
	
						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
						if ($is_holiday) {
							$holidays_count += 1;
						}
	
						//working days excluding holidays based on office shift
						if ($period_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_working_days += 1;
							}
						}
					}
	
					//unpaid leave
					$unpaid_leave_amount = 0;
					$leaves_taken_count = 0;
					$leave_period = array();
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							$pay_date_month = new DateTime('01-' . $pay_date);
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);
	
							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {
									if ($office_shift[0]->monday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
						}
					}
	
					// if joining date and pay date same then this logic work
					$month_date_join = date('m-Y', strtotime($r->date_of_joining));
					$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
					$month_last_date = date('m-Y', strtotime($lastday));
	
					$first_date =  new DateTime($r->date_of_joining);
					$no_of_days_worked = 0;
					$same_month_holidays_count = 0;
					if ($month_date_join == $pay_date) {
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($first_date, $interval, $month_end_date);
						foreach ($period as $p) {
							$p_day = $p->format('l');
							$m_p_date = $p->format('Y-m-d');
	
							//holidays in a month
							$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
							if ($is_holiday) {
								$same_month_holidays_count += 1;
							}
	
							//working days excluding holidays based on office shift
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$no_of_days_worked += 1;
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$no_of_days_worked += 1;
								}
							}
						}
					// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
					$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
					} else {
						// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
						$no_of_days_worked = $no_of_working_days -  $holidays_count;
					}
	
	
					if ($month_date_join == $pay_date){
						$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
					}else{
						$show_main_salary = $basic_salary;
					}
				
					$g_ordinary_wage += $show_main_salary;
					$g_shg += $show_main_salary;
					$g_sdl += $show_main_salary;
				
					$g_ordinary_wage -= $deduction_amount;
					$g_shg -= $deduction_amount;
					$g_sdl -= $deduction_amount;
	
	
					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
							$loan_de_amount += $er_loan;
						}
					} else {
						$loan_de_amount = 0;
					}
					$loan_de_amount = number_format(floatval($loan_de_amount), 2);
	
					
					// 2: all allowances
					$allowance_amount = 0;
					$gross_allowance_amount = 0;
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
	
	
							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								if ($month_date_join == $pay_date){
									$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
								}
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}
	
							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}
	
							$allowance_amount += $eallowance_amount;
						}
					}
					$gross_allowance_amount = $allowance_amount;
	
	
	
					// commissions
					$commissions_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $c->commission_amount / 2;
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
	
							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommissions_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommissions_amount;
							}
	
							if ($c->sdl == 1) {
								$g_sdl += $ecommissions_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommissions_amount;
							}
	
							$commissions_amount += $ecommissions_amount;
						}
					}
	
					//share options
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
	
								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;
					}
	
					
					// otherpayments
					$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
					$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
					$other_payments_amount = 0;
					if ($count_other_payments > 0) {
						foreach ($other_payments->result() as $sl_other_payments) {
							if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
								if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}
	
									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
	
									$other_payments_amount += $epayments_amount;
								}
							} else {
								$first_date = new DateTime($sl_other_payments->date);
								if ($first_date->format('m-Y') == $pay_date) {
									$first_date =  new DateTime($sl_other_payments->date);
								} else {
									$first_date = new DateTime('01-' . $pay_date);
								}
	
								$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));
	
								if (!empty($sl_other_payments->end_date)) {
									$last_date = new DateTime($sl_other_payments->end_date);
									if ($last_date->format('m-Y') == $pay_date) {
										$last_date = new DateTime($sl_other_payments->end_date);
									} else if($last_date->format('m-Y') >= $pay_date){
										$last_date = $month_end_date_for_other;
									} else {
										$last_date = '';
									}
								} else {
									$last_date = $month_end_date_for_other;
								}
								if(!empty($last_date)){
									$last_date->modify('+1 day');
									$final_last_day = new DateTime($last_date->format('d-m-Y'));
									if ($final_last_day->format('m-Y') >= $pay_date) {
										if ($system[0]->is_half_monthly == 1) {
											if ($system[0]->half_deduct_month == 2) {
												$epayments_amount = $sl_other_payments->payments_amount / 2;
											} else {
												$epayments_amount = $sl_other_payments->payments_amount;
											}
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
	
	
										// it for no of working day
										$no_of_days_worked_for_other_payment = 0;
										$same_month_holidays_count_for_other_payment = 0;
										$interval = new DateInterval('P1D');
										$period = new DatePeriod($first_date, $interval, $last_date);
										foreach ($period as $p) {
											$p_day = $p->format('l');
											$p_date = $p->format('Y-m-d');
	
											//holidays in a month
	
											$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
											if ($is_holiday) {
												$same_month_holidays_count_for_other_payment += 1;
											}
	
											//working days excluding holidays based on office shift
											if ($p_day == 'Monday') {
												if ($office_shift[0]->monday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Tuesday') {
												if ($office_shift[0]->tuesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Wednesday') {
												if ($office_shift[0]->wednesday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Thursday') {
												if ($office_shift[0]->thursday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Friday') {
												if ($office_shift[0]->friday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Saturday') {
												if ($office_shift[0]->saturday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											} else if ($p_day == 'Sunday') {
												if ($office_shift[0]->sunday_in_time != '') {
													$no_of_days_worked_for_other_payment += 1;
												}
											}
										}
	
										$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
										$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);
	
	
										if ($sl_other_payments->cpf_applicable == 1) {
											$g_additional_wage += $epayments_amount;
											$g_shg += $epayments_amount;
											$g_sdl += $epayments_amount;
										}
										$other_payments_amount += $epayments_amount;
									}
								}
							}
						}
					} else {
						$other_payments_amount = 0;
					}
	
					$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
		
					if ($unpaid_leaves) {
						$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
					}
					
					// $g_ordinary_wage = $gross_pay;
					$g_shg = $gross_pay;
					$g_sdl = $gross_pay;
	
					$g_ordinary_wage -= $unpaid_leave_amount;
	
					
	
					// other benefit
					$other_benefit_mount = 0;
					$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
					foreach ($other_benefit_list->result() as $benefit_list) {
						$other_benefit_mount += $benefit_list->other_benefit_cost;
					}
	
	
					// statutory_deductions
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') {
								$sta_salary = $gross_pay;
								$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							} else {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_salary_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							}
						}
					} else {
						$statutory_deductions_amount = 0;
					}
	
					// overtime
					$overtime_amount = 0;
					$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
					if ($overtime) {
						$ot_hrs = 0;
						$ot_mins = 0;
						foreach ($overtime as $ot) {
							$total_hours = explode(':', $ot->total_hours);
							$ot_hrs += $total_hours[0];
							$ot_mins += $total_hours[1];
						}
						if ($ot_mins > 0) {
							$ot_hrs += round($ot_mins / 60, 2);
						}
	
						//overtime rate
						$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
						if ($overtime_rate) {
							$rate = $overtime_rate->overtime_pay_rate;
						} else {
							$week_hours = 44;
							$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
							$rate = $rate * 1.5;
						}
	
						if ($ot_hrs > 0) {
							$overtime_amount = round($ot_hrs * $rate, 2);
						}
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$overtime_amount = $overtime_amount / 2;
							}
						}
						$g_ordinary_wage += $overtime_amount;
						$g_sdl += $overtime_amount;
					}
	
					
					$payment_check = $this->Payroll_model->check_make_payment_payslip_for_first_payment($r->user_id, $pay_date);
					$payment_check_final = $this->Payroll_model->check_make_payment_payslip_for_final_payment($r->user_id, $pay_date);
					$balance = 0;
					$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
					if($check && $check[0]->balance_amount > 0){
						$balance = $check[0]->balance_amount;
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
						$status = '<span class="label label-warning">' . "Partially Paid" . '</span>';
	
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
						
						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$delete  = $delete;
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						
					}else if($check && $check[0]->balance_amount == 0){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
					
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;
	
						$status = '<span class="label label-success">Paid</span>';
	
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
						
						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$delete  = $delete;
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						
					}else {
							$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
							$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
							$delete = '';
							$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
							$balance = $this->Xin_model->currency_sign(0, $r->user_id);
						}
	
					
					// employee accommodations
					$employee_accommodations = 0;
					$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
					foreach ($get_employee_accommodations as $get_employee_accommodation) {
						$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
						$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
						if ($period_from == $pay_date || $period_to == $pay_date) {
							if (!empty($get_employee_accommodation->rent_paid)) {
								$employee_accommodations += $get_employee_accommodation->rent_paid;
							}
						}
					}
	
					// employee claims
					$claim_amount = 0;
					$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
					foreach ($get_employee_claims->result() as $claims) {
						$date 	= 	date('m-Y', strtotime($claims->date));
						if ($date == $pay_date) {
							$claim_amount += $claims->amount;
						}
					}
	
	
	
					$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
					$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
					$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;
	
	
					// cpf calculation
					$emp_dob = $r->date_of_birth;
					$dob = new DateTime($emp_dob);
	
					$today = new DateTime('01-' . $pay_date);
					$age = $dob->diff($today);
					$age_year = $age->y;
					$age_month = $age->m;
	
					$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
					$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
					$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;
	
					if ($age_month > 0) {
						$age_year = $age_year + 1;
					}
	
					$cpf_employee 	= 	0;
					$cpf_employer	=	0;
	
					$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
					if ($im_status) {
						$immigration_id = $im_status->immigration_id;
						if ($immigration_id == 2) {
							$issue_date = $im_status->issue_date;
							$i_date = new DateTime($issue_date);
							$today = new DateTime();
							$pr_age = $i_date->diff($today);
							$pr_age_year = $pr_age->y;
							$pr_age_month = $pr_age->m;
						}
	
						if ($immigration_id == 1 || $immigration_id == 2) {
	
							$ordinary_wage = $g_ordinary_wage;
							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}
	
							//additional wage
							$additional_wage = $g_additional_wage;
							$aw = $g_additional_wage;
							$tw = $ow + $additional_wage;
							if ($im_status->issue_date != "") {
								if ($pr_age_year == 1) {
	
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(4 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 666) {
												$total_cpf = 666;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw < 500) {
											$cpf_employer = round(3.5 / 100 * $tw);
											$cpf_employee = 0;
										} else if ($tw > 500 && $tw < 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
											$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;
	
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 2) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.45 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
											$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
											if ($count_total_cpf > 1776) {
												$total_cpf = 1776;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1110) {
												$cpf_employee = 1110;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(6 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.375 * ($tw - 500));
											$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
											$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
											if ($count_total_cpf > 1369) {
												$total_cpf = 1369;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 925) {
												$cpf_employee = 925;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
											if ($count_total_cpf > 814) {
												$total_cpf = 814;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(3.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
											if ($count_total_cpf > 629) {
												$total_cpf = 629;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
								if ($pr_age_year == 3 || $pr_age_year > 3) {
									if ($age_year <= 55) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(17 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.6 * ($tw - 500));
											$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
											$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
											if ($count_total_cpf > 2738) {
												$total_cpf = 2738;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1480) {
												$cpf_employee = 1480;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = $total_cpf - $cpf_employee;
										}
									} else if ($age_year > 55 && $age_year <= 60) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(15.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.51 * ($tw - 500));
											$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
											$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
											if ($count_total_cpf > 2405) {
												$total_cpf = 2405;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 1258) {
												$cpf_employee = 1258;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 60 && $age_year <= 65) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(12 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.345 * ($tw - 500));
											$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
											$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
											if ($count_total_cpf > 1739) {
												$total_cpf = 1739;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 851) {
												$cpf_employee = 851;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 65 && $age_year <= 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(9 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.225 * ($tw - 500));
											$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
											$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
											if ($count_total_cpf > 1221) {
												$total_cpf = 1221;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 555) {
												$cpf_employee = 555;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									} else if ($age_year > 70) {
										if ($tw < 50) {
											$cpf_employee = 0;
											$cpf_employer = 0;
										} else if ($tw > 50 && $tw <= 500) {
											$cpf_employee = 0;
											$cpf_employer = round(7.5 / 100 * $tw);
										} else if ($tw > 500 && $tw <= 750) {
											$cpf_employee = floor(0.15 * ($tw - 500));
											$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
											$cpf_employer = round($total_cpf - $cpf_employee);
										} else if ($tw > 750) {
											$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
											$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
											if ($count_total_cpf > 925) {
												$total_cpf = 925;
											} else {
												$total_cpf = $count_total_cpf;
											}
											if ($count_cpf_employee > 370) {
												$cpf_employee = 370;
											} else {
												$cpf_employee = floor($count_cpf_employee);
											}
											$cpf_employer = round($total_cpf - $cpf_employee);
										}
									}
								}
							}
	
	
	
							if ($immigration_id == 1) {
	
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$count_total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
	
	
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
	
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$count_total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;
	
										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;
	
										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
	
										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
	
							$total_net_salary = $total_net_salary - $cpf_employee;
							$cpf_total = $cpf_employee + $cpf_employer;
	
							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
						}
					}
	
	
					$shg_fund_deduction_amount = 0;
					//Other Fund Contributions
					$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
	
					if ($employee_contributions && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$shg_fund_name = $contribution_type[0]->contribution;
						$shg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
					}
					$ashg_fund_deduction_amount = 0;
	
					$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
					if ($employee_ashg_contributions  && $g_shg > 0) {
						$gross_s = $g_shg;
						$contribution_id = $employee_ashg_contributions->contribution_id;
						$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
						$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
						$ashg_fund_name = $contribution_type[0]->contribution;
	
						$ashg_fund_deduction_amount += $contribution_amount;
						$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
					}
	
					// echo $total_net_salary;
	
					// $sdl_total_amount = 0;
					// if ($g_sdl > 1 && $g_sdl <= 800) {
					// 	$sdl_total_amount = 2;
					// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					// 	$sdl_amount = (0.25 * $g_sdl) / 100;
					// 	$sdl_total_amount = $sdl_amount;
					// } elseif ($g_sdl > 4500) {
					// 	$sdl_total_amount = 11.25;
					// }
	
	
					$net_salary = number_format((float)$total_net_salary, 2, '.', '');
					$basic_salary = number_format((float)$basic_salary, 2, '.', '');
					// if ($basic_salary == 0 || $basic_salary == '') {
					// 	$fmpay = '';
					// } else {
						$fmpay = $mpay;
					// }
	
					$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';
	
					//action link
					$act = $detail . $fmpay . $delete;
					// $act = $fmpay . $delete;
	
					if ($r->wages_type == 1) {
						if ($system[0]->is_half_monthly == 1) {
							$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
						} else {
							$emp_payroll_wage = $wages_type;
						}
					} else {
						$emp_payroll_wage = $wages_type;
					}
	
					$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
					$p = $payslips->result();
					
					$mode_of_payment = $r->payment_mode ?? '';
	
					$field =  '<div class="k-top"><span class="k-icon k-plus" role="presentation"></span><span class="k-checkbox" role="presentation"  style="display:inline-block;"><label><input type="checkbox"  class="role-checkbox user_check_box_adavance" value="'.$r->user_id.'"> </label></span><span class="k-in k-state-focused"></span></div>';
					$field_in =  '<input type="number"  name="advance_amount[]"  class="form-control advance_class"  style="width: 100px;">';
				
	
					// $data[] = array(
					// 	// $act,
					// 	$iemp_name,
					// 	$emp_payroll_wage,
					// 	// $basic_salary,
					// 	$this->Xin_model->currency_sign($show_main_salary, $r->user_id),
					// 	$this->Xin_model->currency_sign($cpf_employee, $r->user_id),
					// 	$net_salary,
					// 	$balance,
					// 	$mode_of_payment,
					// 	$status
					// );
	
					
					$data[] = array(
						$field,
						$iemp_name,
						$this->Xin_model->currency_sign($show_main_salary, $r->user_id),
						$field_in,
					);
				}
			} else {
				$emp_name = $r->first_name . ' ' . $r->last_name;
				// office shift
				$office_shift = $this->Timesheet_model->read_office_shift_information($r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}

				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);
				$hrs_old_int1 = 0;
				$pcount = 0;
				foreach ($result->result() as $hour_work) {
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}
				$pcount = $pcount + $re_pcount;

				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}

				

				// employee deduction
				$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
				$pa_month = date('m-Y', strtotime('01-' . $pay_date));
				$deduction_amount = 0;
				if ($employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						if ($deduction->type_id == 1) {
							$deduction_amount +=  $deduction->amount;
						}
						if ($deduction->type_id == 2) {
							$from_month_year = date('m-Y', strtotime($deduction->from_date));
							$to_month_year = date('d-m-Y', strtotime($deduction->to_date));


							if ($from_month_year != "" && $to_month_year != "") {
								if ($pa_month == $from_month_year || $pa_month == $to_month_year) {
									$deduction_amount +=  $deduction->amount;
								}
							}
						}
					}
				}



				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				$month_start_date = new DateTime('01-' . $pay_date);
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						$pay_date_month = new DateTime('01-' . $pay_date);
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
					}
				}

				// if joining date and pay date same then this logic work
				$month_date_join = date('m-Y', strtotime($r->date_of_joining));
				$lastday = date('t-m-Y', strtotime("01-" . $pay_date));
				$month_last_date = date('m-Y', strtotime($lastday));

				$first_date =  new DateTime($r->date_of_joining);
				$no_of_days_worked = 0;
				$same_month_holidays_count = 0;
				if ($month_date_join == $pay_date) {
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($first_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$p_day = $p->format('l');
						$m_p_date = $p->format('Y-m-d');

						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $m_p_date);
						if ($is_holiday) {
							$same_month_holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($p_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_days_worked += 1;
							}
						} else if ($p_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_days_worked += 1;
							}
						}
					}
				// $no_of_days_worked = $no_of_days_worked - ($same_month_holidays_count + $leaves_taken_count);
				$no_of_days_worked = $no_of_days_worked - $same_month_holidays_count;
				} else {
					// $no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count));
					$no_of_days_worked = $no_of_working_days -  $holidays_count;
				}


				if ($month_date_join == $pay_date){
					$show_main_salary = round((($basic_salary) / $no_of_working_days) * $no_of_days_worked, 2);
				}else{
					$show_main_salary = $basic_salary;
				}
			
				$g_ordinary_wage += $show_main_salary;
				$g_shg += $show_main_salary;
				$g_sdl += $show_main_salary;
			
				$g_ordinary_wage -= $deduction_amount;
				$g_shg -= $deduction_amount;
				$g_sdl -= $deduction_amount;


				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				if ($count_loan_deduction > 0) {
					foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
						} else {
							$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
						}
						$loan_de_amount += $er_loan;
					}
				} else {
					$loan_de_amount = 0;
				}
				$loan_de_amount = number_format(floatval($loan_de_amount), 2);

				
				// 2: all allowances
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, $pay_date);
				if ($salary_allowances) {
					foreach ($salary_allowances as $sa) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$eallowance_amount = $sa->allowance_amount / 2;
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
						} else {
							$eallowance_amount = $sa->allowance_amount;
						}


						if (!empty($sa->salary_month)) {
							$g_additional_wage += $eallowance_amount;
						} else {
							if ($month_date_join == $pay_date){
								$eallowance_amount = round((($eallowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
							}
							$g_ordinary_wage += $eallowance_amount;
							if ($sa->id == 2) {
								$gross_allowance_amount = $eallowance_amount;
							}
						}

						if ($sa->sdl == 1) {
							$g_sdl += $eallowance_amount;
						}
						if ($sa->shg == 1) {
							$g_shg += $eallowance_amount;
						}

						$allowance_amount += $eallowance_amount;
					}
				}
				$gross_allowance_amount = $allowance_amount;



				// commissions
				$commissions_amount = 0;
				$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
				if ($commissions) {
					foreach ($commissions as $c) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$ecommissions_amount = $c->commission_amount / 2;
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
						} else {
							$ecommissions_amount = $c->commission_amount;
						}

						if ($c->commission_type == 9) {
							$g_ordinary_wage += $ecommissions_amount;
						} elseif ($c->commission_type == 10) {
							$g_additional_wage += $ecommissions_amount;
						}

						if ($c->sdl == 1) {
							$g_sdl += $ecommissions_amount;
						}
						if ($c->shg == 1) {
							$g_shg += $ecommissions_amount;
						}

						$commissions_amount += $ecommissions_amount;
					}
				}

				//share options
				$share_options_amount = 0;
				$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
				if ($share_options) {
					$eebr_amount = 0;
					$eris_amount = 0;
					foreach ($share_options as $s) {
						$scheme = $s->so_scheme;
						if ($scheme == 1) {
							$price_doe = $s->price_date_of_excercise;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;
							$amount = ($price_doe - $price_ex) * $no_shares;
							$eebr_amount += $amount;
						} else {
							$price_doe = $s->price_date_of_excercise;
							$price_dog = $s->price_date_of_grant;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;

							$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
							$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
							$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
						}
					}
					$share_options_amount = round($eebr_amount + $eris_amount, 2);
					$g_additional_wage += $share_options_amount;
					$g_sdl += $share_options_amount;
					$g_shg += $share_options_amount;
				}

				
				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				if ($count_other_payments > 0) {
					foreach ($other_payments->result() as $sl_other_payments) {
						if ($sl_other_payments->ad_hoc_allowance == "Ad Hoc") {
							if ($pay_date == date('m-Y', strtotime($sl_other_payments->date))) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$epayments_amount = $sl_other_payments->payments_amount / 2;
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}
								} else {
									$epayments_amount = $sl_other_payments->payments_amount;
								}

								if ($sl_other_payments->cpf_applicable == 1) {
									$g_additional_wage += $epayments_amount;
									$g_shg += $epayments_amount;
									$g_sdl += $epayments_amount;
								}

								$other_payments_amount += $epayments_amount;
							}
						} else {
							$first_date = new DateTime($sl_other_payments->date);
							if ($first_date->format('m-Y') == $pay_date) {
								$first_date =  new DateTime($sl_other_payments->date);
							} else {
								$first_date = new DateTime('01-' . $pay_date);
							}

							$month_end_date_for_other = new DateTime($month_start_date->format('Y-m-t'));

							if (!empty($sl_other_payments->end_date)) {
								$last_date = new DateTime($sl_other_payments->end_date);
								if ($last_date->format('m-Y') == $pay_date) {
									$last_date = new DateTime($sl_other_payments->end_date);
								} else if($last_date->format('m-Y') >= $pay_date){
									$last_date = $month_end_date_for_other;
								} else {
									$last_date = '';
								}
							} else {
								$last_date = $month_end_date_for_other;
							}
							if(!empty($last_date)){
								$last_date->modify('+1 day');
								$final_last_day = new DateTime($last_date->format('d-m-Y'));
								if ($final_last_day->format('m-Y') >= $pay_date) {
									if ($system[0]->is_half_monthly == 1) {
										if ($system[0]->half_deduct_month == 2) {
											$epayments_amount = $sl_other_payments->payments_amount / 2;
										} else {
											$epayments_amount = $sl_other_payments->payments_amount;
										}
									} else {
										$epayments_amount = $sl_other_payments->payments_amount;
									}


									// it for no of working day
									$no_of_days_worked_for_other_payment = 0;
									$same_month_holidays_count_for_other_payment = 0;
									$interval = new DateInterval('P1D');
									$period = new DatePeriod($first_date, $interval, $last_date);
									foreach ($period as $p) {
										$p_day = $p->format('l');
										$p_date = $p->format('Y-m-d');

										//holidays in a month

										$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $p_date);
										if ($is_holiday) {
											$same_month_holidays_count_for_other_payment += 1;
										}

										//working days excluding holidays based on office shift
										if ($p_day == 'Monday') {
											if ($office_shift[0]->monday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Tuesday') {
											if ($office_shift[0]->tuesday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Wednesday') {
											if ($office_shift[0]->wednesday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Thursday') {
											if ($office_shift[0]->thursday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Friday') {
											if ($office_shift[0]->friday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Saturday') {
											if ($office_shift[0]->saturday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										} else if ($p_day == 'Sunday') {
											if ($office_shift[0]->sunday_in_time != '') {
												$no_of_days_worked_for_other_payment += 1;
											}
										}
									}

									$no_of_days_worked_for_other_payment = $no_of_days_worked_for_other_payment - ($same_month_holidays_count);
									$epayments_amount = round((($epayments_amount) / $no_of_working_days) * $no_of_days_worked_for_other_payment, 2);


									if ($sl_other_payments->cpf_applicable == 1) {
										$g_additional_wage += $epayments_amount;
										$g_shg += $epayments_amount;
										$g_sdl += $epayments_amount;
									}
									$other_payments_amount += $epayments_amount;
								}
							}
						}
					}
				} else {
					$other_payments_amount = 0;
				}

				$gross_pay = round(($show_main_salary + $other_payments_amount + $allowance_amount), 2);
	
				if ($unpaid_leaves) {
					$unpaid_leave_amount = round(($gross_pay /$no_of_days_worked) * $leaves_taken_count ,2);
				}
				
				// $g_ordinary_wage = $gross_pay;
				$g_shg = $gross_pay;
				$g_sdl = $gross_pay;

				$g_ordinary_wage -= $unpaid_leave_amount;

				

				// other benefit
				$other_benefit_mount = 0;
				$other_benefit_list = $this->PaymentDeduction_Model->get_all_employee_other_benefits_for_payslip($r->user_id, $pay_date);
				foreach ($other_benefit_list->result() as $benefit_list) {
					$other_benefit_mount += $benefit_list->other_benefit_cost;
				}


				// statutory_deductions
				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if ($count_statutory_deductions > 0) {
					foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
						if ($system[0]->statutory_fixed != 'yes') {
							$sta_salary = $gross_pay;
							$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $st_amount / 2;
								} else {
									$single_sd = $st_amount;
								}
							} else {
								$single_sd = $st_amount;
							}
							$statutory_deductions_amount += $single_sd;
						} else {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
							} else {
								$single_sd = $sl_salary_statutory_deductions->deduction_amount;
							}
							$statutory_deductions_amount += $single_sd;
						}
					}
				} else {
					$statutory_deductions_amount = 0;
				}

				// overtime
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
				if ($overtime) {
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;
				}

				
				$payment_check = $this->Payroll_model->check_make_payment_payslip_for_first_payment($r->user_id, $pay_date);
				$payment_check_final = $this->Payroll_model->check_make_payment_payslip_for_final_payment($r->user_id, $pay_date);
				$balance = 0;
				$check = $this->Payroll_model->check_make_payment_payslip_as_desc($r->user_id, $pay_date);
				if($check && $check[0]->balance_amount > 0){
					$balance = $check[0]->balance_amount;
					$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				
					$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

					$status = '<span class="label label-warning">' . "Partially Paid" . '</span>';

					$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
					$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
					
					if (in_array('313', $role_resources_ids)) {
						$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					} else {
						$delete = '';
					}
					// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
					$delete  = $delete;
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					
				}else if($check && $check[0]->balance_amount == 0){
					$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $pay_date);
				
					$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

					$status = '<span class="label label-success">Paid</span>';

					$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';
					
					if (in_array('313', $role_resources_ids)) {
						$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $check[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
					} else {
						$delete = '';
					}
					// $delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
					$delete  = $delete;
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					
				}else {
						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $pay_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
						$balance = $this->Xin_model->currency_sign(0, $r->user_id);
					}

				
				// employee accommodations
				$employee_accommodations = 0;
				$get_employee_accommodations = $this->PaymentDeduction_Model->get_employee_accommodations_by_employee_id($r->user_id, $pay_date);
				foreach ($get_employee_accommodations as $get_employee_accommodation) {
					$period_from 	= 	date('m-Y', strtotime($get_employee_accommodation->period_from));
					$period_to 		= 	date('m-Y', strtotime($get_employee_accommodation->period_to));
					if ($period_from == $pay_date || $period_to == $pay_date) {
						if (!empty($get_employee_accommodation->rent_paid)) {
							$employee_accommodations += $get_employee_accommodation->rent_paid;
						}
					}
				}

				// employee claims
				$claim_amount = 0;
				$get_employee_claims = $this->Employees_model->getEmployeeClaim($r->user_id);
				foreach ($get_employee_claims->result() as $claims) {
					$date 	= 	date('m-Y', strtotime($claims->date));
					if ($date == $pay_date) {
						$claim_amount += $claims->amount;
					}
				}



				$total_earning = $show_main_salary + $allowance_amount + $overtime_amount + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount + $other_benefit_mount + $deduction_amount + $employee_accommodations;
				$total_net_salary = ($total_earning + $claim_amount) - $total_deduction - $unpaid_leave_amount;


				// cpf calculation
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);

				$today = new DateTime('01-' . $pay_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}

				$cpf_employee 	= 	0;
				$cpf_employer	=	0;

				$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
				if ($im_status) {
					$immigration_id = $im_status->immigration_id;
					if ($immigration_id == 2) {
						$issue_date = $im_status->issue_date;
						$i_date = new DateTime($issue_date);
						$today = new DateTime();
						$pr_age = $i_date->diff($today);
						$pr_age_year = $pr_age->y;
						$pr_age_month = $pr_age->m;
					}

					if ($immigration_id == 1 || $immigration_id == 2) {

						$ordinary_wage = $g_ordinary_wage;
						if ($ordinary_wage > $ordinary_wage_cap) {
							$ow = $ordinary_wage_cap;
						} else {
							$ow = $ordinary_wage;
						}

						//additional wage
						$additional_wage = $g_additional_wage;
						$aw = $g_additional_wage;
						$tw = $ow + $additional_wage;
						if ($im_status->issue_date != "") {
							if ($pr_age_year == 1) {

								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(4 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 4 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (9 / 100) * $ow + (9 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 666) {
											$total_cpf = 666;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw < 500) {
										$cpf_employer = round(3.5 / 100 * $tw);
										$cpf_employee = 0;
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = (5 / 100) * $ow + (5 / 100) * $aw;
										$count_total_cpf = (8.5 / 100) * $ow + (8.5 / 100) * $aw;

										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 2) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.45 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.45 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 15 / 100 * $ow + 15 / 100 * $aw;
										$count_total_cpf = 24 / 100 * $ow + 24 / 100 * $aw;
										if ($count_total_cpf > 1776) {
											$total_cpf = 1776;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1110) {
											$cpf_employee = 1110;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(6 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.375 * ($tw - 500));
										$total_cpf = 6 / 100 * $tw + 0.375 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 12.5 / 100 * $ow + 12.5 / 100 * $aw;
										$count_total_cpf = 18.5 / 100 * $ow + 18.5 / 100 * $aw;
										if ($count_total_cpf > 1369) {
											$total_cpf = 1369;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 925) {
											$cpf_employee = 925;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 11 / 100 * $ow + 11 / 100 * $aw;
										if ($count_total_cpf > 814) {
											$total_cpf = 814;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 3.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 8.5 / 100 * $ow + 8.5 / 100 * $aw;
										if ($count_total_cpf > 629) {
											$total_cpf = 629;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
							if ($pr_age_year == 3 || $pr_age_year > 3) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(17 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
										$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
										if ($count_total_cpf > 2738) {
											$total_cpf = 2738;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1480) {
											$cpf_employee = 1480;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = $total_cpf - $cpf_employee;
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(15.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.51 * ($tw - 500));
										$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;
										$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
										if ($count_total_cpf > 2405) {
											$total_cpf = 2405;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 1258) {
											$cpf_employee = 1258;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(12 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.345 * ($tw - 500));
										$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
										$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

										if ($count_total_cpf > 1739) {
											$total_cpf = 1739;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 851) {
											$cpf_employee = 851;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
										$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

										if ($count_total_cpf > 1221) {
											$total_cpf = 1221;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 555) {
											$cpf_employee = 555;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
										$cpf_employer = round($total_cpf - $cpf_employee);
									} else if ($tw > 750) {
										$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
										$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

										if ($count_total_cpf > 925) {
											$total_cpf = 925;
										} else {
											$total_cpf = $count_total_cpf;
										}
										if ($count_cpf_employee > 370) {
											$cpf_employee = 370;
										} else {
											$cpf_employee = floor($count_cpf_employee);
										}
										$cpf_employer = round($total_cpf - $cpf_employee);
									}
								}
							}
						}



						if ($immigration_id == 1) {

							if ($age_year <= 55) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(17 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.6 * ($tw - 500));
									$total_cpf = 17 / 100 * $tw + 0.6 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 20 / 100 * $ow + 20 / 100 * $aw;
									$count_total_cpf = 37 / 100 * $ow + 37 / 100 * $aw;
									if ($count_total_cpf > 2738) {
										$count_total_cpf = 2738;
									} else {
										$total_cpf = $count_total_cpf;
									}


									if ($count_cpf_employee > 1480) {
										$cpf_employee = 1480;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 55 && $age_year <= 60) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(15.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.51 * ($tw - 500));
									$total_cpf = 15.5 / 100 * ($tw) + 0.51 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 17 / 100 * $ow + 17 / 100 * $aw;

									$count_total_cpf = 32.5 / 100 * ($ow) + 32.5 / 100 * ($aw);
									if ($count_total_cpf > 2405) {
										$count_total_cpf = 2405;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 1258) {
										$cpf_employee = 1258;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 60 && $age_year <= 65) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(12 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.345 * ($tw - 500));
									$total_cpf = 12 / 100 * $tw + 0.345 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 11.5 / 100 * $ow + 11.5 / 100 * $aw;
									$count_total_cpf = 23.5 / 100 * $ow + 23.5 / 100 * $aw;

									if ($count_total_cpf > 1739) {
										$total_cpf = 1739;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 851) {
										$cpf_employee = 851;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 65 && $age_year <= 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(9 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.225 * ($tw - 500));
									$total_cpf = 9 / 100 * $tw + 0.225 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 7.5 / 100 * $ow + 7.5 / 100 * $aw;
									$count_total_cpf = 16.5 / 100 * $ow + 16.5 / 100 * $aw;

									if ($count_total_cpf > 1221) {
										$total_cpf = 1221;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 555) {
										$cpf_employee = 555;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							} else if ($age_year > 70) {
								if ($tw < 50) {
									$cpf_employee = 0;
									$cpf_employer = 0;
								} else if ($tw > 50 && $tw <= 500) {
									$cpf_employee = 0;
									$cpf_employer = round(7.5 / 100 * $tw);
								} else if ($tw > 500 && $tw <= 750) {
									$cpf_employee = floor(0.15 * ($tw - 500));
									$total_cpf = 7.5 / 100 * $tw + 0.15 * ($tw - 500);
									$cpf_employer = round($total_cpf - $cpf_employee);
								} else if ($tw > 750) {
									$count_cpf_employee = 5 / 100 * $ow + 5 / 100 * $aw;
									$count_total_cpf = 12.5 / 100 * $ow + 12.5 / 100 * $aw;

									if ($count_total_cpf > 925) {
										$total_cpf = 925;
									} else {
										$total_cpf = $count_total_cpf;
									}
									if ($count_cpf_employee > 370) {
										$cpf_employee = 370;
									} else {
										$cpf_employee = floor($count_cpf_employee);
									}
									$cpf_employer = round($total_cpf - $cpf_employee);
								}
							}
						}

						$total_net_salary = $total_net_salary - $cpf_employee;
						$cpf_total = $cpf_employee + $cpf_employer;

						$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
						$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
						$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
					}
				}


				$shg_fund_deduction_amount = 0;
				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);

				if ($employee_contributions && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$shg_fund_name = $contribution_type[0]->contribution;
					$shg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $shg_fund_deduction_amount;
				}
				$ashg_fund_deduction_amount = 0;

				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				if ($employee_ashg_contributions  && $g_shg > 0) {
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
					$ashg_fund_name = $contribution_type[0]->contribution;

					$ashg_fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $ashg_fund_deduction_amount;
				}

				// echo $total_net_salary;

				// $sdl_total_amount = 0;
				// if ($g_sdl > 1 && $g_sdl <= 800) {
				// 	$sdl_total_amount = 2;
				// } elseif ($g_sdl > 800 && $g_sdl <= 4500) {
				// 	$sdl_amount = (0.25 * $g_sdl) / 100;
				// 	$sdl_total_amount = $sdl_amount;
				// } elseif ($g_sdl > 4500) {
				// 	$sdl_total_amount = 11.25;
				// }


				$net_salary = number_format((float)$total_net_salary, 2, '.', '');
				$basic_salary = number_format((float)$basic_salary, 2, '.', '');
				// if ($basic_salary == 0 || $basic_salary == '') {
				// 	$fmpay = '';
				// } else {
					$fmpay = $mpay;
				// }

				$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';

				//action link
				$act = $detail . $fmpay . $delete;
				// $act = $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}

				$payslips = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $pay_date);
				$p = $payslips->result();
				
				$mode_of_payment = $r->payment_mode ?? '';

				$field =  '<div class="k-top"><span class="k-icon k-plus" role="presentation"></span><span class="k-checkbox" role="presentation"  style="display:inline-block;"><label><input type="checkbox"  class="role-checkbox" name="employee_id[]" value="'.$r->user_id.'"> </label></span><span class="k-in k-state-focused"></span></div>';
				$field_in =  '<input type="number"  name="advance_amount[]"  class="form-control advance_class"  style="width: 100px;">';
			

				// $data[] = array(
				// 	// $act,
				// 	$iemp_name,
				// 	$emp_payroll_wage,
				// 	// $basic_salary,
				// 	$this->Xin_model->currency_sign($show_main_salary, $r->user_id),
				// 	$this->Xin_model->currency_sign($cpf_employee, $r->user_id),
				// 	$net_salary,
				// 	$balance,
				// 	$mode_of_payment,
				// 	$status
				// );

				
				$data[] = array(
					$field,
					$iemp_name,
					$this->Xin_model->currency_sign($show_main_salary, $r->user_id),
					$field_in,
				);
			}
		}
		$output = array(
			"draw" 				=> 	$draw,
			"recordsTotal" 		=> 	$payslip->num_rows(),
			"recordsFiltered" 	=> 	$payslip->num_rows(),
			"data" 				=> 	$data
		);
		echo json_encode($output);
		exit();
	}


	// for advance salary make payment
	public function add_pay_bulk_advance(){

		if(!empty($this->input->post('employee_id'))){
			foreach($this->input->post('employee_id') as $key => $employee_id){
				$user = $this->Xin_model->read_user_info($employee_id);
				$jurl = random_string('alnum', 40);
				$data = [
					'employee_id' 			=> 	$employee_id,
					'department_id' 		=> 	$user[0]->department_id,
					'company_id' 			=> 	$user[0]->company_id,
					'location_id' 			=> 	$user[0]->location_id,
					'designation_id' 		=> 	$user[0]->designation_id,
					'salary_month' 			=> 	$this->input->post('pay_date'),
					'basic_salary' 			=> 	$user[0]->basic_salary,
					'status' 				=> 	3,
					'payslip_type' 			=> 	'full_monthly',
					'payslip_key' 			=> 	$jurl,
					'year_to_date' 			=> 	date('d-m-Y'),
					'created_at' 			=> 	date('d-m-Y h:i:s'),
					'advance_amount'		=>	$this->input->post('advance_amount')[$key],
					'is_advance'			=> 	1
				];
			}
			$result = $this->Payroll_model->add_salary_payslip($data);
			if($result){
				$Return['result'] = $this->lang->line('xin_success_payment_paid');
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
		}else{
			$Return['error'] = 'Please Select Employee';
			$this->output($Return);
		}
	}


	// get_bank_details
	public function get_bank_details(){
		$result = $this->Company_model->read_company_information($this->input->get('company_id'));
		$data = [];
		if(!empty($result[0]->bank_details)){
			foreach(json_decode($result[0]->bank_details) as $item){
				$data[] = [
					'bank_name'		=>	$item->bank_name
				];
			}
		}

		echo json_encode($data);
	}









	public function payslip_list_bulk_rigo()
	{


		$data['title'] = $this->Xin_model->site_title();
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			// $this->load->view("admin/payroll/generate_payslip", $data);
		} else {
			redirect('admin/');
		}
		// Datatables Variables

		$this->add_pay_to_all_by_id();
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));

		// date and employee id/company id
		$p_date = $this->input->get("month_year");
		// echo $p_date;
		$role_resources_ids = $this->Xin_model->user_role_resource();
		$user_info = $this->Xin_model->read_user_info($session['user_id']);


		$system = $this->Xin_model->read_setting_info(1);
		$data = [];
		$total_amount = 0;
		foreach ($this->input->post('id') as $k => $id) {

			$payslip = $this->db->where('user_id', $id['id'])->get('xin_employees');

			// echo var_dump($payslip->result()); exit;
			foreach ($payslip->result() as $r) {


				// user full name
				$emp_name = $r->first_name . ' ' . $r->last_name;
				$full_name = '<a target="_blank" class="text-primary" href="' . site_url() . 'admin/employees/detail/' . $r->user_id . '">' . $emp_name . '</a>';

				// get total hours > worked > employee
				$pay_date = $this->input->post('month_year');

				// office shift        
				$office_shift = $this->Timesheet_model->read_office_shift_information(($r->office_shift_id == 0) ? 1 : $r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					// total work			
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}
				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);

				$hrs_old_int1 = 0;
				$pcount = 0;
				$Trest = 0;
				$total_time_rs = 0;
				$hrs_old_int_res1 = 0;
				foreach ($result->result() as $hour_work) {
					// total work			
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}
				$pcount = $pcount + $re_pcount;


				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}

				// $pay_basic = $this->Employees_model->get_basic_pay($r->user_id, $pay_date);
				$basic_salary = $basic_salary;

				$pay = 0;
				if ($id['basic_salary'] == "true") {
					$pay = $basic_salary;
				}

				$g_ordinary_wage += $pay;
				$g_shg += $pay;
				$g_sdl += $pay;


				// 2: all allowances
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, date('m-Y'));

				if ($salary_allowances && $id['allowance_amount'] == "true") {
					foreach ($salary_allowances as $sa) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$eallowance_amount = $sa->allowance_amount / 2;
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
						} else {
							$eallowance_amount = $sa->allowance_amount;
						}

						if (!empty($sa->salary_month)) {
							$g_additional_wage += $eallowance_amount;
						} else {
							$g_ordinary_wage += $eallowance_amount;

							if ($sa->id == 2) {
								$gross_allowance_amount = $eallowance_amount;
							}
						}

						if ($sa->sdl == 1) {
							$g_sdl += $eallowance_amount;
						}
						if ($sa->shg == 1) {
							$g_shg += $eallowance_amount;
						}

						$allowance_amount += $eallowance_amount;
					}
				}
				// echo "<pre>";
				// print_r($allowance_amount);
				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				// $month_start_date = new DateTime($pay_date . '-01');
				$month_start_date = new DateTime('01-' . $pay_date);
				// print_r($pay_date);die;
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
				if ($unpaid_leaves && $id['unpaid_leave_amount'] == "true") {
					foreach ($unpaid_leaves as $k => $l) {

						// $pay_date_month = new DateTime($pay_date . '-01');
						$pay_date_month = new DateTime('01-' . $pay_date);
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
						// if(count($leave_period) > 0) {
						// 	if($l->is_half_day == 0) {
						// 		$leaves_taken_count += count($leave_period);
						// 	}else {
						// 		$leaves_taken_count += count($leave_period)  / 2;
						// 	}
						// }
					}
				}

				$no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count)) + $holidays_count;
				$gross_pay = round((($basic_salary + $gross_allowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
				$unpaid_leave_amount = ($basic_salary + $gross_allowance_amount) - $gross_pay;

				// echo 'Working days : '. $no_of_working_days . '<br>';
				// echo 'Holidays : '. $holidays_count . '<br>';
				// echo 'Leaves : '. $leaves_taken_count . '<br>';
				// echo 'Leave Days : ('. implode(", " , $leave_period)  . ')<br>';
				// echo 'Leave Days : <pre>'; print_r($leave_period);
				// echo 'Days Worked : '. $no_of_days_worked . '<br>';
				// echo 'Basic Pay : '. $basic_salary . '<br>';
				// echo 'Gross Pay : '. $gross_pay . '<br>';
				$g_ordinary_wage -= $unpaid_leave_amount;
				// echo 'Unpaid Leave : '. $unpaid_leave_amount . '<br>';
				// echo '<hr>';


				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				if ($count_loan_deduction > 0 && $id['loan_de_amount'] == "true") {
					foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
						} else {
							$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
						}
						$loan_de_amount += $er_loan;
					}
				} else {
					$loan_de_amount = 0;
				}
				$loan_de_amount = number_format(floatval($loan_de_amount), 2);
				// commissionsFff
				$commissions_amount = 0;
				$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
				if ($commissions && $id['commission'] == "true") {
					foreach ($commissions as $c) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$ecommissions_amount = $c->commission_amount / 2;
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
						} else {
							$ecommissions_amount = $c->commission_amount;
						}

						if ($c->commission_type == 9) {
							$g_ordinary_wage += $ecommissions_amount;
						} elseif ($c->commission_type == 10) {
							$g_additional_wage += $ecommissions_amount;
						}

						if ($c->sdl == 1) {
							$g_sdl += $ecommissions_amount;
						}
						if ($c->shg == 1) {
							$g_shg += $ecommissions_amount;
						}

						$commissions_amount += $ecommissions_amount;
					}
				}

				//share options
				$share_options_amount = 0;
				$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
				if ($share_options) {
					$eebr_amount = 0;
					$eris_amount = 0;
					foreach ($share_options as $s) {
						$scheme = $s->so_scheme;
						if ($scheme == 1) {
							$price_doe = $s->price_date_of_excercise;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;
							$amount = ($price_doe - $price_ex) * $no_shares;
							$eebr_amount += $amount;
						} else {
							$price_doe = $s->price_date_of_excercise;
							$price_dog = $s->price_date_of_grant;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;

							$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
							$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
							$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
						}
					}
					$share_options_amount = round($eebr_amount + $eris_amount, 2);
					$g_additional_wage += $share_options_amount;
					$g_sdl += $share_options_amount;
					$g_shg += $share_options_amount;
				}

				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				// $LeaveEnchashment = $this->Employees_model->get_leave_Encashment($r->user_id, $pay_date);
				if ($count_other_payments > 0 && $id['other_payments_amount'] == "true") {
					foreach ($other_payments->result() as $sl_other_payments) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$epayments_amount = $sl_other_payments->payments_amount / 2;
							} else {
								$epayments_amount = $sl_other_payments->payments_amount;
							}
						} else {
							$epayments_amount = $sl_other_payments->payments_amount;
						}
						$other_payments_amount += $epayments_amount;
					}
					// $encamoun = $LeaveEnchashment['ench_amount'];
					// $other_payments_amount += $encamoun;
				} else {
					$other_payments_amount = 0;
				}

				// statutory_deductions

				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if ($count_statutory_deductions > 0 && $id['statutory_deductions_amount'] == "true") {
					foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
						if ($system[0]->statutory_fixed != 'yes') :
							$sta_salary = $basic_salary;
							$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $st_amount / 2;
								} else {
									$single_sd = $st_amount;
								}
							} else {
								$single_sd = $st_amount;
							}
							$statutory_deductions_amount += $single_sd;
						else :
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
							} else {
								$single_sd = $sl_salary_statutory_deductions->deduction_amount;
							}
							$statutory_deductions_amount += $single_sd;
						endif;
					}
				} else {
					$statutory_deductions_amount = 0;
				}

				// 5: overtime
				// $salary_overtime = $this->Employees_model->read_salary_overtime($r->user_id);
				// $count_overtime = $this->Employees_model->count_employee_overtime($r->user_id);
				// $overtime_amount = 0;
				// if($count_overtime > 0) {
				// 	foreach($salary_overtime as $sl_overtime){
				// 		if($system[0]->is_half_monthly==1){
				// 			if($system[0]->half_deduct_month==2){
				// 				$eovertime_hours = $sl_overtime->overtime_hours/2;
				// 				$eovertime_rate = $sl_overtime->overtime_rate/2;
				// 			} else {
				// 				$eovertime_hours = $sl_overtime->overtime_hours;
				// 				$eovertime_rate = $sl_overtime->overtime_rate;
				// 			}
				// 		} else {
				// 			$eovertime_hours = $sl_overtime->overtime_hours;
				// 			$eovertime_rate = $sl_overtime->overtime_rate;
				// 		}
				// 		$overtime_total = $eovertime_hours * $eovertime_rate;
				// 		//$overtime_total = $sl_overtime->overtime_hours * $sl_overtime->overtime_rate;
				// 		$overtime_amount += $overtime_total;
				// 	}
				// } else {
				// 	$overtime_amount = 0;
				// }
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
				if ($overtime) {
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						// if($r->office_shift_id) {
						// 	$shift = $this->Employees_model->read_shift_information($r->office_shift_id);
						// 	if($shift) {
						// 		if($shift[0]->monday_in_time != '' && $shift[0]->monday_out_time != '') {
						// 			$time1 = $shift[0]->monday_in_time;
						// 			$time2 = $shift[0]->monday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->tuesday_in_time != '' && $shift[0]->tuesday_out_time != '') {
						// 			$time1 = $shift[0]->tuesday_in_time;
						// 			$time2 = $shift[0]->tuesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->wednesday_in_time != '' && $shift[0]->wednesday_out_time != '') {
						// 			$time1 = $shift[0]->wednesday_in_time;
						// 			$time2 = $shift[0]->wednesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->thursday_in_time != '' && $shift[0]->thursday_out_time != '') {
						// 			$time1 = $shift[0]->thursday_in_time;
						// 			$time2 = $shift[0]->thursday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->friday_in_time != '' && $shift[0]->friday_out_time != '') {
						// 			$time1 = $shift[0]->friday_in_time;
						// 			$time2 = $shift[0]->friday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->saturday_in_time != '' && $shift[0]->saturday_out_time != '') {
						// 			$time1 = $shift[0]->saturday_in_time;
						// 			$time2 = $shift[0]->saturday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->sunday_in_time != '' && $shift[0]->sunday_out_time != '') {
						// 			$time1 = $shift[0]->sunday_in_time;
						// 			$time2 = $shift[0]->sunday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 	}	
						// }else {
						// 	$week_hours = 40;
						// }
						$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;
				}


				$mode_of_payment = "";

				// make payment
				if ($system[0]->is_half_monthly == 1) {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $p_date);
					$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $p_date);
					if ($payment_check->num_rows() > 1) {

						//foreach($payment_last as $payment_half_last){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $p_date);
						$mode_of_payment = $make_payment[0]->payment_mode;
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}

						$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
						//}
						//detail link
						$detail = '';
					} else if ($payment_check->num_rows() > 0) {
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $p_date);
						$mode_of_payment = $make_payment[0]->payment_mode;
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $p_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';

						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$detail = '';
					} else {
						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $p_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
					//detail link
					//$detail = '';
				} else {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $p_date);
					if ($payment_check->num_rows() > 0) {
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $p_date);
						$mode_of_payment = $make_payment[0]->payment_mode;
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
					} else {
						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $p_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
					}
					//detail link
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
				}
				// this is the allowance
				$all_overtime_P = 0;
				$all_overtime_t = 0;
				// $overt = $this->Employees_model->get_overtime($r->user_id, $pay_date);
				if ($id['all_overtime_P'] == "true") {

					$all_overtime_P = $overtime_amount;
					$all_overtime_t = $overtime_amount;
				}
				// $pay = ($r->wages_type == 2) ? $amm : $basic_salary;
				// $total_net_salary = ((float)$add_amount + (float)$pay + (float)$all_overtime_P);
				$General_amount = 0;
				$motivation_amount = 0;
				$motivation_amount_B = 0;
				$General_amount_B = 0;
				// $appeacial_allowance = $this->Employees_model->get_appeacial_allowance($r->user_id, $pay_date);
				// if ($id['motivation_amount'] == "true") {

				// 	$motivation_amount = $appeacial_allowance['motivation_amount'];
				// }
				// if ($id['General_amount'] == "true") {


				// 	$General_amount = $appeacial_allowance['General_amount'];
				// }
				// if ($id['General_amount'] == "false") {


				// 	$General_amount_B = $appeacial_allowance['General_amount'];
				// }
				// if ($id['motivation_amount'] == "false") {


				// 	$motivation_amount_B = $appeacial_allowance['motivation_amount'];
				// }
				$employee_deduction = $this->Payroll_model->get_deduction_detail($r->user_id, $pay_date);
				$total_employee_deduction = 0;
				if ($id['total_deduction'] == "true" && $employee_deduction) {
					$total_employee_deduction = array_sum(array_column($employee_deduction, 'amount'));
				}
				// this is the allowance
				// $restday_pay1 = $this->Employees_model->restday_pay($r->user_id, $pay_date);
				// $get_cliam_data = $this->Employees_model->get_cliam_data($r->user_id, $p_date);
				$get_cliam_data = 0;

				$restday_pay = 0;
				// if ($id['restday_pay'] == "true") {
				// 	$restday_pay = $restday_pay1['rest_daya_amount'];
				// }
				$g_ordinary_wage += $all_overtime_P;
				$g_sdl += $all_overtime_P;
				$g_shg += $all_overtime_P;
				$g_ordinary_wage += $restday_pay;
				$g_shg += $restday_pay;
				$g_sdl += $restday_pay;
				$g_ordinary_wage += $other_payments_amount;
				$g_shg += $other_payments_amount;
				$g_sdl += $other_payments_amount;
				// add amount				

				// 2: all allowances
				$g_ordinary_wage += $General_amount;
				$g_shg += $General_amount;
				$g_sdl += $General_amount;

				// 2: all allowances

				// 2: all allowances
				$g_ordinary_wage += $motivation_amount;
				$g_shg += $motivation_amount;
				$g_sdl += $motivation_amount;

				$g_ordinary_wage -= $total_employee_deduction;
				$g_shg -= $total_employee_deduction;
				$g_sdl -= $total_employee_deduction;



				$total_earning = floatval($General_amount) + floatval($motivation_amount) + floatval($pay) + floatval($allowance_amount) + floatval($all_overtime_P) + floatval($get_cliam_data)  + floatval($restday_pay) + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount;
				$total_net_salary = $total_earning - $total_deduction - $unpaid_leave_amount - $total_employee_deduction;



				// echo "<pre>";
				// print_r($basic_salary);
				//if($r->salary_advance_paid == ''){
				//$data1 = $add_salary. ' - ' .$loan_de_amount. ' - ' .$net_salary . ' - ' .$salary_ssempee . ' - ' .$statutory_deductions;
				//$fnet_salary = $net_salary_default + $statutory_deductions;
				//	$net_salary = $fnet_salary - $loan_de_amount;
				// this is the allowance

				// $pcount = $pcount + $re_pcount;
				// die;

				// this is the allowance

				/**
				 * Author : Syed Anees
				 * Sub Functionality : CPF on Gross Salary
				 */
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);
				$today = new DateTime($p_date . '-01');

				// $today = new DateTime('01-' . $p_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;
				//    thi=s i=s penchuan cpdf
				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}
				if ($age_year < $age_upto) {
					$age_from = null;
					$age_to = $age_year;
				} elseif ($age_year > $age_upto && $age_year <= $age_above) {
					$age_from = $age_year;
					$age_to = $age_year;
				} elseif ($age_year > $age_above) {
					$age_from = $age_year;
					$age_to = null;
				} else {
					$age_from = null;
					$age_to = null;
				}

				$cpf_employee = 0;
				$aw = 0;
				$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);

				$cpf_contribution = '';
				if ($im_status) {
					$immigration_id = $im_status->immigration_id;
					if ($immigration_id == 2) {
						$issue_date = $im_status->issue_date;
						$i_date = new DateTime($issue_date);
						$today = new DateTime();
						$pr_age = $i_date->diff($today);
						$pr_age_year = $pr_age->y;
						$pr_age_month = $pr_age->m;
						//echo $pr_age_year;exit;
						// if($pr_age_year == 0 && $pr_age_month > 0) {
						if ($pr_age_year == 0 && ($pr_age_month > 0 || $pr_age_month == 0)) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
							// }elseif($pr_age_year == 1 && $pr_age_month > 0) {
						} else if ($pr_age_year == 1 && $pr_age_month == 0) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
							// }elseif($pr_age_year == 1 && $pr_age_month > 0) {
						} elseif ($pr_age_year == 1 && $pr_age_month > 0) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
							// print_r($pr_age_month);exit;
						} elseif ($pr_age_year == 2 && $pr_age_month == 0) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
							// print_r($pr_age_month);exit;
						}
						// elseif($pr_age_year >= 2) {
						// 	// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year,2, $age_from, $age_to, 1);
						// 	$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,1);
						// }
						elseif ($pr_age_year >= 2) {
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 1, $age_from, $age_to);
						}
					} elseif ($immigration_id == 1) {
						// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 1);
						$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 1, $age_from, $age_to);
					}
					if ($immigration_id == 1 || $immigration_id == 2) {
						if ($cpf_contribution) {
							$employee_contribution = $cpf_contribution->contribution_employee;
							$employer_contribution = $cpf_contribution->contribution_employer;
							$total_cpf_contribution = $cpf_contribution->total_cpf;

							// $ordinary_wage = ($allowance_amount + $basic_salary + $overtime_amount + $all_other_payment + $commissions_amount ) - ($loan_de_amount + $statutory_deductions_amount);
							$ordinary_wage = $g_ordinary_wage;

							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}

							// $cpf_total_ow = round(($total_cpf_contribution * $ow) / 100);
							// $ow_cpf_employee = floor(($employee_contribution * $ow) / 100);
							// $ow_cpf_employer = $cpf_total_ow - $ow_cpf_employee;


							// $aw = $g_additional_wage;
							// $cpf_total_aw = round(($total_cpf_contribution * $aw) / 100);
							// $aw_cpf_employee = floor(($employee_contribution * $aw) / 100);
							// $aw_cpf_employer = $cpf_total_aw - $aw_cpf_employee;


							// $cpf_employee = $ow_cpf_employee + $aw_cpf_employee;
							// $cpf_employer = $ow_cpf_employer + $aw_cpf_employer;



							// $cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							// $cpf_employer = number_format((float)$cpf_employer, 2, '.', '');

							/*immigration id 1 cpf count start */
							if ($immigration_id == 1) {
								$tw = $aw + $ow;
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round((17 / 100 * $tw) - $cpf_employee);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$cpf_employer = round((17 / 100 * $tw) + ($cpf_employee) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(20 / 100 * $ow + 20 / 100 * $aw);
										$cpf_employer = round((37 / 100 * $ow + 37 / 100 * $aw) - $cpf_employee);
										// if ($count_cpf_employer > 2220) {
										// 	$cpf_employer = 2220;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 1200) {
										// 	$cpf_employee = 1200;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round((15 / 100 * $tw) - $cpf_employee);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.48 * ($tw - 500));
										$cpf_employer = round((15 / 100 * ($tw) + 0.48 * ($tw - 500)) - $cpf_employee);
										// print_r($cpf_employer);
									} else if ($tw > 750) {
										$cpf_employee = floor(16 / 100 * $tw);
										// + 15 / 100 * $aw;
										$cpf_employer = round(31 / 100 * ($tw) - $cpf_employee);
										// + 29.5 / 100 * ($aw);
										// if ($count_cpf_employer > 1770) {
										// 	$cpf_employer = 1770;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 900) {
										// 	$cpf_employee = 900;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(11 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.285 * ($tw - 500));
										$cpf_employer = round((11 / 100 * $tw + 0.285 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(10.5 / 100 * $tw);
										$cpf_employer = round((22 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 1230) {
										// 	$cpf_employer = 1230;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 570) {
										// 	$cpf_employee = 570;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										// (9% x $750.00) + 0.225($750.00 - $500.00);

										$cpf_employee = floor(0.225 * ($tw - 500));
										$cpf_employer = round((9 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(7.5 / 100 * $tw);
										$cpf_employer = round((16.5 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 930) {
										// 	$cpf_employer = 930;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 420) {
										// 	$cpf_employee = 420;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee =  floor(0.15 * ($tw - 500));
										$cpf_employer = round((7.5 / 100 * $tw) + 0.15 * ($tw - 500) - $cpf_employee);
									} else if ($tw > 750) {

										$cpf_employee = floor(5 / 100 * $tw);
										$cpf_employer = round((12.5 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 750) {
										// 	$cpf_employer = 750;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 300) {
										// 	$cpf_employee = 300;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								}
							}

							/* immigration id 1 cpf count end */
							if ($im_status->issue_date) {
								$issue_date = $im_status->issue_date;
								if ($issue_date != "") {
									$i_date = new DateTime($issue_date);

									$today = new DateTime();
									$pr_age = $i_date->diff($today);
									$pr_age_year = $pr_age->y;
									$pr_age_month = $pr_age->m;
									/* new CPF calculation Start*/
									$tw = $ow + $aw;
									if ($pr_age_year == 1) {

										if ($age_year <= 55) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(4 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((4 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
												$cpf_employer = round(((9 / 100) * $ow + (9 / 100) * $aw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 540) {
												// 	$cpf_employer = 540;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										} else if ($age_year > 55 && $age_year <= 60) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(4 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((4 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
												$cpf_employer = round(((9 / 100) * $ow + (9 / 100) * $aw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 540) {
												// 	$cpf_employer = 540;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										} else if ($age_year > 60 && $age_year <= 65) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round(3.5 / 100 * $tw + 0.15 * ($tw - 500));
											} else if ($tw > 750) {
												$cpf_employee = floor(5 / 100 * $tw);
												$cpf_employer = round(((8.5 / 100) * $tw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 510) {
												// 	$cpf_employer = 510;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										} else if ($age_year > 65) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((3.5 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
												$cpf_employer = round(((8.5 / 100) * $ow + (8.5 / 100) * $aw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 510) {
												// 	$cpf_employer = 510;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										}
									}
									if ($pr_age_year == 2) {
										if ($age_year <= 55) {

											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0 * $tw;
												$cpf_employer = round(9 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.45 * ($tw - 500));
												$cpf_employer = round((9 / 100 * $tw + 0.45 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(15 / 100 * $tw);
												$cpf_employer = round(24 / 100 * $tw) - $cpf_employee;
												// if ($count_cpf_employer > 1440) {
												// 	$cpf_employer = 1440;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 900) {
												// 	$cpf_employee = 900;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 55 && $age_year <= 60) {
											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(6 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.375 * ($tw - 500));
												$cpf_employer = round((6 / 100 * $tw + 0.375 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(7.5 / 100 * $tw);
												$cpf_employer = round((11 / 100 * $tw) - $cpf_employee);
												// if ($count_cpf_employer > 1110) {
												// 	$cpf_employer = 1110;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 750) {
												// 	$cpf_employee = 750;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 60 && $age_year <= 65) {
											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.225 * ($tw - 500));
												$cpf_employer = round((3.5 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(7.5 / 100 * $tw);
												$cpf_employer = round((11 / 100 * $tw) - $cpf_employee);
												// if ($count_cpf_employer > 1110) {
												// 	$cpf_employer = 1110;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 750) {
												// 	$cpf_employee = 750;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 65) {
											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((3.5 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(5 / 100 * $tw);
												$cpf_employer = round((8.5 / 100 * $tw) - $cpf_employee);
												// if ($count_cpf_employer > 1110) {
												// 	$cpf_employer = 1110;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 750) {
												// 	$cpf_employee = 750;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										}
									}
									if ($pr_age_year == 3 || $pr_age_year > 3) {
										if ($age_year <= 55) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round((17 / 100 * $tw) - $cpf_employee);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.6 * ($tw - 500));
												$cpf_employer = round((17 / 100 * $tw) + ($cpf_employee) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(20 / 100 * $ow + 20 / 100 * $aw);
												$cpf_employer = round((37 / 100 * $ow + 37 / 100 * $aw) - $cpf_employee);
												// if ($count_cpf_employer > 2220) {
												// 	$cpf_employer = 2220;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 1200) {
												// 	$cpf_employee = 1200;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 55 && $age_year <= 60) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round((15 / 100 * $tw) - $cpf_employee);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.48 * ($tw - 500));
												$cpf_employer = round((15 / 100 * ($tw) + 0.48 * ($tw - 500)) - $cpf_employee);
												// print_r($cpf_employer);
											} else if ($tw > 750) {
												$cpf_employee = floor(16 / 100 * $tw);
												// + 15 / 100 * $aw;
												$cpf_employer = round(31 / 100 * ($tw) - $cpf_employee);
												// + 29.5 / 100 * ($aw);
												// if ($count_cpf_employer > 1770) {
												// 	$cpf_employer = 1770;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 900) {
												// 	$cpf_employee = 900;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 60 && $age_year <= 65) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(11 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.285 * ($tw - 500));
												$cpf_employer = round((11 / 100 * $tw + 0.285 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(10.5 / 100 * $tw);
												$cpf_employer = round((22 / 100 * $tw) - $cpf_employee);

												// if ($count_cpf_employer > 1230) {
												// 	$cpf_employer = 1230;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 570) {
												// 	$cpf_employee = 570;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 65 && $age_year <= 70) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(9 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												// (9% x $750.00) + 0.225($750.00 - $500.00);

												$cpf_employee = floor(0.225 * ($tw - 500));
												$cpf_employer = round((9 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(7.5 / 100 * $tw);
												$cpf_employer = round((16.5 / 100 * $tw) - $cpf_employee);

												// if ($count_cpf_employer > 930) {
												// 	$cpf_employer = 930;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 420) {
												// 	$cpf_employee = 420;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 70) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(7.5 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee =  floor(0.15 * ($tw - 500));
												$cpf_employer = round((7.5 / 100 * $tw) + 0.15 * ($tw - 500) - $cpf_employee);
											} else if ($tw > 750) {

												$cpf_employee = floor(5 / 100 * $tw);
												$cpf_employer = round((12.5 / 100 * $tw) - $cpf_employee);

												// if ($count_cpf_employer > 750) {
												// 	$cpf_employer = 750;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										}
									}
								}
							}

							/* new CPF calculation End*/
							$total_net_salary = $total_net_salary - $cpf_employee;
							$cpf_total = $cpf_employee + $cpf_employer;

							// $net_salary = number_format((float)$net_salary, 2, '.', '');
							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
						}
					} else {
						$ordinary_wage = $g_ordinary_wage;
						$ow = $ordinary_wage;
						$ow_cpf_employee = 0;
						$ow_cpf_employer = 0;

						$aw = $g_additional_wage;
						$aw_cpf_employee = 0;
						$aw_cpf_employer = 0;
					}
				}
				// echo "<pre>";
				// print_r($cpf_employer);
				// echo "<pre>";
				// print_r($cpf_employee);
				//SHG Contributions
				// print_r($/);die;
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;

					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $fund_deduction_amount;
				}

				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;

					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $fund_deduction_amount;
				}

				$sdl_total_amount = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl_total_amount = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl_total_amount = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl_total_amount = 11.25;
				}

				// $total_net_salary = $total_net_salary - $sdl_total_amount;

				$net_salary = number_format((float)$total_net_salary, 2, '.', '');

				$total_amount += $net_salary;
				$w_net_salary = $net_salary;
				//$basic_salary_cal = $basic_salary * $current_rate; 
				$pay = number_format((float)$pay, 2, '.', '');

				$basic_salary = number_format((float)$basic_salary, 2, '.', '');

				if ($basic_salary == 0 || $basic_salary == '') {
					$fmpay = $mpay;
				} else {
					$fmpay = $mpay;
				}
				$company_info = $this->Company_model->read_company_information($r->company_id);
				$c_name = $company_info[0]->name;
				$Organization_Assigned_Id = $company_info[0]->Organization_Assigned_Id ?? '';
				$c_acc = $company_info[0]->IBM_ACC ?? '';

				if (!is_null($company_info)) {
					$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
					$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
					$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee, $r->company_id);
				} else {
					$basic_salary = $this->Xin_model->currency_sign($basic_salary, $r->user_id);
					$net_salary = $this->Xin_model->currency_sign($net_salary, $r->user_id);
					$cpf_employee = $this->Xin_model->currency_sign($cpf_employee, $r->user_id);
				}

				$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';
				$m_date_month = $this->input->post('m_date_month');
				$formattedDate = str_replace('-', '', $m_date_month);

				//action link
				$bank_ac = $this->Employees_model->get_bank_account_info_add($r->user_id);

				$act = $detail . $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}


				$data[] = array(
					PHP_EOL . 'PAYMENT',
					'SAL',
					$bank_ac->account_number ?? '',
					'SGD',
					'',
					'SGD',
					$formattedDate,
					'',
					'',
					'CSSOFFICE',
					'',
					'',
					'',
					'',
					'0125024040',
					'',
					'',
					'',
					'',
					'DBSSSGSGXXX',
					'',
					'',
					'',
					'',
					'',
					'',
					$w_net_salary,
					'',
					'',
					'',
					'',
					'22',
					date('M') . 'Salary',
					'',
					'',
					'',
					'',
					'',
					'',
					'SALA',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
					'',
				);
			}
		}
		$man_arr[] = ['HEADER', $formattedDate, $Organization_Assigned_Id, $c_name];
		$man_arr[] = $data;
		$man_arr[] = [PHP_EOL . 'TRAILER', count($data), $total_amount];


		echo json_encode($man_arr);
	}









	public function payslip_list_bulk_rigo_ibms()
	{


		$data['title'] = $this->Xin_model->site_title();
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			// $this->load->view("admin/payroll/generate_payslip", $data);
		} else {
			redirect('admin/');
		}
		// Datatables Variables

		$this->add_pay_to_all_by_id();
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));

		// date and employee id/company id
		$p_date = $this->input->get("month_year");
		// echo $p_date;
		$role_resources_ids = $this->Xin_model->user_role_resource();
		$user_info = $this->Xin_model->read_user_info($session['user_id']);


		$system = $this->Xin_model->read_setting_info(1);
		$data = [];
		$total_amount = 0;
		foreach ($this->input->post('id') as $k => $id) {





			$payslip = $this->db->where('user_id', $id)->get('xin_employees');



			// echo var_dump($payslip->result()); exit;
			foreach ($payslip->result() as $r) {


				// user full name
				$emp_name = $r->first_name . ' ' . $r->last_name;
				$full_name = '<a target="_blank" class="text-primary" href="' . site_url() . 'admin/employees/detail/' . $r->user_id . '">' . $emp_name . '</a>';

				// get total hours > worked > employee
				$pay_date = $this->input->post('month_year');

				// office shift        
				$office_shift = $this->Timesheet_model->read_office_shift_information(($r->office_shift_id == 0) ? 1 : $r->office_shift_id);

				//overtime request
				$overtime_count = $this->Overtime_request_model->get_overtime_request_count($r->user_id, $this->input->get('month_year'));
				$re_hrs_old_int1 = 0;
				$re_hrs_old_seconds = 0;
				$re_pcount = 0;
				foreach ($overtime_count as $overtime_hr) {
					// total work			
					$request_clock_in =  new DateTime($overtime_hr->request_clock_in);
					$request_clock_out =  new DateTime($overtime_hr->request_clock_out);
					$re_interval_late = $request_clock_in->diff($request_clock_out);
					$re_hours_r  = $re_interval_late->format('%h');
					$re_minutes_r = $re_interval_late->format('%i');
					$re_total_time = $re_hours_r . ":" . $re_minutes_r . ":" . '00';

					$re_str_time = $re_total_time;

					$re_str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $re_str_time);

					sscanf($re_str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$re_hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$re_hrs_old_int1 += $re_hrs_old_seconds;

					$re_pcount = gmdate("H", $re_hrs_old_int1);
				}
				$result = $this->Payroll_model->total_hours_worked($r->user_id, $pay_date);

				$hrs_old_int1 = 0;
				$pcount = 0;
				$Trest = 0;
				$total_time_rs = 0;
				$hrs_old_int_res1 = 0;
				foreach ($result->result() as $hour_work) {
					// total work			
					$clock_in = $hour_work->total_work;
					$clock_out =  $hour_work->total_work;
					// $interval_late = $clock_in->diff($clock_out);
					// $hours_r  = $interval_late->format('%h');
					// $minutes_r = $interval_late->format('%i');
					// $total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					// $str_time = $total_time;

					// $str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					// sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hour_work->total_work;

					// $hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}

				// get company
				$company = $this->Xin_model->read_company_info($r->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}

				/**
				 * Local Variable
				 */
				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				// 1: salary type
				if ($r->wages_type == 1) {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				} else if ($r->wages_type == 2) {
					$wages_type = $this->lang->line('xin_employee_daily_wages');
					if ($pcount > 0) {
						$basic_salary = $pcount * $r->basic_salary;
					} else {
						$basic_salary = $pcount;
					}
					$p_class = 'emo_hourly_pay';
					$view_p_class = 'hourlywages_template_modal';
				} else {
					$wages_type = $this->lang->line('xin_payroll_basic_salary');
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $r->basic_salary / 2;
					} else {
						$basic_salary = $r->basic_salary;
					}
					$p_class = 'emo_monthly_pay';
					$view_p_class = 'payroll_template_modal';
				}
				$pay_basic = $this->Employees_model->get_basic_pay($r->user_id, $pay_date);
				$pay = $pay_basic['pay'];
				// print_r($basic_salary);
				// die;
				$basic_salary = $pay;
				$g_ordinary_wage += $basic_salary;
				$g_shg += $basic_salary;
				$g_sdl += $basic_salary;
				//  print_r($r->basic_salary);
				// 2: all allowances
				$allowance_amount = 0;
				$allowance_amount_B = 0;
				$gross_allowance_amount = 0;
				$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($r->user_id, date('m-Y'));

				if ($salary_allowances) {
					foreach ($salary_allowances as $sa) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$eallowance_amount = $sa->allowance_amount / 2;
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}
						} else {
							$eallowance_amount = $sa->allowance_amount;
						}

						if (!empty($sa->salary_month)) {
							$g_additional_wage += $eallowance_amount;
						} else {
							$g_ordinary_wage += $eallowance_amount;

							if ($sa->id == 2) {
								$gross_allowance_amount = $eallowance_amount;
							}
						}

						if ($sa->sdl == 1) {
							$g_sdl += $eallowance_amount;
						}
						if ($sa->shg == 1) {
							$g_shg += $eallowance_amount;
						}

						if ($id['allowance_amount'] == "true") {
							$allowance_amount += $eallowance_amount;
						} elseif ($id['allowance_amount'] == "false") {
							$allowance_amount_B += $eallowance_amount;
						}
					}
				}
				$General_amount = 0;
				$motivation_amount = 0;
				$motivation_amount_B = 0;
				$General_amount_B = 0;
				$appeacial_allowance = $this->Employees_model->get_appeacial_allowance($user_id, $p_date);
				if ($id['motivation_amount'] == "true") {

					$motivation_amount = $appeacial_allowance['motivation_amount'];
				}
				if ($id['General_amount'] == "true") {


					$General_amount = $appeacial_allowance['General_amount'];
				}
				if ($id['General_amount'] == "false") {


					$General_amount_B = $appeacial_allowance['General_amount'];
				}
				if ($id['motivation_amount'] == "false") {


					$motivation_amount_B = $appeacial_allowance['motivation_amount'];
				}
				// echo "<pre>";
				// print_r($allowance_amount);
				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				// $month_start_date = new DateTime($pay_date . '-01');
				$month_start_date = new DateTime('01-' . $pay_date);
				// print_r($pay_date);die;
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$period_day = $p->format('l');
					$period_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($r->company_id, $period_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($period_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($period_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$unpaid_leave_amount_B = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($r->user_id, $pay_date);
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {

						// $pay_date_month = new DateTime($pay_date . '-01');
						$pay_date_month = new DateTime('01-' . $pay_date);
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
						// if(count($leave_period) > 0) {
						// 	if($l->is_half_day == 0) {
						// 		$leaves_taken_count += count($leave_period);
						// 	}else {
						// 		$leaves_taken_count += count($leave_period)  / 2;
						// 	}
						// }
					}
				}

				$no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count)) + $holidays_count;
				$gross_pay = round((($basic_salary + $gross_allowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
				$unpaid_leave_amount = ($basic_salary + $gross_allowance_amount) - $gross_pay;
				if ($id['unpaid_leave_amount'] == "true") {
					$unpaid_leave_amount = $unpaid_leave_amount;
				} elseif ($id['unpaid_leave_amount'] == "false") {
					$unpaid_leave_amount = 0;
					$unpaid_leave_amount_B = $unpaid_leave_amount;
				}
				// echo 'Working days : '. $no_of_working_days . '<br>';
				// echo 'Holidays : '. $holidays_count . '<br>';
				// echo 'Leaves : '. $leaves_taken_count . '<br>';
				// echo 'Leave Days : ('. implode(", " , $leave_period)  . ')<br>';
				// echo 'Leave Days : <pre>'; print_r($leave_period);
				// echo 'Days Worked : '. $no_of_days_worked . '<br>';
				// echo 'Basic Pay : '. $basic_salary . '<br>';
				// echo 'Gross Pay : '. $gross_pay . '<br>';
				$g_ordinary_wage -= $unpaid_leave_amount;
				// echo 'Unpaid Leave : '. $unpaid_leave_amount . '<br>';
				// echo '<hr>';


				// 3: all loan/deductions
				$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($r->user_id);
				$count_loan_deduction = $this->Employees_model->count_employee_deductions($r->user_id);
				$loan_de_amount = 0;
				$loan_de_amount_B = 0;
				if ($count_loan_deduction > 0 && $id['loan_de_amount'] == "true") {
					foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
						$loan_de_amount += $sl_salary_loan_deduction->loan_deduction_amount;
					}
				} else {
					$loan_de_amount = 0;
				}
				if ($count_loan_deduction > 0 && $id['loan_de_amount'] == "false") {
					foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
						$loan_de_amount_B += $sl_salary_loan_deduction->loan_deduction_amount;
					}
				} else {
					$loan_de_amount = 0;
				}
				$loan_de_amount = number_format(floatval($loan_de_amount), 2);
				// commissionsFff
				$commissions_amount = 0;
				$commissions = $this->Employees_model->getEmployeeMonthlyCommission($r->user_id, $pay_date);
				if ($commissions && $id['commission'] == "true") {
					foreach ($commissions as $c) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$ecommissions_amount = $c->commission_amount / 2;
							} else {
								$ecommissions_amount = $c->commission_amount;
							}
						} else {
							$ecommissions_amount = $c->commission_amount;
						}

						if ($c->commission_type == 9) {
							$g_ordinary_wage += $ecommissions_amount;
						} elseif ($c->commission_type == 10) {
							$g_additional_wage += $ecommissions_amount;
						}

						if ($c->sdl == 1) {
							$g_sdl += $ecommissions_amount;
						}
						if ($c->shg == 1) {
							$g_shg += $ecommissions_amount;
						}

						$commissions_amount += $ecommissions_amount;
					}
				}

				//share options
				$share_options_amount = 0;
				$share_options = $this->Employees_model->getEmployeeShareOptions($r->user_id, $pay_date);
				if ($share_options && $id['share_options_amount'] == "true") {
					$eebr_amount = 0;
					$eris_amount = 0;
					foreach ($share_options as $s) {
						$scheme = $s->so_scheme;
						if ($scheme == 1) {
							$price_doe = $s->price_date_of_excercise;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;
							$amount = ($price_doe - $price_ex) * $no_shares;
							$eebr_amount += $amount;
						} else {
							$price_doe = $s->price_date_of_excercise;
							$price_dog = $s->price_date_of_grant;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;

							$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
							$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
							$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
						}
					}
					$share_options_amount = round($eebr_amount + $eris_amount, 2);
					$g_additional_wage += $share_options_amount;
					$g_sdl += $share_options_amount;
					$g_shg += $share_options_amount;
				}

				// otherpayments
				$count_other_payments = $this->Employees_model->count_employee_other_payments($r->user_id);
				$other_payments = $this->Employees_model->set_employee_other_payments($r->user_id);
				$other_payments_amount = 0;
				if ($count_other_payments > 0 && $id['other_payments_amount'] == "true") {
					foreach ($other_payments->result() as $sl_other_payments) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$epayments_amount = $sl_other_payments->payments_amount / 2;
							} else {
								$epayments_amount = $sl_other_payments->payments_amount;
							}
						} else {
							$epayments_amount = $sl_other_payments->payments_amount;
						}
						$other_payments_amount += $epayments_amount;
					}
				} else {
					$other_payments_amount = 0;
				}
				$LeaveEnchashment = $this->Employees_model->get_leave_Encashment($r->user_id, $pay_date);
				$encamoun = $LeaveEnchashment['ench_amount'];

				$other_payments_amount += $encamoun;
				// statutory_deductions
				$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($r->user_id);
				$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($r->user_id);
				$statutory_deductions_amount = 0;
				if ($count_statutory_deductions > 0 && $id['statutory_deductions_amount'] == "true") {
					foreach ($statutory_deductions->result() as $sl_salary_statutory_deductions) {
						if ($system[0]->statutory_fixed != 'yes') :
							$sta_salary = $basic_salary;
							$st_amount = $sta_salary / 100 * $sl_salary_statutory_deductions->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $st_amount / 2;
								} else {
									$single_sd = $st_amount;
								}
							} else {
								$single_sd = $st_amount;
							}
							$statutory_deductions_amount += $single_sd;
						else :
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount / 2;
								} else {
									$single_sd = $sl_salary_statutory_deductions->deduction_amount;
								}
							} else {
								$single_sd = $sl_salary_statutory_deductions->deduction_amount;
							}
							$statutory_deductions_amount += $single_sd;
						endif;
					}
				} else {
					$statutory_deductions_amount = 0;
				}

				// 5: overtime
				// $salary_overtime = $this->Employees_model->read_salary_overtime($r->user_id);
				// $count_overtime = $this->Employees_model->count_employee_overtime($r->user_id);
				// $overtime_amount = 0;
				// if($count_overtime > 0) {
				// 	foreach($salary_overtime as $sl_overtime){
				// 		if($system[0]->is_half_monthly==1){
				// 			if($system[0]->half_deduct_month==2){
				// 				$eovertime_hours = $sl_overtime->overtime_hours/2;
				// 				$eovertime_rate = $sl_overtime->overtime_rate/2;
				// 			} else {
				// 				$eovertime_hours = $sl_overtime->overtime_hours;
				// 				$eovertime_rate = $sl_overtime->overtime_rate;
				// 			}
				// 		} else {
				// 			$eovertime_hours = $sl_overtime->overtime_hours;
				// 			$eovertime_rate = $sl_overtime->overtime_rate;
				// 		}
				// 		$overtime_total = $eovertime_hours * $eovertime_rate;
				// 		//$overtime_total = $sl_overtime->overtime_hours * $sl_overtime->overtime_rate;
				// 		$overtime_amount += $overtime_total;
				// 	}
				// } else {
				// 	$overtime_amount = 0;
				// }
				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($r->user_id, $pay_date);
				if ($overtime) {
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($r->user_id);
					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						// if($r->office_shift_id) {
						// 	$shift = $this->Employees_model->read_shift_information($r->office_shift_id);
						// 	if($shift) {
						// 		if($shift[0]->monday_in_time != '' && $shift[0]->monday_out_time != '') {
						// 			$time1 = $shift[0]->monday_in_time;
						// 			$time2 = $shift[0]->monday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->tuesday_in_time != '' && $shift[0]->tuesday_out_time != '') {
						// 			$time1 = $shift[0]->tuesday_in_time;
						// 			$time2 = $shift[0]->tuesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->wednesday_in_time != '' && $shift[0]->wednesday_out_time != '') {
						// 			$time1 = $shift[0]->wednesday_in_time;
						// 			$time2 = $shift[0]->wednesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->thursday_in_time != '' && $shift[0]->thursday_out_time != '') {
						// 			$time1 = $shift[0]->thursday_in_time;
						// 			$time2 = $shift[0]->thursday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->friday_in_time != '' && $shift[0]->friday_out_time != '') {
						// 			$time1 = $shift[0]->friday_in_time;
						// 			$time2 = $shift[0]->friday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->saturday_in_time != '' && $shift[0]->saturday_out_time != '') {
						// 			$time1 = $shift[0]->saturday_in_time;
						// 			$time2 = $shift[0]->saturday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->sunday_in_time != '' && $shift[0]->sunday_out_time != '') {
						// 			$time1 = $shift[0]->sunday_in_time;
						// 			$time2 = $shift[0]->sunday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 	}	
						// }else {
						// 	$week_hours = 40;
						// }
						$rate = round((12 * $r->basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;
				}


				$mode_of_payment = "";

				// make payment
				if ($system[0]->is_half_monthly == 1) {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($r->user_id, $p_date);
					$payment_last = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($r->user_id, $p_date);
					if ($payment_check->num_rows() > 1) {

						//foreach($payment_last as $payment_half_last){
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $p_date);
						$mode_of_payment = $make_payment[0]->payment_mode;
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';
						//$mpay = '<span data-toggle="tooltip" data-placement="top" title="'.$this->lang->line('xin_payroll_make_payment').'"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".'.$p_class.'" data-employee_id="'. $r->user_id . '" data-payment_date="'. $p_date . '" data-company_id="'.$this->input->get("company_id").'"><span class="fa fas fa-money"></span></button></span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}

						$delete = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code><br>' . '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $payment_last[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $payment_last[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span><code>' . $this->lang->line('xin_title_second_half') . '</code>';
						//}
						//detail link
						$detail = '';
					} else if ($payment_check->num_rows() > 0) {
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $p_date);
						$mode_of_payment = $make_payment[0]->payment_mode;
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $p_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';

						$mpay .= '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
						$delete  = $delete . '<code>' . $this->lang->line('xin_title_first_half') . '</code>';
						$detail = '';
					} else {
						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';
						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $p_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
						//detail link
						$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
					}
					//detail link
					//$detail = '';
				} else {
					$payment_check = $this->Payroll_model->read_make_payment_payslip_check($r->user_id, $p_date);
					if ($payment_check->num_rows() > 0) {
						$make_payment = $this->Payroll_model->read_make_payment_payslip($r->user_id, $p_date);
						$mode_of_payment = $make_payment[0]->payment_mode;
						$view_url = site_url() . 'admin/payroll/payslip/id/' . $make_payment[0]->payslip_key;

						$status = '<span class="label label-success">' . $this->lang->line('xin_payroll_paid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_view_payslip') . '"><a href="' . $view_url . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $make_payment[0]->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

						if (in_array('313', $role_resources_ids)) {
							$delete = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_delete') . '"><button type="button" class="btn icon-btn btn-xs btn-danger waves-effect waves-light delete" data-toggle="modal" data-target=".delete-modal" data-record-id="' . $make_payment[0]->payslip_id . '"><span class="fa fa-trash"></span></button></span>';
						} else {
							$delete = '';
						}
					} else {
						$status = '<span class="label label-danger">' . $this->lang->line('xin_payroll_unpaid') . '</span>';

						$mpay = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_payroll_make_payment') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $p_class . '" data-employee_id="' . $r->user_id . '" data-payment_date="' . $p_date . '" data-company_id="' . $this->input->get("company_id") . '"><span class="fa fas fa-money"></span></button></span>';
						$delete = '';
					}
					//detail link
					$detail = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><button type="button" class="btn icon-btn btn-xs btn-outline-secondary waves-effect waves-light" data-toggle="modal" data-target=".' . $view_p_class . '" data-employee_id="' . $r->user_id . '"><span class="fa fa-eye"></span></button></span>';
				}
				// this is the allowance
				$overt = $this->Employees_model->get_overtime($r->user_id, $p_date);
				if ($id['all_overtime_P'] == "true") {

					$all_overtime_P = $overt['all_overtime_P'];
					$all_overtime_t = $overt['all_overtime'];
				}
				// this is the allowance
				$restday_pay1 = $this->Employees_model->restday_pay($r->user_id, $p_date);
				// $get_cliam_data = $this->Employees_model->get_cliam_data($r->user_id, $p_date);
				$get_cliam_data = 0;
				$restday_pay = 0;
				if ($id['restday_pay'] == "true") {
					$restday_pay = $restday_pay1['rest_daya_amount'];
				}
				$g_ordinary_wage += $all_overtime_P;
				$g_ordinary_wage += $restday_pay;
				// add amount				
				// print_r($pay);
				// die;


				$total_earning = floatval($pay) + floatval($allowance_amount) + floatval($all_overtime_P) + floatval($get_cliam_data)  + floatval($restday_pay) + $commissions_amount + $other_payments_amount + $share_options_amount;
				$total_deduction = floatval($loan_de_amount) + $statutory_deductions_amount;
				$total_net_salary = $total_earning - $total_deduction - $unpaid_leave_amount;


				// echo "<pre>";
				// print_r($basic_salary);
				//if($r->salary_advance_paid == ''){
				//$data1 = $add_salary. ' - ' .$loan_de_amount. ' - ' .$net_salary . ' - ' .$salary_ssempee . ' - ' .$statutory_deductions;
				//$fnet_salary = $net_salary_default + $statutory_deductions;
				//	$net_salary = $fnet_salary - $loan_de_amount;
				// this is the allowance

				// $pcount = $pcount + $re_pcount;
				// die;

				// this is the allowance

				/**
				 * Author : Syed Anees
				 * Sub Functionality : CPF on Gross Salary
				 */
				$emp_dob = $r->date_of_birth;
				$dob = new DateTime($emp_dob);
				$today = new DateTime($p_date . '-01');

				// $today = new DateTime('01-' . $p_date);
				$age = $dob->diff($today);
				$age_year = $age->y;
				$age_month = $age->m;

				$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
				$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
				$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

				if ($age_month > 0) {
					$age_year = $age_year + 1;
				}
				if ($age_year < $age_upto) {
					$age_from = null;
					$age_to = $age_year;
				} elseif ($age_year > $age_upto && $age_year <= $age_above) {
					$age_from = $age_year;
					$age_to = $age_year;
				} elseif ($age_year > $age_above) {
					$age_from = $age_year;
					$age_to = null;
				} else {
					$age_from = null;
					$age_to = null;
				}

				$cpf_employee = 0;
				$im_status = $this->Employees_model->getEmployeeImmigrationStatus($r->user_id);
				$cpf_contribution = '';
				$aw = 0;

				if ($im_status) {
					$immigration_id = $im_status->immigration_id;
					if ($immigration_id == 2) {
						$issue_date = $im_status->issue_date;
						$i_date = new DateTime($issue_date);
						$today = new DateTime();
						$pr_age = $i_date->diff($today);
						$pr_age_year = $pr_age->y;
						$pr_age_month = $pr_age->m;
						// echo $pr_age_month;
						if ($pr_age_year == 0 && $pr_age_month > 0) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
						} elseif ($pr_age_year == 1 && $pr_age_month > 0) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
						} elseif ($pr_age_year >= 2) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 1);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 1);
						}
					} elseif ($immigration_id == 1) {
						// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 1);
						$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 1, $age_from, $age_to);
					}

					if ($immigration_id == 1 || $immigration_id == 2) {
						$cpf_employer = 0;
						$cpf_employee = 0;
						if ($cpf_contribution) {
							$employee_contribution = $cpf_contribution->contribution_employee;
							$employer_contribution = $cpf_contribution->contribution_employer;
							$total_cpf_contribution = $cpf_contribution->total_cpf;

							// $ordinary_wage = ($allowance_amount + $basic_salary + $overtime_amount + $all_other_payment + $commissions_amount ) - ($loan_de_amount + $statutory_deductions_amount);
							$ordinary_wage = $g_ordinary_wage;

							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}



							/*immigration id 1 cpf count start */
							if ($immigration_id == 1) {
								$tw = $aw + $ow;
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round((17 / 100 * $tw) - $cpf_employee);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$cpf_employer = round((17 / 100 * $tw) + ($cpf_employee) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(20 / 100 * $ow + 20 / 100 * $aw);
										$cpf_employer = round((37 / 100 * $ow + 37 / 100 * $aw) - $cpf_employee);
										// if ($count_cpf_employer > 2220) {
										// 	$cpf_employer = 2220;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 1200) {
										// 	$cpf_employee = 1200;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round((15 / 100 * $tw) - $cpf_employee);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.48 * ($tw - 500));
										$cpf_employer = round((15 / 100 * ($tw) + 0.48 * ($tw - 500)) - $cpf_employee);
										// print_r($cpf_employer);
									} else if ($tw > 750) {
										$cpf_employee = floor(16 / 100 * $tw);
										// + 15 / 100 * $aw;
										$cpf_employer = round(31 / 100 * ($tw) - $cpf_employee);
										// + 29.5 / 100 * ($aw);
										// if ($count_cpf_employer > 1770) {
										// 	$cpf_employer = 1770;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 900) {
										// 	$cpf_employee = 900;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(11 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.285 * ($tw - 500));
										$cpf_employer = round((11 / 100 * $tw + 0.285 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(10.5 / 100 * $tw);
										$cpf_employer = round((22 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 1230) {
										// 	$cpf_employer = 1230;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 570) {
										// 	$cpf_employee = 570;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										// (9% x $750.00) + 0.225($750.00 - $500.00);

										$cpf_employee = floor(0.225 * ($tw - 500));
										$cpf_employer = round((9 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(7.5 / 100 * $tw);
										$cpf_employer = round((16.5 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 930) {
										// 	$cpf_employer = 930;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 420) {
										// 	$cpf_employee = 420;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee =  floor(0.15 * ($tw - 500));
										$cpf_employer = round((7.5 / 100 * $tw) + 0.15 * ($tw - 500) - $cpf_employee);
									} else if ($tw > 750) {

										$cpf_employee = floor(5 / 100 * $tw);
										$cpf_employer = round((12.5 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 750) {
										// 	$cpf_employer = 750;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 300) {
										// 	$cpf_employee = 300;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								}
							}

							/* immigration id 1 cpf count end */
							if ($im_status->issue_date) {
								$issue_date = $im_status->issue_date;
								if ($issue_date != "") {
									$i_date = new DateTime($issue_date);

									$today = new DateTime();
									$pr_age = $i_date->diff($today);
									$pr_age_year = $pr_age->y;
									$pr_age_month = $pr_age->m;
									/* new CPF calculation Start*/
									$tw = $ow + $aw;
									if ($pr_age_year == 1) {

										if ($age_year <= 55) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(4 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((4 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
												$cpf_employer = round(((9 / 100) * $ow + (9 / 100) * $aw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 540) {
												// 	$cpf_employer = 540;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										} else if ($age_year > 55 && $age_year <= 60) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(4 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((4 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
												$cpf_employer = round(((9 / 100) * $ow + (9 / 100) * $aw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 540) {
												// 	$cpf_employer = 540;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										} else if ($age_year > 60 && $age_year <= 65) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round(3.5 / 100 * $tw + 0.15 * ($tw - 500));
											} else if ($tw > 750) {
												$cpf_employee = floor(5 / 100 * $tw);
												$cpf_employer = round(((8.5 / 100) * $tw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 510) {
												// 	$cpf_employer = 510;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										} else if ($age_year > 65) {
											if ($tw > 50 && $tw < 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw < 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((3.5 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
												$cpf_employer = round(((8.5 / 100) * $ow + (8.5 / 100) * $aw) - $cpf_employee);

												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
												// if ($count_cpf_employer > 510) {
												// 	$cpf_employer = 510;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
											}
										}
									}
									if ($pr_age_year == 2) {
										if ($age_year <= 55) {

											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0 * $tw;
												$cpf_employer = round(9 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.45 * ($tw - 500));
												$cpf_employer = round((9 / 100 * $tw + 0.45 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(15 / 100 * $tw);
												$cpf_employer = round(24 / 100 * $tw) - $cpf_employee;
												// if ($count_cpf_employer > 1440) {
												// 	$cpf_employer = 1440;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 900) {
												// 	$cpf_employee = 900;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 55 && $age_year <= 60) {
											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(6 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.375 * ($tw - 500));
												$cpf_employer = round((6 / 100 * $tw + 0.375 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(7.5 / 100 * $tw);
												$cpf_employer = round((11 / 100 * $tw) - $cpf_employee);
												// if ($count_cpf_employer > 1110) {
												// 	$cpf_employer = 1110;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 750) {
												// 	$cpf_employee = 750;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 60 && $age_year <= 65) {
											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.225 * ($tw - 500));
												$cpf_employer = round((3.5 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(7.5 / 100 * $tw);
												$cpf_employer = round((11 / 100 * $tw) - $cpf_employee);
												// if ($count_cpf_employer > 1110) {
												// 	$cpf_employer = 1110;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 750) {
												// 	$cpf_employee = 750;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 65) {
											if ($tw <= 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(3.5 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.15 * ($tw - 500));
												$cpf_employer = round((3.5 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(5 / 100 * $tw);
												$cpf_employer = round((8.5 / 100 * $tw) - $cpf_employee);
												// if ($count_cpf_employer > 1110) {
												// 	$cpf_employer = 1110;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 750) {
												// 	$cpf_employee = 750;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										}
									}
									if ($pr_age_year == 3 || $pr_age_year > 3) {
										if ($age_year <= 55) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round((17 / 100 * $tw) - $cpf_employee);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.6 * ($tw - 500));
												$cpf_employer = round((17 / 100 * $tw) + ($cpf_employee) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(20 / 100 * $ow + 20 / 100 * $aw);
												$cpf_employer = round((37 / 100 * $ow + 37 / 100 * $aw) - $cpf_employee);
												// if ($count_cpf_employer > 2220) {
												// 	$cpf_employer = 2220;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 1200) {
												// 	$cpf_employee = 1200;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 55 && $age_year <= 60) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round((15 / 100 * $tw) - $cpf_employee);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.48 * ($tw - 500));
												$cpf_employer = round((15 / 100 * ($tw) + 0.48 * ($tw - 500)) - $cpf_employee);
												// print_r($cpf_employer);
											} else if ($tw > 750) {
												$cpf_employee = floor(16 / 100 * $tw);
												// + 15 / 100 * $aw;
												$cpf_employer = round(31 / 100 * ($tw) - $cpf_employee);
												// + 29.5 / 100 * ($aw);
												// if ($count_cpf_employer > 1770) {
												// 	$cpf_employer = 1770;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 900) {
												// 	$cpf_employee = 900;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 60 && $age_year <= 65) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(11 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee = floor(0.285 * ($tw - 500));
												$cpf_employer = round((11 / 100 * $tw + 0.285 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(10.5 / 100 * $tw);
												$cpf_employer = round((22 / 100 * $tw) - $cpf_employee);

												// if ($count_cpf_employer > 1230) {
												// 	$cpf_employer = 1230;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 570) {
												// 	$cpf_employee = 570;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 65 && $age_year <= 70) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(9 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												// (9% x $750.00) + 0.225($750.00 - $500.00);

												$cpf_employee = floor(0.225 * ($tw - 500));
												$cpf_employer = round((9 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
											} else if ($tw > 750) {
												$cpf_employee = floor(7.5 / 100 * $tw);
												$cpf_employer = round((16.5 / 100 * $tw) - $cpf_employee);

												// if ($count_cpf_employer > 930) {
												// 	$cpf_employer = 930;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 420) {
												// 	$cpf_employee = 420;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										} else if ($age_year > 70) {
											if ($tw < 50) {
												$cpf_employee = 0;
												$cpf_employer = 0;
											} else if ($tw > 50 && $tw <= 500) {
												$cpf_employee = 0;
												$cpf_employer = round(7.5 / 100 * $tw);
											} else if ($tw > 500 && $tw <= 750) {
												$cpf_employee =  floor(0.15 * ($tw - 500));
												$cpf_employer = round((7.5 / 100 * $tw) + 0.15 * ($tw - 500) - $cpf_employee);
											} else if ($tw > 750) {

												$cpf_employee = floor(5 / 100 * $tw);
												$cpf_employer = round((12.5 / 100 * $tw) - $cpf_employee);

												// if ($count_cpf_employer > 750) {
												// 	$cpf_employer = 750;
												// } else {
												// 	$cpf_employer = $count_cpf_employer;
												// }
												// if ($count_cpf_employee > 300) {
												// 	$cpf_employee = 300;
												// } else {
												// 	$cpf_employee = $count_cpf_employee;
												// }
											}
										}
									}
								}
							}

							/* new CPF calculation End*/
							$net_salary = $total_net_salary;
							$cpf_total = $cpf_employee + $cpf_employer;



							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
						}
					} else {
						$ordinary_wage = $g_ordinary_wage;
						$ow = $ordinary_wage;
						$ow_cpf_employee = 0;
						$ow_cpf_employer = 0;

						$aw = $g_additional_wage;
						$aw_cpf_employee = 0;
						$aw_cpf_employer = 0;
					}
				}

				// echo "<pre>";
				// print_r($cpf_employer);
				// echo "<pre>";
				// print_r($cpf_employee);
				//SHG Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($r->user_id);
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;

					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $fund_deduction_amount;
				}

				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($r->user_id);
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;

					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					$fund_deduction_amount += $contribution_amount;
					$total_net_salary = $total_net_salary - $fund_deduction_amount;
				}

				$sdl_total_amount = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl_total_amount = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl_total_amount = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl_total_amount = 11.25;
				}

				// $total_net_salary = $total_net_salary - $sdl_total_amount;

				// $net_salary = number_format((float)$net_salary, 2, '.', '');
				$net_salary = number_format((float)$total_net_salary, 2, '.', '');

				$total_amount += $net_salary;
				$total_n = $net_salary;
				//$basic_salary_cal = $basic_salary * $current_rate; 
				$pay = number_format((float)$pay, 2, '.', '');
				$basic_salary = number_format((float)$basic_salary, 2, '.', '');

				if ($basic_salary == 0 || $basic_salary == '') {
					$fmpay = $mpay;
				} else {
					$fmpay = $mpay;
				}
				$company_info = $this->Company_model->read_company_information($r->company_id);
				$c_name = $company_info[0]->name;
				$Organization_Assigned_Id = $company_info[0]->Organization_Assigned_Id;
				$CIMB_CODE = $company_info[0]->CIMB_CODE;
				$CIMB_ACC = $company_info[0]->CIMB_ACC;
				if (!is_null($company_info)) {
					$basic_salary = $this->Xin_model->company_currency_sign($basic_salary, $r->company_id);
					$net_salary = $this->Xin_model->company_currency_sign($net_salary, $r->company_id);
					$cpf_employee = $this->Xin_model->company_currency_sign($cpf_employee, $r->company_id);
				} else {
					$basic_salary = $this->Xin_model->currency_sign($basic_salary, $r->user_id);
					$net_salary = $this->Xin_model->currency_sign($net_salary, $r->user_id);
					$cpf_employee = $this->Xin_model->currency_sign($cpf_employee, $r->user_id);
				}

				$iemp_name = $emp_name . '<small class="text-muted"><i> (' . $comp_name . ')<i></i></i></small><br><small class="text-muted"><i>' . $this->lang->line('xin_employees_id') . ': ' . $r->employee_id . '<i></i></i></small>';

				//action link
				$bank_ac = $this->Employees_model->get_bank_account_info_add($r->user_id);
				$m_date_month = $this->input->post('m_date_month');
				$formattedDate = str_replace('-', '', $m_date_month);
				$act = $detail . $fmpay . $delete;

				if ($r->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$emp_payroll_wage = $wages_type . '<br><small class="text-muted"><i>' . $this->lang->line('xin_half_monthly') . '<i></i></i></small>';
					} else {
						$emp_payroll_wage = $wages_type;
					}
				} else {
					$emp_payroll_wage = $wages_type;
				}

				$data[] = array(
					$bank_ac->account_number ?? '',
					$r->first_name,
					$total_n,
					'SGD',
					'DBSSSGSGXXX',
					'SALA',
					date('M') . '  ' . 'Salary',
					'',
					'',
					'',
					$bank_ac->account_number ?? '' . '%' . $r->first_name . '%' . $total_n . '%SGD' . '%DBSSSGSGXXX%' . '%SALA%' . date('M') . '  ' . 'Salary' . '%%%',

				);
			}
		}



		$man_arr[] = ['', '', '', '', '', '', '', '', '', '', '%'];
		$man_arr[] = ['3', $CIMB_ACC, $c_name, 'SGD', $total_amount, count($data), 'R', 'B', $m_date_month, '', '3%0123456789%' . $c_name . '%SGD%' . $total_amount . '%' . count($data) . '%R%B%' . $formattedDate . ''];
		foreach ($data as $i => $d) {
			$man_arr[] = $data[$i];
		}


		echo json_encode($man_arr);
	}
	
	

	// pay hourly read > payslip
	public function hourlywage_template_read()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] = $this->Xin_model->site_title();
		$id = $this->input->get('employee_id');
		// get addd by > template
		$user = $this->Xin_model->read_user_info($id);
		// user full name
		$full_name = $user[0]->first_name . ' ' . $user[0]->last_name;
		// get designation
		$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($designation)) {
			$designation_name = $designation[0]->designation_name;
		} else {
			$designation_name = '--';
		}
		// department
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$department_name = $department[0]->department_name;
		} else {
			$department_name = '--';
		}
		$data = array(
			'first_name' => $user[0]->first_name,
			'last_name' => $user[0]->last_name,
			'employee_id' => $user[0]->employee_id,
			'user_id' => $user[0]->user_id,
			'euser_id' => $user[0]->user_id,
			'department_name' => $department_name,
			'designation_name' => $designation_name,
			'date_of_joining' => $user[0]->date_of_joining,
			'profile_picture' => $user[0]->profile_picture,
			'gender' => $user[0]->gender,
			'wages_type' => $user[0]->wages_type,
			'basic_salary' => $user[0]->basic_salary,
			'daily_wages' => $user[0]->daily_wages
		);
		if (!empty($session)) {
			$this->load->view('admin/payroll/dialog_templates', $data);
		} else {
			redirect('admin/');
		}
	}

	public function pay_salary_again()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] = $this->Xin_model->site_title();
		$id = $this->input->get('employee_id');
		$s_month = $this->input->get('pay_date');
		$s_data = $this->db
			->where('employee_id', $id)
			->where('salary_month', $s_month)
			->order_by('check_id', 'desc')
			->group_by('employee_id') // Add this line to group by employee_id
			->get('xin_salary_payslips_check')
			->result();

		// get addd by > template
		// print_r($s_data);exit;
		$user = $this->Xin_model->read_user_info($id);
		// $result = $this->Payroll_model->read_template_information($user[0]->monthly_grade_id);
		//$department = $this->Department_model->read_department_information($user[0]->department_id);
		// print_r($result);exit;

		// get designation
		$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($designation)) {
			$designation_id = $designation[0]->designation_id;
		} else {
			$designation_id = 1;
		}
		// department
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$department_id = $department[0]->department_id;
		} else {
			$department_id = 1;
		}
		// //$location = $this->Location_model->read_location_information($department[0]->location_id);
		$data = array(
			'department_id' => $department_id,
			'designation_id' => $designation_id,
			'company_id' => $user[0]->company_id,
			'location_id' => $user[0]->location_id,
			'user_id' => $user[0]->user_id,
			'dob' => $user[0]->date_of_birth,
			'wages_type' => $user[0]->wages_type,
			'basic_salary' => $user[0]->basic_salary,
			'daily_wages' => $user[0]->daily_wages,
			'office_shift_id' => $user[0]->office_shift_id,
			'remaining' => $s_data[0]->balance_amount,
			'sdata' => $s_data
		);
		if (!empty($session)) {
			$this->load->view('admin/payroll/dialog_make_payment_again', $data);
		} else {
			redirect('admin/');
		}
	}



	// pay hourly > create payslip
	public function pay_hourly()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] = $this->Xin_model->site_title();
		$id = $this->input->get('employee_id');
		// get addd by > template
		$user = $this->Xin_model->read_user_info($id);

		$result = $this->Payroll_model->read_template_information($user[0]->monthly_grade_id);
		//$department = $this->Department_model->read_department_information($user[0]->department_id);
		// get designation
		$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($designation)) {
			$designation_id = $designation[0]->designation_id;
		} else {
			$designation_id = 1;
		}
		// department
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$department_id = $department[0]->department_id;
		} else {
			$department_id = 1;
		}
		//$location = $this->Location_model->read_location_information($department[0]->location_id);
		$data = array(
			'department_id' => $department_id,
			'designation_id' => $designation_id,
			'company_id' => $user[0]->company_id,
			'location_id' => $user[0]->location_id,
			'user_id' => $user[0]->user_id,
			'euser_id' => $user[0]->user_id,
			'wages_type' => $user[0]->wages_type,
			'basic_salary' => $user[0]->basic_salary,
			'daily_wages' => $user[0]->daily_wages,
			'office_shift_id' => $user[0]->office_shift_id,
			'date_of_birth' => $user[0]->date_of_birth,
		);
		if (!empty($session)) {
			$this->load->view('admin/payroll/dialog_make_payment', $data);
		} else {
			redirect('admin/');
		}
	}


	public function add_pay_monthly_again()
	{
		// echo "<pre>";
		// print_r($this->input->post());die;


		if ($this->input->post('add_type') == 'add_monthly_payment') {
			/* Define return | here result is used to return user data and error for error message */
			$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
			$Return['csrf_hash'] = $this->security->get_csrf_hash();

			/* Server side PHP input validation */

			/*if($Return['error']!=''){
				$this->output($Return
				);
    		}*/
			$basic_salary = $this->input->post('gross_salary');
			$system = $this->Xin_model->read_setting_info(1);
			$euser_info = $this->Xin_model->read_user_info($this->input->post('emp_id'));
			// office shift
			$office_shift = $this->Timesheet_model->read_office_shift_information($this->input->post('office_shift_id'));
			$result_previous = $this->Payroll_model->add_salary_payslip_get($this->input->post('emp_id'));
			if ($system[0]->is_half_monthly == 1) {
				$is_half_monthly_payroll = 1;
			} else {
				$is_half_monthly_payroll = 0;
			}
			if ($this->input->post('b_am') > 0) {
				$status = 3;
			} else {
				$status = 0;
			}

			$jurl = random_string('alnum', 40);

			$data_bacup = array(



				'gross_salary' => $this->input->post('gross_salary_bc'),


				'total_commissions' => $this->input->post('total_commissions_bc'),
				'total_statutory_deductions' => $this->input->post('total_statutory_deductions_bc'),
				'total_other_payments' => $this->input->post('total_other_payments_bc'),
				'total_allowances' => $this->input->post('total_allowances_bc'),
				'total_loan' => $this->input->post('loan_de_amount_bc'),
				'total_overtime' => $this->input->post('total_overtime_bc'),

				'employee_claim' => $this->input->post('employee_claim_bc'),
				'user_id' => $this->input->post('u_id'),

				'leave_deductions' => $this->input->post('leave_deductions_bc'),

				'net_salary' => $this->input->post('net_salary'),
				'total_share' => $this->input->post('total_share_bc'),
				'additional_allowances' => $this->input->post('additional_allowances_bc'),
				'deduction_amount' => $this->input->post('total_employee_deduction_bc'),
				'General_amount' => $this->input->post('General_amount_bc'),
				'motivation_amount' => $this->input->post('motivation_amount_bc'),

			);
			$this->db->insert('salary_backup_table', $data_bacup);
			$this->db->where('user_id', $this->input->post('u_id'))->update('xin_employees', ['payment_status' => $this->input->post('b_am'), 'payment_mode' => $this->input->post('payment_mode')]);
			$basic_salary = 0;
			$gross_salary = 0;
			$leave_deductions = 0;
			$total_allowances = 0;
			$total_loan = 0;
			$total_overtime = 0;
			$total_commissions = 0;
			$total_statutory_deductions = 0;
			$total_employee_deduction = 0;
			$employee_claim = 0;
			$total_share = 0;
			$total_other_payments = 0;
			$additional_allowances = 0;
			$motivation_amount = 0;
			$General_amount = 0;
			if ($this->input->post('chk_gross_salary')) {

				$basic_salary = $this->input->post('gross_salary');
				$gross_salary = $this->input->post('gross_salary');
			}
			if ($this->input->post('chk_leave_deductions')) {

				$leave_deductions = $this->input->post('leave_deductions');
			}
			if ($this->input->post('chk_total_allowances')) {

				$total_allowances = $this->input->post('total_allowances');
			}
			if ($this->input->post('chk_total_commissions')) {

				$total_commissions = $this->input->post('total_commissions');
			}
			if ($this->input->post('chk_loan_de_amount')) {

				$total_loan = $this->input->post('total_loan');
			}
			if ($this->input->post('chk_total_overtime')) {

				$total_overtime = $this->input->post('total_overtime');
			}
			if ($this->input->post('chk_total_statutory_deductions')) {

				$total_statutory_deductions = $this->input->post('total_statutory_deductions');
			}
			if ($this->input->post('chk_total_other_payments')) {

				$total_other_payments = $this->input->post('total_other_payments');
			}
			if ($this->input->post('chk_total_employee_deduction')) {

				$total_employee_deduction = $this->input->post('total_employee_deduction');
			}
			if ($this->input->post('chk_employee_claim')) {

				$employee_claim = $this->input->post('employee_claim');
			}
			if ($this->input->post('chk_total_share')) {

				$total_share = $this->input->post('total_share');
			}
			if ($this->input->post('chk_additional_allowances')) {

				$additional_allowances = $this->input->post('additional_allowances');
			}
			if ($this->input->post('chk_motivation_amount')) {

				$motivation_amount = $this->input->post('motivation_amount');
			}
			if ($this->input->post('chk_General_amount')) {

				$General_amount = $this->input->post('General_amount');
			}
			$data = array(
				'employee_id' => $this->input->post('emp_id'),
				'department_id' => $this->input->post('department_id'),
				'company_id' => $this->input->post('company_id'),
				'location_id' => $this->input->post('location_id'),
				'designation_id' => $this->input->post('designation_id'),
				'salary_month' => $this->input->post('pay_date'),
				'basic_salary' => $basic_salary + $result_previous->basic_salary,
				'gross_salary' => $gross_salary,
				'net_salary' => $this->input->post('net_salary'),
				'wages_type' => $this->input->post('wages_type'),
				'is_half_monthly_payroll' => $is_half_monthly_payroll,
				'total_commissions' => $total_commissions + $result_previous->total_commissions,
				'total_statutory_deductions' => $total_statutory_deductions + $result_previous->total_statutory_deductions,
				'total_other_payments' => $total_other_payments + $result_previous->total_other_payments,
				'total_allowances' => $total_allowances + $result_previous->total_allowances,
				'total_loan' => $total_loan + $result_previous->total_loan,
				'total_overtime' => $total_overtime + $result_previous->total_overtime,
				'total_overtime_amount' => $this->input->post('total_overtime_amount'),
				'claim_amount' => $employee_claim + (float)$result_previous->claim_amount,
				'cpf_employee_amount' => $this->input->post('total_cpf_employee'),
				'cpf_employer_amount' => $this->input->post('total_cpf_employer'),
				'leave_deduction' => $leave_deductions + $result_previous->leave_deduction,
				'contribution_fund' => $this->input->post('total_fund_contribution'),
				'share_option_amount' => $total_share + $result_previous->share_option_amount,
				'additonal_allowance' => $additional_allowances + (float) $result_previous->additonal_allowance,
				'deduction_amount' => $total_employee_deduction + $result_previous->deduction_amount,
				// 'motivation_amount' => $motivation_amount + $result_previous->motivation_amount,
				// 'General_amount' => $General_amount + $result_previous->General_amount,
				'balance_amount' => $this->input->post('b_am'),
				'is_payment' => '1',
				'status' => $status,
				'payslip_type' => 'full_monthly',
				'payslip_key' => $jurl,
				'year_to_date' => date('d-m-Y'),
				'created_at' => date('d-m-Y h:i:s')
			);
			$result = $this->Payroll_model->add_salary_payslip_update($data, $this->input->post('emp_id'));


			$system_settings = system_settings_info(1);
			if ($system_settings->online_payment_account == '') {
				$online_payment_account = 0;
			} else {
				$online_payment_account = $system_settings->online_payment_account;
			}

			if ($result) {
				if (isset($_POST['allowance_amount']) && count($_POST['allowance_amount']) > 0) {
					for ($i = 0; $i < count($_POST['allowance_amount']); $i++) {
						$allowance_data = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'allowance_amount' => $this->input->post('allowance_amount')[$i],
							'allowance_name' => $this->input->post('allowance_type')[$i],
							'deduction_name' => '',
							'deduction_amount' => ''

						);
						$this->Payroll_model->add_mapping($allowance_data);
					}
				}
				if (isset($_POST['loan_amount']) && count($_POST['loan_amount']) > 0) {
					for ($j = 0; $j < count($_POST['loan_amount']); $j++) {
						$allowance_data = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'allowance_amount' => '',
							'allowance_name' => '',
							'deduction_name' => $this->input->post('loan_title')[$j],
							'deduction_amount' => $this->input->post('loan_amount')[$j],

						);
						$this->Payroll_model->add_mapping($allowance_data);
					}
				}
				if (isset($_POST['statutory_amount']) && count($_POST['statutory_amount']) > 0) {
					for ($k = 0; $k < count($_POST['statutory_amount']); $k++) {
						$allowance_data = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'allowance_amount' => '',
							'allowance_name' => '',
							'deduction_name' => $this->input->post('statutory_title')[$k],
							'deduction_amount' => $this->input->post('statutory_amount')[$k],

						);
						$this->Payroll_model->add_mapping($allowance_data);
					}
				}
				if (isset($_POST['deduction_amount']) && count($_POST['deduction_amount']) > 0) {
					for ($l = 0; $l < count($_POST['deduction_amount']); $l++) {
						$allowance_data = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'allowance_amount' => '',
							'allowance_name' => '',
							'deduction_name' => $this->input->post('deduction_type')[$l],
							'deduction_amount' => $this->input->post('deduction_amount')[$l],

						);
						$this->Payroll_model->add_mapping($allowance_data);
					}
				}
				// $ivdata = array(
				// 	'amount' => $this->input->post('net_salary'),
				// 	'account_id' => $online_payment_account,
				// 	'transaction_type' => 'expense',
				// 	'dr_cr' => 'cr',
				// 	'transaction_date' => date('Y-m-d'),
				// 	'payer_payee_id' => $this->input->post('emp_id'),
				// 	'payment_method_id' => 3,
				// 	'description' => 'Payroll Payments',
				// 	'reference' => 'Payroll Payments',
				// 	'invoice_id' => $result,
				// 	'client_id' => $this->input->post('emp_id'),
				// 	'created_at' => date('Y-m-d H:i:s')
				// );
				// $this->Finance_model->add_transactions($ivdata);

				// update data in bank account
				// $account_id = $this->Finance_model->read_bankcash_information($online_payment_account);
				// $acc_balance = $account_id[0]->account_balance - $this->input->post('net_salary');

				// $data3 = array(
				// 'account_balance' => $acc_balance
				// );
				// $this->Finance_model->update_bankcash_record($data3,$online_payment_account);
				// $appeacial_allowance = $this->Employees_model->get_appeacial_allowance($this->input->post('emp_id'), $this->input->post('pay_date'));
				// $apeacial_allowance_amount = $appeacial_allowance['total_amount'];

				// if ($this->input->post('chk_motivation_amount')) {

				// 	$General_amount_data = array(
				// 		'payslip_id' => $result,
				// 		'employee_id' => $this->input->post('emp_id'),
				// 		'salary_month' => $this->input->post('pay_date'),
				// 		'rate' => $appeacial_allowance['motivation_incentive_rate'],
				// 		'overtime' => $appeacial_allowance['motivation_incentive_time'],
				// 		'total_amount' => $appeacial_allowance['motivation_amount']
				// 	);
				// 	$this->Employees_model->add_salary_payslip_Motivation_amount($General_amount_data);
				// }
				// if ($this->input->post('chk_General_amount')) {

				// 	$General_amount_data = array(
				// 		'payslip_id' => $result,
				// 		'employee_id' => $this->input->post('emp_id'),
				// 		'salary_month' => $this->input->post('pay_date'),
				// 		'rate' => $appeacial_allowance['general_motivation_rate'],
				// 		'overtime' => $appeacial_allowance['general_motivation_time'],
				// 		'total_amount' => $appeacial_allowance['General_amount']
				// 	);
				// 	$this->Employees_model->add_salary_payslip_General_amount($General_amount_data);
				// }

				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				$g_ordinary_wage += $basic_salary;
				$g_shg += $basic_salary;
				$g_sdl += $basic_salary;

				// $g_ordinary_wage += $apeacial_allowance_amount;
				// $g_shg += $apeacial_allowance_amount;
				// $g_sdl += $apeacial_allowance_amount;
				// set allowance
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if ($this->input->post('chk_total_allowances')) {

					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($this->input->post('emp_id'), $this->input->post('pay_date'));

					if ($salary_allowances) {
						foreach ($salary_allowances as $sl_allowances) {

							$esl_allowances = $sl_allowances->allowance_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $esl_allowances / 2;
								} else {
									$eallowance_amount = $esl_allowances;
								}
							} else {
								$eallowance_amount = $esl_allowances;
							}
							$allowance_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'allowance_title' => $sl_allowances->allowance_title,
								'allowance_amount' => $eallowance_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);


							if (!empty($sl_allowances->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								$g_ordinary_wage += $eallowance_amount;
								if ($sl_allowances->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}

							if ($sl_allowances->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sl_allowances->shg == 1) {
								$g_shg += $eallowance_amount;
							}

							$allowance_amount += $eallowance_amount;
						}
					}
				}
				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				// $month_start_date = new DateTime($this->input->post('pay_date') . '-01');
				$month_start_date = new DateTime('01-' . $this->input->post('pay_date'));
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$p_day = $p->format('l');
					$p_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $p_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($p_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($unpaid_leaves) {
					foreach ($unpaid_leaves as $k => $l) {
						// $pay_date_month = new DateTime($this->input->post('pay_date') . '-01');
						$pay_date_month = new DateTime('01-' . $this->input->post('pay_date'));
						$l_from_date = new DateTime($l->from_date);
						$l_to_date = new DateTime($l->to_date);

						if ($l_from_date->format('m') == $l_to_date->format('m')) {
							$start_date = $l_from_date;
							$end_date = $l_to_date;
						} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $l_from_date;
							$end_date = new DateTime($start_date->format('Y-m-t'));
						} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
							$start_date = $pay_date_month;
							$end_date = $l_to_date;
						}
						$end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($start_date, $interval, $end_date);
						foreach ($period as $d) {
							$p_day = $d->format('l');
							if ($p_day == 'Monday') {

								if ($office_shift[0]->monday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							} else if ($p_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
									$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
									if ($l->is_half_day == 0) {
										$leaves_taken_count += 1;
									} else {
										$leaves_taken_count += 0.5;
									}
								}
							}
						}
						$leave_period[$k]['is_half'] = $l->is_half_day;
						// if(count($leave_period) > 0) {
						// 	if($l->is_half_day == 0) {
						// 		$leaves_taken_count += count($leave_period);
						// 	}else {
						// 		$leaves_taken_count += count($leave_period)  / 2;
						// 	}
						// }
					}
				}

				$no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count)) + $holidays_count;

				$gross_pay = round((($basic_salary + $gross_allowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
				$unpaid_leave_amount = ($basic_salary + $gross_allowance_amount) - $gross_pay;

				// echo 'Working days : '. $no_of_working_days . '<br>';
				// echo 'Holidays : '. $holidays_count . '<br>';
				// echo 'Leaves : '. $leaves_taken_count . '<br>';
				// echo 'Leave Days : ('. implode(", " , $leave_period)  . ')<br>';
				// echo 'Days Worked : '. $no_of_days_worked . '<br>';
				// echo 'Basic Pay : '. $g_ordinary_wage . '<br>';
				// echo 'Gross Pay : '. $gross_pay . '<br>';
				$g_ordinary_wage -= $unpaid_leave_amount;
				// echo 'Unpaid Leave : '. $unpaid_leave_amount . '<br>';
				// echo '<hr>';
				if ($unpaid_leave_amount > 0 && $leaves_taken_count > 0) {
					foreach ($leave_period as $l) {
						$is_half = $l['is_half'];
						$leave_dates = $l['leave_date'];
						$leave_day_pay = round(($basic_salary + $gross_allowance_amount) / $no_of_working_days, 2);
						if ($is_half) {
							$leave_day_pay = $leave_day_pay / 2;
						}
						foreach ($leave_dates as $ld) {
							$unpaid_leave_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'leave_date' => $ld,
								'leave_amount' => $leave_day_pay,
								'is_half' => $is_half,
								'total_leave_amount' => $unpaid_leave_amount
							);
							$this->Payroll_model->add_salary_payslip_leave_deduction($unpaid_leave_data);
						}
					}
				}
				$employee_deduction = $this->Payroll_model->get_deduction_detail($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($this->input->post('chk_total_employee_deduction') && $employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						$xin_salary_deduction = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'salary_month' => $this->input->post('pay_date'),
							'name' => $deduction->deduction_type,
							'amount' => $deduction->amount,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}
				}
				// commissions
				$commission_amount = 0;
				$commissions = $this->Employees_model->getEmployeeMonthlyCommission($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($commissions && $this->input->post('chk_total_commissions')) {
					foreach ($commissions as $c) {
						if ($system[0]->is_half_monthly == 1) {
							if ($system[0]->half_deduct_month == 2) {
								$ecommission_amount = $c->commission_amount / 2;
							} else {
								$ecommission_amount = $c->commission_amount;
							}
						} else {
							$ecommission_amount = $c->commission_amount;
						}

						if ($c->commission_type == 9) {
							$g_ordinary_wage += $ecommission_amount;
						} elseif ($c->commission_type == 10) {
							$g_additional_wage += $ecommission_amount;
						}

						if ($c->sdl == 1) {
							$g_sdl += $ecommission_amount;
						}
						if ($c->shg == 1) {
							$g_shg += $ecommission_amount;
						}

						$commissions_data = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'salary_month' => $this->input->post('pay_date'),
							'commission_id' => $c->commission_type,
							'commission_amount' => $ecommission_amount,
							'created_at' => date('d-m-Y h:i:s')
						);
						$this->Payroll_model->add_salary_payslip_commissions($commissions_data);

						$commission_amount += $ecommission_amount;
					}
				}

				//share options
				$share_options_amount = 0;
				$share_options = $this->Employees_model->getEmployeeShareOptions($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($share_options) {
					$eebr_amount = 0;
					$eris_amount = 0;
					foreach ($share_options as $s) {
						$scheme = $s->so_scheme;
						if ($scheme == 1) {
							$price_doe = $s->price_date_of_excercise;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;
							$amount = ($price_doe - $price_ex) * $no_shares;
							$eebr_amount += $amount;
						} else {
							$price_doe = $s->price_date_of_excercise;
							$price_dog = $s->price_date_of_grant;
							$price_ex = $s->excercise_price;
							$no_shares = $s->no_of_shares;

							$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
							$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
							$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
						}
					}
					$share_options_amount = round($eebr_amount + $eris_amount, 2);
					$g_additional_wage += $share_options_amount;
					$g_sdl += $share_options_amount;
					$g_shg += $share_options_amount;

					$share_options_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'salary_month' => $this->input->post('pay_date'),
						'amount' => round($share_options_amount, 2)
					);
					$this->Payroll_model->add_salary_payslip_share_options($share_options_data);
				}
				if ($this->input->post('chk_total_other_payments')) {

					// set other payments
					$salary_other_payments = $this->Employees_model->read_salary_other_payments($this->input->post('emp_id'));
					$count_other_payment = $this->Employees_model->count_employee_other_payments($this->input->post('emp_id'));
					$other_payment_amount = 0;
					if ($count_other_payment > 0 && $this->input->post('chk_total_other_payments')) {
						foreach ($salary_other_payments as $sl_other_payments) {
							$esl_other_payments = $sl_other_payments->payments_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$epayments_amount = $esl_other_payments / 2;
								} else {
									$epayments_amount = $esl_other_payments;
								}
							} else {
								$epayments_amount = $esl_other_payments;
							}
							$other_payments_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'payments_title' => $sl_other_payments->payments_title,
								'payments_amount' => $epayments_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
						}
					}
				}
				if ($this->input->post('chk_total_statutory_deductions')) {

					// set statutory_deductions
					$salary_statutory_deductions = $this->Employees_model->read_salary_statutory_deductions($this->input->post('emp_id'));
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($this->input->post('emp_id'));
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($salary_statutory_deductions as $sl_statutory_deduction) {
							$esl_statutory_deduction = $sl_statutory_deduction->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ededuction_amount = $esl_statutory_deduction / 2;
								} else {
									$ededuction_amount = $esl_statutory_deduction;
								}
							} else {
								$ededuction_amount = $esl_statutory_deduction;
							}
							$statutory_deduction_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'deduction_title' => $sl_statutory_deduction->deduction_title,
								'deduction_amount' => $ededuction_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);
						}
					}
				}
				if ($this->input->post('chk_total_loan')) {
					// set loan
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($this->input->post('emp_id'));
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($this->input->post('emp_id'));
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							$esl_salary_loan_deduction = $sl_salary_loan_deduction->loan_deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eloan_deduction_amount = $esl_salary_loan_deduction / 2;
								} else {
									$eloan_deduction_amount = $esl_salary_loan_deduction;
								}
							} else {
								$eloan_deduction_amount = $esl_salary_loan_deduction;
							}
							$loan_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'loan_title' => $sl_salary_loan_deduction->loan_deduction_title,
								'loan_amount' => $eloan_deduction_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
						}
					}
				}

				// set overtime
				// $salary_overtime = $this->Employees_model->read_salary_overtime($this->input->post('emp_id'));
				// $count_overtime = $this->Employees_model->count_employee_overtime($this->input->post('emp_id'));
				// $overtime_amount = 0;
				// if($count_overtime > 0) {
				// 	foreach($salary_overtime as $sl_overtime){
				// 		$eovertime_hours = $sl_overtime->overtime_hours;
				// 		$eovertime_rate = $sl_overtime->overtime_rate;
				// 		if($system[0]->is_half_monthly==1){
				// 			if($system[0]->half_deduct_month==2){
				// 				$esl_overtime_hr = $eovertime_hours/2;
				// 				$esl_overtime_rate = $eovertime_rate/2;
				// 			} else {
				// 				$esl_overtime_hr = $eovertime_hours;
				// 				$esl_overtime_rate = $eovertime_rate;
				// 			}
				// 		} else {
				// 			$esl_overtime_hr = $eovertime_hours;
				// 			$esl_overtime_rate = $eovertime_rate;
				// 		}
				// 		$overtime_data = array(
				// 		'payslip_id' => $result,
				// 		'employee_id' => $this->input->post('emp_id'),
				// 		'overtime_salary_month' => $this->input->post('pay_date'),
				// 		'overtime_title' => $sl_overtime->overtime_type,
				// 		'overtime_no_of_days' => $sl_overtime->no_of_days,
				// 		'overtime_hours' => $esl_overtime_hr,
				// 		'overtime_rate' => $esl_overtime_rate,
				// 		'created_at' => date('d-m-Y h:i:s')
				// 		);
				// 		$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				// 	}
				// }

				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($overtime) {
					$ot_days = 0;
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
						$ot_days += 1;
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($this->input->post('emp_id'));

					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						// if($this->input->post('office_shift_id')) {
						// 	$shift = $this->Employees_model->read_shift_information($this->input->post('office_shift_id'));
						// 	if($shift) {
						// 		if($shift[0]->monday_in_time != '' && $shift[0]->monday_out_time != '') {
						// 			$time1 = $shift[0]->monday_in_time;
						// 			$time2 = $shift[0]->monday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->tuesday_in_time != '' && $shift[0]->tuesday_out_time != '') {
						// 			$time1 = $shift[0]->tuesday_in_time;
						// 			$time2 = $shift[0]->tuesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->wednesday_in_time != '' && $shift[0]->wednesday_out_time != '') {
						// 			$time1 = $shift[0]->wednesday_in_time;
						// 			$time2 = $shift[0]->wednesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->thursday_in_time != '' && $shift[0]->thursday_out_time != '') {
						// 			$time1 = $shift[0]->thursday_in_time;
						// 			$time2 = $shift[0]->thursday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->friday_in_time != '' && $shift[0]->friday_out_time != '') {
						// 			$time1 = $shift[0]->friday_in_time;
						// 			$time2 = $shift[0]->friday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->saturday_in_time != '' && $shift[0]->saturday_out_time != '') {
						// 			$time1 = $shift[0]->saturday_in_time;
						// 			$time2 = $shift[0]->saturday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->sunday_in_time != '' && $shift[0]->sunday_out_time != '') {
						// 			$time1 = $shift[0]->sunday_in_time;
						// 			$time2 = $shift[0]->sunday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 	}	
						// }else {
						// 	$week_hours = 40;
						// }
						$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;

					$overtime_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'overtime_salary_month' => $this->input->post('pay_date'),
						'overtime_no_of_days' => $ot_days,
						'overtime_hours' => $ot_hrs,
						'overtime_rate' => $rate,
						'total_overtime' => $overtime_amount,
						'created_at' => date('d-m-Y h:i:s')
					);
					$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				}

				//cpf
				$total_cpf =  $this->input->post('total_cpf');

				if ($total_cpf && $total_cpf > 0) {
					$ow_paid = $this->input->post('ow_paid');

					$cpf_data = [
						'payslip_id' => $result,
						// 'month_year' => $this->input->post('pay_date'). '-01',
						'month_year' => '01-' . $this->input->post('pay_date'),
						'ow_paid'	=> $ow_paid,
						'ow_cpf'	=> $this->input->post('ow_cpf'),
						'ow_cpf_employer'	=> $this->input->post('ow_cpf_employer'),
						'ow_cpf_employee'	=> $this->input->post('ow_cpf_employee'),
						'aw_paid'	=> $this->input->post('aw_paid'),
						'aw_cpf'	=> $this->input->post('aw_cpf'),
						'aw_cpf_employer'	=> $this->input->post('aw_cpf_employer'),
						'aw_cpf_employee'	=> $this->input->post('aw_cpf_employee')
					];

					$cpf_payslip = $this->Cpf_payslip_model->add_cpf_payslip($cpf_data);
				}

				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' => $result,
						'contribution_id' => $contribution_id,
						'contribution_amount' => $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}


				//ASHG Fund Contributions
				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' => $result,
						'contribution_id' => $contribution_id,
						'contribution_amount' => $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//sdl
				$sdl = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl = 11.25;
				}

				$cdata = array(
					'payslip_id' => $result,
					'contribution_id' => 5,
					'contribution_amount' => $sdl
				);
				$this->Contribution_fund_model->setContributionPayslip($cdata);

				$Return['result'] = $this->lang->line('xin_success_payment_paid');
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
			$this->output($Return);
			exit;
		}
	}

	// Validate and add info in database > add monthly payment
	public function add_pay_hourly()
	{

		if ($this->input->post('add_type') == 'add_pay_hourly') {
			/* Define return | here result is used to return user data and error for error message */
			$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
			$Return['csrf_hash'] = $this->security->get_csrf_hash();

			/* Server side PHP input validation */

			/*if($Return['error']!=''){
       		$this->output($Return);
    	}*/
			$system = $this->Xin_model->read_setting_info(1);
			// office shift
			$office_shift = $this->Timesheet_model->read_office_shift_information($this->input->post('office_shift_id'));
			$basic_salary = $this->input->post('basic_salary');

			if ($system[0]->is_half_monthly == 1) {
				$is_half_monthly_payroll = 1;
			} else {
				$is_half_monthly_payroll = 0;
			}
			$data_bacup = array(



				'gross_salary' => $this->input->post('gross_salary_bc'),


				'total_commissions' => $this->input->post('total_commissions_bc'),
				'total_statutory_deductions' => $this->input->post('total_statutory_deductions_bc'),
				'total_other_payments' => $this->input->post('total_other_payments_bc'),
				'total_allowances' => $this->input->post('total_allowances_bc'),
				'total_loan' => $this->input->post('loan_de_amount_bc'),
				'total_overtime' => $this->input->post('total_overtime_bc'),

				'employee_claim' => $this->input->post('employee_claim_bc'),
				'user_id' => $this->input->post('u_id'),

				'leave_deductions' => $this->input->post('leave_deductions_bc'),
				'net_salary' => $this->input->post('net_salary'),

				'total_share' => $this->input->post('total_share_bc'),
				'additional_allowances' => $this->input->post('additional_allowances_bc'),
				'deduction_amount' => $this->input->post('total_employee_deduction_bc'),
				'General_amount' => $this->input->post('General_amount_bc'),
				'motivation_amount' => $this->input->post('motivation_amount_bc'),

			);
			$this->db->insert('salary_backup_table', $data_bacup);
			$this->db->where('user_id', $this->input->post('u_id'))->update('xin_employees', ['payment_status' => $this->input->post('b_am'), 'payment_type' => 'HO', 'payment_mode' => $this->input->post('payment_mode')]);
			$basic_salary = 0;
			$gross_salary = 0;
			$leave_deductions = 0;
			$total_allowances = 0;
			$total_loan = 0;
			$total_overtime = 0;
			$total_commissions = 0;
			$total_statutory_deductions = 0;
			$total_employee_deduction = 0;
			$employee_claim = 0;
			$total_other_payments = 0;
			$total_share = 0;
			$additional_allowances = 0;
			$motivation_amount = 0;
			$General_amount = 0;
			if ($this->input->post('chk_gross_salary')) {

				$basic_salary = $this->input->post('basic_salary');
				$gross_salary = $this->input->post('gross_salary');
			}
			if ($this->input->post('chk_leave_deductions')) {

				$leave_deductions = $this->input->post('leave_deductions');
			}
			if ($this->input->post('chk_total_allowances')) {

				$total_allowances = $this->input->post('total_allowances');
			}
			if ($this->input->post('chk_total_commissions')) {

				$total_commissions = $this->input->post('total_commissions');
			}
			if ($this->input->post('chk_loan_de_amount')) {

				$total_loan = $this->input->post('total_loan');
			}
			if ($this->input->post('chk_total_overtime')) {

				$total_overtime = $this->input->post('total_overtime');
			}
			if ($this->input->post('chk_total_statutory_deductions')) {

				$total_statutory_deductions = $this->input->post('total_statutory_deductions');
			}
			if ($this->input->post('chk_total_other_payments')) {

				$total_other_payments = $this->input->post('total_other_payments');
			}
			if ($this->input->post('chk_total_employee_deduction')) {

				$total_employee_deduction = $this->input->post('total_employee_deduction');
			}
			if ($this->input->post('chk_employee_claim')) {

				$employee_claim = $this->input->post('employee_claim');
			}
			if ($this->input->post('chk_total_share')) {

				$total_share = $this->input->post('total_share');
			}
			if ($this->input->post('chk_additional_allowances')) {

				$additional_allowances = $this->input->post('additional_allowances');
			}
			if ($this->input->post('chk_motivation_amount')) {

				$motivation_amount = $this->input->post('motivation_amount');
			}
			if ($this->input->post('chk_General_amount')) {

				$General_amount = $this->input->post('General_amount');
			}
			$jurl = random_string('alnum', 40);
			$data = array(
				'employee_id' => $this->input->post('emp_id'),
				'department_id' => $this->input->post('department_id'),
				'company_id' => $this->input->post('company_id'),
				'location_id' => $this->input->post('location_id'),
				'designation_id' => $this->input->post('designation_id'),
				'salary_month' => $this->input->post('pay_date'),
				'basic_salary' => $basic_salary,
				'gross_salary' => $gross_salary,
				'net_salary' => $this->input->post('net_salary'),
				'wages_type' => $this->input->post('wages_type'),
				'is_half_monthly_payroll' => $is_half_monthly_payroll,
				'total_commissions' => $total_commissions,
				'total_statutory_deductions' => $total_statutory_deductions,
				'statutory_deductions' => $total_statutory_deductions,
				'total_other_payments' => $total_other_payments,
				'total_allowances' => $total_allowances,
				'total_loan' => $total_loan,
				'total_overtime' => $total_overtime,
				'total_overtime_amount' => $this->input->post('total_overtime_amount'),
				'claim_amount' => $employee_claim,
				'hours_worked' => $this->input->post('hours_worked'),
				'cpf_employee_amount' => $this->input->post('total_cpf_employee') ?? 0,
				'cpf_employer_amount' => $this->input->post('total_cpf_employer') ?? 0,
				'additonal_allowance' => $additional_allowances,
				'deduction_amount' => $total_employee_deduction,
				'balance_amount' => $this->input->post('b_am'),
				'is_payment' => '1',
				'status' => '0',
				'payslip_type' => 'hourly',
				'payslip_key' => $jurl,
				'year_to_date' => date('d-m-Y'),
				'created_at' => date('d-m-Y h:i:s')
			);
			$result = $this->Payroll_model->add_salary_payslip($data);
			$system_settings = system_settings_info(1);
			if ($system_settings->online_payment_account == '') {
				$online_payment_account = 0;
			} else {
				$online_payment_account = $system_settings->online_payment_account;
			}
			if ($result) {
				// $ivdata = array(
				// 'amount' => $this->input->post('net_salary'),
				// 'account_id' => $online_payment_account,
				// 'transaction_type' => 'expense',
				// 'dr_cr' => 'cr',
				// 'transaction_date' => date('Y-m-d'),
				// 'payer_payee_id' => $this->input->post('emp_id'),
				// 'payment_method_id' => 3,
				// 'description' => 'Payroll Payments',
				// 'reference' => 'Payroll Payments',
				// 'invoice_id' => $result,
				// 'client_id' => $this->input->post('emp_id'),
				// 'created_at' => date('Y-m-d H:i:s')
				// );
				// $this->Finance_model->add_transactions($ivdata);
				// // update data in bank account
				// $account_id = $this->Finance_model->read_bankcash_information($online_payment_account);
				// $acc_balance = $account_id[0]->account_balance - $this->input->post('net_salary');

				// $data3 = array(
				// 'account_balance' => $acc_balance
				// );
				// $this->Finance_model->update_bankcash_record($data3,$online_payment_account);
				$result_total_work = $this->Payroll_model->total_hours_worked($this->input->post('emp_id'), $this->input->post('pay_date'));
				$hrs_old_int1 = 0;
				$pcount = 0;
				$Trest = 0;
				$total_time_rs = 0;
				$hrs_old_int_res1 = 0;
				foreach ($result_total_work->result() as $hour_work) {
					// total work			
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}

				$basic_salary = $basic_salary * $pcount;

				// $appeacial_allowance = $this->Employees_model->get_appeacial_allowance($this->input->post('emp_id'), $this->input->post('pay_date'));
				// $apeacial_allowance_amount = $appeacial_allowance['total_amount'];

				if ($this->input->post('chk_motivation_amount_y')) {

					$General_amount_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'salary_month' => $this->input->post('pay_date'),
						'rate' => $appeacial_allowance['motivation_incentive_rate'],
						'overtime' => $appeacial_allowance['motivation_incentive_time'],
						'total_amount' => $appeacial_allowance['motivation_amount']
					);
					$this->Employees_model->add_salary_payslip_Motivation_amount($General_amount_data);
				}
				if ($this->input->post('chk_General_amount_u')) {

					$General_amount_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'salary_month' => $this->input->post('pay_date'),
						'rate' => $appeacial_allowance['general_motivation_rate'],
						'overtime' => $appeacial_allowance['general_motivation_time'],
						'total_amount' => $appeacial_allowance['General_amount']
					);
					$this->Employees_model->add_salary_payslip_General_amount($General_amount_data);
				}






				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				$g_ordinary_wage += $basic_salary;
				$g_shg += $basic_salary;
				$g_sdl += $basic_salary;



				// $g_ordinary_wage += $apeacial_allowance_amount;
				// $g_shg += $apeacial_allowance_amount;
				// $g_sdl += $apeacial_allowance_amount;

				// set allowance
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if ($this->input->post('chk_total_allowances')) {
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($salary_allowances) {
						foreach ($salary_allowances as $sl_allowances) {
							$esl_allowances = $sl_allowances->allowance_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $esl_allowances / 2;
								} else {
									$eallowance_amount = $esl_allowances;
								}
							} else {
								$eallowance_amount = $esl_allowances;
							}
							$allowance_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'allowance_title' => $sl_allowances->allowance_title,
								'allowance_amount' => $eallowance_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);


							if (!empty($sl_allowances->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								$g_ordinary_wage += $eallowance_amount;
								if ($sl_allowances->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}

							if ($sl_allowances->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sl_allowances->shg == 1) {
								$g_shg += $eallowance_amount;
							}

							$allowance_amount += $eallowance_amount;
						}
					}
				}

				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				// $month_start_date = new DateTime($this->input->post('pay_date') . '-01');
				$month_start_date = new DateTime('01-' . $this->input->post('pay_date'));
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$p_day = $p->format('l');
					$p_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $p_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($p_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				if ($this->input->post('chk_leave_deductions')) {
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							// $pay_date_month = new DateTime($this->input->post('pay_date') . '-01');
							$pay_date_month = new DateTime('01-' . $this->input->post('pay_date'));
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);

							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$holiday_array_new = array();

							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {

									if ($office_shift[0]->monday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
							// if(count($leave_period) > 0) {
							// 	if($l->is_half_day == 0) {
							// 		$leaves_taken_count += count($leave_period);
							// 	}else {
							// 		$leaves_taken_count += count($leave_period)  / 2;
							// 	}
							// }
						}
					}
				}

				$no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count)) + $holidays_count;

				$gross_pay = round((($basic_salary + $gross_allowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
				$unpaid_leave_amount = ($basic_salary + $gross_allowance_amount) - $gross_pay;

				// echo 'Working days : '. $no_of_working_days . '<br>';
				// echo 'Holidays : '. $holidays_count . '<br>';
				// echo 'Leaves : '. $leaves_taken_count . '<br>';
				// echo 'Leave Days : ('. implode(", " , $leave_period)  . ')<br>';
				// echo 'Days Worked : '. $no_of_days_worked . '<br>';
				// echo 'Basic Pay : '. $g_ordinary_wage . '<br>';
				// echo 'Gross Pay : '. $gross_pay . '<br>';
				$g_ordinary_wage -= $unpaid_leave_amount;
				// echo 'Unpaid Leave : '. $unpaid_leave_amount . '<br>';
				// echo '<hr>';
				if ($unpaid_leave_amount > 0 && $leaves_taken_count > 0) {
					foreach ($leave_period as $l) {
						$is_half = $l['is_half'];
						$leave_dates = $l['leave_date'];
						$leave_day_pay = round(($basic_salary + $gross_allowance_amount) / $no_of_working_days, 2);
						if ($is_half) {
							$leave_day_pay = $leave_day_pay / 2;
						}
						foreach ($leave_dates as $ld) {
							$unpaid_leave_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'leave_date' => $ld,
								'leave_amount' => $leave_day_pay,
								'is_half' => $is_half,
								'total_leave_amount' => $unpaid_leave_amount
							);
							$this->Payroll_model->add_salary_payslip_leave_deduction($unpaid_leave_data);
						}
					}
				}
				$employee_deduction = $this->Payroll_model->get_deduction_detail($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($this->input->post('chk_total_employee_deduction') && $employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						$xin_salary_deduction = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'salary_month' => $this->input->post('pay_date'),
							'name' => $deduction->deduction_type,
							'amount' => $deduction->amount,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}
				}
				if ($this->input->post('chk_total_commissions')) {
					// commissions
					$commission_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommission_amount = $c->commission_amount / 2;
								} else {
									$ecommission_amount = $c->commission_amount;
								}
							} else {
								$ecommission_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommission_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommission_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommission_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommission_amount;
							}

							$commissions_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'commission_id' => $c->commission_type,
								'commission_amount' => $ecommission_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_commissions($commissions_data);

							$commission_amount += $ecommission_amount;
						}
					}
				}
				if ($this->input->post('chk_total_share')) {
					//share options
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;

						$share_options_data = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'salary_month' => $this->input->post('pay_date'),
							'amount' => round($share_options_amount, 2)
						);
						$this->Payroll_model->add_salary_payslip_share_options($share_options_data);
					}
				}
				if ($this->input->post('chk_total_other_payments')) {
					// set other payments
					$salary_other_payments = $this->Employees_model->read_salary_other_payments($this->input->post('emp_id'));
					$count_other_payment = $this->Employees_model->count_employee_other_payments($this->input->post('emp_id'));
					$other_payment_amount = 0;
					if ($count_other_payment > 0) {
						foreach ($salary_other_payments as $sl_other_payments) {
							$esl_other_payments = $sl_other_payments->payments_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$epayments_amount = $esl_other_payments / 2;
								} else {
									$epayments_amount = $esl_other_payments;
								}
							} else {
								$epayments_amount = $esl_other_payments;
							}
							$other_payments_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'payments_title' => $sl_other_payments->payments_title,
								'payments_amount' => $epayments_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
						}
					}
				}
				if ($this->input->post('chk_total_statutory_deductions')) {
					// set statutory_deductions
					$salary_statutory_deductions = $this->Employees_model->read_salary_statutory_deductions($this->input->post('emp_id'));
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($this->input->post('emp_id'));
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($salary_statutory_deductions as $sl_statutory_deduction) {
							$esl_statutory_deduction = $sl_statutory_deduction->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ededuction_amount = $esl_statutory_deduction / 2;
								} else {
									$ededuction_amount = $esl_statutory_deduction;
								}
							} else {
								$ededuction_amount = $esl_statutory_deduction;
							}
							$statutory_deduction_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'deduction_title' => $sl_statutory_deduction->deduction_title,
								'deduction_amount' => $ededuction_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);
						}
					}
				}
				if ($this->input->post('chk_loan_de_amount')) {
					// set loan
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($this->input->post('emp_id'));
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($this->input->post('emp_id'));
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							$esl_salary_loan_deduction = $sl_salary_loan_deduction->loan_deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eloan_deduction_amount = $esl_salary_loan_deduction / 2;
								} else {
									$eloan_deduction_amount = $esl_salary_loan_deduction;
								}
							} else {
								$eloan_deduction_amount = $esl_salary_loan_deduction;
							}
							$loan_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'loan_title' => $sl_salary_loan_deduction->loan_deduction_title,
								'loan_amount' => $eloan_deduction_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
						}
					}
				}

				// set overtime
				// $salary_overtime = $this->Employees_model->read_salary_overtime($this->input->post('emp_id'));
				// $count_overtime = $this->Employees_model->count_employee_overtime($this->input->post('emp_id'));
				// $overtime_amount = 0;
				// if($count_overtime > 0) {
				// 	foreach($salary_overtime as $sl_overtime){
				// 		$eovertime_hours = $sl_overtime->overtime_hours;
				// 		$eovertime_rate = $sl_overtime->overtime_rate;
				// 		if($system[0]->is_half_monthly==1){
				// 			if($system[0]->half_deduct_month==2){
				// 				$esl_overtime_hr = $eovertime_hours/2;
				// 				$esl_overtime_rate = $eovertime_rate/2;
				// 			} else {
				// 				$esl_overtime_hr = $eovertime_hours;
				// 				$esl_overtime_rate = $eovertime_rate;
				// 			}
				// 		} else {
				// 			$esl_overtime_hr = $eovertime_hours;
				// 			$esl_overtime_rate = $eovertime_rate;
				// 		}
				// 		$overtime_data = array(
				// 		'payslip_id' => $result,
				// 		'employee_id' => $this->input->post('emp_id'),
				// 		'overtime_salary_month' => $this->input->post('pay_date'),
				// 		'overtime_title' => $sl_overtime->overtime_type,
				// 		'overtime_no_of_days' => $sl_overtime->no_of_days,
				// 		'overtime_hours' => $esl_overtime_hr,
				// 		'overtime_rate' => $esl_overtime_rate,
				// 		'created_at' => date('d-m-Y h:i:s')
				// 		);
				// 		$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				// 	}
				// }

				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($overtime) {
					$ot_days = 0;
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
						$ot_days += 1;
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($this->input->post('emp_id'));
					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						// if($this->input->post('office_shift_id')) {
						// 	$shift = $this->Employees_model->read_shift_information($this->input->post('office_shift_id'));
						// 	if($shift) {
						// 		if($shift[0]->monday_in_time != '' && $shift[0]->monday_out_time != '') {
						// 			$time1 = $shift[0]->monday_in_time;
						// 			$time2 = $shift[0]->monday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->tuesday_in_time != '' && $shift[0]->tuesday_out_time != '') {
						// 			$time1 = $shift[0]->tuesday_in_time;
						// 			$time2 = $shift[0]->tuesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->wednesday_in_time != '' && $shift[0]->wednesday_out_time != '') {
						// 			$time1 = $shift[0]->wednesday_in_time;
						// 			$time2 = $shift[0]->wednesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->thursday_in_time != '' && $shift[0]->thursday_out_time != '') {
						// 			$time1 = $shift[0]->thursday_in_time;
						// 			$time2 = $shift[0]->thursday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->friday_in_time != '' && $shift[0]->friday_out_time != '') {
						// 			$time1 = $shift[0]->friday_in_time;
						// 			$time2 = $shift[0]->friday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->saturday_in_time != '' && $shift[0]->saturday_out_time != '') {
						// 			$time1 = $shift[0]->saturday_in_time;
						// 			$time2 = $shift[0]->saturday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->sunday_in_time != '' && $shift[0]->sunday_out_time != '') {
						// 			$time1 = $shift[0]->sunday_in_time;
						// 			$time2 = $shift[0]->sunday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 	}	
						// }else {
						// 	$week_hours = 40;
						// }
						$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;

					$overtime_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'overtime_salary_month' => $this->input->post('pay_date'),
						'overtime_no_of_days' => $ot_days,
						'overtime_hours' => $ot_hrs,
						'overtime_rate' => $rate,
						'total_overtime' => $overtime_amount,
						'created_at' => date('d-m-Y h:i:s')
					);
					$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				}

				//cpf
				$total_cpf =  $this->input->post('total_cpf');
				if ($total_cpf && $total_cpf > 0) {
					$ow_paid = $this->input->post('ow_paid');

					$cpf_data = [
						'payslip_id' => $result,
						// 'month_year' => $this->input->post('pay_date'). '-01',
						'month_year' => '01-' . $this->input->post('pay_date'),
						'ow_paid'	=> $ow_paid,
						'ow_cpf'	=> $this->input->post('ow_cpf'),
						'ow_cpf_employer'	=> $this->input->post('ow_cpf_employer'),
						'ow_cpf_employee'	=> $this->input->post('ow_cpf_employee'),
						'aw_paid'	=> $this->input->post('aw_paid'),
						'aw_cpf'	=> $this->input->post('aw_cpf'),
						'aw_cpf_employer'	=> $this->input->post('aw_cpf_employer'),
						'aw_cpf_employee'	=> $this->input->post('aw_cpf_employee')
					];

					$cpf_payslip = $this->Cpf_payslip_model->add_cpf_payslip($cpf_data);
				}

				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' => $result,
						'contribution_id' => $contribution_id,
						'contribution_amount' => $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//ASHG Fund Contributions
				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' => $result,
						'contribution_id' => $contribution_id,
						'contribution_amount' => $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//sdl
				$sdl = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl = 11.25;
				}

				$cdata = array(
					'payslip_id' => $result,
					'contribution_id' => 5,
					'contribution_amount' => $sdl
				);
				$this->Contribution_fund_model->setContributionPayslip($cdata);

				$Return['result'] = $this->lang->line('xin_success_payment_paid');
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
			$this->output($Return);
			exit;
		}
	}
	public function add_pay_hourly_again()
	{

		if ($this->input->post('add_type') == 'add_pay_hourly') {
			/* Define return | here result is used to return user data and error for error message */
			$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
			$Return['csrf_hash'] = $this->security->get_csrf_hash();

			/* Server side PHP input validation */

			/*if($Return['error']!=''){
       		$this->output($Return);
    	}*/
			$system = $this->Xin_model->read_setting_info(1);
			// office shift
			$office_shift = $this->Timesheet_model->read_office_shift_information($this->input->post('office_shift_id'));
			$basic_salary = $this->input->post('basic_salary');
			$result_previous = $this->Payroll_model->add_salary_payslip_get($this->input->post('emp_id'));
			if ($system[0]->is_half_monthly == 1) {
				$is_half_monthly_payroll = 1;
			} else {
				$is_half_monthly_payroll = 0;
			}
			$data_bacup = array(



				'gross_salary' => $this->input->post('gross_salary_bc'),


				'total_commissions' => $this->input->post('total_commissions_bc'),
				'total_statutory_deductions' => $this->input->post('total_statutory_deductions_bc'),
				'total_other_payments' => $this->input->post('total_other_payments_bc'),
				'total_allowances' => $this->input->post('total_allowances_bc'),
				'total_loan' => $this->input->post('loan_de_amount_bc'),
				'total_overtime' => $this->input->post('total_overtime_bc'),

				'employee_claim' => $this->input->post('employee_claim_bc'),
				'user_id' => $this->input->post('u_id'),

				'leave_deductions' => $this->input->post('leave_deductions_bc'),
				'net_salary' => $this->input->post('net_salary'),

				'total_share' => $this->input->post('total_share_bc'),
				'additional_allowances' => $this->input->post('additional_allowances_bc'),
				'deduction_amount' => $this->input->post('total_employee_deduction_bc'),
				'General_amount' => $this->input->post('General_amount_bc'),
				'motivation_amount' => $this->input->post('motivation_amount_bc'),

			);
			$this->db->insert('salary_backup_table', $data_bacup);
			$this->db->where('user_id', $this->input->post('u_id'))->update('xin_employees', ['payment_status' => $this->input->post('b_am'), 'payment_mode' => $this->input->post('payment_mode')]);
			$basic_salary = 0;
			$gross_salary = 0;
			$leave_deductions = 0;
			$total_allowances = 0;
			$total_loan = 0;
			$total_overtime = 0;
			$total_commissions = 0;
			$total_statutory_deductions = 0;
			$total_employee_deduction = 0;
			$employee_claim = 0;
			$total_other_payments = 0;
			$total_share = 0;
			$total_overtime_amount = 0;
			$additional_allowances = 0;
			$motivation_amount = 0;
			$General_amount = 0;
			if ($this->input->post('chk_gross_salary')) {

				$basic_salary = $this->input->post('basic_salary');
				$gross_salary = $this->input->post('gross_salary');
			}
			if ($this->input->post('chk_leave_deductions')) {

				$leave_deductions = $this->input->post('leave_deductions');
			}
			if ($this->input->post('chk_total_allowances')) {

				$total_allowances = $this->input->post('total_allowances');
			}
			if ($this->input->post('chk_total_commissions')) {

				$total_commissions = $this->input->post('total_commissions');
			}
			if ($this->input->post('chk_loan_de_amount')) {

				$total_loan = $this->input->post('total_loan');
			}
			if ($this->input->post('chk_total_overtime')) {

				$total_overtime = $this->input->post('total_overtime');
			}
			if ($this->input->post('chk_total_statutory_deductions')) {

				$total_statutory_deductions = $this->input->post('total_statutory_deductions');
			}
			if ($this->input->post('chk_total_other_payments')) {

				$total_other_payments = $this->input->post('total_other_payments');
			}
			if ($this->input->post('chk_total_employee_deduction')) {

				$total_employee_deduction = $this->input->post('total_employee_deduction');
			}
			if ($this->input->post('chk_employee_claim')) {

				$employee_claim = $this->input->post('employee_claim');
			}
			if ($this->input->post('chk_total_share')) {

				$total_share = $this->input->post('total_share');
			}
			if ($this->input->post('chk_additional_allowances')) {

				$additional_allowances = $this->input->post('additional_allowances');
			}
			if ($this->input->post('chk_motivation_amount')) {

				$motivation_amount = $this->input->post('motivation_amount');
			}
			if ($this->input->post('chk_General_amount')) {

				$General_amount = $this->input->post('General_amount');
			}
			$jurl = random_string('alnum', 40);
			$data = array(
				'employee_id' => $this->input->post('emp_id'),
				'department_id' => $this->input->post('department_id'),
				'company_id' => $this->input->post('company_id'),
				'location_id' => $this->input->post('location_id'),
				'designation_id' => $this->input->post('designation_id'),
				'salary_month' => $this->input->post('pay_date'),
				'basic_salary' => $basic_salary + $result_previous->basic_salary,
				'gross_salary' => $gross_salary + $result_previous->gross_salary,
				'net_salary' => $this->input->post('net_salary'),
				'wages_type' => $this->input->post('wages_type'),
				'is_half_monthly_payroll' => $is_half_monthly_payroll,
				'total_commissions' => $total_commissions + $result_previous->total_commissions,
				'total_statutory_deductions' => $total_statutory_deductions + $result_previous->total_statutory_deductions,
				'total_other_payments' => $total_other_payments + $result_previous->total_other_payments,
				'total_allowances' => $total_allowances + $result_previous->total_allowances,
				'total_loan' => $total_loan + $result_previous->total_loan,
				'total_overtime' => $total_overtime + $result_previous->total_overtime,
				'total_overtime_amount' => $result_previous->total_overtime_amount + $this->input->post('total_overtime_amount'),
				'claim_amount' => $employee_claim,
				'deduction_amount' => $total_employee_deduction + $result_previous->deduction_amount,
				'hours_worked' => $this->input->post('hours_worked'),
				'cpf_employee_amount' => $this->input->post('total_cpf_employee'),
				'cpf_employer_amount' => $this->input->post('total_cpf_employer'),
				'additonal_allowance' => $additional_allowances,
				'deduction_amount' => $total_employee_deduction,
				'balance_amount' => $this->input->post('b_am'),

				'is_payment' => '1',
				'status' => '0',
				'payslip_type' => 'hourly',
				'payslip_key' => $jurl,
				'year_to_date' => date('d-m-Y'),
				'created_at' => date('d-m-Y h:i:s')
			);
			$result = $this->Payroll_model->add_salary_payslip_update($data, $this->input->post('emp_id'));
			$system_settings = system_settings_info(1);
			if ($system_settings->online_payment_account == '') {
				$online_payment_account = 0;
			} else {
				$online_payment_account = $system_settings->online_payment_account;
			}
			if ($result) {
				// $ivdata = array(
				// 'amount' => $this->input->post('net_salary'),
				// 'account_id' => $online_payment_account,
				// 'transaction_type' => 'expense',
				// 'dr_cr' => 'cr',
				// 'transaction_date' => date('Y-m-d'),
				// 'payer_payee_id' => $this->input->post('emp_id'),
				// 'payment_method_id' => 3,
				// 'description' => 'Payroll Payments',
				// 'reference' => 'Payroll Payments',
				// 'invoice_id' => $result,
				// 'client_id' => $this->input->post('emp_id'),
				// 'created_at' => date('Y-m-d H:i:s')
				// );
				// $this->Finance_model->add_transactions($ivdata);
				// // update data in bank account
				// $account_id = $this->Finance_model->read_bankcash_information($online_payment_account);
				// $acc_balance = $account_id[0]->account_balance - $this->input->post('net_salary');

				// $data3 = array(
				// 'account_balance' => $acc_balance
				// );
				// $this->Finance_model->update_bankcash_record($data3,$online_payment_account);
				$result_total_work = $this->Payroll_model->total_hours_worked($this->input->post('emp_id'), $this->input->post('pay_date'));
				$hrs_old_int1 = 0;
				$pcount = 0;
				$Trest = 0;
				$total_time_rs = 0;
				$hrs_old_int_res1 = 0;
				foreach ($result_total_work->result() as $hour_work) {
					// total work			
					$clock_in =  new DateTime($hour_work->clock_in);
					$clock_out =  new DateTime($hour_work->clock_out);
					$interval_late = $clock_in->diff($clock_out);
					$hours_r  = $interval_late->format('%h');
					$minutes_r = $interval_late->format('%i');
					$total_time = $hours_r . ":" . $minutes_r . ":" . '00';

					$str_time = $total_time;

					$str_time = preg_replace("/^([\d]{1,2})\:([\d]{2})$/", "00:$1:$2", $str_time);

					sscanf($str_time, "%d:%d:%d", $hours, $minutes, $seconds);

					$hrs_old_seconds = $hours * 3600 + $minutes * 60 + $seconds;

					$hrs_old_int1 += $hrs_old_seconds;

					$pcount = gmdate("H", $hrs_old_int1);
				}

				$basic_salary = $basic_salary * $pcount;
				// $appeacial_allowance = $this->Employees_model->get_appeacial_allowance($this->input->post('emp_id'), $this->input->post('pay_date'));
				// $apeacial_allowance_amount = $appeacial_allowance['total_amount'];

				if ($this->input->post('chk_motivation_amount_p')) {

					$General_amount_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'salary_month' => $this->input->post('pay_date'),
						'rate' => $appeacial_allowance['motivation_incentive_rate'],
						'overtime' => $appeacial_allowance['motivation_incentive_time'],
						'total_amount' => $appeacial_allowance['motivation_amount']
					);
					$this->Employees_model->add_salary_payslip_Motivation_amount($General_amount_data);
				}
				if ($this->input->post('chk_General_amount_p')) {

					$General_amount_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'salary_month' => $this->input->post('pay_date'),
						'rate' => $appeacial_allowance['general_motivation_rate'],
						'overtime' => $appeacial_allowance['general_motivation_time'],
						'total_amount' => $appeacial_allowance['General_amount']
					);
					$this->Employees_model->add_salary_payslip_General_amount($General_amount_data);
				}


				$g_ordinary_wage = 0;
				$g_additional_wage = 0;
				$g_shg = 0;
				$g_sdl = 0;

				$g_ordinary_wage += $basic_salary;
				$g_shg += $basic_salary;
				$g_sdl += $basic_salary;

				// set allowance
				$allowance_amount = 0;
				$gross_allowance_amount = 0;
				if ($this->input->post('chk_total_allowances')) {
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($salary_allowances) {
						foreach ($salary_allowances as $sl_allowances) {
							$esl_allowances = $sl_allowances->allowance_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $esl_allowances / 2;
								} else {
									$eallowance_amount = $esl_allowances;
								}
							} else {
								$eallowance_amount = $esl_allowances;
							}
							$allowance_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'allowance_title' => $sl_allowances->allowance_title,
								'allowance_amount' => $eallowance_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);


							if (!empty($sl_allowances->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								$g_ordinary_wage += $eallowance_amount;
								if ($sl_allowances->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}

							if ($sl_allowances->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sl_allowances->shg == 1) {
								$g_shg += $eallowance_amount;
							}

							$allowance_amount += $eallowance_amount;
						}
					}
				}

				//3: Gross rate of pay (unpaid leave deduction)
				$holidays_count = 0;
				$no_of_working_days = 0;
				// $month_start_date = new DateTime($this->input->post('pay_date') . '-01');
				$month_start_date = new DateTime('01-' . $this->input->post('pay_date'));
				$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
				$month_end_date->modify('+1 day');
				$interval = new DateInterval('P1D');
				$period = new DatePeriod($month_start_date, $interval, $month_end_date);
				foreach ($period as $p) {
					$p_day = $p->format('l');
					$p_date = $p->format('Y-m-d');

					//holidays in a month
					$is_holiday = $this->Timesheet_model->is_holiday_on_date($this->input->post('company_id'), $p_date);
					if ($is_holiday) {
						$holidays_count += 1;
					}

					//working days excluding holidays based on office shift
					if ($p_day == 'Monday') {
						if ($office_shift[0]->monday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Tuesday') {
						if ($office_shift[0]->tuesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Wednesday') {
						if ($office_shift[0]->wednesday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Thursday') {
						if ($office_shift[0]->thursday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Friday') {
						if ($office_shift[0]->friday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Saturday') {
						if ($office_shift[0]->saturday_in_time != '') {
							$no_of_working_days += 1;
						}
					} else if ($p_day == 'Sunday') {
						if ($office_shift[0]->sunday_in_time != '') {
							$no_of_working_days += 1;
						}
					}
				}

				//unpaid leave
				$unpaid_leave_amount = 0;
				$leaves_taken_count = 0;
				$leave_period = array();
				if ($this->input->post('chk_leave_deductions')) {
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							// $pay_date_month = new DateTime($this->input->post('pay_date') . '-01');
							$pay_date_month = new DateTime('01-' . $this->input->post('pay_date'));
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);

							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {

									if ($office_shift[0]->monday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '' && in_array($d->format('Y-m-d'), $holiday_array_new) !== true) {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
							// if(count($leave_period) > 0) {
							// 	if($l->is_half_day == 0) {
							// 		$leaves_taken_count += count($leave_period);
							// 	}else {
							// 		$leaves_taken_count += count($leave_period)  / 2;
							// 	}
							// }
						}
					}
				}

				$no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count)) + $holidays_count;

				$gross_pay = round((($basic_salary + $gross_allowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
				$unpaid_leave_amount = ($basic_salary + $gross_allowance_amount) - $gross_pay;

				// echo 'Working days : '. $no_of_working_days . '<br>';
				// echo 'Holidays : '. $holidays_count . '<br>';
				// echo 'Leaves : '. $leaves_taken_count . '<br>';
				// echo 'Leave Days : ('. implode(", " , $leave_period)  . ')<br>';
				// echo 'Days Worked : '. $no_of_days_worked . '<br>';
				// echo 'Basic Pay : '. $g_ordinary_wage . '<br>';
				// echo 'Gross Pay : '. $gross_pay . '<br>';
				$g_ordinary_wage -= $unpaid_leave_amount;
				// echo 'Unpaid Leave : '. $unpaid_leave_amount . '<br>';
				// echo '<hr>';
				if ($unpaid_leave_amount > 0 && $leaves_taken_count > 0) {
					foreach ($leave_period as $l) {
						$is_half = $l['is_half'];
						$leave_dates = $l['leave_date'];
						$leave_day_pay = round(($basic_salary + $gross_allowance_amount) / $no_of_working_days, 2);
						if ($is_half) {
							$leave_day_pay = $leave_day_pay / 2;
						}
						foreach ($leave_dates as $ld) {
							$unpaid_leave_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'leave_date' => $ld,
								'leave_amount' => $leave_day_pay,
								'is_half' => $is_half,
								'total_leave_amount' => $unpaid_leave_amount
							);
							$this->Payroll_model->add_salary_payslip_leave_deduction($unpaid_leave_data);
						}
					}
				}
				if ($this->input->post('chk_total_commissions')) {
					// commissions
					$commission_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommission_amount = $c->commission_amount / 2;
								} else {
									$ecommission_amount = $c->commission_amount;
								}
							} else {
								$ecommission_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommission_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommission_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommission_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommission_amount;
							}

							$commissions_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'commission_id' => $c->commission_type,
								'commission_amount' => $ecommission_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_commissions($commissions_data);

							$commission_amount += $ecommission_amount;
						}
					}
				}
				if ($this->input->post('chk_total_share')) {
					//share options
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($this->input->post('emp_id'), $this->input->post('pay_date'));
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;

						$share_options_data = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'salary_month' => $this->input->post('pay_date'),
							'amount' => round($share_options_amount, 2)
						);
						$this->Payroll_model->add_salary_payslip_share_options($share_options_data);
					}
				}
				if ($this->input->post('chk_total_other_payments')) {
					// set other payments
					$salary_other_payments = $this->Employees_model->read_salary_other_payments($this->input->post('emp_id'));
					$count_other_payment = $this->Employees_model->count_employee_other_payments($this->input->post('emp_id'));
					$other_payment_amount = 0;
					if ($count_other_payment > 0) {
						foreach ($salary_other_payments as $sl_other_payments) {
							$esl_other_payments = $sl_other_payments->payments_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$epayments_amount = $esl_other_payments / 2;
								} else {
									$epayments_amount = $esl_other_payments;
								}
							} else {
								$epayments_amount = $esl_other_payments;
							}
							$other_payments_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'payments_title' => $sl_other_payments->payments_title,
								'payments_amount' => $epayments_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
						}
					}
				}
				if ($this->input->post('chk_total_statutory_deductions')) {
					// set statutory_deductions
					$salary_statutory_deductions = $this->Employees_model->read_salary_statutory_deductions($this->input->post('emp_id'));
					$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($this->input->post('emp_id'));
					$statutory_deductions_amount = 0;
					if ($count_statutory_deductions > 0) {
						foreach ($salary_statutory_deductions as $sl_statutory_deduction) {
							$esl_statutory_deduction = $sl_statutory_deduction->deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ededuction_amount = $esl_statutory_deduction / 2;
								} else {
									$ededuction_amount = $esl_statutory_deduction;
								}
							} else {
								$ededuction_amount = $esl_statutory_deduction;
							}
							$statutory_deduction_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'deduction_title' => $sl_statutory_deduction->deduction_title,
								'deduction_amount' => $ededuction_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);
						}
					}
				}
				$employee_deduction = $this->Payroll_model->get_deduction_detail($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($this->input->post('chk_total_employee_deduction') && $employee_deduction) {
					foreach ($employee_deduction as $deduction) {
						$xin_salary_deduction = array(
							'payslip_id' => $result,
							'employee_id' => $this->input->post('emp_id'),
							'salary_month' => $this->input->post('pay_date'),
							'name' => $deduction->deduction_type,
							'amount' => $deduction->amount,

						);
						$this->Payroll_model->add_salary_payslip_deduction($xin_salary_deduction);
					}
				}
				if ($this->input->post('chk_loan_de_amount')) {
					// set loan
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($this->input->post('emp_id'));
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($this->input->post('emp_id'));
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							$esl_salary_loan_deduction = $sl_salary_loan_deduction->loan_deduction_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eloan_deduction_amount = $esl_salary_loan_deduction / 2;
								} else {
									$eloan_deduction_amount = $esl_salary_loan_deduction;
								}
							} else {
								$eloan_deduction_amount = $esl_salary_loan_deduction;
							}
							$loan_data = array(
								'payslip_id' => $result,
								'employee_id' => $this->input->post('emp_id'),
								'salary_month' => $this->input->post('pay_date'),
								'loan_title' => $sl_salary_loan_deduction->loan_deduction_title,
								'loan_amount' => $eloan_deduction_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
						}
					}
				}

				// set overtime
				// $salary_overtime = $this->Employees_model->read_salary_overtime($this->input->post('emp_id'));
				// $count_overtime = $this->Employees_model->count_employee_overtime($this->input->post('emp_id'));
				// $overtime_amount = 0;
				// if($count_overtime > 0) {
				// 	foreach($salary_overtime as $sl_overtime){
				// 		$eovertime_hours = $sl_overtime->overtime_hours;
				// 		$eovertime_rate = $sl_overtime->overtime_rate;
				// 		if($system[0]->is_half_monthly==1){
				// 			if($system[0]->half_deduct_month==2){
				// 				$esl_overtime_hr = $eovertime_hours/2;
				// 				$esl_overtime_rate = $eovertime_rate/2;
				// 			} else {
				// 				$esl_overtime_hr = $eovertime_hours;
				// 				$esl_overtime_rate = $eovertime_rate;
				// 			}
				// 		} else {
				// 			$esl_overtime_hr = $eovertime_hours;
				// 			$esl_overtime_rate = $eovertime_rate;
				// 		}
				// 		$overtime_data = array(
				// 		'payslip_id' => $result,
				// 		'employee_id' => $this->input->post('emp_id'),
				// 		'overtime_salary_month' => $this->input->post('pay_date'),
				// 		'overtime_title' => $sl_overtime->overtime_type,
				// 		'overtime_no_of_days' => $sl_overtime->no_of_days,
				// 		'overtime_hours' => $esl_overtime_hr,
				// 		'overtime_rate' => $esl_overtime_rate,
				// 		'created_at' => date('d-m-Y h:i:s')
				// 		);
				// 		$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				// 	}
				// }

				$overtime_amount = 0;
				$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($this->input->post('emp_id'), $this->input->post('pay_date'));
				if ($overtime) {
					$ot_days = 0;
					$ot_hrs = 0;
					$ot_mins = 0;
					foreach ($overtime as $ot) {
						$total_hours = explode(':', $ot->total_hours);
						$ot_hrs += $total_hours[0];
						$ot_mins += $total_hours[1];
						$ot_days += 1;
					}
					if ($ot_mins > 0) {
						$ot_hrs += round($ot_mins / 60, 2);
					}

					//overtime rate
					$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($this->input->post('emp_id'));
					if ($overtime_rate) {
						$rate = $overtime_rate->overtime_pay_rate;
					} else {
						$week_hours = 44;
						// if($this->input->post('office_shift_id')) {
						// 	$shift = $this->Employees_model->read_shift_information($this->input->post('office_shift_id'));
						// 	if($shift) {
						// 		if($shift[0]->monday_in_time != '' && $shift[0]->monday_out_time != '') {
						// 			$time1 = $shift[0]->monday_in_time;
						// 			$time2 = $shift[0]->monday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->tuesday_in_time != '' && $shift[0]->tuesday_out_time != '') {
						// 			$time1 = $shift[0]->tuesday_in_time;
						// 			$time2 = $shift[0]->tuesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->wednesday_in_time != '' && $shift[0]->wednesday_out_time != '') {
						// 			$time1 = $shift[0]->wednesday_in_time;
						// 			$time2 = $shift[0]->wednesday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->thursday_in_time != '' && $shift[0]->thursday_out_time != '') {
						// 			$time1 = $shift[0]->thursday_in_time;
						// 			$time2 = $shift[0]->thursday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->friday_in_time != '' && $shift[0]->friday_out_time != '') {
						// 			$time1 = $shift[0]->friday_in_time;
						// 			$time2 = $shift[0]->friday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->saturday_in_time != '' && $shift[0]->saturday_out_time != '') {
						// 			$time1 = $shift[0]->saturday_in_time;
						// 			$time2 = $shift[0]->saturday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 		if($shift[0]->sunday_in_time != '' && $shift[0]->sunday_out_time != '') {
						// 			$time1 = $shift[0]->sunday_in_time;
						// 			$time2 = $shift[0]->sunday_out_time;
						// 			$time1 = explode(':',$time1);
						// 			$time2 = explode(':',$time2);
						// 			$hours1 = $time1[0];
						// 			$hours2 = $time2[0];
						// 			$mins1 = $time1[1];
						// 			$mins2 = $time2[1];
						// 			$hours = $hours2 - $hours1;
						// 			$mins = 0;
						// 			if($hours < 0)
						// 			{
						// 				$hours = 24 + $hours;
						// 			}
						// 			if($mins2 >= $mins1) {
						// 				$mins = $mins2 - $mins1;
						// 			}
						// 			else {
						// 				$mins = ($mins2 + 60) - $mins1;
						// 				$hours--;
						// 			}
						// 			if($mins > 0) {
						// 				$hours += round($mins / 60, 2);
						// 			}
						// 			$week_hours += $hours;
						// 		}
						// 	}	
						// }else {
						// 	$week_hours = 40;
						// }
						$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
						$rate = $rate * 1.5;
					}

					if ($ot_hrs > 0) {
						$overtime_amount = round($ot_hrs * $rate, 2);
					}
					if ($system[0]->is_half_monthly == 1) {
						if ($system[0]->half_deduct_month == 2) {
							$overtime_amount = $overtime_amount / 2;
						}
					}
					$g_ordinary_wage += $overtime_amount;
					$g_sdl += $overtime_amount;

					$overtime_data = array(
						'payslip_id' => $result,
						'employee_id' => $this->input->post('emp_id'),
						'overtime_salary_month' => $this->input->post('pay_date'),
						'overtime_no_of_days' => $ot_days,
						'overtime_hours' => $ot_hrs,
						'overtime_rate' => $rate,
						'total_overtime' => $overtime_amount,
						'created_at' => date('d-m-Y h:i:s')
					);
					$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
				}

				//cpf
				$total_cpf =  $this->input->post('total_cpf');
				if ($total_cpf && $total_cpf > 0) {
					$ow_paid = $this->input->post('ow_paid');

					$cpf_data = [
						'payslip_id' => $result,
						// 'month_year' => $this->input->post('pay_date'). '-01',
						'month_year' => '01-' . $this->input->post('pay_date'),
						'ow_paid'	=> $ow_paid,
						'ow_cpf'	=> $this->input->post('ow_cpf'),
						'ow_cpf_employer'	=> $this->input->post('ow_cpf_employer'),
						'ow_cpf_employee'	=> $this->input->post('ow_cpf_employee'),
						'aw_paid'	=> $this->input->post('aw_paid'),
						'aw_cpf'	=> $this->input->post('aw_cpf'),
						'aw_cpf_employer'	=> $this->input->post('aw_cpf_employer'),
						'aw_cpf_employee'	=> $this->input->post('aw_cpf_employee')
					];

					$cpf_payslip = $this->Cpf_payslip_model->add_cpf_payslip($cpf_data);
				}

				//Other Fund Contributions
				$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' => $result,
						'contribution_id' => $contribution_id,
						'contribution_amount' => $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//ASHG Fund Contributions
				$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($this->input->post('emp_id'));
				if ($employee_ashg_contributions) {
					$fund_deduction_amount = 0;
					$gross_s = $g_shg;
					$contribution_id = $employee_ashg_contributions->contribution_id;
					$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

					$fund_deduction_amount += $contribution_amount;
					$cdata = array(
						'payslip_id' => $result,
						'contribution_id' => $contribution_id,
						'contribution_amount' => $contribution_amount
					);
					$this->Contribution_fund_model->setContributionPayslip($cdata);
				}

				//sdl
				$sdl = 0;
				if ($g_sdl > 1 && $g_sdl <= 800) {
					$sdl = 2;
				} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
					$sdl_amount = (0.25 * $g_sdl) / 100;
					$sdl = $sdl_amount;
				} elseif ($g_sdl > 4500) {
					$sdl = 11.25;
				}

				$cdata = array(
					'payslip_id' => $result,
					'contribution_id' => 5,
					'contribution_amount' => $sdl
				);
				$this->Contribution_fund_model->setContributionPayslip($cdata);

				$Return['result'] = $this->lang->line('xin_success_payment_paid');
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
			$this->output($Return);
			exit;
		}
	}

	// Validate and add info in database > add monthly payment
	public function add_half_pay_to_all()
	{

		/* Define return | here result is used to return user data and error for error message */
		$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
		$Return['csrf_hash'] = $this->security->get_csrf_hash();

		if ($this->input->post('add_type') == 'payroll') {
			if ($this->input->post('company_id') == 0 && $this->input->post('location_id') == 0 && $this->input->post('department_id') == 0) {
				$result = $this->Xin_model->all_employees();
			} else if ($this->input->post('company_id') != 0 && $this->input->post('location_id') == 0 && $this->input->post('department_id') == 0) {
				$eresult = $this->Payroll_model->get_company_payroll_employees($this->input->post('company_id'));
				$result = $eresult->result();
			} else if ($this->input->post('company_id') != 0 && $this->input->post('location_id') != 0 && $this->input->post('department_id') == 0) {
				$eresult = $this->Payroll_model->get_company_location_payroll_employees($this->input->post('company_id'), $this->input->post('location_id'));
				$result = $eresult->result();
			} else if ($this->input->post('company_id') != 0 && $this->input->post('location_id') != 0 && $this->input->post('department_id') != 0) {
				$eresult = $this->Payroll_model->get_company_location_dep_payroll_employees($this->input->post('company_id'), $this->input->post('location_id'), $this->input->post('department_id'));
				$result = $eresult->result();
			} else {
				$Return['error'] = $this->lang->line('xin_record_not_found');
			}
			$system = $this->Xin_model->read_setting_info(1);
			$system_settings = system_settings_info(1);
			if ($system_settings->online_payment_account == '') {
				$online_payment_account = 0;
			} else {
				$online_payment_account = $system_settings->online_payment_account;
			}
			foreach ($result as $empid) {
				$user_id = $empid->user_id;
				$user = $this->Xin_model->read_user_info($user_id);

				if ($system[0]->is_half_monthly == 1) {
					$is_half_monthly_payroll = 1;
				} else {
					$is_half_monthly_payroll = 0;
				}
				/* Server side PHP input validation */
				if ($empid->wages_type == 1) {
					if ($system[0]->is_half_monthly == 1) {
						$basic_salary = $empid->basic_salary / 2;
					} else {
						$basic_salary = $empid->basic_salary;
					}
				} else {
					$basic_salary = $empid->daily_wages;
				}
				if ($basic_salary > 0) {
					// get designation
					$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
					if (!is_null($designation)) {
						$designation_id = $designation[0]->designation_id;
					} else {
						$designation_id = 1;
					}
					// department
					$department = $this->Department_model->read_department_information($user[0]->department_id);
					if (!is_null($department)) {
						$department_id = $department[0]->department_id;
					} else {
						$department_id = 1;
					}

					$salary_allowances = $this->Employees_model->read_salary_allowances($user_id);
					$count_allowances = $this->Employees_model->count_employee_allowances($user_id);
					$allowance_amount = 0;
					if ($count_allowances > 0) {
						foreach ($salary_allowances as $sl_allowances) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sl_allowances->allowance_amount / 2;
								} else {
									$eallowance_amount = $sl_allowances->allowance_amount;
								}
							} else {
								$eallowance_amount = $sl_allowances->allowance_amount;
							}
							$allowance_amount += $eallowance_amount;
							//  $allowance_amount += $sl_allowances->allowance_amount;
						}
					} else {
						$allowance_amount = 0;
					}
					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($user_id);
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount / 2;
								} else {
									$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
								}
							} else {
								$er_loan = $sl_salary_loan_deduction->loan_deduction_amount;
							}
							$loan_de_amount += $er_loan;
							// $loan_de_amount += $sl_salary_loan_deduction->loan_deduction_amount;
						}
					} else {
						$loan_de_amount = 0;
					}

					$loan_de_amount = number_format(floatval($loan_de_amount), 2);
					// 5: overtime
					$salary_overtime = $this->Employees_model->read_salary_overtime($user_id);
					$count_overtime = $this->Employees_model->count_employee_overtime($user_id);
					$overtime_amount = 0;
					if ($count_overtime > 0) {
						foreach ($salary_overtime as $sl_overtime) {
							//$overtime_total = $sl_overtime->overtime_hours * $sl_overtime->overtime_rate;
							//$overtime_amount += $overtime_total;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eovertime_hours = $sl_overtime->overtime_hours / 2;
									$eovertime_rate = $sl_overtime->overtime_rate / 2;
								} else {
									$eovertime_hours = $sl_overtime->overtime_hours;
									$eovertime_rate = $sl_overtime->overtime_rate;
								}
							} else {
								$eovertime_hours = $sl_overtime->overtime_hours;
								$eovertime_rate = $sl_overtime->overtime_rate;
							}
							$overtime_amount += $eovertime_hours * $eovertime_rate;
						}
					} else {
						$overtime_amount = 0;
					}



					// 6: statutory deductions
					// 4: other payment
					$other_payments = $this->Employees_model->set_employee_other_payments($user_id);
					$other_payments_amount = 0;
					if (!is_null($other_payments)) :
						foreach ($other_payments->result() as $sl_other_payments) {
							//$other_payments_amount += $sl_other_payments->payments_amount;
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$epayments_amount = $sl_other_payments->payments_amount / 2;
								} else {
									$epayments_amount = $sl_other_payments->payments_amount;
								}
							} else {
								$epayments_amount = $sl_other_payments->payments_amount;
							}
							$other_payments_amount += $epayments_amount;
						}
					endif;
					// all other payment
					$all_other_payment = $other_payments_amount;
					// 5: commissions
					$commissions = $this->Employees_model->set_employee_commissions($user_id);
					if (!is_null($commissions)) :
						$commissions_amount = 0;
						foreach ($commissions->result() as $sl_commissions) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $sl_commissions->commission_amount / 2;
								} else {
									$ecommissions_amount = $sl_commissions->commission_amount;
								}
							} else {
								$ecommissions_amount = $sl_commissions->commission_amount;
							}
							$commissions_amount += $ecommissions_amount;
							// $commissions_amount += $sl_commissions->commission_amount;
						}
					endif;
					// 6: statutory deductions
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($user_id);
					if (!is_null($statutory_deductions)) :
						$statutory_deductions_amount = 0;
						foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') :
								$sta_salary = $basic_salary;
								$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $st_amount / 2;
									} else {
										$single_sd = $st_amount;
									}
								} else {
									$single_sd = $st_amount;
								}
								$statutory_deductions_amount += $single_sd;
							else :
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$single_sd = $sl_statutory_deductions->deduction_amount / 2;
									} else {
										$single_sd = $sl_statutory_deductions->deduction_amount;
									}
								} else {
									$single_sd = $sl_statutory_deductions->deduction_amount;
								}
								$statutory_deductions_amount += $single_sd;
							//$statutory_deductions_amount += $sl_statutory_deductions->deduction_amount;
							endif;
						}
					endif;

					// add amount
					$add_salary = $allowance_amount + $basic_salary + $overtime_amount + $other_payments_amount + $commissions_amount;
					// add amount
					$net_salary_default = $add_salary - floatval($loan_de_amount) - $statutory_deductions_amount;
					$net_salary = $net_salary_default;
					$net_salary = number_format((float)$net_salary, 2, '.', '');
					$jurl = random_string('alnum', 40);
					$data = array(
						'employee_id' => $user_id,
						'department_id' => $department_id,
						'company_id' => $user[0]->company_id,
						'designation_id' => $designation_id,
						'salary_month' => $this->input->post('month_year'),
						'basic_salary' => $basic_salary,
						'net_salary' => $net_salary,
						'wages_type' => $empid->wages_type,
						'total_allowances' => $allowance_amount,
						'total_loan' => $loan_de_amount,
						'total_overtime' => $overtime_amount,
						'total_commissions' => $commissions_amount,
						'total_statutory_deductions' => $statutory_deductions_amount,
						'total_other_payments' => $other_payments_amount,
						'is_half_monthly_payroll' => $is_half_monthly_payroll,
						'is_payment' => '1',
						'payslip_type' => 'full_monthly',
						'payslip_key' => $jurl,
						'year_to_date' => date('d-m-Y'),
						'created_at' => date('d-m-Y h:i:s')
					);
					$result = $this->Payroll_model->add_salary_payslip($data);

					if ($result) {
						$ivdata = array(
							'amount' => $net_salary,
							'account_id' => $online_payment_account,
							'transaction_type' => 'expense',
							'dr_cr' => 'cr',
							'transaction_date' => date('Y-m-d'),
							'payer_payee_id' => $user_id,
							'payment_method_id' => 3,
							'description' => 'Payroll Payments',
							'reference' => 'Payroll Payments',
							'invoice_id' => $result,
							'client_id' => $user_id,
							'created_at' => date('Y-m-d H:i:s')
						);
						$this->Finance_model->add_transactions($ivdata);
						// update data in bank account
						$account_id = $this->Finance_model->read_bankcash_information($online_payment_account);
						$acc_balance = $account_id[0]->account_balance - $net_salary;

						$data3 = array(
							'account_balance' => $acc_balance
						);
						$this->Finance_model->update_bankcash_record($data3, $online_payment_account);

						$salary_allowances = $this->Employees_model->read_salary_allowances($user_id);
						$count_allowances = $this->Employees_model->count_employee_allowances($user_id);
						$allowance_amount = 0;
						if ($count_allowances > 0) {
							foreach ($salary_allowances as $sl_allowances) {
								$allowance_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'allowance_title' => $sl_allowances->allowance_title,
									'allowance_amount' => $sl_allowances->allowance_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);
							}
						}
						// set commissions
						$salary_commissions = $this->Employees_model->read_salary_commissions($user_id);
						$count_commission = $this->Employees_model->count_employee_commissions($user_id);
						$commission_amount = 0;
						if ($count_commission > 0) {
							foreach ($salary_commissions as $sl_commission) {
								$commissions_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'commission_title' => $sl_commission->commission_title,
									'commission_amount' => $sl_commission->commission_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$this->Payroll_model->add_salary_payslip_commissions($commissions_data);
							}
						}
						// set other payments
						$salary_other_payments = $this->Employees_model->read_salary_other_payments($user_id);
						$count_other_payment = $this->Employees_model->count_employee_other_payments($user_id);
						$other_payment_amount = 0;
						if ($count_other_payment > 0) {
							foreach ($salary_other_payments as $sl_other_payments) {
								$other_payments_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'payments_title' => $sl_other_payments->payments_title,
									'payments_amount' => $sl_other_payments->payments_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
							}
						}
						// set statutory_deductions
						$salary_statutory_deductions = $this->Employees_model->read_salary_statutory_deductions($user_id);
						$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($user_id);
						$statutory_deductions_amount = 0;
						if ($count_statutory_deductions > 0) {
							foreach ($salary_statutory_deductions as $sl_statutory_deduction) {
								$statutory_deduction_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'deduction_title' => $sl_statutory_deduction->deduction_title,
									'deduction_amount' => $sl_statutory_deduction->deduction_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);
							}
						}
						$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($user_id);
						$count_loan_deduction = $this->Employees_model->count_employee_deductions($user_id);
						$loan_de_amount = 0;
						if ($count_loan_deduction > 0) {
							foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
								$loan_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'loan_title' => $sl_salary_loan_deduction->loan_deduction_title,
									'loan_amount' => $sl_salary_loan_deduction->loan_deduction_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
							}
						}
						$salary_overtime = $this->Employees_model->read_salary_overtime($user_id);
						$count_overtime = $this->Employees_model->count_employee_overtime($user_id);
						$overtime_amount = 0;
						if ($count_overtime > 0) {
							foreach ($salary_overtime as $sl_overtime) {
								//$overtime_total = $sl_overtime->overtime_hours * $sl_overtime->overtime_rate;
								$overtime_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'overtime_salary_month' => $this->input->post('month_year'),
									'overtime_title' => $sl_overtime->overtime_type,
									'overtime_no_of_days' => $sl_overtime->no_of_days,
									'overtime_hours' => $sl_overtime->overtime_hours,
									'overtime_rate' => $sl_overtime->overtime_rate,
									'created_at' => date('d-m-Y h:i:s')
								);
								$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
							}
						}

						$Return['result'] = $this->lang->line('xin_success_payment_paid');
					} else {
						$Return['error'] = $this->lang->line('xin_error_msg');
					}
				} // if basic salary
			}
			$Return['result'] = $this->lang->line('xin_success_payment_paid');
			$this->output($Return);
			exit;
		} // f
	}

	// Validate and add info in database > add monthly payment
	public function add_pay_to_all()
	{

		/* Define return | here result is used to return user data and error for error message */
		$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
		$Return['csrf_hash'] = $this->security->get_csrf_hash();

		if ($this->input->post('add_type') == 'payroll') {
			$p_date = $this->input->post('month_year');
			if ($this->input->post('company_id') == 0 && $this->input->post('location_id') == 0 && $this->input->post('department_id') == 0) {
				$eresult = $this->Payroll_model->get_all_employees($p_date);
				$result = $eresult->result();
			} else if ($this->input->post('company_id') != 0 && $this->input->post('location_id') == 0 && $this->input->post('department_id') == 0) {
				$eresult = $this->Payroll_model->get_company_payroll_employees($this->input->post('company_id'), $p_date);
				$result = $eresult->result();
			} else if ($this->input->post('company_id') != 0 && $this->input->post('location_id') != 0 && $this->input->post('department_id') == 0) {
				$eresult = $this->Payroll_model->get_company_location_payroll_employees($this->input->post('company_id'), $this->input->post('location_id'), $p_date);
				$result = $eresult->result();
			} else if ($this->input->post('company_id') != 0 && $this->input->post('location_id') != 0 && $this->input->post('department_id') != 0) {
				$eresult = $this->Payroll_model->get_company_location_dep_payroll_employees($this->input->post('company_id'), $this->input->post('location_id'), $this->input->post('department_id'), $p_date);
				$result = $eresult->result();
			} else {
				$Return['error'] = $this->lang->line('xin_record_not_found');
			}
			$system = $this->Xin_model->read_setting_info(1);
			$system_settings = system_settings_info(1);

			if ($system_settings->online_payment_account == '') {
				$online_payment_account = 0;
			} else {
				$online_payment_account = $system_settings->online_payment_account;
			}
			// print_r($result);exit;
			foreach ($result as $empid) {
				$user_id = $empid->user_id;
				$user = $this->Xin_model->read_user_info($user_id);

				// office shift
				$office_shift = $this->Timesheet_model->read_office_shift_information($user[0]->office_shift_id);

				/* Server side PHP input validation */
				if ($empid->wages_type == 1) {
					$basic_salary = $empid->basic_salary;
				} else {
					$basic_salary = $empid->daily_wages;
				}
				$pay_count = $this->Payroll_model->read_make_payment_payslip_check($user_id, $this->input->post('month_year'));
				if ($pay_count->num_rows() > 0) {
					$pay_val = $this->Payroll_model->read_make_payment_payslip($user_id, $this->input->post('month_year'));
					$this->payslip_delete_all($pay_val[0]->payslip_id);
				}

				if ($basic_salary > 0) {
					/**
					 * Local Variable
					 */
					$g_ordinary_wage = 0;
					$g_additional_wage = 0;
					$g_shg = 0;
					$g_sdl = 0;

					// get designation
					$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
					if (!is_null($designation)) {
						$designation_id = $designation[0]->designation_id;
					} else {
						$designation_id = 1;
					}
					// department
					$department = $this->Department_model->read_department_information($user[0]->department_id);
					if (!is_null($department)) {
						$department_id = $department[0]->department_id;
					} else {
						$department_id = 1;
					}

					$g_ordinary_wage += $basic_salary;
					$g_shg += $basic_salary;
					$g_sdl += $basic_salary;

					// 2: all allowances
					$allowance_amount = 0;
					$gross_allowance_amount = 0;
					$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($user_id, $p_date);
					if ($salary_allowances) {
						foreach ($salary_allowances as $sa) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$eallowance_amount = $sa->allowance_amount / 2;
								} else {
									$eallowance_amount = $sa->allowance_amount;
								}
							} else {
								$eallowance_amount = $sa->allowance_amount;
							}

							if (!empty($sa->salary_month)) {
								$g_additional_wage += $eallowance_amount;
							} else {
								$g_ordinary_wage += $eallowance_amount;
								if ($sa->id == 2) {
									$gross_allowance_amount = $eallowance_amount;
								}
							}

							if ($sa->sdl == 1) {
								$g_sdl += $eallowance_amount;
							}
							if ($sa->shg == 1) {
								$g_shg += $eallowance_amount;
							}

							$allowance_amount += $eallowance_amount;
						}
					}

					// $salary_allowances = $this->Employees_model->read_salary_allowances($user_id);
					// $count_allowances = $this->Employees_model->count_employee_allowances($user_id);
					// $allowance_amount = 0;
					// if($count_allowances > 0) {
					// 	foreach($salary_allowances as $sl_allowances){
					// 		$allowance_amount += $sl_allowances->allowance_amount;
					// 	}
					// } else {
					// 	$allowance_amount = 0;
					// }

					//3: Gross rate of pay (unpaid leave deduction)
					$holidays_count = 0;
					$no_of_working_days = 0;
					$month_start_date = new DateTime('01-' . $p_date);
					$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
					$month_end_date->modify('+1 day');
					$interval = new DateInterval('P1D');
					$period = new DatePeriod($month_start_date, $interval, $month_end_date);
					foreach ($period as $p) {
						$period_day = $p->format('l');
						$period_date = $p->format('Y-m-d');

						//holidays in a month
						$is_holiday = $this->Timesheet_model->is_holiday_on_date($user[0]->company_id, $period_date);
						if ($is_holiday) {
							$holidays_count += 1;
						}

						//working days excluding holidays based on office shift
						if ($period_day == 'Monday') {
							if ($office_shift[0]->monday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Tuesday') {
							if ($office_shift[0]->tuesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Wednesday') {
							if ($office_shift[0]->wednesday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Thursday') {
							if ($office_shift[0]->thursday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Friday') {
							if ($office_shift[0]->friday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Saturday') {
							if ($office_shift[0]->saturday_in_time != '') {
								$no_of_working_days += 1;
							}
						} else if ($period_day == 'Sunday') {
							if ($office_shift[0]->sunday_in_time != '') {
								$no_of_working_days += 1;
							}
						}
					}

					//unpaid leave
					$unpaid_leave_amount = 0;
					$leaves_taken_count = 0;
					$leave_period = array();
					$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($user_id, $p_date);
					if ($unpaid_leaves) {
						foreach ($unpaid_leaves as $k => $l) {
							$pay_date_month = new DateTime('01-' . $p_date);
							$l_from_date = new DateTime($l->from_date);
							$l_to_date = new DateTime($l->to_date);

							if ($l_from_date->format('m') == $l_to_date->format('m')) {
								$start_date = $l_from_date;
								$end_date = $l_to_date;
							} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $l_from_date;
								$end_date = new DateTime($start_date->format('Y-m-t'));
							} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
								$start_date = $pay_date_month;
								$end_date = $l_to_date;
							}
							$end_date->modify('+1 day');
							$interval = new DateInterval('P1D');
							$period = new DatePeriod($start_date, $interval, $end_date);
							foreach ($period as $d) {
								$p_day = $d->format('l');
								if ($p_day == 'Monday') {
									if ($office_shift[0]->monday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Tuesday') {
									if ($office_shift[0]->tuesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Wednesday') {
									if ($office_shift[0]->wednesday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Thursday') {
									if ($office_shift[0]->thursday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Friday') {
									if ($office_shift[0]->friday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Saturday') {
									if ($office_shift[0]->saturday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								} else if ($p_day == 'Sunday') {
									if ($office_shift[0]->sunday_in_time != '') {
										$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
										if ($l->is_half_day == 0) {
											$leaves_taken_count += 1;
										} else {
											$leaves_taken_count += 0.5;
										}
									}
								}
							}
							$leave_period[$k]['is_half'] = $l->is_half_day;
							// if(count($leave_period) > 0) {
							// 	if($l->is_half_day == 0) {
							// 		$leaves_taken_count += count($leave_period);
							// 	}else {
							// 		$leaves_taken_count += count($leave_period)  / 2;
							// 	}
							// }
						}
					}

					$no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count)) + $holidays_count;
					$gross_pay = round((($basic_salary + $gross_allowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
					$unpaid_leave_amount = ($basic_salary + $gross_allowance_amount) - $gross_pay;

					// echo 'Working days : '. $no_of_working_days . '<br>';
					// echo 'Holidays : '. $holidays_count . '<br>';
					// echo 'Leaves : '. $leaves_taken_count . '<br>';
					// echo 'Leave Days : ('. implode(", " , $leave_period)  . ')<br>';
					// echo 'Days Worked : '. $no_of_days_worked . '<br>';
					// echo 'Basic Pay : '. $g_ordinary_wage . '<br>';
					// echo 'Gross Pay : '. $gross_pay . '<br>';
					$g_ordinary_wage -= $unpaid_leave_amount;
					// echo 'Unpaid Leave : '. $unpaid_leave_amount . '<br>';
					// echo '<hr>';

					// 3: all loan/deductions
					$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($user_id);
					$count_loan_deduction = $this->Employees_model->count_employee_deductions($user_id);
					$loan_de_amount = 0;
					if ($count_loan_deduction > 0) {
						foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
							$loan_de_amount += $sl_salary_loan_deduction->loan_deduction_amount;
						}
					} else {
						$loan_de_amount = 0;
					}
					$loan_de_amount = number_format(floatval($loan_de_amount), 2);

					// 5: overtime
					// $salary_overtime = $this->Employees_model->read_salary_overtime($user_id);
					// $count_overtime = $this->Employees_model->count_employee_overtime($user_id);
					// $overtime_amount = 0;
					// if($count_overtime > 0) {
					// 	foreach($salary_overtime as $sl_overtime){
					// 		$overtime_total = $sl_overtime->overtime_hours * $sl_overtime->overtime_rate;
					// 		$overtime_amount += $overtime_total;
					// 	}
					// } else {
					// 	$overtime_amount = 0;
					// }



					// 4: other payment
					$other_payments = $this->Employees_model->set_employee_other_payments($user_id);
					$other_payments_amount = 0;
					if (!is_null($other_payments)) :
						foreach ($other_payments->result() as $sl_other_payments) {
							$other_payments_amount += $sl_other_payments->payments_amount;
						}
					endif;

					// all other payment
					$all_other_payment = $other_payments_amount;

					// 5: commissions
					// $commissions = $this->Employees_model->set_employee_commissions($user_id);
					// if(!is_null($commissions)):
					// 	$commissions_amount = 0;
					// 	foreach($commissions->result() as $sl_commissions) {
					// 		$commissions_amount += $sl_commissions->commission_amount;
					// 	}
					// endif;
					// commissions
					$commissions_amount = 0;
					$commissions = $this->Employees_model->getEmployeeMonthlyCommission($user_id, $p_date);
					if ($commissions) {
						foreach ($commissions as $c) {
							if ($system[0]->is_half_monthly == 1) {
								if ($system[0]->half_deduct_month == 2) {
									$ecommissions_amount = $c->commission_amount / 2;
								} else {
									$ecommissions_amount = $c->commission_amount;
								}
							} else {
								$ecommissions_amount = $c->commission_amount;
							}

							if ($c->commission_type == 9) {
								$g_ordinary_wage += $ecommissions_amount;
							} elseif ($c->commission_type == 10) {
								$g_additional_wage += $ecommissions_amount;
							}

							if ($c->sdl == 1) {
								$g_sdl += $ecommissions_amount;
							}
							if ($c->shg == 1) {
								$g_shg += $ecommissions_amount;
							}

							$commissions_amount += $ecommissions_amount;
						}
					}

					//share options
					$share_options_amount = 0;
					$share_options = $this->Employees_model->getEmployeeShareOptions($user_id, $p_date);
					if ($share_options) {
						$eebr_amount = 0;
						$eris_amount = 0;
						foreach ($share_options as $s) {
							$scheme = $s->so_scheme;
							if ($scheme == 1) {
								$price_doe = $s->price_date_of_excercise;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;
								$amount = ($price_doe - $price_ex) * $no_shares;
								$eebr_amount += $amount;
							} else {
								$price_doe = $s->price_date_of_excercise;
								$price_dog = $s->price_date_of_grant;
								$price_ex = $s->excercise_price;
								$no_shares = $s->no_of_shares;

								$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
								$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
								$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
							}
						}
						$share_options_amount = round($eebr_amount + $eris_amount, 2);
						$g_additional_wage += $share_options_amount;
						$g_sdl += $share_options_amount;
						$g_shg += $share_options_amount;
					}

					// 6: statutory deductions
					$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions($user_id);
					if (!is_null($statutory_deductions)) :
						$statutory_deductions_amount = 0;
						foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
							if ($system[0]->statutory_fixed != 'yes') :
								$sta_salary = $basic_salary;
								$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
								$statutory_deductions_amount += $st_amount;
							else :
								$statutory_deductions_amount += $sl_statutory_deductions->deduction_amount;
							endif;
						}
					endif;

					$overtime_amount = 0;
					$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($user_id, $p_date);
					if ($overtime) {
						$ot_hrs = 0;
						$ot_mins = 0;
						foreach ($overtime as $ot) {
							$total_hours = explode(':', $ot->total_hours);
							$ot_hrs += $total_hours[0];
							$ot_mins += $total_hours[1];
						}
						if ($ot_mins > 0) {
							$ot_hrs += round($ot_mins / 60, 2);
						}

						//overtime rate
						$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($user_id);
						if ($overtime_rate) {
							$rate = $overtime_rate->overtime_pay_rate;
						} else {
							$week_hours = 44;
							// if($empid->office_shift_id) {
							// 	$shift = $this->Employees_model->read_shift_information($empid->office_shift_id);
							// 	if($shift) {
							// 		if($shift[0]->monday_in_time != '' && $shift[0]->monday_out_time != '') {
							// 			$time1 = $shift[0]->monday_in_time;
							// 			$time2 = $shift[0]->monday_out_time;
							// 			$time1 = explode(':',$time1);
							// 			$time2 = explode(':',$time2);
							// 			$hours1 = $time1[0];
							// 			$hours2 = $time2[0];
							// 			$mins1 = $time1[1];
							// 			$mins2 = $time2[1];
							// 			$hours = $hours2 - $hours1;
							// 			$mins = 0;
							// 			if($hours < 0)
							// 			{
							// 				$hours = 24 + $hours;
							// 			}
							// 			if($mins2 >= $mins1) {
							// 				$mins = $mins2 - $mins1;
							// 			}
							// 			else {
							// 				$mins = ($mins2 + 60) - $mins1;
							// 				$hours--;
							// 			}
							// 			if($mins > 0) {
							// 				$hours += round($mins / 60, 2);
							// 			}
							// 			$week_hours += $hours;
							// 		}
							// 		if($shift[0]->tuesday_in_time != '' && $shift[0]->tuesday_out_time != '') {
							// 			$time1 = $shift[0]->tuesday_in_time;
							// 			$time2 = $shift[0]->tuesday_out_time;
							// 			$time1 = explode(':',$time1);
							// 			$time2 = explode(':',$time2);
							// 			$hours1 = $time1[0];
							// 			$hours2 = $time2[0];
							// 			$mins1 = $time1[1];
							// 			$mins2 = $time2[1];
							// 			$hours = $hours2 - $hours1;
							// 			$mins = 0;
							// 			if($hours < 0)
							// 			{
							// 				$hours = 24 + $hours;
							// 			}
							// 			if($mins2 >= $mins1) {
							// 				$mins = $mins2 - $mins1;
							// 			}
							// 			else {
							// 				$mins = ($mins2 + 60) - $mins1;
							// 				$hours--;
							// 			}
							// 			if($mins > 0) {
							// 				$hours += round($mins / 60, 2);
							// 			}
							// 			$week_hours += $hours;
							// 		}
							// 		if($shift[0]->wednesday_in_time != '' && $shift[0]->wednesday_out_time != '') {
							// 			$time1 = $shift[0]->wednesday_in_time;
							// 			$time2 = $shift[0]->wednesday_out_time;
							// 			$time1 = explode(':',$time1);
							// 			$time2 = explode(':',$time2);
							// 			$hours1 = $time1[0];
							// 			$hours2 = $time2[0];
							// 			$mins1 = $time1[1];
							// 			$mins2 = $time2[1];
							// 			$hours = $hours2 - $hours1;
							// 			$mins = 0;
							// 			if($hours < 0)
							// 			{
							// 				$hours = 24 + $hours;
							// 			}
							// 			if($mins2 >= $mins1) {
							// 				$mins = $mins2 - $mins1;
							// 			}
							// 			else {
							// 				$mins = ($mins2 + 60) - $mins1;
							// 				$hours--;
							// 			}
							// 			if($mins > 0) {
							// 				$hours += round($mins / 60, 2);
							// 			}
							// 			$week_hours += $hours;
							// 		}
							// 		if($shift[0]->thursday_in_time != '' && $shift[0]->thursday_out_time != '') {
							// 			$time1 = $shift[0]->thursday_in_time;
							// 			$time2 = $shift[0]->thursday_out_time;
							// 			$time1 = explode(':',$time1);
							// 			$time2 = explode(':',$time2);
							// 			$hours1 = $time1[0];
							// 			$hours2 = $time2[0];
							// 			$mins1 = $time1[1];
							// 			$mins2 = $time2[1];
							// 			$hours = $hours2 - $hours1;
							// 			$mins = 0;
							// 			if($hours < 0)
							// 			{
							// 				$hours = 24 + $hours;
							// 			}
							// 			if($mins2 >= $mins1) {
							// 				$mins = $mins2 - $mins1;
							// 			}
							// 			else {
							// 				$mins = ($mins2 + 60) - $mins1;
							// 				$hours--;
							// 			}
							// 			if($mins > 0) {
							// 				$hours += round($mins / 60, 2);
							// 			}
							// 			$week_hours += $hours;
							// 		}
							// 		if($shift[0]->friday_in_time != '' && $shift[0]->friday_out_time != '') {
							// 			$time1 = $shift[0]->friday_in_time;
							// 			$time2 = $shift[0]->friday_out_time;
							// 			$time1 = explode(':',$time1);
							// 			$time2 = explode(':',$time2);
							// 			$hours1 = $time1[0];
							// 			$hours2 = $time2[0];
							// 			$mins1 = $time1[1];
							// 			$mins2 = $time2[1];
							// 			$hours = $hours2 - $hours1;
							// 			$mins = 0;
							// 			if($hours < 0)
							// 			{
							// 				$hours = 24 + $hours;
							// 			}
							// 			if($mins2 >= $mins1) {
							// 				$mins = $mins2 - $mins1;
							// 			}
							// 			else {
							// 				$mins = ($mins2 + 60) - $mins1;
							// 				$hours--;
							// 			}
							// 			if($mins > 0) {
							// 				$hours += round($mins / 60, 2);
							// 			}
							// 			$week_hours += $hours;
							// 		}
							// 		if($shift[0]->saturday_in_time != '' && $shift[0]->saturday_out_time != '') {
							// 			$time1 = $shift[0]->saturday_in_time;
							// 			$time2 = $shift[0]->saturday_out_time;
							// 			$time1 = explode(':',$time1);
							// 			$time2 = explode(':',$time2);
							// 			$hours1 = $time1[0];
							// 			$hours2 = $time2[0];
							// 			$mins1 = $time1[1];
							// 			$mins2 = $time2[1];
							// 			$hours = $hours2 - $hours1;
							// 			$mins = 0;
							// 			if($hours < 0)
							// 			{
							// 				$hours = 24 + $hours;
							// 			}
							// 			if($mins2 >= $mins1) {
							// 				$mins = $mins2 - $mins1;
							// 			}
							// 			else {
							// 				$mins = ($mins2 + 60) - $mins1;
							// 				$hours--;
							// 			}
							// 			if($mins > 0) {
							// 				$hours += round($mins / 60, 2);
							// 			}
							// 			$week_hours += $hours;
							// 		}
							// 		if($shift[0]->sunday_in_time != '' && $shift[0]->sunday_out_time != '') {
							// 			$time1 = $shift[0]->sunday_in_time;
							// 			$time2 = $shift[0]->sunday_out_time;
							// 			$time1 = explode(':',$time1);
							// 			$time2 = explode(':',$time2);
							// 			$hours1 = $time1[0];
							// 			$hours2 = $time2[0];
							// 			$mins1 = $time1[1];
							// 			$mins2 = $time2[1];
							// 			$hours = $hours2 - $hours1;
							// 			$mins = 0;
							// 			if($hours < 0)
							// 			{
							// 				$hours = 24 + $hours;
							// 			}
							// 			if($mins2 >= $mins1) {
							// 				$mins = $mins2 - $mins1;
							// 			}
							// 			else {
							// 				$mins = ($mins2 + 60) - $mins1;
							// 				$hours--;
							// 			}
							// 			if($mins > 0) {
							// 				$hours += round($mins / 60, 2);
							// 			}
							// 			$week_hours += $hours;
							// 		}
							// 	}	
							// }else {
							// 	$week_hours = 40;
							// }
							$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
							$rate = $rate * 1.5;
						}

						if ($ot_hrs > 0) {
							$overtime_amount = round($ot_hrs * $rate, 2);
						}

						$g_ordinary_wage += $overtime_amount;
						$g_sdl += $overtime_amount;
					}


					// add amount
					$add_salary = $allowance_amount + $basic_salary + $overtime_amount + $other_payments_amount + $commissions_amount + $share_options_amount;
					// add amount
					$net_salary_default = $add_salary - floatval($loan_de_amount) - $statutory_deductions_amount;
					$net_salary = $net_salary_default;
					$net_salary = number_format((float)$net_salary, 2, '.', '');
					$jurl = random_string('alnum', 40);

					//unpaid leave deduction
					$net_salary = $net_salary - $unpaid_leave_amount;

					/**
					 * Author : Syed Anees
					 * Sub Functionality : CPF on Gross Salary
					 */
					$emp_dob = $empid->date_of_birth;
					$dob = new DateTime($emp_dob);
					$today = new DateTime('01-' . $p_date);
					$age = $dob->diff($today);
					$age_year = $age->y;
					$age_month = $age->m;

					$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
					$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
					$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

					if ($age_month > 0) {
						$age_year = $age_year + 1;
					}
					if ($age_year < $age_upto) {
						$age_from = null;
						$age_to = $age_year;
					} elseif ($age_year > $age_upto && $age_year <= $age_above) {
						$age_from = $age_year;
						$age_to = $age_year;
					} elseif ($age_year > $age_above) {
						$age_from = $age_year;
						$age_to = null;
					} else {
						$age_from = null;
						$age_to = null;
					}
					$cpf_employee = 0;
					$im_status = $this->Employees_model->getEmployeeImmigrationStatus($user_id);

					if ($im_status) {
						$immigration_id = $im_status->immigration_id;
						if ($immigration_id == 2) {
							$issue_date = $im_status->issue_date;
							$i_date = new DateTime($issue_date);
							$today = new DateTime();
							$pr_age = $i_date->diff($today);
							$pr_age_year = $pr_age->y;
							$pr_age_month = $pr_age->m;

							// if($pr_age_year == 0 && $pr_age_month > 0) {
							// 	// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
							// 	$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
							// }elseif($pr_age_year == 1 && $pr_age_month > 0) {
							// 	// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
							// 	$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
							// }elseif($pr_age_year >= 2) {
							// 	// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 1);
							// 	$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,1);
							// }

							// if($pr_age_year == 0 && $pr_age_month > 0) {
							if ($pr_age_year == 0 && ($pr_age_month > 0 || $pr_age_month == 0)) {
								// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
								$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
								// }elseif($pr_age_year == 1 && $pr_age_month > 0) {
							} else if ($pr_age_year == 1 && $pr_age_month == 0) {
								// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
								$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
								// }elseif($pr_age_year == 1 && $pr_age_month > 0) {
							} elseif ($pr_age_year == 1 && $pr_age_month > 0) {
								// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
								$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
								// print_r($pr_age_month);exit;
							} elseif ($pr_age_year == 2 && $pr_age_month == 0) {
								// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
								$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
								// print_r($pr_age_month);exit;
							}
							// elseif($pr_age_year >= 2) {
							// 	// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year,2, $age_from, $age_to, 1);
							// 	$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,1);
							// }
							elseif ($pr_age_year >= 2) {
								$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 1, $age_from, $age_to);
							}
						} elseif ($immigration_id == 1) {
							// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 1);
							$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 1, $age_from, $age_to);
						}
						if ($immigration_id == 1 || $immigration_id == 2) {
							if ($cpf_contribution) {
								$total_cpf_contribution = $cpf_contribution->total_cpf;
								$employee_contribution = $cpf_contribution->contribution_employee;
								// $ordinary_wage = $basic_salary - $total_deduction;
								$ordinary_wage = $g_ordinary_wage;
								if ($ordinary_wage > $ordinary_wage_cap) {
									$ow = $ordinary_wage_cap;
								} else {
									$ow = $ordinary_wage;
								}

								//additional wage
								$additional_wage = $g_additional_wage;

								//total contribution
								$cpf_total_ow = round(($total_cpf_contribution * $ow) / 100);
								$cpf_total_aw = round(($total_cpf_contribution * $additional_wage) / 100);

								//employee contribution
								$cpf_employee_ow = floor(($employee_contribution * $ow) / 100);
								$cpf_employee_aw = floor(($employee_contribution * $additional_wage) / 100);

								$total_cpf = $cpf_total_ow + $cpf_total_aw;
								$cpf_employee = $cpf_employee_ow + $cpf_employee_aw;
								$net_salary = $net_salary - $cpf_employee;
								$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							}
						} else {
							$cpf_contribution = false;
						}
					}

					//SHG Contributions
					// $employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($user_id);

					// if($employee_contributions) {
					// 	$fund_deduction_amount = 0;
					// 	$gross_s = $g_shg;

					// 	$contribution_id = $employee_contributions->contribution_id;
					// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					// 	$fund_deduction_amount += $contribution_amount;
					// 	$net_salary = $net_salary - $fund_deduction_amount;
					// }

					//ASHG Contributions
					// $employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($user_id);
					// if($employee_ashg_contributions) {
					// 	$fund_deduction_amount = 0;
					// 	$gross_s = $g_shg;

					// 	$contribution_id = $employee_ashg_contributions->contribution_id;
					// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
					// 	$fund_deduction_amount += $contribution_amount;
					// 	$net_salary = $net_salary - $fund_deduction_amount;
					// }
					$fund_deduction_amount = 0;
					$contribution_data = $this->Employees_model->set_employee_contribution($user_id);

					if (count($contribution_data) > 0) {
						$contribution_fund = array();
						foreach ($contribution_data as $c_data) {
							$contribution_amount = $this->Contribution_fund_model->getContributionRate($basic_salary, $c_data->contribution_id);
							$fund_deduction_amount += $contribution_amount;
						}
						$net_salary = $net_salary - $fund_deduction_amount;
					}
					//SDL
					$sdl_total_amount = 0;
					if ($g_sdl > 1 && $g_sdl <= 800) {
						$sdl_total_amount = 2;
					} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
						$sdl_amount = (0.25 * $g_sdl) / 100;
						$sdl_total_amount = $sdl_amount;
					} elseif ($g_sdl > 4500) {
						$sdl_total_amount = 11.25;
					}
					// $net_salary = $net_salary - $sdl_total_amount;

					$data = array(
						'employee_id' => $user_id,
						'department_id' => $department_id,
						'company_id' => $user[0]->company_id,
						'designation_id' => $designation_id,
						'salary_month' => $this->input->post('month_year'),
						'basic_salary' => $basic_salary,
						'gross_salary' => $add_salary,
						'net_salary' => $net_salary,
						'wages_type' => $empid->wages_type,
						'total_allowances' => $allowance_amount,
						'total_loan' => $loan_de_amount,
						'total_overtime' => $overtime_amount,
						'total_commissions' => $commissions_amount,
						'total_statutory_deductions' => $statutory_deductions_amount,
						'total_other_payments' => $other_payments_amount,
						'cpf_employee_amount' => $cpf_employee,
						'is_payment' => '1',
						'payslip_type' => 'full_monthly',
						'payslip_key' => $jurl,
						'year_to_date' => date('d-m-Y'),
						'created_at' => date('d-m-Y h:i:s')
					);
					$result = $this->Payroll_model->add_salary_payslip($data);

					if ($result) {
						// $ivdata = array(
						// 	'amount' => $net_salary,
						// 	'account_id' => $online_payment_account,
						// 	'transaction_type' => 'expense',
						// 	'dr_cr' => 'cr',
						// 	'transaction_date' => date('Y-m-d'),
						// 	'payer_payee_id' => $user_id,
						// 	'payment_method_id' => 3,
						// 	'description' => 'Payroll Payments',
						// 	'reference' => 'Payroll Payments',
						// 	'invoice_id' => $result,
						// 	'client_id' => $user_id,
						// 	'created_at' => date('Y-m-d H:i:s')
						// );
						// $this->Finance_model->add_transactions($ivdata);
						// // update data in bank account
						// $account_id = $this->Finance_model->read_bankcash_information($online_payment_account);
						// $acc_balance = $account_id[0]->account_balance - $net_salary;

						// $data3 = array(
						// 	'account_balance' => $acc_balance
						// );
						// $this->Finance_model->update_bankcash_record($data3,$online_payment_account);

						$g_ordinary_wage = 0;
						$g_additional_wage = 0;
						$g_shg = 0;
						$g_sdl = 0;

						$g_ordinary_wage += $basic_salary;
						$g_shg += $basic_salary;
						$g_sdl += $basic_salary;

						// set allowance
						$allowance_amount = 0;
						$gross_allowance_amount = 0;
						$salary_allowances = $this->Employees_model->getEmployeeMonthlyAllowance($user_id, $this->input->post('month_year'));
						if ($salary_allowances) {
							foreach ($salary_allowances as $sl_allowances) {
								$esl_allowances = $sl_allowances->allowance_amount;
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$eallowance_amount = $esl_allowances / 2;
									} else {
										$eallowance_amount = $esl_allowances;
									}
								} else {
									$eallowance_amount = $esl_allowances;
								}
								$allowance_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'allowance_title' => $sl_allowances->allowance_title,
									'allowance_amount' => $eallowance_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$_allowance_data = $this->Payroll_model->add_salary_payslip_allowances($allowance_data);


								if (!empty($sl_allowances->salary_month)) {
									$g_additional_wage += $eallowance_amount;
								} else {
									$g_ordinary_wage += $eallowance_amount;
									if ($sl_allowances->id == 2) {
										$gross_allowance_amount = $eallowance_amount;
									}
								}

								if ($sl_allowances->sdl == 1) {
									$g_sdl += $eallowance_amount;
								}
								if ($sl_allowances->shg == 1) {
									$g_shg += $eallowance_amount;
								}

								$allowance_amount += $eallowance_amount;

								$allowance_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'allowance_amount' => $eallowance_amount,
									'allowance_name' => $sl_allowances->allowance_title,
									'deduction_name' => '',
									'deduction_amount' => ''

								);
								$this->Payroll_model->add_mapping($allowance_data);
							}
						}

						//3: Gross rate of pay (unpaid leave deduction)
						$holidays_count = 0;
						$no_of_working_days = 0;
						$month_start_date = new DateTime('01-' . $this->input->post('month_year'));
						$month_end_date = new DateTime($month_start_date->format('Y-m-t'));
						$month_end_date->modify('+1 day');
						$interval = new DateInterval('P1D');
						$period = new DatePeriod($month_start_date, $interval, $month_end_date);
						foreach ($period as $p) {
							$period_day = $p->format('l');
							$period_date = $p->format('Y-m-d');

							//holidays in a month
							$is_holiday = $this->Timesheet_model->is_holiday_on_date($user[0]->company_id, $period_date);
							if ($is_holiday) {
								$holidays_count += 1;
							}

							//working days excluding holidays based on office shift
							if ($period_day == 'Monday') {
								if ($office_shift[0]->monday_in_time != '') {
									$no_of_working_days += 1;
								}
							} else if ($period_day == 'Tuesday') {
								if ($office_shift[0]->tuesday_in_time != '') {
									$no_of_working_days += 1;
								}
							} else if ($period_day == 'Wednesday') {
								if ($office_shift[0]->wednesday_in_time != '') {
									$no_of_working_days += 1;
								}
							} else if ($period_day == 'Thursday') {
								if ($office_shift[0]->thursday_in_time != '') {
									$no_of_working_days += 1;
								}
							} else if ($period_day == 'Friday') {
								if ($office_shift[0]->friday_in_time != '') {
									$no_of_working_days += 1;
								}
							} else if ($period_day == 'Saturday') {
								if ($office_shift[0]->saturday_in_time != '') {
									$no_of_working_days += 1;
								}
							} else if ($period_day == 'Sunday') {
								if ($office_shift[0]->sunday_in_time != '') {
									$no_of_working_days += 1;
								}
							}
						}

						//unpaid leave
						$unpaid_leave_amount = 0;
						$leaves_taken_count = 0;
						$leave_period = array();
						$unpaid_leaves = $this->Employees_model->getEmployeeMonthUnpaidLeaves($user_id, $this->input->post('month_year'));
						if ($unpaid_leaves) {
							foreach ($unpaid_leaves as $k => $l) {
								$pay_date_month = new DateTime('01-' . $this->input->post('month_year'));
								$l_from_date = new DateTime($l->from_date);
								$l_to_date = new DateTime($l->to_date);

								if ($l_from_date->format('m') == $l_to_date->format('m')) {
									$start_date = $l_from_date;
									$end_date = $l_to_date;
								} elseif ($l_from_date->format('m') == $pay_date_month->format('m')) {
									$start_date = $l_from_date;
									$end_date = new DateTime($start_date->format('Y-m-t'));
								} elseif ($l_to_date->format('m') == $pay_date_month->format('m')) {
									$start_date = $pay_date_month;
									$end_date = $l_to_date;
								}
								$end_date->modify('+1 day');
								$interval = new DateInterval('P1D');
								$period = new DatePeriod($start_date, $interval, $end_date);
								foreach ($period as $d) {
									$p_day = $d->format('l');
									if ($p_day == 'Monday') {
										if ($office_shift[0]->monday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Tuesday') {
										if ($office_shift[0]->tuesday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Wednesday') {
										if ($office_shift[0]->wednesday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Thursday') {
										if ($office_shift[0]->thursday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Friday') {
										if ($office_shift[0]->friday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Saturday') {
										if ($office_shift[0]->saturday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									} else if ($p_day == 'Sunday') {
										if ($office_shift[0]->sunday_in_time != '') {
											$leave_period[$k]['leave_date'][] = $d->format('Y-m-d');
											if ($l->is_half_day == 0) {
												$leaves_taken_count += 1;
											} else {
												$leaves_taken_count += 0.5;
											}
										}
									}
								}
								$leave_period[$k]['is_half'] = $l->is_half_day;
								// if(count($leave_period) > 0) {
								// 	if($l->is_half_day == 0) {
								// 		$leaves_taken_count += count($leave_period);
								// 	}else {
								// 		$leaves_taken_count += count($leave_period)  / 2;
								// 	}
								// }
							}
						}

						$no_of_days_worked = ($no_of_working_days - ($leaves_taken_count + $holidays_count)) + $holidays_count;

						$gross_pay = round((($basic_salary + $gross_allowance_amount) / $no_of_working_days) * $no_of_days_worked, 2);
						$unpaid_leave_amount = ($basic_salary + $gross_allowance_amount) - $gross_pay;

						// echo 'Working days : '. $no_of_working_days . '<br>';
						// echo 'Holidays : '. $holidays_count . '<br>';
						// echo 'Leaves : '. $leaves_taken_count . '<br>';
						// echo 'Leave Days : ('. implode(", " , $leave_period)  . ')<br>';
						// echo 'Days Worked : '. $no_of_days_worked . '<br>';
						// echo 'Basic Pay : '. $g_ordinary_wage . '<br>';
						// echo 'Gross Pay : '. $gross_pay . '<br>';
						$g_ordinary_wage -= $unpaid_leave_amount;
						// echo 'Unpaid Leave : '. $unpaid_leave_amount . '<br>';
						// echo '<hr>';
						if ($unpaid_leave_amount > 0 && $leaves_taken_count > 0) {
							foreach ($leave_period as $l) {
								$is_half = $l['is_half'];
								$leave_dates = $l['leave_date'];
								$leave_day_pay = round(($basic_salary + $gross_allowance_amount) / $no_of_working_days, 2);
								if ($is_half) {
									$leave_day_pay = $leave_day_pay / 2;
								}
								foreach ($leave_dates as $ld) {
									$unpaid_leave_data = array(
										'payslip_id' => $result,
										'employee_id' => $user_id,
										'salary_month' => $this->input->post('month_year'),
										'leave_date' => $ld,
										'leave_amount' => $leave_day_pay,
										'is_half' => $is_half,
										'total_leave_amount' => $unpaid_leave_amount
									);
									$this->Payroll_model->add_salary_payslip_leave_deduction($unpaid_leave_data);
								}
							}
						}
						// commissions
						$commission_amount = 0;
						$commissions = $this->Employees_model->getEmployeeMonthlyCommission($user_id, $this->input->post('month_year'));
						if ($commissions) {
							foreach ($commissions as $c) {
								if ($system[0]->is_half_monthly == 1) {
									if ($system[0]->half_deduct_month == 2) {
										$ecommission_amount = $c->commission_amount / 2;
									} else {
										$ecommission_amount = $c->commission_amount;
									}
								} else {
									$ecommission_amount = $c->commission_amount;
								}

								if ($c->commission_type == 9) {
									$g_ordinary_wage += $ecommission_amount;
								} elseif ($c->commission_type == 10) {
									$g_additional_wage += $ecommission_amount;
								}

								if ($c->sdl == 1) {
									$g_sdl += $ecommission_amount;
								}
								if ($c->shg == 1) {
									$g_shg += $ecommission_amount;
								}

								$commissions_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'commission_id' => $c->commission_type,
									'commission_amount' => $ecommission_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$this->Payroll_model->add_salary_payslip_commissions($commissions_data);

								$commission_amount += $ecommission_amount;
							}
						}

						//share options
						$share_options_amount = 0;
						$share_options = $this->Employees_model->getEmployeeShareOptions($user_id, $this->input->post('month_year'));
						if ($share_options) {
							$eebr_amount = 0;
							$eris_amount = 0;
							foreach ($share_options as $s) {
								$scheme = $s->so_scheme;
								if ($scheme == 1) {
									$price_doe = $s->price_date_of_excercise;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;
									$amount = ($price_doe - $price_ex) * $no_shares;
									$eebr_amount += $amount;
								} else {
									$price_doe = $s->price_date_of_excercise;
									$price_dog = $s->price_date_of_grant;
									$price_ex = $s->excercise_price;
									$no_shares = $s->no_of_shares;

									$tax_exempt_amount = ($price_doe - $price_dog) * $no_shares;
									$tax_no_exempt_amount = ($price_dog - $price_ex) * $no_shares;
									$eris_amount += $tax_exempt_amount + $tax_no_exempt_amount;
								}
							}
							$share_options_amount = round($eebr_amount + $eris_amount, 2);
							$g_additional_wage += $share_options_amount;
							$g_sdl += $share_options_amount;
							$g_shg += $share_options_amount;

							$share_options_data = array(
								'payslip_id' => $result,
								'employee_id' => $user_id,
								'salary_month' => $this->input->post('month_year'),
								'amount' => round($share_options_amount, 2)
							);
							$this->Payroll_model->add_salary_payslip_share_options($share_options_data);
						}


						// set other payments
						$salary_other_payments = $this->Employees_model->read_salary_other_payments($user_id);
						$count_other_payment = $this->Employees_model->count_employee_other_payments($user_id);
						$other_payment_amount = 0;
						if ($count_other_payment > 0) {
							foreach ($salary_other_payments as $sl_other_payments) {
								$other_payments_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'payments_title' => $sl_other_payments->payments_title,
									'payments_amount' => $sl_other_payments->payments_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$this->Payroll_model->add_salary_payslip_other_payments($other_payments_data);
							}
						}

						// set statutory_deductions
						$salary_statutory_deductions = $this->Employees_model->read_salary_statutory_deductions($user_id);
						$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions($user_id);
						$statutory_deductions_amount = 0;
						if ($count_statutory_deductions > 0) {
							foreach ($salary_statutory_deductions as $sl_statutory_deduction) {
								$statutory_deduction_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'deduction_title' => $sl_statutory_deduction->deduction_title,
									'deduction_amount' => $sl_statutory_deduction->deduction_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$this->Payroll_model->add_salary_payslip_statutory_deductions($statutory_deduction_data);

								$allowance_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'allowance_amount' => '',
									'allowance_name' => '',
									'deduction_name' => $sl_statutory_deduction->deduction_title,
									'deduction_amount' => $sl_statutory_deduction->deduction_amount,

								);
								$this->Payroll_model->add_mapping($allowance_data);
							}
						}

						$salary_loan_deduction = $this->Employees_model->read_salary_loan_deductions($user_id);
						$count_loan_deduction = $this->Employees_model->count_employee_deductions($user_id);
						$loan_de_amount = 0;
						if ($count_loan_deduction > 0) {
							foreach ($salary_loan_deduction as $sl_salary_loan_deduction) {
								$loan_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'salary_month' => $this->input->post('month_year'),
									'loan_title' => $sl_salary_loan_deduction->loan_deduction_title,
									'loan_amount' => $sl_salary_loan_deduction->loan_deduction_amount,
									'created_at' => date('d-m-Y h:i:s')
								);
								$_loan_data = $this->Payroll_model->add_salary_payslip_loan($loan_data);
								$allowance_data = array(
									'payslip_id' => $result,
									'employee_id' => $user_id,
									'allowance_amount' => '',
									'allowance_name' => '',
									'deduction_name' => $sl_salary_loan_deduction->loan_deduction_title,
									'deduction_amount' => $sl_salary_loan_deduction->loan_deduction_amount,

								);
								$this->Payroll_model->add_mapping($allowance_data);
							}
						}

						// $salary_overtime = $this->Employees_model->read_salary_overtime($user_id);
						// $count_overtime = $this->Employees_model->count_employee_overtime($user_id);
						// $overtime_amount = 0;
						// if($count_overtime > 0) {
						// 	foreach($salary_overtime as $sl_overtime){
						// 		//$overtime_total = $sl_overtime->overtime_hours * $sl_overtime->overtime_rate;
						// 		$overtime_data = array(
						// 		'payslip_id' => $result,
						// 		'employee_id' => $user_id,
						// 		'overtime_salary_month' => $this->input->post('month_year'),
						// 		'overtime_title' => $sl_overtime->overtime_type,
						// 		'overtime_no_of_days' => $sl_overtime->no_of_days,
						// 		'overtime_hours' => $sl_overtime->overtime_hours,
						// 		'overtime_rate' => $sl_overtime->overtime_rate,
						// 		'created_at' => date('d-m-Y h:i:s')
						// 		);
						// 		$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
						// 	}
						// }

						$overtime_amount = 0;
						$overtime = $this->Overtime_request_model->getEmployeeMonthOvertime($user_id, $this->input->post('month_year'));
						if ($overtime) {
							$ot_days = 0;
							$ot_hrs = 0;
							$ot_mins = 0;
							foreach ($overtime as $ot) {
								$total_hours = explode(':', $ot->total_hours);
								$ot_hrs += $total_hours[0];
								$ot_mins += $total_hours[1];
								$ot_days += 1;
							}
							if ($ot_mins > 0) {
								$ot_hrs += round($ot_mins / 60, 2);
							}

							//overtime rate
							$overtime_rate = $this->Employees_model->getEmployeeOvertimeRate($user_id);
							if ($overtime_rate) {
								$rate = $overtime_rate->overtime_pay_rate;
							} else {
								$week_hours = 44;
								// if($empid->office_shift_id) {
								// 	$shift = $this->Employees_model->read_shift_information($empid->office_shift_id);
								// 	if($shift) {
								// 		if($shift[0]->monday_in_time != '' && $shift[0]->monday_out_time != '') {
								// 			$time1 = $shift[0]->monday_in_time;
								// 			$time2 = $shift[0]->monday_out_time;
								// 			$time1 = explode(':',$time1);
								// 			$time2 = explode(':',$time2);
								// 			$hours1 = $time1[0];
								// 			$hours2 = $time2[0];
								// 			$mins1 = $time1[1];
								// 			$mins2 = $time2[1];
								// 			$hours = $hours2 - $hours1;
								// 			$mins = 0;
								// 			if($hours < 0)
								// 			{
								// 				$hours = 24 + $hours;
								// 			}
								// 			if($mins2 >= $mins1) {
								// 				$mins = $mins2 - $mins1;
								// 			}
								// 			else {
								// 				$mins = ($mins2 + 60) - $mins1;
								// 				$hours--;
								// 			}
								// 			if($mins > 0) {
								// 				$hours += round($mins / 60, 2);
								// 			}
								// 			$week_hours += $hours;
								// 		}
								// 		if($shift[0]->tuesday_in_time != '' && $shift[0]->tuesday_out_time != '') {
								// 			$time1 = $shift[0]->tuesday_in_time;
								// 			$time2 = $shift[0]->tuesday_out_time;
								// 			$time1 = explode(':',$time1);
								// 			$time2 = explode(':',$time2);
								// 			$hours1 = $time1[0];
								// 			$hours2 = $time2[0];
								// 			$mins1 = $time1[1];
								// 			$mins2 = $time2[1];
								// 			$hours = $hours2 - $hours1;
								// 			$mins = 0;
								// 			if($hours < 0)
								// 			{
								// 				$hours = 24 + $hours;
								// 			}
								// 			if($mins2 >= $mins1) {
								// 				$mins = $mins2 - $mins1;
								// 			}
								// 			else {
								// 				$mins = ($mins2 + 60) - $mins1;
								// 				$hours--;
								// 			}
								// 			if($mins > 0) {
								// 				$hours += round($mins / 60, 2);
								// 			}
								// 			$week_hours += $hours;
								// 		}
								// 		if($shift[0]->wednesday_in_time != '' && $shift[0]->wednesday_out_time != '') {
								// 			$time1 = $shift[0]->wednesday_in_time;
								// 			$time2 = $shift[0]->wednesday_out_time;
								// 			$time1 = explode(':',$time1);
								// 			$time2 = explode(':',$time2);
								// 			$hours1 = $time1[0];
								// 			$hours2 = $time2[0];
								// 			$mins1 = $time1[1];
								// 			$mins2 = $time2[1];
								// 			$hours = $hours2 - $hours1;
								// 			$mins = 0;
								// 			if($hours < 0)
								// 			{
								// 				$hours = 24 + $hours;
								// 			}
								// 			if($mins2 >= $mins1) {
								// 				$mins = $mins2 - $mins1;
								// 			}
								// 			else {
								// 				$mins = ($mins2 + 60) - $mins1;
								// 				$hours--;
								// 			}
								// 			if($mins > 0) {
								// 				$hours += round($mins / 60, 2);
								// 			}
								// 			$week_hours += $hours;
								// 		}
								// 		if($shift[0]->thursday_in_time != '' && $shift[0]->thursday_out_time != '') {
								// 			$time1 = $shift[0]->thursday_in_time;
								// 			$time2 = $shift[0]->thursday_out_time;
								// 			$time1 = explode(':',$time1);
								// 			$time2 = explode(':',$time2);
								// 			$hours1 = $time1[0];
								// 			$hours2 = $time2[0];
								// 			$mins1 = $time1[1];
								// 			$mins2 = $time2[1];
								// 			$hours = $hours2 - $hours1;
								// 			$mins = 0;
								// 			if($hours < 0)
								// 			{
								// 				$hours = 24 + $hours;
								// 			}
								// 			if($mins2 >= $mins1) {
								// 				$mins = $mins2 - $mins1;
								// 			}
								// 			else {
								// 				$mins = ($mins2 + 60) - $mins1;
								// 				$hours--;
								// 			}
								// 			if($mins > 0) {
								// 				$hours += round($mins / 60, 2);
								// 			}
								// 			$week_hours += $hours;
								// 		}
								// 		if($shift[0]->friday_in_time != '' && $shift[0]->friday_out_time != '') {
								// 			$time1 = $shift[0]->friday_in_time;
								// 			$time2 = $shift[0]->friday_out_time;
								// 			$time1 = explode(':',$time1);
								// 			$time2 = explode(':',$time2);
								// 			$hours1 = $time1[0];
								// 			$hours2 = $time2[0];
								// 			$mins1 = $time1[1];
								// 			$mins2 = $time2[1];
								// 			$hours = $hours2 - $hours1;
								// 			$mins = 0;
								// 			if($hours < 0)
								// 			{
								// 				$hours = 24 + $hours;
								// 			}
								// 			if($mins2 >= $mins1) {
								// 				$mins = $mins2 - $mins1;
								// 			}
								// 			else {
								// 				$mins = ($mins2 + 60) - $mins1;
								// 				$hours--;
								// 			}
								// 			if($mins > 0) {
								// 				$hours += round($mins / 60, 2);
								// 			}
								// 			$week_hours += $hours;
								// 		}
								// 		if($shift[0]->saturday_in_time != '' && $shift[0]->saturday_out_time != '') {
								// 			$time1 = $shift[0]->saturday_in_time;
								// 			$time2 = $shift[0]->saturday_out_time;
								// 			$time1 = explode(':',$time1);
								// 			$time2 = explode(':',$time2);
								// 			$hours1 = $time1[0];
								// 			$hours2 = $time2[0];
								// 			$mins1 = $time1[1];
								// 			$mins2 = $time2[1];
								// 			$hours = $hours2 - $hours1;
								// 			$mins = 0;
								// 			if($hours < 0)
								// 			{
								// 				$hours = 24 + $hours;
								// 			}
								// 			if($mins2 >= $mins1) {
								// 				$mins = $mins2 - $mins1;
								// 			}
								// 			else {
								// 				$mins = ($mins2 + 60) - $mins1;
								// 				$hours--;
								// 			}
								// 			if($mins > 0) {
								// 				$hours += round($mins / 60, 2);
								// 			}
								// 			$week_hours += $hours;
								// 		}
								// 		if($shift[0]->sunday_in_time != '' && $shift[0]->sunday_out_time != '') {
								// 			$time1 = $shift[0]->sunday_in_time;
								// 			$time2 = $shift[0]->sunday_out_time;
								// 			$time1 = explode(':',$time1);
								// 			$time2 = explode(':',$time2);
								// 			$hours1 = $time1[0];
								// 			$hours2 = $time2[0];
								// 			$mins1 = $time1[1];
								// 			$mins2 = $time2[1];
								// 			$hours = $hours2 - $hours1;
								// 			$mins = 0;
								// 			if($hours < 0)
								// 			{
								// 				$hours = 24 + $hours;
								// 			}
								// 			if($mins2 >= $mins1) {
								// 				$mins = $mins2 - $mins1;
								// 			}
								// 			else {
								// 				$mins = ($mins2 + 60) - $mins1;
								// 				$hours--;
								// 			}
								// 			if($mins > 0) {
								// 				$hours += round($mins / 60, 2);
								// 			}
								// 			$week_hours += $hours;
								// 		}
								// 	}	
								// }else {
								// 	$week_hours = 40;
								// }
								$rate = round((12 * $basic_salary) / (52 * $week_hours), 2);
								$rate = $rate * 1.5;
							}

							if ($ot_hrs > 0) {
								$overtime_amount = round($ot_hrs * $rate, 2);
							}
							$g_ordinary_wage += $overtime_amount;
							$g_sdl += $overtime_amount;

							$overtime_data = array(
								'payslip_id' => $result,
								'employee_id' => $user_id,
								'overtime_salary_month' => $this->input->post('month_year'),
								'overtime_no_of_days' => $ot_days,
								'overtime_hours' => $ot_hrs,
								'overtime_rate' => $rate,
								'total_overtime' => $overtime_amount,
								'created_at' => date('d-m-Y h:i:s')
							);
							$_overtime_data = $this->Payroll_model->add_salary_payslip_overtime($overtime_data);
						}

						//Other Fund Contributions
						$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($user_id);
						if ($employee_contributions) {
							$fund_deduction_amount = 0;
							$gross_s = $g_shg;
							$contribution_id = $employee_contributions->contribution_id;
							$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

							$fund_deduction_amount += $contribution_amount;
							$cdata = array(
								'payslip_id' => $result,
								'contribution_id' => $contribution_id,
								'contribution_amount' => $contribution_amount
							);
							$this->Contribution_fund_model->setContributionPayslip($cdata);
						}

						//ASHG Fund Contributions
						$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($user_id);
						if ($employee_ashg_contributions) {
							$fund_deduction_amount = 0;
							$gross_s = $g_shg;
							$contribution_id = $employee_ashg_contributions->contribution_id;
							$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);

							$fund_deduction_amount += $contribution_amount;
							$cdata = array(
								'payslip_id' => $result,
								'contribution_id' => $contribution_id,
								'contribution_amount' => $contribution_amount
							);
							$this->Contribution_fund_model->setContributionPayslip($cdata);
						}

						//sdl
						$sdl = 0;
						if ($g_sdl > 1 && $g_sdl <= 800) {
							$sdl = 2;
						} elseif ($g_sdl > 800 && $g_sdl <= 4500) {
							$sdl_amount = (0.25 * $g_sdl) / 100;
							$sdl = $sdl_amount;
						} elseif ($g_sdl > 4500) {
							$sdl = 11.25;
						}

						$cdata = array(
							'payslip_id' => $result,
							'contribution_id' => 5,
							'contribution_amount' => $sdl
						);
						$this->Contribution_fund_model->setContributionPayslip($cdata);

						$cpf_total = 0;
						if ($cpf_contribution) {
							$employee_contribution = $cpf_contribution->contribution_employee;
							$employer_contribution = $cpf_contribution->contribution_employer;
							$total_cpf_contribution = $cpf_contribution->total_cpf;

							// $ordinary_wage = ($allowance_amount + $basic_salary + $overtime_amount + $all_other_payment + $commissions_amount ) - ($loan_de_amount + $statutory_deductions_amount);
							$ordinary_wage = $g_ordinary_wage;
							if ($ordinary_wage > $ordinary_wage_cap) {
								$ow = $ordinary_wage_cap;
							} else {
								$ow = $ordinary_wage;
							}

							$cpf_total_ow = round(($total_cpf_contribution * $ow) / 100);
							$ow_cpf_employee = floor(($employee_contribution * $ow) / 100);
							$ow_cpf_employer = $cpf_total_ow - $ow_cpf_employee;


							$aw = $g_additional_wage;
							$cpf_total_aw = round(($total_cpf_contribution * $aw) / 100);
							$aw_cpf_employee = floor(($employee_contribution * $aw) / 100);
							$aw_cpf_employer = $cpf_total_aw - $aw_cpf_employee;


							$cpf_employee = $ow_cpf_employee + $aw_cpf_employee;
							$cpf_employer = $ow_cpf_employer + $aw_cpf_employer;

							$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
							$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
							$net_salary = $net_salary - $cpf_employee;
							$cpf_total = $cpf_employee + $cpf_employer;
						}

						//cpf

						if ($cpf_total > 0) {

							$ow_paid = $g_ordinary_wage;
							$aw_paid = $g_additional_wage;

							$cpf_data = [
								'payslip_id' => $result,
								'month_year' => '01-' . $this->input->post('month_year'),
								'ow_paid'	=> $ow_paid,
								'ow_cpf'	=> $ow,
								'ow_cpf_employer'	=> $ow_cpf_employer,
								'ow_cpf_employee'	=> $ow_cpf_employee,
								'aw_paid'	=> $aw_paid,
								'aw_cpf'	=> $aw_paid,
								'aw_cpf_employer'	=> $aw_cpf_employer,
								'aw_cpf_employee'	=> $aw_cpf_employee
							];

							$cpf_payslip = $this->Cpf_payslip_model->add_cpf_payslip($cpf_data);
						}

						$Return['result'] = $this->lang->line('xin_success_payment_paid');
					} else {
						$Return['error'] = $this->lang->line('xin_error_msg');
					}
				} // if basic salary

			}
			$Return['result'] = $this->lang->line('xin_success_payment_paid');
			$this->output($Return);
			exit;
		} // f
	}

	// hourly_list > templates
	public function payment_history_list()
	{

		$data['title'] = $this->Xin_model->site_title();
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			$this->load->view("admin/payroll/payment_history", $data);
		} else {
			redirect('admin/');
		}
		// Datatables Variables
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));

		$role_resources_ids = $this->Xin_model->user_role_resource();
		$user_info = $this->Xin_model->read_user_info($session['user_id']);
		if ($this->input->get("ihr") == 'true') {
			if ($this->input->get("company_id") == 0 && $this->input->get("location_id") == 0 && $this->input->get("department_id") == 0) {
				if ($this->input->get("salary_month") == '') {
					$history = $this->Payroll_model->all_employees_payment_history();
				} else {
					$history = $this->Payroll_model->all_employees_payment_history_month($this->input->get("salary_month"));
				}
			} else if ($this->input->get("company_id") != 0 && $this->input->get("location_id") == 0 && $this->input->get("department_id") == 0) {
				if ($this->input->get("salary_month") == '') {
					$history = $this->Payroll_model->get_company_payslip_history($this->input->get("company_id"));
				} else {
					$history = $this->Payroll_model->get_company_payslip_history_month($this->input->get("company_id"), $this->input->get("salary_month"));
				}
			} else if ($this->input->get("company_id") != 0 && $this->input->get("location_id") != 0 && $this->input->get("department_id") == 0) {
				if ($this->input->get("salary_month") == '') {
					$history = $this->Payroll_model->get_company_location_payslips($this->input->get("company_id"), $this->input->get("location_id"));
				} else {
					$history = $this->Payroll_model->get_company_location_payslips_month($this->input->get("company_id"), $this->input->get("location_id"), $this->input->get("salary_month"));
				}
			} else if ($this->input->get("company_id") != 0 && $this->input->get("location_id") != 0 && $this->input->get("department_id") != 0) {
				if ($this->input->get("salary_month") == '') {
					$history = $this->Payroll_model->get_company_location_department_payslips($this->input->get("company_id"), $this->input->get("location_id"), $this->input->get("department_id"));
				} else {
					$history = $this->Payroll_model->get_company_location_department_payslips_month($this->input->get("company_id"), $this->input->get("location_id"), $this->input->get("department_id"), $this->input->get("salary_month"));
				}
			}/**/ /*else if($this->input->get("company_id")!=0 && $this->input->get("location_id")!=0 && $this->input->get("department_id")!=0 && $this->input->get("designation_id")!=0){
				$history = $this->Payroll_model->get_company_location_department_designation_payslips($this->input->get("company_id"),$this->input->get("location_id"),$this->input->get("department_id"),$this->input->get("designation_id"));
			}*/
		} else {
			if ($user_info[0]->user_role_id == 1) {
				$history = $this->Payroll_model->employees_payment_history();
			} else {
				if (in_array('391', $role_resources_ids)) {
					$history = $this->Payroll_model->get_company_payslips($user_info[0]->company_id);
				} else {
					$history = $this->Payroll_model->get_payroll_slip($session['user_id']);
				}
			}
		}
		$data = array();

		foreach ($history->result() as $r) {

			// get addd by > template
			$user = $this->Xin_model->read_user_info($r->employee_id);
			// user full name
			if (!is_null($user)) {
				$full_name = $user[0]->first_name . ' ' . $user[0]->last_name;
				$emp_link = $user[0]->employee_id;
				$month_payment = date("F, Y", strtotime('01-' . $r->salary_month));

				$p_amount = $this->Xin_model->currency_sign($r->net_salary, $r->user_id);

				// get date > created at > and format
				$created_at = $this->Xin_model->set_date_format($r->created_at);
				// get designation
				$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
				if (!is_null($designation)) {
					$designation_name = $designation[0]->designation_name;
				} else {
					$designation_name = '--';
				}
				// department
				$department = $this->Department_model->read_department_information($user[0]->department_id);
				if (!is_null($department)) {
					$department_name = $department[0]->department_name;
				} else {
					$department_name = '--';
				}
				$department_designation = $designation_name . ' (' . $department_name . ')';
				// get company
				$company = $this->Xin_model->read_company_info($user[0]->company_id);
				if (!is_null($company)) {
					$comp_name = $company[0]->name;
				} else {
					$comp_name = '--';
				}
				// bank account
				$bank_account = $this->Employees_model->get_employee_bank_account_last($user[0]->user_id);
				if (!is_null($bank_account)) {
					$account_number = $bank_account[0]->account_number;
				} else {
					$account_number = '--';
				}
				$payslip = '<span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_view') . '"><a href="' . site_url() . 'admin/payroll/payslip/id/' . $r->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-arrow-circle-right"></span></button></a></span><span data-toggle="tooltip" data-placement="top" title="' . $this->lang->line('xin_download') . '"><a href="' . site_url() . 'admin/payroll/pdf_create/p/' . $r->payslip_key . '"><button type="button" class="btn icon-btn btn-xs btn-default waves-effect waves-light"><span class="fa fa-download"></span></button></a></span>';

				$ifull_name = nl2br($full_name . "\r\n <small class='text-muted'><i>" . $this->lang->line('xin_employees_id') . ': ' . $emp_link . "<i></i></i></small>\r\n <small class='text-muted'><i>" . $department_designation . '<i></i></i></small>');
				$data[] = array(
					$payslip,
					$full_name,
					$comp_name,
					$account_number,
					$p_amount,
					$month_payment,
					$created_at,
				);
			}
		} // if employee available

		$output = array(
			"draw" => $draw,
			"recordsTotal" => $history->num_rows(),
			"recordsFiltered" => $history->num_rows(),
			"data" => $data
		);
		echo json_encode($output);
		exit();
	}

	



	public function pdf_create()
	{
		$system = $this->Xin_model->read_setting_info(1);
		// 	// create new PDF document
		$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

		$key = $this->uri->segment(5);
		$payment = $this->Payroll_model->read_salary_payslip_info_key($key);

		if (is_null($payment)) {
			redirect('admin/payroll/generate_payslip');
		}
		$user = $this->Xin_model->read_user_info($payment[0]->employee_id);

		// if password generate option enable
		if ($system[0]->is_payslip_password_generate == 1) {
			/**
			 * Protect PDF from being printed, copied or modified. In order to being viewed, the user needs
			 * to provide password as selected format in settings module.
			 */
			if ($system[0]->payslip_password_format == 'dateofbirth') {
				$password_val = date("dmY", strtotime($user[0]->date_of_birth));
			} else if ($system[0]->payslip_password_format == 'contact_no') {
				$password_val = $user[0]->contact_no;
			} else if ($system[0]->payslip_password_format == 'full_name') {
				$password_val = $user[0]->first_name . $user[0]->last_name;
			} else if ($system[0]->payslip_password_format == 'email') {
				$password_val = $user[0]->email;
			} else if ($system[0]->payslip_password_format == 'password') {
				$password_val = $user[0]->password;
			} else if ($system[0]->payslip_password_format == 'user_password') {
				$password_val = $user[0]->username . $user[0]->password;
			} else if ($system[0]->payslip_password_format == 'employee_id') {
				$password_val = $user[0]->employee_id;
			} else if ($system[0]->payslip_password_format == 'employee_id_password') {
				$password_val = $user[0]->employee_id . $user[0]->password;
			} else if ($system[0]->payslip_password_format == 'dateofbirth_name') {
				$dob = date("dmY", strtotime($user[0]->date_of_birth));
				$fname = $user[0]->first_name;
				$lname = $user[0]->last_name;
				$password_val = $dob . $fname[0] . $lname[0];
			}
			$pdf->SetProtection(array('print', 'copy', 'modify'), $password_val, $password_val, 0, null);
		}


		$_des_name = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($_des_name)) {
			$_designation_name = $_des_name[0]->designation_name;
		} else {
			$_designation_name = '';
		}
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$_department_name = $department[0]->department_name;
		} else {
			$_department_name = '';
		}
		//$location = $this->Xin_model->read_location_info($department[0]->location_id);
		// company info
		$company = $this->Xin_model->read_company_info($user[0]->company_id);

		$p_method = '';
		if (!is_null($company)) {
			$company_name = $company[0]->name;
			$company_logo = $company[0]->logo;
			$address_1 = $company[0]->address_1;
			$address_2 = $company[0]->address_2;
			$city = $company[0]->city;
			$state = $company[0]->state;
			$zipcode = $company[0]->zipcode;
			$country = $this->Xin_model->read_country_info($company[0]->country);
			if (!is_null($country)) {
				$country_name = $country[0]->country_name;
			} else {
				$country_name = '--';
			}
			$c_info_email = $company[0]->email;
			$c_info_phone = $company[0]->contact_number;
		} else {
			$company_name = '--';
			$company_logo = '--';
			$address_1 = '--';
			$address_2 = '--';
			$city = '--';
			$state = '--';
			$zipcode = '--';
			$country_name = '--';
			$c_info_email = '--';
			$c_info_phone = '--';
		}
		$fname = $user[0]->first_name . ' ' . $user[0]->last_name;
		$created_at = $this->Xin_model->set_date_format($payment[0]->created_at);
		$date_of_joining = $this->Xin_model->set_date_format($user[0]->date_of_joining);
		$salary_month = $this->Xin_model->set_date_format($payment[0]->salary_month);
		// check
		$half_title = '';
		if ($system[0]->is_half_monthly == 1) {
			$payment_check1 = $this->Payroll_model->read_make_payment_payslip_half_month_check_first($payment[0]->employee_id, $payment[0]->salary_month);
			$payment_check2 = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($payment[0]->employee_id, $payment[0]->salary_month);
			$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($payment[0]->employee_id, $payment[0]->salary_month);
			if ($payment_check->num_rows() > 1) {
				if ($payment_check2[0]->payslip_key == $this->uri->segment(5)) {
					$half_title = '(' . $this->lang->line('xin_title_second_half') . ')';
				} else if ($payment_check1[0]->payslip_key == $this->uri->segment(5)) {
					$half_title = '(' . $this->lang->line('xin_title_first_half') . ')';
				} else {
					$half_title = '';
				}
			} else {
				$half_title = '(' . $this->lang->line('xin_title_first_half') . ')';
			}
			$half_title = $half_title;
		} else {
			$half_title = '';
		}

		// basic salary
		$bs = 0;
		$basic_salary = $payment[0]->basic_salary;
		//$company_detail = $this->Employees_model->get_company_detail($user[0]->payslip_id);

		// allowances
		$count_allowances = $this->Employees_model->count_employee_allowances_payslip($payment[0]->payslip_id);
		$allowances = $this->Employees_model->set_employee_allowances_payslip($payment[0]->payslip_id);
		// $motivation_amount = $this->Employees_model->set_employee_motivation_amount_payslip($payment[0]->payslip_id);
		// $general_amount = $this->Employees_model->set_employee_general_amount_payslip($payment[0]->payslip_id);
		//echo $this->db->last_query();exit;
		// commissions
		$general_allowance_amount = 0;
		$motivation_allowance_amount = 0;
		// if ($general_amount) {
		// 	$general_allowance_amount = $general_amount->total_amount;
		// }
		// if ($motivation_amount) {
		// 	$motivation_allowance_amount = $motivation_amount->total_amount;
		// }
		$count_commissions = $this->Employees_model->count_employee_commissions_payslip($payment[0]->payslip_id);
		$commissions = $this->Employees_model->set_employee_commissions_payslip($payment[0]->payslip_id);
		// print_r($commissions->result());die;
		// otherpayments
		$count_other_payments = $this->Employees_model->count_employee_other_payments_payslip($payment[0]->payslip_id);
		$other_payments = $this->Employees_model->set_employee_other_payments_payslip($payment[0]->payslip_id);
		// statutory_deductions
		$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions_payslip($payment[0]->payslip_id);
		$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions_payslip($payment[0]->payslip_id);
		// overtime
		$count_overtime = $this->Employees_model->count_employee_overtime_payslip($payment[0]->payslip_id);
		$overtime = $this->Employees_model->set_employee_overtime_payslip($payment[0]->payslip_id);
		// loan
		$count_loan = $this->Employees_model->count_employee_deductions_payslip($payment[0]->payslip_id);
		$loan = $this->Employees_model->set_employee_deductions_payslip($payment[0]->payslip_id);
		//

		$statutory_deduction_amount = 0;
		$loan_de_amount = 0;
		$allowances_amount = 0;
		$commissions_amount = 0;
		$other_payments_amount = 0;
		$overtime_amount = 0;
		// laon
		if ($count_loan > 0) :
			foreach ($loan->result() as $r_loan) {
				$loan_de_amount += $r_loan->loan_amount;
			}
			$loan_de_amount = $loan_de_amount;
		else :
			$loan_de_amount = 0;
		endif;
		// allowances
		$loan_de_amount = number_format(floatval($loan_de_amount), 2);
		$allowances_amount = 0;
		foreach ($allowances->result() as $sl_allowances) {
			$allowances_amount += $sl_allowances->allowance_amount;
		}
		// commission
		$commissions_amount = 0;
		foreach ($commissions->result() as $sl_commissions) {
			$commissions_amount += $sl_commissions->commission_amount;
		}
		// statutory deduction
		$statutory_deduction_amount = 0;
		foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
			if ($system[0]->statutory_fixed != 'yes') :
				$sta_salary = $basic_salary;
				$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
				//$statutory_deductions_amount += $st_amount;
				if ($system[0]->is_half_monthly == 1) {
					if ($system[0]->half_deduct_month == 2) {
						$single_sd = $st_amount / 2;
					} else {
						$single_sd = $st_amount;
					}
				} else {
					$single_sd = $st_amount;
				}
				$statutory_deduction_amount += $single_sd;
			else :
				if ($system[0]->is_half_monthly == 1) {
					if ($system[0]->half_deduct_month == 2) {
						$single_sd = $sl_statutory_deductions->deduction_amount / 2;
					} else {
						$single_sd = $sl_statutory_deductions->deduction_amount;
					}
				} else {
					$single_sd = $sl_statutory_deductions->deduction_amount;
				}
				$statutory_deduction_amount += $single_sd;
			endif;
		}


		// other amount
		$other_payments_amount = 0;
		foreach ($other_payments->result() as $sl_other_payments) {
			$other_payments_amount += $sl_other_payments->payments_amount;
		}
		// overtime
		$overtime_amount = 0;
		foreach ($overtime->result() as $r_overtime) {
			$overtime_total = (float)$r_overtime->overtime_hours * (float)$r_overtime->overtime_rate;
			$overtime_amount += $overtime_total;
		}

		//cpf
		$cpf_result = $this->Cpf_payslip_model->getCpfByPayslipId($payment[0]->payslip_id);
		if ($payment[0]->cpf_employee_amount || $payment[0]->cpf_employer_amount) {
			$cpf_employer = $payment[0]->cpf_employer_amount;
			$cpf_employee = $payment[0]->cpf_employee_amount;
		} else {
			$cpf_employer = 0;
			$cpf_employee = 0;
		}


		//share options
		$share_option_amount = 0;
		$share_option = $this->Payroll_model->getShareOptionPayslip($payment[0]->payslip_id);
		if ($share_option) {
			$share_option_amount = round($share_option->amount, 2);
		}

		//Leave Deductions
		$total_leave_deduction = 0;
		$leave_deductions = $this->Payroll_model->getLeaveDeductionPayslip($payment[0]->payslip_id);
		if ($leave_deductions) {
			$total_leave_deduction = round($leave_deductions[0]->total_leave_amount, 2);
		}
		$system = $this->Xin_model->read_setting_info(1);
		$work_day = 1;


		$basic_s = $basic_salary;
		if (count($allowances->result()) > 0) {
			$alt = array_sum(array_column($allowances->result(), 'allowance_amount'));

			$pay_data['allowance'] = $allowances->result();
			$pay_data['allowance_total'] = $alt;
		}

		// $get_cliam_data = $this->Employees_model->get_cliam_data($user[0]->user_id, $payment[0]->salary_month);
		$restday_pay = 0;
		if ($payment[0]->payslip_type == 'hourly') {

			$all_overtime_P = $overtime_amount;
			$total_earning = $allowances_amount + $all_overtime_P + $restday_pay + $general_allowance_amount + $motivation_allowance_amount + $basic_s + $commissions_amount + $other_payments_amount;
			$total_deduction = floatval($loan_de_amount) + $statutory_deduction_amount + $payment[0]->deduction_amount;
			$total_net_salary = $total_earning - $total_deduction;
			//cpf
			$total_net_salary = $total_net_salary - $cpf_employee;
			$etotal_earning = $total_net_salary;
		} else {

			$all_overtime_P = $overtime_amount;
			$total_earning = ($allowances_amount + $all_overtime_P + $basic_s + $general_allowance_amount + $motivation_allowance_amount + $restday_pay + $commissions_amount + $other_payments_amount + $share_option_amount) - $total_leave_deduction;
			$total_deduction = floatval($loan_de_amount) + $statutory_deduction_amount + $payment[0]->deduction_amount;
			$total_net_salary = $total_earning - $total_deduction;
			//cpf
			// echo $overtime_amount;exit;

			if ($cpf_employee) {
				// $total_net_salary = $total_net_salary - $cpf_employee;
			}
			// $etotal_earning = $total_net_salary - $cpf_employer;
			//contribution
			$contribution = 0;
			if ($contribution) {
				$contribution_amount = 0;
				// foreach ($contribution as $c) {
				// 	if ($c->contribution_id != 5) {
				// 		$contribution_amount += $c->contribution_amount;
				// 	}
				// }
				$total_net_salary = $total_net_salary - $contribution_amount;
			}
			$total_net_salary = $total_net_salary - $cpf_employee;
		}
		// $LeaveEnchashment = $this->Employees_model->get_leave_Encashment($user[0]->user_id, $payment[0]->salary_month);
		// $getBalanceLeave = $this->Employees_model->get_leave_balance($user[0]->user_id, $payment[0]->salary_month);
		// $employee_deduction = $this->Payroll_model->getEmployeeDeductionPayslip($payment[0]->payslip_id);
		$encamoun = 0;

		$get_salary_payslip_overtime_by = $this->Payroll_model->get_salary_payslip_overtime_by($payment[0]->payslip_id);

		// new code by Debasis
		$deductions_list = $this->Payroll_model->get_deduction_detail($payment[0]->employee_id, $payment[0]->salary_month);

		$pay_data['total_overtime_pay'] = $get_salary_payslip_overtime_by[0]->total_overtime ?? 0;
		$pay_data['overtime_hours'] = $get_salary_payslip_overtime_by[0]->overtime_hours ?? 0;
		$pay_data['statutory_deductions_list'] = $statutory_deductions;
		$pay_data['total_leave_deduction'] = $total_leave_deduction;
		$pay_data['deductions_list'] = $deductions_list;
		$pay_data['loan_list']	= $loan;
		// $pay_data['basic'] = $basic_s;
		// end new code


		$pay_data['user_id'] = $user[0]->user_id;
		$pay_data['name'] = $fname;
		$pay_data['basic'] = $basic_s;
		$pay_data['restd'] = $restday_pay;
		$pay_data['rest_daya'] = 0;
		$pay_data['overtime'] = $all_overtime_P;
		$pay_data['total_pay'] = $total_net_salary + $encamoun - $payment[0]->contribution_fund;
		$pay_data['overtime_t'] = 0;
		$pay_data['claims'] = $encamoun;
		$pay_data['other_payments_array'] = $other_payments->result();
		$pay_data['commissions'] = $commissions->result();
		$pay_data['contribution_fund']	=  $payment[0]->contribution_fund;

		$pay_data['other_payments_amount'] = $other_payments_amount;
		$pay_data['total_deduction'] = $total_deduction + $total_leave_deduction + $payment[0]->contribution_fund;
		$pay_data['company_name'] = $company_name;
		$pay_data['company_logo'] = $company_logo;
		$pay_data['company_detals'] = $company;
		$pay_data['date_of_payment'] = $payment[0]->salary_month;
		$pay_data['balance_leave'] = $getBalanceLeave->balance_leaves ?? 0;
		$pay_data['allowance_array'] = $allowances->result();
		$pay_data['cpf_employer'] = $cpf_employer;
		$pay_data['cpf_employee'] = $cpf_employee;
		$pay_data['employee_deduction'] = 0;
		$pay_data['employee_id'] = $user[0]->employee_id;
		$pay_data['statutory_deduction_amount'] = $statutory_deduction_amount;

		$pay_data['general_amount'] = $general_allowance_amount;
		$pay_data['motivation_amount'] = $motivation_allowance_amount;
		$pay_data['loan'] = $loan_de_amount;
		$pay_data['mode'] = $user[0]->payment_mode;

		$options = new Options();
		$options->set('isRemoteEnabled', true);
		$dompdf = new Dompdf($options);
		// 	echo "<pre>";
		//   print_r($user[0]->payment_mode);die;




		// $rr = $this->load->view('admin/payroll/ff', $pay_data, true);
		$rr = $this->load->view('admin/payroll/new_ff', $pay_data, true);
		// $this->load->view('admin/payroll/new_ff', $pay_data);exit;
		$dompdf->loadHtml($rr);


		$customPaper = array(0, 0, 1000, 1500); // Adjust this as needed
		$dompdf->setPaper($customPaper);
		$dompdf->render();

		$dompdf->stream($fname . '_' . $payment[0]->salary_month . '.pdf', ["Attachment" => false]);
	}
	// public function pdf_create()
	// {

	// 	//$this->load->library('Pdf');
	// 	$system = $this->Xin_model->read_setting_info(1);
	// 	// create new PDF document
	// 	$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

	// 	$key = $this->uri->segment(5);
	// 	$payment = $this->Payroll_model->read_salary_payslip_info_key($key);

	// 	if (is_null($payment)) {
	// 		redirect('admin/payroll/generate_payslip');
	// 	}
	// 	$user = $this->Xin_model->read_user_info($payment[0]->employee_id);

	// 	// if password generate option enable
	// 	if ($system[0]->is_payslip_password_generate == 1) {
	// 		/**
	// 		 * Protect PDF from being printed, copied or modified. In order to being viewed, the user needs
	// 		 * to provide password as selected format in settings module.
	// 		 */
	// 		if ($system[0]->payslip_password_format == 'dateofbirth') {
	// 			$password_val = date("dmY", strtotime($user[0]->date_of_birth));
	// 		} else if ($system[0]->payslip_password_format == 'contact_no') {
	// 			$password_val = $user[0]->contact_no;
	// 		} else if ($system[0]->payslip_password_format == 'full_name') {
	// 			$password_val = $user[0]->first_name . $user[0]->last_name;
	// 		} else if ($system[0]->payslip_password_format == 'email') {
	// 			$password_val = $user[0]->email;
	// 		} else if ($system[0]->payslip_password_format == 'password') {
	// 			$password_val = $user[0]->password;
	// 		} else if ($system[0]->payslip_password_format == 'user_password') {
	// 			$password_val = $user[0]->username . $user[0]->password;
	// 		} else if ($system[0]->payslip_password_format == 'employee_id') {
	// 			$password_val = $user[0]->employee_id;
	// 		} else if ($system[0]->payslip_password_format == 'employee_id_password') {
	// 			$password_val = $user[0]->employee_id . $user[0]->password;
	// 		} else if ($system[0]->payslip_password_format == 'dateofbirth_name') {
	// 			$dob = date("dmY", strtotime($user[0]->date_of_birth));
	// 			$fname = $user[0]->first_name;
	// 			$lname = $user[0]->last_name;
	// 			$password_val = $dob . $fname[0] . $lname[0];
	// 		}
	// 		$pdf->SetProtection(array('print', 'copy', 'modify'), $password_val, $password_val, 0, null);
	// 	}


	// 	$_des_name = $this->Designation_model->read_designation_information($user[0]->designation_id);
	// 	if (!is_null($_des_name)) {
	// 		$_designation_name = $_des_name[0]->designation_name;
	// 	} else {
	// 		$_designation_name = '';
	// 	}
	// 	$department = $this->Department_model->read_department_information($user[0]->department_id);
	// 	if (!is_null($department)) {
	// 		$_department_name = $department[0]->department_name;
	// 	} else {
	// 		$_department_name = '';
	// 	}
	// 	//$location = $this->Xin_model->read_location_info($department[0]->location_id);
	// 	// company info
	// 	$company = $this->Xin_model->read_company_info($user[0]->company_id);

	// 	$p_method = '';
	// 	if (!is_null($company)) {
	// 		$company_name = $company[0]->name;
	// 		$address_1 = $company[0]->address_1;
	// 		$address_2 = $company[0]->address_2;
	// 		$city = $company[0]->city;
	// 		$state = $company[0]->state;
	// 		$zipcode = $company[0]->zipcode;
	// 		$country = $this->Xin_model->read_country_info($company[0]->country);
	// 		if (!is_null($country)) {
	// 			$country_name = $country[0]->country_name;
	// 		} else {
	// 			$country_name = '--';
	// 		}
	// 		$c_info_email = $company[0]->email;
	// 		$c_info_phone = $company[0]->contact_number;
	// 	} else {
	// 		$company_name = '--';
	// 		$address_1 = '--';
	// 		$address_2 = '--';
	// 		$city = '--';
	// 		$state = '--';
	// 		$zipcode = '--';
	// 		$country_name = '--';
	// 		$c_info_email = '--';
	// 		$c_info_phone = '--';
	// 	}
	// 	$company_logo = base_url() . 'uploads/logo/payroll/' . $system[0]->payroll_logo;
	// 	$company_logos = base_url() . 'uploads/company/' . $company[0]->logo;

	// 	//$pdf = new Pdf('P', 'mm', 'A4', true, 'UTF-8', false);
	// 	// set default header data
	// 	//$c_info_address = $address_1.' '.$address_2.', '.$city.' - '.$zipcode.', '.$country_name;
	// 	$c_info_address = $address_1 . ' ' . $address_2 . ', ' . $city . ' - ' . $zipcode;
	// 	//$email_phone_address = "$c_info_address \n".$this->lang->line('xin_phone')." : $c_info_phone | ".$this->lang->line('dashboard_email')." : $c_info_email ";

	// 	$email_phone_address = "$c_info_address \n" . $this->lang->line('xin_phone') . " : $c_info_phone | " . $this->lang->line('dashboard_email') . " : $c_info_email \n";

	// 	$header_string = $email_phone_address;
	// 	// set document information
	// 	$pdf->SetCreator('HRSALE');
	// 	$pdf->SetAuthor('HRSALE');
	// 	//$pdf->SetTitle('Workable-Zone - Payslip');
	// 	//$pdf->SetSubject('TCPDF Tutorial');
	// 	//$pdf->SetKeywords('TCPDF, PDF, example, test, guide');
	// 	$pdf->SetHeaderData(PDF_HEADER_LOGO,  15, $company_name, $header_string);
	// 	//$pdf->SetHeaderData("", 15, $company_name, $header_string);

	// 	$pdf->setFooterData(array(0, 64, 0), array(0, 64, 128));

	// 	// set header and footer fonts
	// 	$pdf->setHeaderFont(array('helvetica', '', 11.5));
	// 	$pdf->setFooterFont(array('helvetica', '', 9));

	// 	// set default monospaced font
	// 	$pdf->SetDefaultMonospacedFont('courier');

	// 	// set margins
	// 	$pdf->SetMargins(15, 27, 15);
	// 	$pdf->SetHeaderMargin(5);
	// 	$pdf->SetFooterMargin(10);

	// 	// set auto page breaks
	// 	$pdf->SetAutoPageBreak(TRUE, 25);

	// 	// set image scale factor
	// 	$pdf->setImageScale(1.25);
	// 	$pdf->SetAuthor('HRSALE');
	// 	$pdf->SetTitle($company_name . ' - ' . $this->lang->line('xin_print_payslip'));
	// 	$pdf->SetSubject($this->lang->line('xin_payslip'));
	// 	$pdf->SetKeywords($this->lang->line('xin_payslip'));
	// 	// set font
	// 	$pdf->SetFont('helvetica', 'B', 10);

	// 	// set header and footer fonts
	// 	$pdf->setHeaderFont(array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
	// 	$pdf->setFooterFont(array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

	// 	// set default monospaced font
	// 	$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

	// 	// set margins
	// 	$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
	// 	$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
	// 	$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

	// 	// set auto page breaks
	// 	$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

	// 	// set image scale factor
	// 	$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

	// 	// ---------------------------------------------------------

	// 	// set default font subsetting mode
	// 	$pdf->setFontSubsetting(true);

	// 	// Set font
	// 	// dejavusans is a UTF-8 Unicode font, if you only need to
	// 	// print standard ASCII chars, you can use core fonts like
	// 	// helvetica or times to reduce file size.
	// 	$pdf->SetFont('dejavusans', '', 10, '', true);

	// 	// Add a page
	// 	// This method has several options, check the source code documentation for more information.
	// 	$pdf->AddPage();
	// 	// -----------------------------------------------------------------------------
	// 	$fname = $user[0]->first_name . ' ' . $user[0]->last_name;
	// 	$created_at = $this->Xin_model->set_date_format($payment[0]->created_at);
	// 	$date_of_joining = $this->Xin_model->set_date_format($user[0]->date_of_joining);
	// 	$salary_month = $this->Xin_model->set_date_format($payment[0]->salary_month);
	// 	// check
	// 	$half_title = '';
	// 	if ($system[0]->is_half_monthly == 1) {
	// 		$payment_check1 = $this->Payroll_model->read_make_payment_payslip_half_month_check_first($payment[0]->employee_id, $payment[0]->salary_month);
	// 		$payment_check2 = $this->Payroll_model->read_make_payment_payslip_half_month_check_last($payment[0]->employee_id, $payment[0]->salary_month);
	// 		$payment_check = $this->Payroll_model->read_make_payment_payslip_half_month_check($payment[0]->employee_id, $payment[0]->salary_month);
	// 		if ($payment_check->num_rows() > 1) {
	// 			if ($payment_check2[0]->payslip_key == $this->uri->segment(5)) {
	// 				$half_title = '(' . $this->lang->line('xin_title_second_half') . ')';
	// 			} else if ($payment_check1[0]->payslip_key == $this->uri->segment(5)) {
	// 				$half_title = '(' . $this->lang->line('xin_title_first_half') . ')';
	// 			} else {
	// 				$half_title = '';
	// 			}
	// 		} else {
	// 			$half_title = '(' . $this->lang->line('xin_title_first_half') . ')';
	// 		}
	// 		$half_title = $half_title;
	// 	} else {
	// 		$half_title = '';
	// 	}

	// 	// basic salary
	// 	$bs = 0;
	// 	$bs = $payment[0]->basic_salary;
	// 	//$company_detail = $this->Employees_model->get_company_detail($user[0]->payslip_id);

	// 	// allowances
	// 	$count_allowances = $this->Employees_model->count_employee_allowances_payslip($payment[0]->payslip_id);
	// 	$allowances = $this->Employees_model->set_employee_allowances_payslip($payment[0]->payslip_id);
	// 	//echo $this->db->last_query();exit;
	// 	// commissions
	// 	$count_commissions = $this->Employees_model->count_employee_commissions_payslip($payment[0]->payslip_id);
	// 	$commissions = $this->Employees_model->set_employee_commissions_payslip($payment[0]->payslip_id);
	// 	// otherpayments
	// 	$count_other_payments = $this->Employees_model->count_employee_other_payments_payslip($payment[0]->payslip_id);
	// 	$other_payments = $this->Employees_model->set_employee_other_payments_payslip($payment[0]->payslip_id);
	// 	// statutory_deductions
	// 	$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions_payslip($payment[0]->payslip_id);
	// 	$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions_payslip($payment[0]->payslip_id);
	// 	// overtime
	// 	$count_overtime = $this->Employees_model->count_employee_overtime_payslip($payment[0]->payslip_id);
	// 	$overtime = $this->Employees_model->set_employee_overtime_payslip($payment[0]->payslip_id);
	// 	// loan
	// 	$count_loan = $this->Employees_model->count_employee_deductions_payslip($payment[0]->payslip_id);
	// 	$loan = $this->Employees_model->set_employee_deductions_payslip($payment[0]->payslip_id);
	// 	//
	// 	$statutory_deduction_amount = 0;
	// 	$loan_de_amount = 0;
	// 	$allowances_amount = 0;
	// 	$commissions_amount = 0;
	// 	$other_payments_amount = 0;
	// 	$overtime_amount = 0;
	// 	// laon
	// 	if ($count_loan > 0) :
	// 		foreach ($loan->result() as $r_loan) {
	// 			$loan_de_amount += $r_loan->loan_amount;
	// 		}
	// 		$loan_de_amount = $loan_de_amount;
	// 	else :
	// 		$loan_de_amount = 0;
	// 	endif;
	// 	// allowances
	// 	$allowances_amount = 0;
	// 	foreach ($allowances->result() as $sl_allowances) {
	// 		$allowances_amount += $sl_allowances->allowance_amount;
	// 	}
	// 	// commission
	// 	$commissions_amount = 0;
	// 	foreach ($commissions->result() as $sl_commissions) {
	// 		$commissions_amount += $sl_commissions->commission_amount;
	// 	}
	// 	// statutory deduction
	// 	$statutory_deduction_amount = 0;
	// 	foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
	// 		//$statutory_deduction_amount += $sl_statutory_deductions->deduction_amount;
	// 		if ($system[0]->statutory_fixed != 'yes') :
	// 			$sta_salary = $bs;
	// 			$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
	// 			$statutory_deduction_amount += $st_amount;
	// 		else :
	// 			$statutory_deduction_amount += $sl_statutory_deductions->deduction_amount;
	// 		endif;
	// 	}
	// 	// other amount
	// 	$other_payments_amount = 0;
	// 	foreach ($other_payments->result() as $sl_other_payments) {
	// 		$other_payments_amount += $sl_other_payments->payments_amount;
	// 	}
	// 	// overtime
	// 	$overtime_amount = 0;
	// 	foreach ($overtime->result() as $r_overtime) {
	// 		$overtime_total = (float)$r_overtime->overtime_hours * (float)$r_overtime->overtime_rate;
	// 		$overtime_amount += $overtime_total;
	// 	}

	// 	//cpf
	// 	$cpf_result = $this->Cpf_payslip_model->getCpfByPayslipId($payment[0]->payslip_id);
	// 	if ($cpf_result) {
	// 		$cpf_employer = round($cpf_result->ow_cpf_employer + $cpf_result->aw_cpf_employer, 2);
	// 		$cpf_employee = round($cpf_result->ow_cpf_employee + $cpf_result->aw_cpf_employee, 2);
	// 	} else {
	// 		$cpf_employer = 0;
	// 		$cpf_employee = 0;
	// 	}

	// 	//share options
	// 	$share_option_amount = 0;
	// 	$share_option = $this->Payroll_model->getShareOptionPayslip($payment[0]->payslip_id);
	// 	if ($share_option) {
	// 		$share_option_amount = round($share_option->amount, 2);
	// 	}

	// 	//Leave Deductions
	// 	$total_leave_deduction = 0;
	// 	$leave_deductions = $this->Payroll_model->getLeaveDeductionPayslip($payment[0]->payslip_id);
	// 	if ($leave_deductions) {
	// 		$total_leave_deduction = round($leave_deductions[0]->total_leave_amount, 2);
	// 	}
	// 	$system = $this->Xin_model->read_setting_info(1);

	// 	$company_info = $this->Xin_model->read_company_setting_info(1);
	// 	$company_logo = base_url() . 'uploads/company/' . $company_info[0]->logo;

	// 	// <td align="left" width="30%">'.$pdf->Image($company_logos,20, 30, 20, 20).'</td>

	// 	$tbl = '<br><br>
	// 	<table cellpadding="1" cellspacing="1" border="0">
	// 	<tr>
	// 			<td align="left" width="30%"></td>
	// 			<td align="right" width="70%"><h1>' . $company_name . '</h1><br><br><br></td>

	// 		</tr>

	// 	</table>';
	// 	$pdf->writeHTML($tbl, true, false, false, false, '');


	// 	$tbl0 = '<table><tr>
	// 	<td align="center"><h3>' . $this->lang->line('xin_payslip') . '</h3></td>
	// 	</tr></table>';
	// 	$pdf->writeHTML($tbl0, true, false, false, false, '');
	// 	// -----------------------------------------------------------------------------
	// 	// set cell padding
	// 	$pdf->setCellPaddings(1, 1, 1, 1);

	// 	// set cell margins
	// 	$pdf->setCellMargins(0, 0, 0, 0);

	// 	// set color for background
	// 	$pdf->SetFillColor(255, 255, 127);
	// 	// set some text for example
	// 	//$txt = 'Employee Details';
	// 	// Multicell
	// 	//$pdf->MultiCell(180, 6, $txt, 0, 'L', 11, 0, '', '', true);
	// 	//$pdf->Ln(7);
	// 	$tbl1 = '
	// 	<table cellpadding="3" cellspacing="0">

	// 		<tr>
	// 			<td>' . $this->lang->line('xin_employee_name') . ':</td>
	// 			<td>' . $fname . '</td>

	// 			<td>Payslip ID:</td>
	// 			<td>' . $payment[0]->payslip_id . '</td>
	// 		</tr>
	// 		<tr>
	// 		<td>Employee NRIC/FIN:</td>
	// 			<td>' . $user[0]->id_no . '</td>
	// 		<td>Payslip Month</td>
	// 		<td>' . date('M Y', strtotime('01-' . $payment[0]->salary_month)) . '</td>
	// 		</tr>

	// 		<tr>
	// 		<td>Employee DOB:</td>
	// 			<td>' . $user[0]->date_of_birth . '</td>
	// 			<td>Salary Period</td>
	// 		<td>' . date("01-m-Y", strtotime('01-' . $payment[0]->salary_month)) . ' To ' . date("t-m-Y", strtotime('01-' . $payment[0]->salary_month)) . '</td>
	// 		</tr>

	// 		<tr>

	// 			<td>' . $this->lang->line('left_designation') . '</td>
	// 			<td>' . $_designation_name . '</td>
	// 			<td>Payment Status</td>
	// 		<td>' . ($payment[0]->is_payment == 1 ? 'Paid' : 'Pending') . '</td>
	// 		</tr>
	// 		<tr>
	// 		<td>Reference:</td>
	// 			<td></td>
	// 			<td>Payment Type/Date</td>
	// 		<td>' . ucfirst(str_replace('_', ' ', $payment[0]->payslip_type)) . '/' . $payment[0]->year_to_date . '</td>
	// 		</tr>';
	// 	if ($payment[0]->payslip_type == 'hourly') {
	// 		$hcount = $payment[0]->hours_worked;
	// 		$tbl1 .= '<tr>
	// 			<td>' . $this->lang->line('xin_employee_doj') . '</td>
	// 			<td>' . $date_of_joining . '</td>
	// 			<td>' . $this->lang->line('xin_payroll_hours_worked_total') . '</td>
	// 			<td>' . $hcount . '</td>
	// 		</tr>';
	// 	} else {
	// 		$date = strtotime($payment[0]->year_to_date);
	// 		$day = date('d', $date);
	// 		$month = date('m', $date);
	// 		$year = date('Y', $date);
	// 		// total days in month
	// 		$daysInMonth = cal_days_in_month(0, $month, $year);
	// 		$imonth = date('F', $date);
	// 		$r = $this->Xin_model->read_user_info($user[0]->user_id);
	// 		$pcount = 0;
	// 		$acount = 0;
	// 		$lcount = 0;
	// 		for ($i = 1; $i <= $daysInMonth; $i++) :
	// 			$i = str_pad($i, 2, 0, STR_PAD_LEFT);
	// 			// get date <
	// 			$attendance_date = $year . '-' . $month . '-' . $i;
	// 			$get_day = strtotime($attendance_date);
	// 			$day = date('l', $get_day);
	// 			$user_id = $r[0]->user_id;
	// 			$office_shift_id = $r[0]->office_shift_id;
	// 			$attendance_status = '';
	// 			// get holiday
	// 			$h_date_chck = $this->Timesheet_model->holiday_date_check($attendance_date);
	// 			$holiday_arr = array();
	// 			if ($h_date_chck->num_rows() == 1) {
	// 				$h_date = $this->Timesheet_model->holiday_date($attendance_date);
	// 				$begin = new DateTime($h_date[0]->start_date);
	// 				$end = new DateTime($h_date[0]->end_date);
	// 				$end = $end->modify('+1 day');

	// 				$interval = new DateInterval('P1D');
	// 				$daterange = new DatePeriod($begin, $interval, $end);

	// 				foreach ($daterange as $date) {
	// 					$holiday_arr[] =  $date->format("Y-m-d");
	// 				}
	// 			} else {
	// 				$holiday_arr[] = '99-99-99';
	// 			}
	// 			// get leave/employee
	// 			$leave_date_chck = $this->Timesheet_model->leave_date_check($user_id, $attendance_date);
	// 			$leave_arr = array();
	// 			if ($leave_date_chck->num_rows() == 1) {
	// 				$leave_date = $this->Timesheet_model->leave_date($user_id, $attendance_date);
	// 				$begin1 = new DateTime($leave_date[0]->from_date);
	// 				$end1 = new DateTime($leave_date[0]->to_date);
	// 				$end1 = $end1->modify('+1 day');

	// 				$interval1 = new DateInterval('P1D');
	// 				$daterange1 = new DatePeriod($begin1, $interval1, $end1);

	// 				foreach ($daterange1 as $date1) {
	// 					$leave_arr[] =  $date1->format("Y-m-d");
	// 				}
	// 			} else {
	// 				$leave_arr[] = '99-99-99';
	// 			}
	// 			$office_shift = $this->Timesheet_model->read_office_shift_information($office_shift_id);
	// 			$check = $this->Timesheet_model->attendance_first_in_check($user_id, $attendance_date);
	// 			// get holiday>events
	// 			if ($office_shift[0]->monday_in_time == '' && $day == 'Monday') {
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount += 0;
	// 			} else if ($office_shift[0]->tuesday_in_time == '' && $day == 'Tuesday') {
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount += 0;
	// 			} else if ($office_shift[0]->wednesday_in_time == '' && $day == 'Wednesday') {
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount += 0;
	// 			} else if ($office_shift[0]->thursday_in_time == '' && $day == 'Thursday') {
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount += 0;
	// 			} else if ($office_shift[0]->friday_in_time == '' && $day == 'Friday') {
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount += 0;
	// 			} else if ($office_shift[0]->saturday_in_time == '' && $day == 'Saturday') {
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount -= 1;
	// 			} else if ($office_shift[0]->sunday_in_time == '' && $day == 'Sunday') {
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount -= 1;
	// 			} else if (in_array($attendance_date, $holiday_arr)) { // holiday
	// 				$status = 'H';
	// 				$pcount += 0;
	// 				//$acount += 0;
	// 			} else if (in_array($attendance_date, $leave_arr)) { // on leave
	// 				$status = 'L';
	// 				$pcount += 0;
	// 				$lcount += 1;
	// 				//	$acount += 0;
	// 			} else if ($check->num_rows() > 0) {
	// 				$pcount += 1;
	// 				//$acount -= 1;
	// 			} else {
	// 				$status = 'A';
	// 				//$acount += 1;
	// 				$pcount += 0;
	// 				// set to present date
	// 				$iattendance_date = strtotime($attendance_date);
	// 				$icurrent_date = strtotime(date('Y-m-d'));
	// 				if ($iattendance_date <= $icurrent_date) {
	// 					$acount += 1;
	// 				} else {
	// 					$acount += 0;
	// 				}
	// 			}
	// 		endfor;
	// 		$tbl1 .= '<tr>
	// 			<td>' . $this->lang->line('xin_employee_doj') . '</td>
	// 			<td>' . $user[0]->date_of_joining . '</td>
	// 			<td>' . $this->lang->line('xin_payroll_no_of_days_in_month') . '</td>
	// 			<td>' . $daysInMonth . '</td>
	// 		</tr>';
	// 	}
	// 	$tbl1 .= '</table>';

	// 	$pdf->writeHTML($tbl1, true, false, true, false, '');
	// 	if ($payment[0]->payslip_type == 'hourly') {
	// 		$total_earning = $allowances_amount + $commissions_amount + $other_payments_amount + $overtime_amount;
	// 		$total_deductions = $loan_de_amount + $statutory_deduction_amount;
	// 		$total_count = $hcount * $bs;
	// 	} else {
	// 		$total_earning = $bs + $allowances_amount + $commissions_amount + $other_payments_amount + $share_option_amount + $overtime_amount;
	// 		$total_deductions = $loan_de_amount + $statutory_deduction_amount;
	// 	}
	// 	/*<tr>
	// 			<td colspan="2">'.$this->lang->line('xin_payroll_hourly_rate').'</td>
	// 			<td align="center">'.$this->Xin_model->currency_sign($payment[0]->basic_salary).'</td>	
	// 			<td>&nbsp;</td>				
	// 		</tr>*/
	// 	//// break..
	// 	$pdf->Ln(7);

	// 	//allowances
	// 	$total_allowance = 0;
	// 	if ($count_allowances > 0) {
	// 		$tblbrk2 = '';
	// 		foreach ($allowances->result() as $sl_allowances) {
	// 			$tblbrk2 .= '<tr>
	// 				<td colspan="2">' . $sl_allowances->allowance_title . '</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($sl_allowances->allowance_amount) . '</td>			
	// 				</tr>';

	// 			$total_allowance += $sl_allowances->allowance_amount;
	// 		}
	// 	} else {
	// 		$tblbrk2 = '<tr>
	// 				<td colspan="2">Allowance</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign(0) . '</td>				
	// 				</tr>';
	// 	}

	// 	//statutory_deductions
	// 	$tblbrk3 = '';
	// 	$tblbrk4 = '';
	// 	$tblbrk5 = '';
	// 	$tblbrk6 = '';
	// 	$total_statutory = 0;
	// 	$total_loan = 0;
	// 	$total_leave_deduction = 0;
	// 	$total_contribution = 0;
	// 	$tblbrk12 = '';

	// 	if ($count_statutory_deductions > 0) {
	// 		foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
	// 			if ($system[0]->statutory_fixed != 'yes') :
	// 				$sta_salary = $bs;
	// 				$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
	// 				$xstatutory_deduction_amount = $st_amount;
	// 			else :
	// 				$xstatutory_deduction_amount = $sl_statutory_deductions->deduction_amount;
	// 			endif;
	// 			$tblbrk3 .= '<tr>
	// 				<td colspan="2">' . $sl_statutory_deductions->deduction_title . '</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($xstatutory_deduction_amount) . '</td>			
	// 				</tr>';
	// 			$total_statutory += $xstatutory_deduction_amount;
	// 		}
	// 	} else {
	// 		$tblbrk3 = '';
	// 	}
	// 	//loan
	// 	if ($count_loan > 0) {
	// 		foreach ($loan->result() as $r_loan) {
	// 			$tblbrk4 .= '<tr>
	// 				<td colspan="2">' . $r_loan->loan_title . '</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($r_loan->loan_amount) . '</td>	
	// 				</tr>';
	// 		}
	// 		$total_loan += $r_loan->loan_amount;
	// 	} else {
	// 		$tblbrk4 = '';
	// 	}
	// 	//Leave Deduction
	// 	if ($leave_deductions) {
	// 		// $total_leave_deduction = round($leave_deductions[0]->total_leave_amount, 2);
	// 		foreach ($leave_deductions as $ld) {
	// 			if ($ld->is_half == 0) {
	// 				$lday = "Full Day";
	// 			} else {
	// 				$lday = "Half Day";
	// 			}
	// 			$tblbrk5 .= '<tr>
	// 				<td colspan="2">No Pay (Unpaid Leave) (' . date('d M Y', strtotime($ld->leave_date)) . ') (' . $lday . ')</td>
	// 				<td>&nbsp;</td>
	// 				<td align="center">' . $this->Xin_model->currency_sign($ld->leave_amount) . '</td>	
	// 				</tr>';
	// 			$total_leave_deduction += $ld->leave_amount;
	// 		}
	// 	} else {
	// 		$tblbrk5 = '';
	// 	}
	// 	//Contribution funds
	// 	$contribution = $this->Contribution_fund_model->getContributionPayslip($payment[0]->payslip_id);

	// 	if ($contribution) {
	// 		$contribution_fund = array();
	// 		foreach ($contribution as $i => $c) {
	// 			//if($c->contribution_id != 5) {
	// 			$tblbrk12 .= '<tr>
	// 					<td colspan="2">' . $c->contribution . '</td>
	// 					<td colspan="2">' . $this->Xin_model->currency_sign($c->contribution_amount) . '</td>	
	// 					</tr>';
	// 			//}
	// 			$total_contribution += $c->contribution_amount;
	// 		}
	// 		// $data['contribution_fund'] = $contribution_fund;
	// 	} else {
	// 		$tblbrk12 = '';
	// 	}
	// 	if ($cpf_employee > 0) {

	// 		$tblbrk6 .= '<tr>
	// 				<td colspan="2">CPF Employee</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($cpf_employee) . '</td>	
	// 				</tr>';
	// 	} else {
	// 		$cpf_employee = 0;
	// 		$tblbrk6 = '';
	// 	}

	// 	$total_deduction = $total_statutory  + $total_loan + $total_leave_deduction + $cpf_employee + $total_contribution;
	// 	// $tblbrk .= '<tr>
	// 	// <td colspan="2">Total Deduction (C) </td>
	// 	// <td colspan="2">'.$this->Xin_model->currency_sign($total_deduction).'</td>				
	// 	// </tr>';

	// 	//$tblbrk .= $tblbrk3 . $tblbrk4 . $tblbrk5 . $tblbrk6 .$tblbrk12;
	// 	// $tblbrk .= '<tr>
	// 	// 	<td colspan="4"></td>

	// 	// 	</tr>';
	// 	//overtime
	// 	$tblbrk7 = '';
	// 	$total_overtime = 0;

	// 	if ($count_overtime > 0) {

	// 		foreach ($overtime->result() as $r_overtime) {
	// 			$overtime_total = (float)$r_overtime->overtime_hours * (float)$r_overtime->overtime_rate;
	// 			$tblbrk7 .= '<tr>
	// 				<td colspan="2">Overtime (' . $r_overtime->overtime_hours . 'hrs x ' . $this->Xin_model->currency_sign($r_overtime->overtime_rate) . ')</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($overtime_total) . '</td>			
	// 				</tr>';
	// 			$total_overtime += $overtime_total;
	// 		}
	// 		// $tblbrk .= '<tr>
	// 		// 	<td colspan="2">Total Overtime Pay (D)</td>
	// 		// 	<td colspan="2">'.$this->Xin_model->currency_sign($total_overtime).'</td>	

	// 		// 	</tr>';

	// 		//	$tblbrk .= $tblbrk7;
	// 	} else {
	// 		// $tblbrk .= '<tr>
	// 		// <td colspan="2">Total Overtime Pay (D)</td>
	// 		// <td colspan="2">'.$this->Xin_model->currency_sign($total_overtime).'</td>			
	// 		// </tr>';
	// 	}

	// 	// $tblbrk .= '<tr>
	// 	// <td colspan="4"></td>		
	// 	// </tr>';

	// 	//other_payments
	// 	$tblbrk8 = '';
	// 	$tblbrk9 = '';
	// 	$tblbrk10 = '';
	// 	$tblbrk11 = '';

	// 	$total_other_payment = 0;
	// 	$total_commission = 0;
	// 	$total_other = 0;
	// 	$cpf_employer = 0;
	// 	$share_option_amount = 0;

	// 	if ($count_other_payments > 0) {
	// 		foreach ($other_payments->result() as $sl_other_payments) {
	// 			$tblbrk8 .= '<tr>
	// 				<td colspan="2">' . $sl_other_payments->payments_title . '</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($sl_other_payments->payments_amount) . '</td>				
	// 				</tr>';
	// 			$total_other_payment += $sl_other_payments->payments_amount;
	// 		}
	// 	} else {
	// 		$total_other_payment = 0;
	// 		$tblbrk8 = '';
	// 	}
	// 	//commissions
	// 	if ($count_commissions > 0) {
	// 		foreach ($commissions->result() as $sl_commissions) {
	// 			$tblbrk9 .= '<tr>
	// 				<td colspan="2">Commission</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($sl_commissions->commission_amount) . '</td>					
	// 				</tr>';
	// 			$total_commission += $sl_commissions->commission_amount;
	// 		}
	// 	} else {
	// 		$total_commission = 0;
	// 		$tblbrk9 = '';
	// 	}
	// 	//share options
	// 	if ($share_option_amount > 0) {

	// 		$tblbrk10 .= '<tr>
	// 				<td colspan="2">Share Option Sale</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($share_option_amount) . '</td>				
	// 				</tr>';
	// 	} else {
	// 		$share_option_amount = 0;
	// 		$tblbrk10 = '';
	// 	}

	// 	//cpf
	// 	if ($cpf_employer > 0) {
	// 		$tblbrk11 .= '<tr>
	// 				<td colspan="2">CPF Employer</td>
	// 				<td colspan="2">' . $this->Xin_model->currency_sign($cpf_employer) . '</td>		
	// 				</tr>';
	// 	} else {
	// 		$cpf_employer = 0;
	// 		$tblbrk11 = '';
	// 	}
	// 	$total_other = $total_other_payment + $total_commission + $share_option_amount + $cpf_employer;
	// 	// $tblbrk .= '<tr>
	// 	// <td colspan="2">Other Additional Payments (E)</td>
	// 	// <td colspan="2">'.$this->Xin_model->currency_sign($total_other).'</td>	
	// 	// </tr>';
	// 	// $tblbrk .= $tblbrk8 . $tblbrk9.$tblbrk10 .$tblbrk11;

	// 	// $tblbrk .= '<tr>
	// 	// <td colspan="4"></td>
	// 	// </tr>';

	// 	if ($payment[0]->payslip_type == 'hourly') {

	// 		$total_net_salary = $total_count + $total_allowance - $total_deduction + $total_overtime + $total_other;
	// 		$tblbrk = '

	// 				<tr><td colspan="2" align="center"><strong>NET PAY(A+B-C+D+E)</strong></td>
	// 				<td colspan="2" align="center"><strong>' . $this->Xin_model->currency_sign($total_net_salary) . '</strong></td>
	// 				</tr></table>';
	// 	} else {


	// 		$total_net_salary = $bs + $total_allowance - $total_deduction + $total_overtime + $total_other;
	// 		//cpf
	// 		//$total_net_salary = $total_net_salary - $cpf_employee;
	// 		//contribution
	// 		if ($contribution) {
	// 			$contribution_amount = 0;
	// 			foreach ($contribution as $c) {
	// 				if ($c->contribution_id != 5) {
	// 					$contribution_amount += $c->contribution_amount;
	// 				}
	// 			}
	// 		}



	// 		// 	$tblbrk .= '<tr><td colspan="2">NET Salary Pay(A+B-C+D+E)</td>
	// 		// 	<td colspan="2"><strong>'.$this->Xin_model->currency_sign($total_net_salary).'</strong></td>
	// 		// 	</tr>';


	// 		// 	$tblbrk .= '<tr>
	// 		// <td colspan="4"></td>
	// 		// </tr>';

	// 		// $tblbrk .= '<tr>
	// 		// <td colspan="4">Payment Information</td>
	// 		// </tr>';
	// 		// $tblbrk .= '<tr>
	// 		// <td colspan="2">Date of Payment </td>
	// 		// <td colspan="2">'.$payment[0]->year_to_date.'</td>	

	// 		// </tr>';
	// 		$bank_detail = $this->Employees_model->set_employee_bank_account($payment[0]->employee_id);
	// 		$employee_bank_detail = $bank_detail->result();
	// 		// if($bank_detail->num_rows() > 0){
	// 		// $tblbrk .= '<tr>
	// 		// <td colspan="2">Bank Transfer  </td>
	// 		// <td colspan="2">'.$employee_bank_detail[0]->account_number.'('.$employee_bank_detail[0]->bank_name.')</td>	
	// 		// </tr>';
	// 		// $tblbrk .= '<tr>
	// 		// <td colspan="4"></td>
	// 		// </tr>';
	// 		// }else{
	// 		// 	$tblbrk .= '<tr>
	// 		// 	<td colspan="2">Bank Transfer  </td>
	// 		// 	<td colspan="2"></td>	
	// 		// 	</tr>';
	// 		// 	$tblbrk .= '<tr>
	// 		// 	<td colspan="4"></td>
	// 		// 	</tr>';
	// 		// }
	// 		$leave_detail = $this->Employees_model->getEmployeeMonthlyLeaves($payment[0]->employee_id, date('Y-m-d', strtotime($payment[0]->year_to_date)));

	// 		$total_leave_detail = $this->Employees_model->getTotalEmployeeLeaves($payment[0]->employee_id, date('Y-m-d', strtotime($payment[0]->year_to_date)))->result();

	// 		$leaves = $leave_detail->result();

	// 		if ($leave_detail->num_rows() > 0) {
	// 			$tblbrk = '<tr><td colspan="2">Leave Used</td>
	// 			<td colspan="2">Days/Date</td>

	// 			</tr>';
	// 			$total_no_leave = 0;
	// 			if ($total_leave_detail) {
	// 				foreach ($total_leave_detail as $leave) {
	// 					foreach ($leaves as $monthly_leave) {
	// 						$total_no_leave += $monthly_leave->no_of_leaves;
	// 						// if($leave->type_name == $monthly_leave->type_name){
	// 						// $tblbrk .= '<tr><td colspan="2">'.$leave->type_name.'</td>
	// 						// 	<td colspan="2" >'.$monthly_leave->no_of_leaves.'/'.$leave->no_of_leaves.'</td>

	// 						// 	</tr>';

	// 						// }
	// 					}
	// 				}
	// 			}
	// 		}
	// 		// else{
	// 		// 	$tblbrk .= '<tr><td colspan="2">Leave Used</td>
	// 		// 	<td colspan="2">Days/Date</td>

	// 		// 	</tr>';

	// 		// 		$tblbrk .= '<tr><td colspan="2"></td>
	// 		// 			<td colspan="2"></td>

	// 		// 			</tr>';


	// 		// }

	// 		// 	$tblbrk .= '</table>';
	// 		//  }
	// 		$mapping_data = $this->Payroll_model->get_mapping_data($payment[0]->payslip_id);
	// 		//echo "<pre>";print_r($mapping_data);exit;
	// 		$tblbrk = '<table cellpadding="3" cellspacing="0" border="1" rules="none"><tr>
	// 			<td colspan="3" align="center"><strong>Income</strong></td>
	// 			<td colspan="3" align="center"><strong>Deductions</strong></td>	

	// 		</tr>';
	// 		$claim_info = $this->Employees_model->read_employee_claim_information($payment[0]->employee_id);

	// 		$claim_amount = 0;
	// 		if ($claim_info) {
	// 			foreach ($claim_info as $claim) {
	// 				$claim_amount += $claim->amount;
	// 			}
	// 		}
	// 		$d_amount = 0;

	// 		foreach ($mapping_data as $m) {
	// 			if ($m->deduction_name != "") {
	// 				$d_amount += $m->deduction_amount;
	// 			}
	// 		}
	// 		$contribution_data = $this->Employees_model->set_employee_contribution($payment[0]->employee_id);
	// 		// 	if(count($contribution_data) > 0){
	// 		// 		$b=1;

	// 		// 	foreach($contribution_data as $c_data){
	// 		// 	$contribution_amount = $this->Contribution_fund_model->getContributionRate($bs, $c_data->contribution_id);
	// 		// 	$d_amount += $contribution_amount;

	// 		//  }

	// 		//			 }
	// 		//Monthly Payslip(A) Total Allowance(B)  Additional Allowances(E) Total Additional(C) Total Overtime Pay (D) Total Claim(I) 

	// 		if ($payment[0]->payslip_type != 'hourly') {
	// 			$tblbrk .= '<tr>
	// 				<td colspan="2"  style="border-left-style: hidden;">Basic Rate(Monthly)</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($bs) . '</td>	
	// 				<td colspan="2"  style="border-left-style: hidden;">Total Deductions</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($d_amount) . '</td>

	// 			</tr>';
	// 			foreach ($mapping_data as $m) {
	// 				if ($m->deduction_name != "") {
	// 					$tblbrk .= '<tr>
	// 							<td colspan="2" style="border-left-style: hidden;"></td>
	// 							<td style="border-right-style: hidden;"></td>
	// 							<td colspan="2"  style="border-left-style: hidden;">&nbsp;&nbsp;&nbsp;-' . $m->deduction_name . '</td>
	// 							<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($m->deduction_amount) .
	// 						'</td></tr>';
	// 				}
	// 			}
	// 			// if(count($contribution_data) > 0) {
	// 			// 	$contribution_fund = array();
	// 			// 	foreach($contribution_data as $c_data) {
	// 			// 		$contribution_amount = $this->Contribution_fund_model->getContributionRate($bs, $c_data->contribution_id);
	// 			// 		//if($c->contribution_id != 5) {
	// 			// 			$tblbrk .= '<tr>
	// 			// 			<td colspan="2" style="border-left-style: hidden;"></td>
	// 			// 			<td style="border-right-style: hidden;"></td>
	// 			// 			<td colspan="2" style="border-left-style: hidden;">'.$c_data->contribution.'</td>
	// 			// 			<td colspan="2" style="border-right-style: hidden;">'.$this->Xin_model->currency_sign($contribution_amount).'</td>	
	// 			// 			</tr>';
	// 			// 		//}


	// 			// 	}
	// 			// }
	// 			$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-left-style: hidden;">' . $this->lang->line('xin_payroll_basic_salary') . '(A)</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($bs) . '</td>	
	// 				<td colspan="2"  style="border-left-style: hidden;">Employee CPF</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->cpf_employee_amount) . '</td>		
	// 			</tr>';
	// 		} else {
	// 			$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-left-style: hidden;">Basic Rate</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($total_count) . '</td>	
	// 				<td colspan="2"  style="border-left-style: hidden;">Total Deductions</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->total_statutory_deductions) . '</td>		
	// 			</tr>';

	// 			foreach ($mapping_data as $m) {
	// 				if ($m->deduction_name != "") {
	// 					$tblbrk .= '<tr>
	// 							<td colspan="2" style="border-left-style: hidden;"></td>
	// 							<td style="border-right-style: hidden;"></td>
	// 							<td colspan="2"  style="border-left-style: hidden;">&nbsp;&nbsp;&nbsp;-' . $m->deduction_name . '</td>
	// 							<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($m->deduction_amount) .
	// 						'</td></tr>';
	// 				}
	// 			}
	// 			$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-left-style: hidden;">' . $this->lang->line('xin_payroll_hourly_rate') . ' x ' . $this->lang->line('xin_payroll_hours_worked_total') . '(A)<br> ' . $this->Xin_model->currency_sign($bs) . ' x ' . $hcount . '</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($total_count) . '</td>	
	// 				<td colspan="2"  style="border-left-style: hidden;">Employee CPF(F)</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->cpf_employee_amount) . '</td>			
	// 			</tr>';
	// 		}

	// 		$tblbrk .= '<tr>
	// 			<td colspan="2" style="border-left-style: hidden;">Total Allowance(B)</td>
	// 			<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->total_allowances) . '</td>	
	// 			<td colspan="2"  style="border-left-style: hidden;">Unpaid Leave</td>	
	// 			<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->leave_deduction) . '</td>		
	// 		</tr>';
	// 		foreach ($mapping_data as $m) {
	// 			if ($m->allowance_name != "") {
	// 				$tblbrk .= '<tr><td colspan="2"  style="border-left-style: hidden;">&nbsp;&nbsp;&nbsp;+' . $m->allowance_name . '</td>
	// 					<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($m->allowance_amount) . '</td></tr>';
	// 			}
	// 		}
	// 		// if($allowances->result() > 0){
	// 		// foreach($allowances->result() as $sl_allowances) {
	// 		// 	$tblbrk .= '<tr>
	// 		// 		<td colspan="2" style="border-left-style: hidden;">'.$sl_allowances->allowance_title.'</td>
	// 		// 		<td style="border-right-style: hidden;">'.$this->Xin_model->currency_sign($sl_allowances->allowance_amount).'</td>	
	// 		// 		<td colspan="2" style="border-left-style: hidden;"></td>
	// 		// 		<td style="border-right-style: hidden;"></td>	
	// 		// 		</tr>';

	// 		// 		$total_allowance +=$sl_allowances->allowance_amount;
	// 		// 	}
	// 		// }
	// 		$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-left-style: hidden;"> Additional Allowances(E)</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->additonal_allowance) . '</td>	
	// 				<td colspan="2"  style="border-left-style: hidden;">Loan</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->total_loan) . '</td>
	// 				</tr>';
	// 		$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-left-style: hidden;">Total Additional(C)</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign((float)$payment[0]->total_other_payments + (float)$payment[0]->total_commissions + (float)$payment[0]->share_option_amount) . '</td>	
	// 				<td colspan="2"  style="border-left-style: hidden;"></td>
	// 				<td style="border-right-style: hidden;"></td>	
	// 				</tr>';
	// 		$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-left-style: hidden;">Total Overtime Pay (D)</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->total_overtime) . '</td>	

	// 				</tr>';
	// 		$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-left-style: hidden;">Total Claim(I)</td>
	// 				<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->claim_amount) . '</td>	

	// 				</tr>';
	// 		// $income=$bs+$total_allowance+$total_other_payment+ $total_commission+$share_option_amount+$total_overtime+$claim_amount;
	// 		// $deduction= $total_deduction + $cpf_employee+$total_loan+$total_leave_deduction;
	// 		$income = (float)$bs + (float)$payment[0]->total_allowances + (float)$payment[0]->total_other_payments + (float) $payment[0]->total_commissions + (float)$payment[0]->share_option_amount + (float)$payment[0]->total_overtime + (float)$payment[0]->claim_amount;
	// 		//$deduction= (float)$payment[0]->deduction_amount + (float)$payment[0]->total_statutory_deductions	 +(float) $payment[0]->cpf_employee_amount+(float)$payment[0]->total_loan+(float)$payment[0]->leave_deduction;
	// 		$deduction = (float)$d_amount + (float) $payment[0]->cpf_employee_amount + (float)$payment[0]->leave_deduction + (float)$payment[0]->total_loan;

	// 		$tblbrk .= '<tr>
	// 				<td colspan="2" style="border-top-style: hidden;"><strong>Total Income</strong></td>
	// 				<td style="border-right-style: hidden;border-top-style: hidden;"><strong>' . $this->Xin_model->currency_sign($income) . '</strong></td>	
	// 				<td colspan="2" style="border-top-style: hidden;"><strong>Total Deduction(F)</strong></td>
	// 				<td style="border-right-style: hidden;border-top-style: hidden;"><strong>' . $this->Xin_model->currency_sign($deduction) . '</strong></td>	
	// 			</tr>';
	// 		$tblbrk .= '</table>';


	// 		$payment_code = "A";

	// 		if ((float)$payment[0]->total_allowances != 0)
	// 			$payment_code .= "+B";
	// 		if ((float)$payment[0]->additonal_allowance != 0)
	// 			$payment_code .= "+E";
	// 		if (((float)$payment[0]->total_other_payments + (float)$payment[0]->total_commissions + (float)$payment[0]->share_option_amount) != 0)
	// 			$payment_code .= "+C";
	// 		if ((float)$payment[0]->total_overtime != 0)
	// 			$payment_code .= "+D";
	// 		if ((float)$payment[0]->claim_amount != 0)
	// 			$payment_code .= "+I";

	// 		$pdf->writeHTML($tblbrk, true, false, true, false, '');
	// 		$net_pay = $income - $deduction;
	// 		$tblbrk1 = '<table cellpadding="4" cellspacing="0" border="1">';
	// 		$tblbrk1 .= '<tr>
	// 		<td colspan="2" style="border-left-style: dden;">Employer CPF</td>
	// 		<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($payment[0]->cpf_employer_amount) . '</td>	
	// 		<td colspan="2"  style="border-left-style: hidden;">Days Worked</td>
	// 		<td style="border-right-style: hidden;">' . $pcount . '</td>	
	// 	</tr>';
	// 		$tblbrk1 .= '<tr>
	// 		<td colspan="2" style="border-left-style: hidden;">Gross Pay(' . $payment_code . ')</td>
	// 		<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($income) . '</td>	
	// 		<td colspan="2"  style="border-left-style: hidden;">Days Off</td>
	// 		<td style="border-right-style: hidden;">' . $lcount . '</td>	
	// 	</tr>';
	// 		$tblbrk1 .= '<tr>
	// 		<td colspan="2" style="border-left-style: hidden;">NET Pay (' . $payment_code . '-F)</td>
	// 		<td style="border-right-style: hidden;">' . $this->Xin_model->currency_sign($net_pay) . '</td>	
	// 		<td colspan="2"  style="border-left-style: hidden;">Balance(Unpaid)</td>
	// 		<td style="border-right-style: hidden;">' . $lcount . '</td>	
	// 		</tr>';
	// 		$tblbrk1 .= '<tr>
	// 		<td colspan="2"  style="border-left-style: hidden;"></td>
	// 		<td style="border-right-style: hidden;"></td>	
	// 		<td colspan="2"  style="border-left-style: hidden;">Remark:</td>
	// 		<td style="border-right-style: hidden;"></td>	
	// 	</tr>';

	// 		$tblbrk1 .= '</table>';
	// 		$pdf->writeHTML($tblbrk1, true, false, true, false, '');

	// 		////////////////// end break salary..
	// 		/*$pdf->Ln(7);
	// 	$tblc = '<table cellpadding="3" cellspacing="0" border="1"><tr>
	// 			<td colspan="2">'.$this->lang->line('xin_payroll_total_earning').'</td>
	// 			<td colspan="2">'.$this->lang->line('xin_payroll_total_deductions').'</td>				
	// 		</tr>
	// 		<tr>
	// 			<td colspan="2">'.$this->Xin_model->currency_sign($total_earning).'</td>
	// 			<td colspan="2">'.$this->Xin_model->currency_sign($total_deductions).'</td>				
	// 		</tr>
	// 		</table>';
	// 	$pdf->writeHTML($tblc, true, false, true, false, '');*/

	// 		/*if(null!=$this->uri->segment(4) && $this->uri->segment(4)=='p') {
	// 	// -----------------------------------------------------------------------------		
	// 	$tbl2 = '';
	// 	// -----------------------------------------------------------------------------
	// 	$txt = 'Payslip Details';

	// 	// Multicell test
	// 	$pdf->MultiCell(180, 6, $txt, 0, 'L', 11, 0, '', '', true);
	// 	$pdf->Ln(7);
	// 	$tbl2 .= '
	// 	<table cellpadding="3" cellspacing="0" border="1">';
	// 		 if($payment[0]->wages_type == 1){
	// 		$tbl2 .= ' <tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_payroll_basic_salary').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->basic_salary).'</td>
	// 		</tr>';
	// 		} else {
	// 			$tbl2 .= ' <tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_employee_daily_wages').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->daily_wages).'</td>
	// 		</tr>';
	// 		}
	// 		if($payment[0]->total_allowances!=0 || $payment[0]->total_allowances!=''):
	// 		$tbl2 .= '<tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_payroll_total_allowance').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->total_allowances).'</td>
	// 		</tr>';
	// 		endif;
	// 		if($payment[0]->total_commissions!=0 || $payment[0]->total_commissions!=''):
	// 		$tbl2 .= '<tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_hr_commissions').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->total_commissions).'</td>
	// 		</tr>';
	// 		endif;
	// 		if($payment[0]->total_loan!=0 || $payment[0]->total_loan!=''):
	// 		$tbl2 .= '<tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_payroll_total_loan').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->total_loan).'</td>
	// 		</tr>';
	// 		endif;
	// 		if($payment[0]->total_overtime!=0 || $payment[0]->total_overtime!=''):
	// 		$tbl2 .= '<tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_payroll_total_overtime').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->total_overtime).'</td>
	// 		</tr>';
	// 		endif;
	// 		if($payment[0]->total_statutory_deductions!=0 || $payment[0]->total_statutory_deductions!=''):
	// 		$tbl2 .= '<tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_employee_set_statutory_deductions').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->total_statutory_deductions).'</td>
	// 		</tr>';
	// 		endif;
	// 		if($payment[0]->total_other_payments!=0 || $payment[0]->total_other_payments!=''):
	// 		$tbl2 .= '<tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_employee_set_other_payment').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign($payment[0]->total_other_payments).'</td>
	// 		</tr>';
	// 		endif;

	// 		$total_earning = $bs + $allowances_amount + $overtime_amount + $commissions_amount + $other_payments_amount;
	// 		$total_deduction = $loan_de_amount + $statutory_deduction_amount;
	// 		$total_net_salary = $total_earning - $total_deduction;
	// 		$tbl2 .= '<tr>
	// 			<td colspan="2">&nbsp;</td>
	// 			<td>'.$this->lang->line('xin_payroll_net_salary').'</td>
	// 			<td align="right">'.$this->Xin_model->currency_sign(number_format($total_net_salary, 2, '.', ',')).'</td>
	// 		</tr>
	// 	</table>
	// 	';

	// 	$pdf->writeHTML($tbl2, true, false, false, false, '');
	// 	}*/
	// 		// $tbl = '
	// 		// <table cellpadding="5" cellspacing="0" border="0">
	// 		// 	<tr>
	// 		// 		<td align="right" colspan="1">This is a computer generated slip and does not require signature.</td>
	// 		// 	</tr>
	// 		// </table>';
	// 		// $pdf->writeHTML($tbl, true, false, false, false, '');

	// 		// ---------------------------------------------------------

	// 		// Close and output PDF document
	// 		// This method has several options, check the source code documentation for more information.
	// 		$fname = strtolower($fname);
	// 		$pay_month = strtolower(date("F Y", strtotime($payment[0]->year_to_date)));
	// 		//Close and output PDF document
	// 		ob_start();
	// 		$pdf->Output('payslip_' . $fname . '_' . $pay_month . '.pdf', 'I');
	// 		ob_end_flush();
	// 	}
	// }
	public function pdf_createv2()
	{

		//$this->load->library('Pdf');
		$system = $this->Xin_model->read_setting_info(1);
		// create new PDF document
		$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

		$id = $this->uri->segment(5);
		$payment = $this->Payroll_model->read_salary_payslip_info($id);
		$user = $this->Xin_model->read_user_info($payment[0]->employee_id);

		// if password generate option enable
		if ($system[0]->is_payslip_password_generate == 1) {
			/**
			 * Protect PDF from being printed, copied or modified. In order to being viewed, the user needs
			 * to provide password as selected format in settings module.
			 */
			if ($system[0]->payslip_password_format == 'dateofbirth') {
				$password_val = date("dmY", strtotime($user[0]->date_of_birth));
			} else if ($system[0]->payslip_password_format == 'contact_no') {
				$password_val = $user[0]->contact_no;
			} else if ($system[0]->payslip_password_format == 'full_name') {
				$password_val = $user[0]->first_name . $user[0]->last_name;
			} else if ($system[0]->payslip_password_format == 'email') {
				$password_val = $user[0]->email;
			} else if ($system[0]->payslip_password_format == 'password') {
				$password_val = $user[0]->password;
			} else if ($system[0]->payslip_password_format == 'user_password') {
				$password_val = $user[0]->username . $user[0]->password;
			} else if ($system[0]->payslip_password_format == 'employee_id') {
				$password_val = $user[0]->employee_id;
			} else if ($system[0]->payslip_password_format == 'employee_id_password') {
				$password_val = $user[0]->employee_id . $user[0]->password;
			} else if ($system[0]->payslip_password_format == 'dateofbirth_name') {
				$dob = date("dmY", strtotime($user[0]->date_of_birth));
				$fname = $user[0]->first_name;
				$lname = $user[0]->last_name;
				$password_val = $dob . $fname[0] . $lname[0];
			}
			$pdf->SetProtection(array('print', 'copy', 'modify'), $password_val, $password_val, 0, null);
		}


		$_des_name = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($_des_name)) {
			$_designation_name = $_des_name[0]->designation_name;
		} else {
			$_designation_name = '';
		}
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$_department_name = $department[0]->department_name;
		} else {
			$_department_name = '';
		}
		//$location = $this->Xin_model->read_location_info($department[0]->location_id);
		// company info
		$company = $this->Xin_model->read_company_info($user[0]->company_id);


		$p_method = '';
		if (!is_null($company)) {
			$company_name = $company[0]->name;
			$address_1 = $company[0]->address_1;
			$address_2 = $company[0]->address_2;
			$city = $company[0]->city;
			$state = $company[0]->state;
			$zipcode = $company[0]->zipcode;
			$country = $this->Xin_model->read_country_info($company[0]->country);
			if (!is_null($country)) {
				$country_name = $country[0]->country_name;
			} else {
				$country_name = '--';
			}
			$c_info_email = $company[0]->email;
			$c_info_phone = $company[0]->contact_number;
		} else {
			$company_name = '--';
			$address_1 = '--';
			$address_2 = '--';
			$city = '--';
			$state = '--';
			$zipcode = '--';
			$country_name = '--';
			$c_info_email = '--';
			$c_info_phone = '--';
		}
		//$pdf = new Pdf('P', 'mm', 'A4', true, 'UTF-8', false);
		// set default header data
		$c_info_address = $address_1 . ' ' . $address_2 . ', ' . $city . ' - ' . $zipcode . ', ' . $country_name;
		$email_phone_address = "" . $this->lang->line('dashboard_email') . " : $c_info_email | " . $this->lang->line('xin_phone') . " : $c_info_phone \n" . $this->lang->line('xin_address') . ": $c_info_address";
		$header_string = $email_phone_address;
		// set document information
		$pdf->SetCreator('HRSALE');
		$pdf->SetAuthor('HRSALE');
		//$pdf->SetTitle('Workable-Zone - Payslip');
		//$pdf->SetSubject('TCPDF Tutorial');
		//$pdf->SetKeywords('TCPDF, PDF, example, test, guide');
		$pdf->SetHeaderData('../../../uploads/logo/payroll/' . $system[0]->payroll_logo, 40, $company_name, $header_string);

		$pdf->setFooterData(array(0, 64, 0), array(0, 64, 128));

		// set header and footer fonts
		$pdf->setHeaderFont(array('helvetica', '', 11.5));
		$pdf->setFooterFont(array('helvetica', '', 9));

		// set default monospaced font
		$pdf->SetDefaultMonospacedFont('courier');

		// set margins
		$pdf->SetMargins(15, 27, 15);
		$pdf->SetHeaderMargin(5);
		$pdf->SetFooterMargin(10);

		// set auto page breaks
		$pdf->SetAutoPageBreak(TRUE, 25);

		// set image scale factor
		$pdf->setImageScale(1.25);
		$pdf->SetAuthor('HRSALE');
		$pdf->SetTitle($company_name . ' - ' . $this->lang->line('xin_print_payslip'));
		$pdf->SetSubject($this->lang->line('xin_payslip'));
		$pdf->SetKeywords($this->lang->line('xin_payslip'));
		// set font
		$pdf->SetFont('helvetica', 'B', 10);

		// set header and footer fonts
		$pdf->setHeaderFont(array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
		$pdf->setFooterFont(array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

		// set default monospaced font
		$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

		// set margins
		$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
		$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
		$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

		// set auto page breaks
		$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

		// set image scale factor
		$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

		// ---------------------------------------------------------

		// set default font subsetting mode
		$pdf->setFontSubsetting(true);

		// Set font
		// dejavusans is a UTF-8 Unicode font, if you only need to
		// print standard ASCII chars, you can use core fonts like
		// helvetica or times to reduce file size.
		$pdf->SetFont('dejavusans', '', 10, '', true);

		// Add a page
		// This method has several options, check the source code documentation for more information.
		$pdf->AddPage();
		// -----------------------------------------------------------------------------
		$fname = $user[0]->first_name . ' ' . $user[0]->last_name;
		$created_at = $this->Xin_model->set_date_format($payment[0]->created_at);
		$date_of_joining = $this->Xin_model->set_date_format($user[0]->date_of_joining);
		$salary_month = $this->Xin_model->set_date_format($payment[0]->salary_month);
		// basic salary
		$bs = 0;
		if ($payment[0]->basic_salary != '') {
			$bs = $payment[0]->basic_salary;
		} else {
			$bs = $payment[0]->daily_wages;
		}
		// allowances
		$count_allowances = $this->Employees_model->count_employee_allowances_payslip($payment[0]->payslip_id);
		$allowances = $this->Employees_model->set_employee_allowances_payslip($payment[0]->payslip_id);
		// commissions
		$count_commissions = $this->Employees_model->count_employee_commissions_payslip($payment[0]->payslip_id);
		$commissions = $this->Employees_model->set_employee_commissions_payslip($payment[0]->payslip_id);
		// otherpayments
		$count_other_payments = $this->Employees_model->count_employee_other_payments_payslip($payment[0]->payslip_id);
		$other_payments = $this->Employees_model->set_employee_other_payments_payslip($payment[0]->payslip_id);
		// statutory_deductions
		$count_statutory_deductions = $this->Employees_model->count_employee_statutory_deductions_payslip($payment[0]->payslip_id);
		$statutory_deductions = $this->Employees_model->set_employee_statutory_deductions_payslip($payment[0]->payslip_id);
		// overtime
		$count_overtime = $this->Employees_model->count_employee_overtime_payslip($payment[0]->payslip_id);
		$overtime = $this->Employees_model->set_employee_overtime_payslip($payment[0]->payslip_id);
		// loan
		$count_loan = $this->Employees_model->count_employee_deductions_payslip($payment[0]->payslip_id);
		$loan = $this->Employees_model->set_employee_deductions_payslip($payment[0]->payslip_id);
		//
		$statutory_deduction_amount = 0;
		$loan_de_amount = 0;
		$allowances_amount = 0;
		$commissions_amount = 0;
		$other_payments_amount = 0;
		$overtime_amount = 0;
		// laon
		if ($count_loan > 0) :
			foreach ($loan->result() as $r_loan) {
				$loan_de_amount += $r_loan->loan_amount;
			}
			$loan_de_amount = $loan_de_amount;
		else :
			$loan_de_amount = 0;
		endif;
		// allowances
		$loan_de_amount = number_format(floatval($loan_de_amount), 2);
		$allowances_amount = 0;
		foreach ($allowances->result() as $sl_allowances) {
			$allowances_amount += $sl_allowances->allowance_amount;
		}
		// commission
		$commissions_amount = 0;
		foreach ($commissions->result() as $sl_commissions) {
			$commissions_amount += $sl_commissions->commission_amount;
		}
		// statutory deduction
		$statutory_deduction_amount = 0;
		foreach ($statutory_deductions->result() as $sl_statutory_deductions) {
			//$statutory_deduction_amount += $sl_statutory_deductions->deduction_amount;
			if ($system[0]->statutory_fixed != 'yes') :
				$sta_salary = $bs;
				$st_amount = $sta_salary / 100 * $sl_statutory_deductions->deduction_amount;
				$statutory_deduction_amount += $st_amount;
			else :
				$statutory_deduction_amount += $sl_statutory_deductions->deduction_amount;
			endif;
		}
		// other amount
		$other_payments_amount = 0;
		foreach ($other_payments->result() as $sl_other_payments) {
			$other_payments_amount += $sl_other_payments->payments_amount;
		}
		// overtime
		$overtime_amount = 0;
		foreach ($overtime->result() as $r_overtime) {
			$overtime_total = $r_overtime->overtime_hours * $r_overtime->overtime_rate;
			$overtime_amount += $overtime_total;
		}
		$tbl = '<br><br>
		<table cellpadding="1" cellspacing="1" border="0">
			<tr>
				<td align="center"><h1>' . $this->lang->line('xin_payslip') . '</h1></td>
			</tr>
			<tr>
				<td align="center"><strong>' . $this->lang->line('xin_payslip_number') . ':</strong> #' . $payment[0]->payslip_id . '</td>
			</tr>
			<tr>
				<td align="center"><strong>' . $this->lang->line('xin_salary_month') . ':</strong> ' . date("F Y", strtotime($payment[0]->year_to_date)) . '</td>
			</tr>
		</table>
		';
		$pdf->writeHTML($tbl, true, false, false, false, '');
		// -----------------------------------------------------------------------------
		// set cell padding
		$pdf->setCellPaddings(1, 1, 1, 1);

		// set cell margins
		$pdf->setCellMargins(0, 0, 0, 0);

		// set color for background
		$pdf->SetFillColor(255, 255, 127);
		// set some text for example
		$txt = 'Employee Details';
		// Multicell
		$pdf->MultiCell(180, 6, $txt, 0, 'L', 11, 0, '', '', true);
		$pdf->Ln(7);
		$tbl1 = '
		<table cellpadding="3" cellspacing="0" border="1">
			<tr>
				<td>' . $this->lang->line('xin_name') . '</td>
				<td>' . $fname . '</td>
				<td>' . $this->lang->line('dashboard_employee_id') . '</td>
				<td>' . $user[0]->employee_id . '</td>
			</tr>
			<tr>
				<td>' . $this->lang->line('left_department') . '</td>
				<td>' . $_department_name . '</td>
				<td>' . $this->lang->line('left_designation') . '</td>
				<td>' . $_designation_name . '</td>
			</tr>
			<tr>
				<td>' . $this->lang->line('xin_e_details_date') . '</td>
				<td>' . date("d F, Y") . '</td>
				<td>' . $this->lang->line('xin_payslip_number') . '</td>
				<td>' . $payment[0]->payslip_id . '</td>
			</tr>
		</table>
		';

		$pdf->writeHTML($tbl1, true, false, true, false, '');

		$total_earning = $bs + $allowances_amount + $commissions_amount + $other_payments_amount + $overtime_amount;
		$total_deductions = floatval($loan_de_amount) + $statutory_deduction_amount;
		$pdf->Ln(7);
		$tblc = '<table cellpadding="3" cellspacing="0" border="1"><tr>
				<td colspan="2">' . $this->lang->line('xin_payroll_total_earning') . '</td>
				<td colspan="2">' . $this->lang->line('xin_payroll_total_deductions') . '</td>				
			</tr>
			<tr>
				<td colspan="2">' . $this->Xin_model->currency_sign($total_earning, $user[0]->user_id) . '</td>
				<td colspan="2">' . $this->Xin_model->currency_sign($total_deductions, $user[0]->user_id) . '</td>				
			</tr>
			</table>';
		$pdf->writeHTML($tblc, true, false, true, false, '');

		if (null != $this->uri->segment(4) && $this->uri->segment(4) == 'p') {
			// -----------------------------------------------------------------------------		
			$tbl2 = '';
			// -----------------------------------------------------------------------------
			$txt = 'Payslip Details';

			// Multicell test
			$pdf->MultiCell(180, 6, $txt, 0, 'L', 11, 0, '', '', true);
			$pdf->Ln(7);
			$tbl2 .= '
		<table cellpadding="3" cellspacing="0" border="1">';
			if ($payment[0]->wages_type == 1) {
				$tbl2 .= ' <tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_payroll_basic_salary') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->basic_salary, $user[0]->user_id) . '</td>
			</tr>';
			} else {
				$tbl2 .= ' <tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_employee_daily_wages') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->daily_wages, $user[0]->user_id) . '</td>
			</tr>';
			}
			if ($payment[0]->total_allowances != 0 || $payment[0]->total_allowances != '') :
				$tbl2 .= '<tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_payroll_total_allowance') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->total_allowances, $user[0]->user_id) . '</td>
			</tr>';
			endif;
			if ($payment[0]->total_commissions != 0 || $payment[0]->total_commissions != '') :
				$tbl2 .= '<tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_hr_commissions') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->total_commissions, $user[0]->user_id) . '</td>
			</tr>';
			endif;
			if ($payment[0]->total_loan != 0 || $payment[0]->total_loan != '') :
				$tbl2 .= '<tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_payroll_total_loan') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->total_loan, $user[0]->user_id) . '</td>
			</tr>';
			endif;
			if ($payment[0]->total_overtime != 0 || $payment[0]->total_overtime != '') :
				$tbl2 .= '<tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_payroll_total_overtime') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->total_overtime, $user[0]->user_id) . '</td>
			</tr>';
			endif;
			if ($payment[0]->total_statutory_deductions != 0 || $payment[0]->total_statutory_deductions != '') :
				$tbl2 .= '<tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_employee_set_statutory_deductions') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->total_statutory_deductions, $user[0]->user_id) . '</td>
			</tr>';
			endif;
			if ($payment[0]->total_other_payments != 0 || $payment[0]->total_other_payments != '') :
				$tbl2 .= '<tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_employee_set_other_payment') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign($payment[0]->total_other_payments, $user[0]->user_id) . '</td>
			</tr>';
			endif;
			/*if($payment[0]->wages_type == 1){
				$bs = $payment[0]->basic_salary;
			} else {
				$bs = $payment[0]->daily_wages;
			}*/
			$total_earning = $bs + $allowances_amount + $overtime_amount + $commissions_amount + $other_payments_amount;
			$total_deduction = floatval($loan_de_amount) + $statutory_deduction_amount;
			$total_net_salary = $total_earning - $total_deduction;
			$tbl2 .= '<tr>
				<td colspan="2">&nbsp;</td>
				<td>' . $this->lang->line('xin_payroll_net_salary') . '</td>
				<td align="right">' . $this->Xin_model->currency_sign(number_format($total_net_salary, 2, '.', ','), $user[0]->user_id) . '</td>
			</tr>
		</table>
		';

			$pdf->writeHTML($tbl2, true, false, false, false, '');
		}
		$tbl = '
		<table cellpadding="5" cellspacing="0" border="0">
			<tr>
				<td align="right" colspan="1">This is a computer generated slip and does not require signature.</td>
			</tr>
		</table>';
		$pdf->writeHTML($tbl, true, false, false, false, '');

		// ---------------------------------------------------------

		// Close and output PDF document
		// This method has several options, check the source code documentation for more information.
		$fname = strtolower($fname);
		$pay_month = strtolower(date("F Y", strtotime($payment[0]->year_to_date)));
		//Close and output PDF document
		ob_start();
		$pdf->Output('payslip_' . $fname . '_' . $pay_month . '.pdf', 'I');
		ob_end_flush();
	}

	// get company > employees
	public function get_employees()
	{

		$data['title'] = $this->Xin_model->site_title();
		$id = $this->uri->segment(4);

		$data = array(
			'company_id' => $id
		);
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			$this->load->view("admin/payroll/get_employees", $data);
		} else {
			redirect('admin/');
		}
		// Datatables Variables
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));
	}

	// make payment info by id
	public function make_payment_view()
	{
		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		$data['title'] = $this->Xin_model->site_title();
		$id = $this->input->get('pay_id');
		// $data['all_countries'] = $this->xin_model->get_countries();
		$result = $this->Payroll_model->read_make_payment_information($id);
		// get addd by > template
		$user = $this->Xin_model->read_user_info($result[0]->employee_id);
		// get designation
		$designation = $this->Designation_model->read_designation_information($user[0]->designation_id);
		if (!is_null($designation)) {
			$designation_name = $designation[0]->designation_name;
		} else {
			$designation_name = '--';
		}
		// department
		$department = $this->Department_model->read_department_information($user[0]->department_id);
		if (!is_null($department)) {
			$department_name = $department[0]->department_name;
		} else {
			$department_name = '--';
		}

		$data = array(
			'first_name' => $user[0]->first_name,
			'last_name' => $user[0]->last_name,
			'employee_id' => $user[0]->employee_id,
			'department_name' => $department_name,
			'designation_name' => $designation_name,
			'date_of_joining' => $user[0]->date_of_joining,
			'profile_picture' => $user[0]->profile_picture,
			'gender' => $user[0]->gender,
			'monthly_grade_id' => $user[0]->monthly_grade_id,
			'hourly_grade_id' => $user[0]->hourly_grade_id,
			'basic_salary' => $result[0]->basic_salary,
			//'is_half_monthly' => $user[0]->is_half_monthly,
			//'half_deduct_month' => $user[0]->half_deduct_month,
			'payment_date' => $result[0]->payment_date,
			'payment_method' => $result[0]->payment_method,
			'overtime_rate' => $result[0]->overtime_rate,
			'hourly_rate' => $result[0]->hourly_rate,
			'total_hours_work' => $result[0]->total_hours_work,
			'is_payment' => $result[0]->is_payment,
			'is_advance_salary_deduct' => $result[0]->is_advance_salary_deduct,
			'advance_salary_amount' => $result[0]->advance_salary_amount,
			'house_rent_allowance' => $result[0]->house_rent_allowance,
			'medical_allowance' => $result[0]->medical_allowance,
			'travelling_allowance' => $result[0]->travelling_allowance,
			'dearness_allowance' => $result[0]->dearness_allowance,
			'provident_fund' => $result[0]->provident_fund,
			'security_deposit' => $result[0]->security_deposit,
			'tax_deduction' => $result[0]->tax_deduction,
			'gross_salary' => $result[0]->gross_salary,
			'total_allowances' => $result[0]->total_allowances,
			'total_deductions' => $result[0]->total_deductions,
			'net_salary' => $result[0]->net_salary,
			'payment_amount' => $result[0]->payment_amount,
			'comments' => $result[0]->comments,
		);
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			$this->load->view('admin/payroll/dialog_payslip', $data);
		} else {
			redirect('admin/');
		}
	}

	public function payslip_delete()
	{

		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		/* Define return | here result is used to return user data and error for error message */
		$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
		$id = $this->uri->segment(4);
		$Return['csrf_hash'] = $this->security->get_csrf_hash();
		$this->Payroll_model->delete_payslip_mapping_salary_backup($id);
		$result = $this->Payroll_model->delete_record($id);
		if (isset($id)) {
			$this->db->delete('xin_salary_payslips_check', ['payslip_id' => $id]);
			// $this->db->delete('xin_general', ['payslip_id' => $id]);
			// $this->db->delete('xin_motivation', ['payslip_id' => $id]);
			$this->db->delete('xin_salary_deduction', ['payslip_id' => $id]);
			$this->Payroll_model->delete_payslip_allowances_items($id);
			$this->Payroll_model->delete_payslip_commissions_items($id);
			$this->Payroll_model->delete_payslip_other_payment_items($id);
			$this->Payroll_model->delete_payslip_statutory_deductions_items($id);
			$this->Payroll_model->delete_payslip_overtime_items($id);
			$this->Payroll_model->delete_payslip_loan_items($id);
			$this->Contribution_fund_model->delete_contribution_payslip($id);
			$this->Cpf_payslip_model->delete_cpf_payslip($id);
			$this->Payroll_model->delete_payslip_share_options($id);
			$this->Payroll_model->delete_payslip_leave_deduction($id);
			$this->Payroll_model->delete_payslip_mapping($id);

			$Return['result'] = $this->lang->line('xin_hr_payslip_deleted');
		} else {
			$Return['error'] = $this->lang->line('xin_error_msg');
		}
		$this->output($Return);
	}

	public function payslip_delete_all($id)
	{

		$session = $this->session->userdata('username');
		if (empty($session)) {
			redirect('admin/');
		}
		/* Define return | here result is used to return user data and error for error message */
		$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
		$id = $id;
		$Return['csrf_hash'] = $this->security->get_csrf_hash();
		$this->Payroll_model->delete_record($id);
		$this->Payroll_model->delete_payslip_allowances_items($id);
		$this->Payroll_model->delete_payslip_commissions_items($id);
		$this->Payroll_model->delete_payslip_other_payment_items($id);
		$this->Payroll_model->delete_payslip_statutory_deductions_items($id);
		$this->Payroll_model->delete_payslip_overtime_items($id);
		$this->Payroll_model->delete_payslip_loan_items($id);
	}

	// get company > locations
	public function get_company_plocations()
	{

		$data['title'] = $this->Xin_model->site_title();
		$keywords = preg_split("/[\s,]+/", $this->uri->segment(4));
		if (is_numeric($keywords[0])) {
			$id = $keywords[0];

			$data = array(
				'company_id' => $id
			);
			$session = $this->session->userdata('username');
			if (!empty($session)) {
				$data = $this->security->xss_clean($data);
				$this->load->view("admin/payroll/get_company_plocations", $data);
			} else {
				redirect('admin/');
			}
		}
		// Datatables Variables
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));
	}

	// get location > departments
	public function get_location_pdepartments()
	{

		$data['title'] = $this->Xin_model->site_title();
		$keywords = preg_split("/[\s,]+/", $this->uri->segment(4));
		if (is_numeric($keywords[0])) {
			$id = $keywords[0];

			$data = array(
				'location_id' => $id
			);
			$session = $this->session->userdata('username');
			if (!empty($session)) {
				$data = $this->security->xss_clean($data);
				$this->load->view("admin/payroll/get_location_pdepartments", $data);
			} else {
				redirect('admin/');
			}
		}
		// Datatables Variables
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));
	}

	public function get_department_pdesignations()
	{

		$data['title'] = $this->Xin_model->site_title();
		$id = $this->uri->segment(4);

		$data = array(
			'department_id' => $id,
			'all_designations' => $this->Designation_model->all_designations(),
		);
		$session = $this->session->userdata('username');
		if (!empty($session)) {
			$this->load->view("admin/payroll/get_department_pdesignations", $data);
		} else {
			redirect('admin/');
		}
		// Datatables Variables
		$draw = intval($this->input->get("draw"));
		$start = intval($this->input->get("start"));
		$length = intval($this->input->get("length"));
	}

	// Validate and update info in database // update_status
	public function update_payroll_status()
	{

		if ($this->input->post('type') == 'update_status') {
			/* Define return | here result is used to return user data and error for error message */
			$Return = array('result' => '', 'error' => '', 'csrf_hash' => '');
			$Return['csrf_hash'] = $this->security->get_csrf_hash();
			if ($this->input->post('status') === '') {
				$Return['error'] = $this->lang->line('xin_error_template_status');
			}
			if ($Return['error'] != '') {
				$this->output($Return);
			}
			$data = array(
				'status' => $this->input->post('status'),
			);
			$id = $this->input->post('payroll_id');
			$result = $this->Payroll_model->update_payroll_status($data, $id);
			if ($result == TRUE) {
				if ($this->input->post('status') == 1) {
					$Return['result'] = $this->lang->line('xin_role_first_level_approved');
				} else if ($this->input->post('status') == 2) {
					$Return['result'] = $this->lang->line('xin_approved_final_payroll_title');
				} else {
					$Return['result'] = $this->lang->line('xin_disabled_payroll_title');
				}
			} else {
				$Return['error'] = $this->lang->line('xin_error_msg');
			}
			$this->output($Return);
			exit;
		}
	}
	public function get_contribution_amount()
	{
		// $basic_salary=$_GET['basic_salary'];
		$user_id = $_GET['user_id'];
		$gross_salary = $_GET['gross_salary'];
		$emp_dob = $_GET['emp_dob'];
		$g_additional_wage = $_GET['g_additional_wage'];
		$g_ordinary_wage = $gross_salary;
		/*CPF start */
		$today = new DateTime('01-' . $this->input->get('pay_date'));
		$dob = new DateTime($emp_dob);
		$age = $dob->diff($today);
		$age_year = $age->y;
		$age_month = $age->m;

		$age_upto = $this->Cpf_options_model->get_option_value('emp_upto_age')->option_value;
		$age_above = $this->Cpf_options_model->get_option_value('emp_above_age')->option_value;
		$ordinary_wage_cap = $this->Cpf_options_model->get_option_value('ordinary_wage_cap')->option_value;

		if ($age_month > 0) {
			$age_year = $age_year + 1;
		}
		if ($age_year < $age_upto) {
			$age_from = null;
			$age_to = $age_year;
		} elseif ($age_year > $age_above) {
			$age_from = $age_year;
			$age_to = null;
		} elseif ($age_year > $age_upto && $age_year <= $age_above) {
			$age_from = $age_year;
			$age_to = $age_year;
		} else {
			$age_from = null;
			$age_to = null;
		}

		$im_status = $this->Employees_model->getEmployeeImmigrationStatus($user_id);
		$cpf_contribution = '';
		if ($im_status) {
			$immigration_id = $im_status->immigration_id;
			if ($immigration_id == 2) {
				$issue_date = $im_status->issue_date;
				$i_date = new DateTime($issue_date);
				$today = new DateTime();
				$pr_age = $i_date->diff($today);
				$pr_age_year = $pr_age->y;
				$pr_age_month = $pr_age->m;
				//echo $pr_age_year;exit;
				// if($pr_age_year == 0 && $pr_age_month > 0) {
				if ($pr_age_year == 0 && ($pr_age_month > 0 || $pr_age_month == 0)) {
					// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
					$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
					// }elseif($pr_age_year == 1 && $pr_age_month > 0) {
				} else if ($pr_age_year == 1 && $pr_age_month == 0) {
					// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 1);
					$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,  1);
					// }elseif($pr_age_year == 1 && $pr_age_month > 0) {
				} elseif ($pr_age_year == 1 && $pr_age_month > 0) {
					// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
					$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
					// print_r($pr_age_month);exit;
				} elseif ($pr_age_year == 2 && $pr_age_month == 0) {
					// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 2, 2);
					$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to, 2);
					// print_r($pr_age_month);exit;
				}
				// elseif($pr_age_year >= 2) {
				// 	// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year,2, $age_from, $age_to, 1);
				// 	$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 2, $age_from, $age_to,1);
				// }
				elseif ($pr_age_year >= 2) {
					$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 1, $age_from, $age_to);
				}
			} elseif ($immigration_id == 1) {
				// $cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, $age_from, $age_to, 1);
				$cpf_contribution = $this->Cpf_percentage_model->get_cpf_contribution_by_age($age_year, 1, $age_from, $age_to);
			}
			if ($immigration_id == 1 || $immigration_id == 2) {
				if ($cpf_contribution) {
					$employee_contribution = $cpf_contribution->contribution_employee;
					$employer_contribution = $cpf_contribution->contribution_employer;
					$total_cpf_contribution = $cpf_contribution->total_cpf;

					// $ordinary_wage = ($allowance_amount + $basic_salary + $overtime_amount + $all_other_payment + $commissions_amount ) - ($loan_de_amount + $statutory_deductions_amount);
					$ordinary_wage = $g_ordinary_wage;

					if ($ordinary_wage > $ordinary_wage_cap) {
						$ow = $ordinary_wage_cap;
					} else {
						$ow = $ordinary_wage;
					}

					// $cpf_total_ow = round(($total_cpf_contribution * $ow) / 100);
					// $ow_cpf_employee = floor(($employee_contribution * $ow) / 100);
					// $ow_cpf_employer = $cpf_total_ow - $ow_cpf_employee;


					// $aw = $g_additional_wage;
					// $cpf_total_aw = round(($total_cpf_contribution * $aw) / 100);
					// $aw_cpf_employee = floor(($employee_contribution * $aw) / 100);
					// $aw_cpf_employer = $cpf_total_aw - $aw_cpf_employee;


					// $cpf_employee = $ow_cpf_employee + $aw_cpf_employee;
					// $cpf_employer = $ow_cpf_employer + $aw_cpf_employer;



					// $cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
					// $cpf_employer = number_format((float)$cpf_employer, 2, '.', '');

					/*immigration id 1 cpf count start */
					if ($immigration_id == 1) {
						$aw = $g_additional_wage;
						$tw = $aw + $ow;
						if ($age_year <= 55) {
							if ($tw < 50) {
								$cpf_employee = 0;
								$cpf_employer = 0;
							} else if ($tw > 50 && $tw <= 500) {
								$cpf_employee = 0;
								$cpf_employer = round((17 / 100 * $tw) - $cpf_employee);
							} else if ($tw > 500 && $tw <= 750) {
								$cpf_employee = floor(0.6 * ($tw - 500));
								$cpf_employer = round((17 / 100 * $tw) + ($cpf_employee) - $cpf_employee);
							} else if ($tw > 750) {
								$cpf_employee = floor(20 / 100 * $ow + 20 / 100 * $aw);
								$cpf_employer = round((37 / 100 * $ow + 37 / 100 * $aw) - $cpf_employee);
								// if ($count_cpf_employer > 2220) {
								// 	$cpf_employer = 2220;
								// } else {
								// 	$cpf_employer = $count_cpf_employer;
								// }
								// if ($count_cpf_employee > 1200) {
								// 	$cpf_employee = 1200;
								// } else {
								// 	$cpf_employee = $count_cpf_employee;
								// }
							}
						} else if ($age_year > 55 && $age_year <= 60) {
							if ($tw < 50) {
								$cpf_employee = 0;
								$cpf_employer = 0;
							} else if ($tw > 50 && $tw <= 500) {
								$cpf_employee = 0;
								$cpf_employer = round((15 / 100 * $tw) - $cpf_employee);
							} else if ($tw > 500 && $tw <= 750) {
								$cpf_employee = floor(0.48 * ($tw - 500));
								$cpf_employer = round((15 / 100 * ($tw) + 0.48 * ($tw - 500)) - $cpf_employee);
								// print_r($cpf_employer);
							} else if ($tw > 750) {
								$cpf_employee = floor(16 / 100 * $tw);
								// + 15 / 100 * $aw;
								$cpf_employer = round(31 / 100 * ($tw) - $cpf_employee);
								// + 29.5 / 100 * ($aw);
								// if ($count_cpf_employer > 1770) {
								// 	$cpf_employer = 1770;
								// } else {
								// 	$cpf_employer = $count_cpf_employer;
								// }
								// if ($count_cpf_employee > 900) {
								// 	$cpf_employee = 900;
								// } else {
								// 	$cpf_employee = $count_cpf_employee;
								// }
							}
						} else if ($age_year > 60 && $age_year <= 65) {
							if ($tw < 50) {
								$cpf_employee = 0;
								$cpf_employer = 0;
							} else if ($tw > 50 && $tw <= 500) {
								$cpf_employee = 0;
								$cpf_employer = round(11 / 100 * $tw);
							} else if ($tw > 500 && $tw <= 750) {
								$cpf_employee = floor(0.285 * ($tw - 500));
								$cpf_employer = round((11 / 100 * $tw + 0.285 * ($tw - 500)) - $cpf_employee);
							} else if ($tw > 750) {
								$cpf_employee = floor(10.5 / 100 * $tw);
								$cpf_employer = round((22 / 100 * $tw) - $cpf_employee);

								// if ($count_cpf_employer > 1230) {
								// 	$cpf_employer = 1230;
								// } else {
								// 	$cpf_employer = $count_cpf_employer;
								// }
								// if ($count_cpf_employee > 570) {
								// 	$cpf_employee = 570;
								// } else {
								// 	$cpf_employee = $count_cpf_employee;
								// }
							}
						} else if ($age_year > 65 && $age_year <= 70) {
							if ($tw < 50) {
								$cpf_employee = 0;
								$cpf_employer = 0;
							} else if ($tw > 50 && $tw <= 500) {
								$cpf_employee = 0;
								$cpf_employer = round(9 / 100 * $tw);
							} else if ($tw > 500 && $tw <= 750) {
								// (9% x $750.00) + 0.225($750.00 - $500.00);

								$cpf_employee = floor(0.225 * ($tw - 500));
								$cpf_employer = round((9 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
							} else if ($tw > 750) {
								$cpf_employee = floor(7.5 / 100 * $tw);
								$cpf_employer = round((16.5 / 100 * $tw) - $cpf_employee);

								// if ($count_cpf_employer > 930) {
								// 	$cpf_employer = 930;
								// } else {
								// 	$cpf_employer = $count_cpf_employer;
								// }
								// if ($count_cpf_employee > 420) {
								// 	$cpf_employee = 420;
								// } else {
								// 	$cpf_employee = $count_cpf_employee;
								// }
							}
						} else if ($age_year > 70) {
							if ($tw < 50) {
								$cpf_employee = 0;
								$cpf_employer = 0;
							} else if ($tw > 50 && $tw <= 500) {
								$cpf_employee = 0;
								$cpf_employer = round(7.5 / 100 * $tw);
							} else if ($tw > 500 && $tw <= 750) {
								$cpf_employee =  floor(0.15 * ($tw - 500));
								$cpf_employer = round((7.5 / 100 * $tw) + 0.15 * ($tw - 500) - $cpf_employee);
							} else if ($tw > 750) {

								$cpf_employee = floor(5 / 100 * $tw);
								$cpf_employer = round((12.5 / 100 * $tw) - $cpf_employee);

								// if ($count_cpf_employer > 750) {
								// 	$cpf_employer = 750;
								// } else {
								// 	$cpf_employer = $count_cpf_employer;
								// }
								// if ($count_cpf_employee > 300) {
								// 	$cpf_employee = 300;
								// } else {
								// 	$cpf_employee = $count_cpf_employee;
								// }
							}
						}
					}

					/* immigration id 1 cpf count end */
					if ($im_status->issue_date) {
						$issue_date = $im_status->issue_date;
						if ($issue_date != "") {
							$i_date = new DateTime($issue_date);

							$today = new DateTime();
							$pr_age = $i_date->diff($today);
							$pr_age_year = $pr_age->y;
							$pr_age_month = $pr_age->m;
							/* new CPF calculation Start*/
							$aw = $g_additional_wage;
							$tw = $ow + $aw;
							if ($pr_age_year == 1) {

								if ($age_year <= 55) {
									if ($tw > 50 && $tw < 500) {
										$cpf_employee = 0;
										$cpf_employer = round(4 / 100 * $tw);
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$cpf_employer = round((4 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
										$cpf_employer = round(((9 / 100) * $ow + (9 / 100) * $aw) - $cpf_employee);

										// if ($count_cpf_employee > 300) {
										// 	$cpf_employee = 300;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
										// if ($count_cpf_employer > 540) {
										// 	$cpf_employer = 540;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw > 50 && $tw < 500) {
										$cpf_employee = 0;
										$cpf_employer = round(4 / 100 * $tw);
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$cpf_employer = round((4 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
										$cpf_employer = round(((9 / 100) * $ow + (9 / 100) * $aw) - $cpf_employee);

										// if ($count_cpf_employee > 300) {
										// 	$cpf_employee = 300;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
										// if ($count_cpf_employer > 540) {
										// 	$cpf_employer = 540;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw > 50 && $tw < 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$cpf_employer = round(3.5 / 100 * $tw + 0.15 * ($tw - 500));
									} else if ($tw > 750) {
										$cpf_employee = floor(5 / 100 * $tw);
										$cpf_employer = round(((8.5 / 100) * $tw) - $cpf_employee);

										// if ($count_cpf_employee > 300) {
										// 	$cpf_employee = 300;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
										// if ($count_cpf_employer > 510) {
										// 	$cpf_employer = 510;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
									}
								} else if ($age_year > 65) {
									if ($tw > 50 && $tw < 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw < 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$cpf_employer = round((3.5 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor((5 / 100) * $ow + (5 / 100) * $aw);
										$cpf_employer = round(((8.5 / 100) * $ow + (8.5 / 100) * $aw) - $cpf_employee);

										// if ($count_cpf_employee > 300) {
										// 	$cpf_employee = 300;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
										// if ($count_cpf_employer > 510) {
										// 	$cpf_employer = 510;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
									}
								}
							}
							if ($pr_age_year == 2) {
								if ($age_year <= 55) {

									if ($tw <= 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0 * $tw;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.45 * ($tw - 500));
										$cpf_employer = round((9 / 100 * $tw + 0.45 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(15 / 100 * $tw);
										$cpf_employer = round(24 / 100 * $tw) - $cpf_employee;
										// if ($count_cpf_employer > 1440) {
										// 	$cpf_employer = 1440;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 900) {
										// 	$cpf_employee = 900;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw <= 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(6 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.375 * ($tw - 500));
										$cpf_employer = round((6 / 100 * $tw + 0.375 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(7.5 / 100 * $tw);
										$cpf_employer = round((11 / 100 * $tw) - $cpf_employee);
										// if ($count_cpf_employer > 1110) {
										// 	$cpf_employer = 1110;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 750) {
										// 	$cpf_employee = 750;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw <= 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.225 * ($tw - 500));
										$cpf_employer = round((3.5 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(7.5 / 100 * $tw);
										$cpf_employer = round((11 / 100 * $tw) - $cpf_employee);
										// if ($count_cpf_employer > 1110) {
										// 	$cpf_employer = 1110;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 750) {
										// 	$cpf_employee = 750;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 65) {
									if ($tw <= 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(3.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.15 * ($tw - 500));
										$cpf_employer = round((3.5 / 100 * $tw + 0.15 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(5 / 100 * $tw);
										$cpf_employer = round((8.5 / 100 * $tw) - $cpf_employee);
										// if ($count_cpf_employer > 1110) {
										// 	$cpf_employer = 1110;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 750) {
										// 	$cpf_employee = 750;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								}
							}
							if ($pr_age_year == 3 || $pr_age_year > 3) {
								if ($age_year <= 55) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round((17 / 100 * $tw) - $cpf_employee);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.6 * ($tw - 500));
										$cpf_employer = round((17 / 100 * $tw) + ($cpf_employee) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(20 / 100 * $ow + 20 / 100 * $aw);
										$cpf_employer = round((37 / 100 * $ow + 37 / 100 * $aw) - $cpf_employee);
										// if ($count_cpf_employer > 2220) {
										// 	$cpf_employer = 2220;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 1200) {
										// 	$cpf_employee = 1200;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 55 && $age_year <= 60) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round((15 / 100 * $tw) - $cpf_employee);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.48 * ($tw - 500));
										$cpf_employer = round((15 / 100 * ($tw) + 0.48 * ($tw - 500)) - $cpf_employee);
										// print_r($cpf_employer);
									} else if ($tw > 750) {
										$cpf_employee = floor(16 / 100 * $tw);
										// + 15 / 100 * $aw;
										$cpf_employer = round(31 / 100 * ($tw) - $cpf_employee);
										// + 29.5 / 100 * ($aw);
										// if ($count_cpf_employer > 1770) {
										// 	$cpf_employer = 1770;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 900) {
										// 	$cpf_employee = 900;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 60 && $age_year <= 65) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(11 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee = floor(0.285 * ($tw - 500));
										$cpf_employer = round((11 / 100 * $tw + 0.285 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(10.5 / 100 * $tw);
										$cpf_employer = round((22 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 1230) {
										// 	$cpf_employer = 1230;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 570) {
										// 	$cpf_employee = 570;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 65 && $age_year <= 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(9 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										// (9% x $750.00) + 0.225($750.00 - $500.00);

										$cpf_employee = floor(0.225 * ($tw - 500));
										$cpf_employer = round((9 / 100 * $tw + 0.225 * ($tw - 500)) - $cpf_employee);
									} else if ($tw > 750) {
										$cpf_employee = floor(7.5 / 100 * $tw);
										$cpf_employer = round((16.5 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 930) {
										// 	$cpf_employer = 930;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 420) {
										// 	$cpf_employee = 420;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								} else if ($age_year > 70) {
									if ($tw < 50) {
										$cpf_employee = 0;
										$cpf_employer = 0;
									} else if ($tw > 50 && $tw <= 500) {
										$cpf_employee = 0;
										$cpf_employer = round(7.5 / 100 * $tw);
									} else if ($tw > 500 && $tw <= 750) {
										$cpf_employee =  floor(0.15 * ($tw - 500));
										$cpf_employer = round((7.5 / 100 * $tw) + 0.15 * ($tw - 500) - $cpf_employee);
									} else if ($tw > 750) {

										$cpf_employee = floor(5 / 100 * $tw);
										$cpf_employer = round((12.5 / 100 * $tw) - $cpf_employee);

										// if ($count_cpf_employer > 750) {
										// 	$cpf_employer = 750;
										// } else {
										// 	$cpf_employer = $count_cpf_employer;
										// }
										// if ($count_cpf_employee > 300) {
										// 	$cpf_employee = 300;
										// } else {
										// 	$cpf_employee = $count_cpf_employee;
										// }
									}
								}
							}
						}
					}

					/* new CPF calculation End*/
					$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
					$cpf_total = $cpf_employee + $cpf_employer;

					$cpf_employee = number_format((float)$cpf_employee, 2, '.', '');
					$cpf_employer = number_format((float)$cpf_employer, 2, '.', '');
					$cpf_total    = number_format((float)$cpf_total, 2, '.', '');
				}
			} else {
				$ordinary_wage = $g_ordinary_wage;
				$ow = $ordinary_wage;
				$ow_cpf_employee = 0;
				$ow_cpf_employer = 0;

				$aw = $g_additional_wage;
				$aw_cpf_employee = 0;
				$aw_cpf_employer = 0;
			}
		}
		/* CPF END */
		/*contribution Funds*/
		$employee_contributions = $this->Contribution_fund_model->getEmployeeSelfHelpContributions($user_id);

		$shg_fund_deduction_amount = 0;
		if ($employee_contributions) {
			$gross_s = $gross_salary + $g_additional_wage;
			$contribution_id = $employee_contributions->contribution_id;
			$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
			$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
			$shg_fund_name = $contribution_type[0]->contribution;
			$shg_fund_deduction_amount += $contribution_amount;
		}
		$ashg_fund_deduction_amount = 0;
		$ashg_fund_name = "";
		$employee_ashg_contributions = $this->Contribution_fund_model->getEmployeeAdditionalSelfHelpContributions($user_id);
		if ($employee_ashg_contributions) {
			$gross_s = $gross_salary + $g_additional_wage;

			$contribution_id = $employee_ashg_contributions->contribution_id;
			$contribution_amount = $this->Contribution_fund_model->getContributionRate($gross_s, $contribution_id);
			$contribution_type = $this->Contribution_fund_model->getContributionFundsById($contribution_id);
			$ashg_fund_name = $contribution_type[0]->contribution;

			$ashg_fund_deduction_amount += $contribution_amount;
		}
		$output = array(
			'shg_fund_deduction_amount' => $shg_fund_deduction_amount,
			'ashg_fund_deduction_amount' => $ashg_fund_deduction_amount,
			// 'shg_fund_name'=>$shg_fund_name,
			// 'ashg_fund_name'=>$ashg_fund_name,
			'cpf_employee' => $cpf_employee
		);
		echo json_encode($output);
	}
}
